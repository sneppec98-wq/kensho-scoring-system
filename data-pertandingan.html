<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Pertandingan | Spartan Sport</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg: #020617;
            --surface: #0f172a;
            --card: #020617;
            --border: rgba(255, 255, 255, .08);
            --text: #e5e7eb;
            --muted: #94a3b8;
            --accent: #3b82f6;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow-x: hidden;
        }

        .card {
            background: rgba(15, 23, 42, .6);
            border: 1px solid var(--border);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .shimmer-text {
            background: linear-gradient(to right, var(--text) 20%, #ffffff 50%, var(--text) 80%);
            background-size: 200% auto;
            color: transparent;
            -webkit-background-clip: text;
            background-clip: text;
            animation: shine 3s linear infinite;
        }

        @keyframes shine {
            to {
                background-position: 200% center;
            }
        }
    </style>
</head>

<body class="flex min-h-screen">

    <!-- SIDEBAR -->
    <aside
        class="w-20 fixed h-screen flex flex-col items-center py-8 border-r border-white/5 bg-black/30 backdrop-blur-xl z-50">
        <a href="dashboard.html">
            <img src="kensho-logo.png" class="w-9 mb-10 hover:scale-110 transition-transform">
        </a>

        <a href="dashboard.html" title="Dashboard"
            class="w-10 h-10 rounded-lg flex items-center justify-center text-slate-400 hover:text-blue-400 hover:bg-blue-500/10 transition mb-4">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                </path>
            </svg>
        </a>

        <button onclick="handleLogout()" title="Logout"
            class="mt-auto mb-6 w-10 h-10 rounded-lg flex items-center justify-center text-slate-400 hover:text-red-400 hover:bg-red-500/10 transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                </path>
            </svg>
        </button>
    </aside>

    <!-- MAIN -->
    <main class="ml-20 flex-1 max-w-6xl mx-auto px-10 py-10">

        <!-- HEADER -->
        <header class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-3xl font-bold tracking-tight uppercase shimmer-text">Data Pertandingan</h1>
                <p class="text-xs text-slate-500 tracking-widest uppercase opacity-60">Sistem Kontrol & Manajemen Event
                </p>
            </div>

            <div class="flex items-center gap-4">
                <button onclick="openModal('modalAddEvent')"
                    class="px-5 py-2.5 rounded-xl bg-blue-600 text-white text-[10px] font-black uppercase tracking-widest hover:bg-blue-500 transition-all shadow-lg shadow-blue-500/20 active:scale-95">
                    + Pertandingan Baru
                </button>

                <div onclick="openProfileModal()"
                    class="flex items-center gap-3 px-4 py-2 rounded-xl bg-white/5 border border-white/10 cursor-pointer hover:bg-white/10 transition-all">
                    <div class="text-right">
                        <p id="userRoleDisplay" class="text-[8px] uppercase font-black text-slate-600 tracking-widest">
                            OWNER</p>
                        <p id="userNameDisplay" class="text-[10px] font-bold uppercase text-blue-400">Loading…</p>
                    </div>
                    <div
                        class="w-8 h-8 rounded-lg bg-blue-500/10 flex items-center justify-center text-blue-400 border border-blue-500/20">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </header>

        <!-- EVENT LIST -->
        <section id="eventList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="col-span-full py-20 text-center text-xs text-slate-500 italic opacity-40">
                Memuat data pertandingan...
            </div>
        </section>

    </main>

    <!-- MODAL ADD EVENT -->
    <div id="modalAddEvent"
        class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="card w-full max-w-md p-8 animate-in fade-in zoom-in duration-300">
            <h2 class="text-xl font-bold italic uppercase shimmer-text mb-8">Buat Pertandingan Baru</h2>

            <div class="space-y-6">
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase tracking-widest opacity-40">Nama Event</label>
                    <input id="eventNameInput" placeholder="CONTOH: PIALA SPARTAN IV"
                        class="w-full px-4 py-3 rounded-xl bg-black/30 border border-white/10 text-sm font-bold uppercase tracking-widest text-white outline-none focus:border-blue-500/50 transition-all">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase tracking-widest opacity-40">Tanggal</label>
                        <input id="eventDateInput" type="date"
                            class="w-full px-4 py-3 rounded-xl bg-black/30 border border-white/10 text-sm font-bold text-white outline-none focus:border-blue-500/50 transition-all">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase tracking-widest opacity-40">Lokasi</label>
                        <input id="eventLocationInput" placeholder="KOTA / PROV"
                            class="w-full px-4 py-3 rounded-xl bg-black/30 border border-white/10 text-sm font-bold uppercase tracking-widest text-white outline-none focus:border-blue-500/50 transition-all">
                    </div>
                </div>

                <div class="flex gap-4 pt-4">
                    <button onclick="closeModal('modalAddEvent')"
                        class="flex-1 py-3 text-[10px] font-black uppercase tracking-widest text-slate-500 hover:text-white transition-all">
                        Batal
                    </button>
                    <button onclick="saveEvent()"
                        class="flex-1 py-3 rounded-xl bg-blue-600 text-white text-[10px] font-black uppercase tracking-widest hover:bg-blue-500 shadow-lg shadow-blue-500/20 active:scale-95 transition-all">
                        Simpan Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PROFILE MODAL (Simplified context from original) -->
    <div id="profileModal"
        class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="card w-full max-w-md p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold italic uppercase shimmer-text">Update Profil</h2>
                <button onclick="closeModal('profileModal')"
                    class="text-slate-500 hover:text-white transition-all">✕</button>
            </div>
            <form id="profileForm" class="space-y-6">
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase tracking-widest opacity-40">Nama Lengkap</label>
                    <input type="text" id="profileName" required
                        class="w-full px-4 py-3 rounded-xl bg-black/20 border border-white/10 text-sm font-bold text-white outline-none">
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase tracking-widest opacity-40">Email</label>
                    <input type="email" id="profileEmail" readonly
                        class="w-full px-4 py-3 rounded-xl bg-black/40 border border-white/5 text-sm font-bold text-slate-500 outline-none cursor-not-allowed">
                </div>
                <button type="submit"
                    class="w-full py-4 rounded-xl bg-blue-600 text-white text-[10px] font-black uppercase tracking-widest hover:bg-blue-500 active:scale-95 transition-all">Simpan
                    Perubahan</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { db, auth } from './js/firebase-init.js';
        import { handleLogout } from './js/auth-helpers.js';
        import { onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { collection, onSnapshot, query, orderBy, addDoc, deleteDoc, doc, where, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { logActivity } from './js/activity-logger.js';

        window.handleLogout = handleLogout;

        const eventListContainer = document.getElementById('eventList');

        // REALTIME LISTENER
        onSnapshot(query(collection(db, "events"), orderBy("createdAt", "desc")), snap => {
            if (snap.empty) {
                eventListContainer.innerHTML = `<div class="col-span-full py-20 text-center text-xs text-slate-500 italic">Belum ada data pertandingan aktif.</div>`;
                return;
            }
            eventListContainer.innerHTML = '';
            snap.forEach((docSnap, index) => {
                const e = docSnap.data();
                const id = docSnap.id;

                const div = document.createElement('div');
                div.className = 'animate-in slide-in-from-bottom-4 duration-300 fill-mode-both';
                div.style.animationDelay = `${index * 50}ms`;

                div.innerHTML = `
      <div class="card p-6 flex flex-col justify-between hover:bg-white/[0.08] hover:border-blue-500/30 transition-all cursor-pointer group relative overflow-hidden" 
           onclick="location.href='event-detail.html?id=${id}'">
        <div class="absolute -top-10 -right-10 w-24 h-24 bg-blue-500/5 rounded-full blur-2xl group-hover:bg-blue-500/10 transition-all"></div>
        
        <div class="relative">
          <div class="flex justify-between items-start mb-4">
              <div class="w-10 h-10 rounded-lg bg-blue-500/10 flex items-center justify-center text-blue-400 group-hover:bg-blue-500 group-hover:text-white transition-all">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
              </div>
              <button onclick="event.stopPropagation(); deleteEvent('${id}', '${e.name}')" class="opacity-0 group-hover:opacity-100 p-2 text-slate-500 hover:text-red-400 transition-all">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
              </button>
          </div>
          
          <h3 class="text-lg font-black italic uppercase text-slate-100 group-hover:text-blue-400 transition-colors mb-2">${e.name}</h3>
          <div class="flex flex-col gap-1 opacity-60">
              <p class="text-[9px] font-bold uppercase tracking-widest flex items-center gap-2">
                <span class="w-1 h-1 rounded-full bg-blue-500"></span>
                TGL: ${e.date || '-'}
              </p>
              <p class="text-[9px] font-bold uppercase tracking-widest flex items-center gap-2">
                <span class="w-1 h-1 rounded-full bg-blue-500"></span>
                LOC: ${e.location || '-'}
              </p>
          </div>
        </div>

        <div class="mt-6 flex items-center justify-between pt-4 border-t border-white/5">
            <span class="text-[8px] font-black uppercase tracking-widest text-slate-500 group-hover:text-blue-500 transition-all">Konfigurasi Event</span>
            <svg class="w-4 h-4 text-slate-600 group-hover:text-blue-500 transform group-hover:translate-x-1 transition-all" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
        </div>
      </div>`;
                eventListContainer.appendChild(div);
            });
        });

        window.saveEvent = async () => {
            const name = eventNameInput.value;
            const date = eventDateInput.value;
            const location = eventLocationInput.value;

            if (!name) return alert("Nama event wajib diisi");

            try {
                await addDoc(collection(db, "events"), {
                    name: name.toUpperCase(),
                    date: date,
                    location: location.toUpperCase(),
                    createdAt: new Date().toISOString(),
                    status: 'active',
                    setupComplete: false, // Force setup completion
                    createdBy: auth.currentUser?.uid || 'anonymous'
                });

                await logActivity("Buat Event", `Membuat event baru: ${name.toUpperCase()}`);
                closeModal('modalAddEvent');

                // Reset inputs
                eventNameInput.value = '';
                eventDateInput.value = '';
                eventLocationInput.value = '';
            } catch (error) {
                alert("Gagal menyimpan event: " + error.message);
            }
        };

        window.deleteEvent = async (id, name) => {
            if (confirm(`Hapus event "${name}"? Semua data terkait akan ikut terhapus.`)) {
                try {
                    await deleteDoc(doc(db, "events", id));
                    await logActivity("Hapus Event", `Menghapus event: ${name}`);
                } catch (error) {
                    alert("Gagal menghapus event: " + error.message);
                }
            }
        };

        // MODAL CONTROLS
        window.openModal = id => document.getElementById(id).classList.remove('hidden');
        window.closeModal = id => document.getElementById(id).classList.add('hidden');

        // PROFILE MODAL
        window.openProfileModal = () => {
            const user = auth.currentUser;
            if (user) {
                document.getElementById('profileName').value = user.displayName || "";
                document.getElementById('profileEmail').value = user.email || "";
                document.getElementById('profileModal').classList.remove('hidden');
            }
        };

        document.getElementById('profileForm').onsubmit = async (e) => {
            e.preventDefault();
            const newName = document.getElementById('profileName').value;
            try {
                const oldName = auth.currentUser.displayName;
                await updateProfile(auth.currentUser, { displayName: newName });
                document.getElementById('userNameDisplay').innerText = newName;
                await logActivity("Update Profil", `Mengubah nama profil dari "${oldName}" menjadi "${newName}"`);
                alert("Profil berhasil diperbarui!");
                closeModal('profileModal');
            } catch (error) {
                alert("Gagal memperbarui profil: " + error.message);
            }
        };

        // AUTH & ROLE
        onAuthStateChanged(auth, async user => {
            if (!user) {
                location.href = 'login.html';
            } else {
                userNameDisplay.innerText = user.displayName || user.email.split('@')[0];

                // Role Check
                const q = query(collection(db, "admins"), where("email", "==", user.email));
                const snap = await getDocs(q);
                if (!snap.empty) {
                    const adminData = snap.docs[0].data();
                    userRoleDisplay.innerText = adminData.role.toUpperCase();
                } else {
                    userRoleDisplay.innerText = "ADMIN";
                }
            }
        });
    </script>

</body>

</html>