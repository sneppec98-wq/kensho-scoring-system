<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Bagan | Spartan Sport</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/window-controls.css">
    <style>
        :root {
            --bg: #f8fafc;
            /* Slate 50 */
            --light: #f1f5f9;
            /* Slate 100 */
            --dark: #e2e8f0;
            /* Slate 200 */
            --text: #0f172a;
            /* Slate 900 */
            --accent: #ef4444;
            /* Red 500 */
            --blue: #3b82f6;
            /* Blue 500 */
        }

        body {
            background: var(--bg);
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: var(--text);
            overflow-x: hidden;
        }

        /* NEUMORPHISM UI */
        .neu-flat {
            background: rgba(248, 250, 252, 0.8);
            backdrop-filter: blur(20px);
            box-shadow: 10px 10px 30px rgba(0, 0, 0, 0.05), -5px -5px 20px rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.03);
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .neu-inset {
            background: rgba(241, 245, 249, 0.5);
            backdrop-filter: blur(5px);
            box-shadow: inset 4px 4px 12px rgba(0, 0, 0, 0.05), inset -2px -2px 8px rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.02);
        }

        .neu-button {
            background: #ffffff;
            box-shadow: 4px 4px 12px rgba(0, 0, 0, 0.05), -2px -2px 8px rgba(255, 255, 255, 0.8);
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: 1px solid rgba(0, 0, 0, 0.03);
            color: var(--text);
        }

        .neu-button:hover {
            transform: translateY(-2px);
            box-shadow: 6px 6px 15px rgba(0, 0, 0, 0.4), -3px -3px 10px rgba(255, 255, 255, 0.05);
            color: var(--blue);
            border-color: rgba(59, 130, 246, 0.2);
        }

        /* Aurora Background */
        #aurora-container {
            position: fixed;
            inset: 0;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
            background: var(--bg);
        }

        .aurora {
            position: absolute;
            width: 80vmax;
            height: 80vmax;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.05;
            /* Even softer for light theme */
            mix-blend-mode: multiply;
            animation: drift 20s infinite alternate linear;
        }

        .aurora-1 {
            background: var(--accent);
            top: -20%;
            left: -20%;
        }

        .aurora-2 {
            background: #4f46e5;
            bottom: -20%;
            right: -20%;
            animation-delay: -5s;
        }

        .aurora-3 {
            background: #06b6d4;
            top: 40%;
            left: 30%;
            animation-duration: 25s;
        }

        @keyframes drift {
            from {
                transform: translate(0, 0) scale(1);
            }

            to {
                transform: translate(10%, 10%) scale(1.1);
            }
        }

        .shimmer-text {
            background: linear-gradient(to right, var(--text) 20%, #ffffff 50%, var(--text) 80%);
            background-size: 200% auto;
            color: transparent;
            -webkit-background-clip: text;
            background-clip: text;
            animation: shine 3s linear infinite;
        }

        @keyframes shine {
            to {
                background-position: 200% center;
            }
        }

        /* SIDEBAR DROPDOWN SYSTEM */
        .dropdown-menu {
            display: none;
            position: absolute;
            left: 100%;
            top: 0;
            padding-left: 20px;
            z-index: 100;
            min-width: 200px;
        }

        .group:hover .dropdown-menu {
            display: block;
            animation: slideRight 0.2s ease-out;
        }

        .dropdown-content {
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(25px);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 1.25rem;
            border-radius: 1.25rem;
        }

        @keyframes slideRight {
            from {
                opacity: 0;
                transform: translateX(10px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--dark);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* Refined Sidebar */
        aside {
            background: rgba(15, 23, 42, 0.8) !important;
            backdrop-filter: blur(25px) saturate(180%) !important;
            border-right: 1px solid rgba(255, 255, 255, 0.05) !important;
            padding-top: 2rem;
            padding-bottom: 2rem;
        }

        .side-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            background: transparent;
            margin-bottom: 1.5rem;
        }

        .side-btn:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px) scale(1.05);
        }

        .side-btn.active {
            color: var(--blue);
            background: rgba(59, 130, 246, 0.1);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.05);
            border: 1px solid rgba(59, 130, 246, 0.15);
        }

        .side-btn.active::before {
            content: '';
            position: absolute;
            left: -18px;
            width: 3px;
            height: 18px;
            background: var(--blue);
            border-radius: 0 4px 4px 0;
            box-shadow: 0 0 10px var(--blue);
        }

        /* Sidebar Tooltip */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            left: calc(100% + 15px);
            top: 50%;
            transform: translateY(-50%) translateX(-5px);
            background: rgba(15, 17, 26, 0.9);
            backdrop-filter: blur(10px);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
        }

        [data-tooltip]:hover::after {
            opacity: 1;
            transform: translateY(-50%) translateX(0);
        }

        /* Voice Lounge Floating Panel */
        #voice-lounge-panel {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 320px;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 2.5rem;
            z-index: 1000;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(120%);
        }

        #voice-lounge-panel.active {
            transform: translateY(0);
        }

        .voice-user {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            background: rgba(255, 255, 255, 0.03);
            transition: all 0.3s;
        }

        .voice-user.speaking {
            background: rgba(248, 113, 113, 0.1);
            box-shadow: 0 0 15px rgba(248, 113, 113, 0.1);
            border-color: rgba(248, 113, 113, 0.2);
        }

        .pulse-mic {
            animation: mic-pulse 2s infinite;
        }

        @keyframes mic-pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.2);
                opacity: 0.5;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* BRACKET VISUAL SYSTEM */
        .bracket-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            padding: 20px;
            position: relative;

            /* F4 Landscape Proportions (330:210 = 1.57:1) */
            width: 100%;
            max-width: 100%;
            aspect-ratio: 1.57;
            margin: 0 auto;
        }

        .bracket-round {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            height: 100%;
            position: relative;
        }

        .bracket-match {
            display: flex;
            flex-direction: column;
            position: relative;
            margin-bottom: 30px;
        }

        .bracket-match:last-child {
            margin-bottom: 0;
        }

        .bracket-node {
            width: 190px;
            padding: 12px 18px;
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            margin: 6px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text);
            position: relative;
            z-index: 2;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .bracket-node:hover {
            transform: translateX(5px);
            border-color: rgba(248, 113, 113, 0.3);
        }

        .bracket-node.winner {
            color: var(--accent);
        }

        /* Connectors */
        .bracket-match::after {
            content: '';
            position: absolute;
            right: -30px;
            top: 50%;
            width: 30px;
            height: 2px;
            background: var(--dark);
            z-index: 1;
        }

        /* Dynamic Connectors Vertical Lines */
        .bracket-round:not(:last-child) .bracket-match:nth-child(odd)::before,
        .bracket-round:not(:last-child) .bracket-match:nth-child(even)::before {
            content: '';
            position: absolute;
            right: -30px;
            width: 2px;
            background: var(--dark);
            z-index: 1;
        }

        /* Round 1 (8 matches -> 4 next) */
        .round-1 .bracket-match:nth-child(odd)::before {
            top: 50%;
            height: calc(50% + 23px);
        }

        .round-1 .bracket-match:nth-child(even)::before {
            bottom: 50%;
            height: calc(50% + 23px);
        }

        /* Round 2 (4 matches -> 2 next) */
        .round-2 .bracket-match:nth-child(odd)::before {
            top: 50%;
            height: calc(50% + 60px);
        }

        .round-2 .bracket-match:nth-child(even)::before {
            bottom: 50%;
            height: calc(50% + 60px);
        }

        /* Round 3 (2 matches -> 1 next) */
        .round-3 .bracket-match:nth-child(odd)::before {
            top: 50%;
            height: calc(50% + 140px);
        }

        .round-3 .bracket-match:nth-child(even)::before {
            bottom: 50%;
            height: calc(50% + 140px);
        }

        /* Round 4 (Specific for 16-man 1st round if needed) */
        /* Currently bracket-match margin/height is handled by flex-around */

        /* Remove horizontal line for final round */
        .bracket-round:last-child .bracket-match::after {
            display: none;
        }

        /* Empty Node style */
        .bracket-node.empty {
            border-style: dashed !important;
            opacity: 0.15;
            color: rgba(255, 255, 255, 0.2);
        }

        .final-node {
            background: rgba(248, 113, 113, 0.05);
            border: 1px solid rgba(248, 113, 113, 0.2) !important;
            animation: finalPulse 2s infinite;
        }

        @keyframes finalPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(248, 113, 113, 0.2);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(248, 113, 113, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(248, 113, 113, 0);
            }
        }

        /* PRINT SYSTEM */
        @media print {

            aside,
            header,
            .no-print,
            footer,
            #step-1,
            #step-2 {
                display: none !important;
            }

            body {
                background: white !important;
                color: black !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            main {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                background: white !important;
            }

            .neu-flat,
            .neu-inset,
            .neu-button {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                background: white !important;
            }

            .bracket-node {
                color: black !important;
                border: 1px solid #333 !important;
                background: white !important;
            }

            .bracket-match::after,
            .bracket-round div::before {
                background: #333 !important;
            }

            .bracket-container {
                scale: 1 !important;
                transform: none !important;
                padding: 20px !important;
                color: black !important;
            }

            .text-red-400,
            .text-red-500,
            .text-accent {
                color: #cc0000 !important;
            }

            /* LEGAL/F4 Page Size */
            @page {
                size: 215.9mm 330.2mm;
                /* F4/Legal approx */
                margin: 10mm;
            }
        }
    </style>
</head>

<body class="min-h-screen flex text-slate-900 bg-[#f8fafc]">
    <script src="js/window-controls.js"></script>
    <!-- Aurora Background -->
    <div id="aurora-container">
        <div class="aurora aurora-1"></div>
        <div class="aurora aurora-2"></div>
        <div class="aurora aurora-3"></div>
    </div>

    <main class="flex-1 p-10 overflow-y-auto custom-scrollbar">
        <header class="flex justify-between items-end mb-12">
            <div>
                <div
                    class="flex items-center space-x-4 mb-4 text-[10px] font-black uppercase tracking-[0.3em] opacity-40">
                    <a href="data-pertandingan.html" class="hover:text-blue-500 transition-colors">PERTANDINGAN</a>
                    <span>/</span>
                    <a href="javascript:window.history.back()"
                        class="hover:text-blue-500 transition-colors uppercase font-bold text-slate-700">PIALA
                        SPARTAN
                        2026</a>
                    <span>/</span>
                    <span class="text-blue-500 opacity-100 font-extrabold">GENERATOR BAGAN</span>
                </div>
                <h1 class="text-5xl font-black italic tracking-tighter uppercase leading-none shimmer-text">
                    Generator
                    Bagan</h1>
            </div>
            <div class="flex items-center gap-6">
                <!-- USER INFO REMOVED -->
                <button onclick="window.history.back()"
                    class="neu-button px-6 py-3 rounded-xl text-[9px] font-black uppercase tracking-widest text-slate-400 hover:text-white transition-all">Kembali</button>
            </div>
        </header>

        <div class="space-y-12">
            <!-- SECTION 1: KONFIGURASI (HORIZONTAL BAR) -->
            <section class="neu-flat p-10 rounded-[3rem] border border-white/5">
                <div class="flex flex-col gap-10">
                    <!-- Step 1 Header -->
                    <div
                        class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 border-b border-white/5 pb-8">
                        <div>
                            <p class="text-[9px] font-black uppercase tracking-[0.3em] text-blue-500 mb-2">Langkah 1
                            </p>
                            <h3 class="text-3xl font-black italic uppercase">Konfigurasi Turnamen</h3>
                            <p class="text-[10px] font-bold opacity-30 tracking-widest mt-1 italic">Sesuaikan
                                parameter
                                event dan kelas tanding</p>
                        </div>
                        <div class="flex gap-4 w-full md:w-auto">
                            <!-- Tombol Excel, Generate, dan Reset dihapus untuk otomatisasi penuh -->
                        </div>
                    </div>

                    <!-- Step 1 Inputs -->
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-10">
                        <div class="space-y-4">
                            <label
                                class="text-[10px] font-black uppercase opacity-40 ml-4 block tracking-[0.2em] text-blue-500">Kategori
                                Tanding</label>
                            <select
                                class="w-full neu-inset px-8 py-6 rounded-[2rem] outline-none text-sm font-black uppercase tracking-widest text-slate-900 border border-slate-200 focus:border-blue-400/50 transition-all cursor-pointer bg-white">
                                <option>Kumite Putra -55KG</option>
                                <option>Kumite Putri -50KG</option>
                                <option>Kata Perorangan Putra</option>
                                <option>Kumite Perorangan Putri -50KG (Senior)</option>
                                <option>Kumite Perorangan Putri +68KG (Senior)</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 border-b border-slate-100 pb-8">
                            <div class="space-y-4">
                                <label
                                    class="text-[10px] font-black uppercase opacity-40 ml-4 block tracking-[0.2em]">Event
                                    Aktif</label>
                                <div
                                    class="neu-inset px-8 py-6 rounded-[2rem] text-sm font-black text-slate-400 border border-slate-100 uppercase italic bg-white">
                                    PIALA SPARTAN 2026</div>
                            </div>
                            <div class="space-y-4">
                                <label
                                    class="text-[10px] font-black uppercase opacity-40 ml-4 block tracking-[0.2em]">Jumlah
                                    Peserta</label>
                                <div class="flex items-center gap-4">
                                    <input id="participantCount" type="number" min="2" max="16" value="0" readonly
                                        class="w-full neu-inset px-8 py-6 rounded-[2rem] outline-none text-sm font-black uppercase tracking-widest text-slate-400 border border-slate-200 bg-slate-50/50 cursor-not-allowed transition-all">
                                    <span class="text-[11px] font-black opacity-30 italic pr-6">ORG</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECTION 2: LIST ATLET (TABBED INTERFACE) -->
            <section class="neu-flat p-10 rounded-[3rem] border border-white">
                <div class="flex flex-col gap-10">
                    <!-- HEADER & ACTIONS -->
                    <div
                        class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-8 border-b border-slate-100 pb-10">
                        <div class="space-y-1">
                            <h3 class="text-3xl font-black italic uppercase text-slate-900">Peserta</h3>
                            <p id="athleteTotalLabel" class="text-xs font-black italic text-blue-500 opacity-60">0 ATLET
                            </p>
                        </div>

                        <div class="flex flex-wrap items-center gap-6">
                            <!-- ACTION: DRAW -->
                            <button onclick="smartDrawParticipants()"
                                class="px-8 py-4 rounded-2xl bg-blue-500 text-white text-[10px] font-black uppercase tracking-widest hover:bg-blue-600 shadow-[0_15px_30px_rgba(59,130,246,0.3)] transition-all flex items-center gap-3 group">
                                <svg class="w-4 h-4 group-hover:scale-110 transition-transform" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                        d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg> SMART DRAW (OTO)
                            </button>

                            <!-- TABS NAVIGATION -->
                            <div class="flex p-1.5 bg-slate-100 rounded-[1.5rem] border border-slate-200/50">
                                <button onclick="switchStep2Tab('text')" id="tabBtnText"
                                    class="px-8 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all bg-white text-blue-600 shadow-md">
                                    1. DATA FIX
                                </button>
                                <button onclick="switchStep2Tab('visual')" id="tabBtnVisual"
                                    class="px-8 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all text-slate-400 hover:text-slate-600">
                                    2. ATUR BAGIAN
                                </button>
                                <button onclick="switchStep2Tab('magic')" id="tabBtnMagic"
                                    class="hidden px-8 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all text-slate-400 hover:text-slate-600">
                                    3. MAGIC BEREGU ðŸª„
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- MAIN CONTENT AREA -->
                    <div class="space-y-8">
                        <!-- TAB CONTENT 1: DATA FIX (TEXTAREA) -->
                        <div id="step2TabText" class="block">
                            <textarea id="manualNames" rows="10" readonly
                                placeholder="Daftar peserta resmi akan muncul di sini..."
                                class="w-full neu-inset px-8 py-6 rounded-[2.5rem] outline-none text-[11px] font-bold uppercase tracking-[0.1em] text-slate-500 border border-slate-200 bg-slate-50/50 cursor-not-allowed transition-all custom-scrollbar resize-none font-mono leading-relaxed"></textarea>
                        </div>

                        <!-- TAB CONTENT 2: ATUR BAGIAN (VISUAL) -->
                        <div id="step2TabVisual" class="hidden">
                            <div
                                class="p-8 rounded-[2.5rem] bg-indigo-50/50 border border-indigo-100/50 mb-6 group hover:bg-indigo-50 transition-colors">
                                <div class="flex items-start gap-4">
                                    <div class="p-3 bg-white rounded-2xl shadow-sm text-indigo-500">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </div>
                                    <div class="space-y-1">
                                        <p class="text-[10px] font-black uppercase text-indigo-600 tracking-wider">Mode
                                            Pengaturan Visual</p>
                                        <p class="text-[11px] font-bold text-slate-500 leading-relaxed">Klik dua kartu
                                            atlet di bawah ini untuk menukar posisi tanding mereka secara langsung pada
                                            bagan SVG.</p>
                                    </div>
                                </div>
                            </div>
                            <div id="athleteTags"
                                class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                <!-- Visual cards rendered here -->
                            </div>
                        </div>

                        <!-- TAB CONTENT 3: MAGIC BEREGU -->
                        <div id="step2TabMagic" class="hidden">
                            <div class="p-10 rounded-[2.5rem] bg-blue-50/50 border border-blue-100/50 mb-8">
                                <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                                    <div class="flex items-start gap-5">
                                        <div
                                            class="w-14 h-14 rounded-2xl bg-white shadow-sm flex items-center justify-center text-blue-500 text-2xl">
                                            ðŸª„</div>
                                        <div>
                                            <h4 class="text-xl font-black italic uppercase text-slate-900 mb-1">Magic
                                                Team Builder</h4>
                                            <p class="text-xs font-bold text-slate-500">Otomatis menggabungkan 3 atlet
                                                dari kontingen yang sama menjadi satu tim.</p>
                                        </div>
                                    </div>
                                    <button onclick="groupAthletesByTeamMagic()"
                                        class="px-10 py-5 rounded-2xl bg-blue-600 text-white text-[10px] font-black uppercase tracking-[0.2em] shadow-xl hover:bg-blue-700 hover:scale-105 active:scale-95 transition-all flex items-center gap-3">
                                        ðŸª„ SULAP JADI TIM
                                    </button>
                                </div>
                            </div>
                            <div id="magicTeamList" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                                <!-- Grouped teams will be rendered here -->
                                <div
                                    class="col-span-full py-20 text-center opacity-30 italic font-bold uppercase tracking-widest text-xs">
                                    Klik tombol sulap untuk memproses data anggota...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECTION 3: VISUALISASI BAGAN (LARGE AREA) -->
            <section class="neu-flat p-6 rounded-[3rem] border border-white/5 min-h-[600px] flex flex-col">
                <header class="mb-12 flex justify-between items-end border-b border-white/5 pb-8">
                    <div>
                        <p id="bracketCategoryLabel"
                            class="text-xs font-black uppercase tracking-[0.4em] text-blue-500 mb-2">Kumite Putra
                            -55KG
                        </p>
                        <h3 id="bracketEventLabel" class="text-3xl font-black italic uppercase">PIALA SPARTAN 2026
                        </h3>
                        <p
                            class="text-[10px] font-bold opacity-30 tracking-widest mt-2 italic border-t border-white/5 pt-2">
                            Bagan Pertandingan Otomatis</p>
                    </div>

                    <div class="flex items-center gap-6 mb-1">
                        <div class="flex items-center gap-3 px-4 py-2 rounded-xl bg-slate-100 border border-slate-200">
                            <input type="checkbox" id="useShortName" onchange="generateBracket()"
                                class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
                            <label for="useShortName"
                                class="text-[9px] font-black uppercase tracking-widest text-slate-500 cursor-pointer">Nama
                                Singkat</label>
                        </div>
                        <button id="btnPreviewFestival" onclick="handlePreviewFestival()"
                            class="neu-button px-8 py-3 rounded-xl flex items-center gap-3 text-[10px] font-black uppercase tracking-widest text-emerald-600 bg-emerald-500/5 border border-emerald-500/10 hover:bg-emerald-600 hover:text-white transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                            PRATINJAU FESTIVAL
                        </button>
                        <button onclick="exportToPremium('pdf', event)"
                            class="neu-button px-8 py-3 rounded-xl flex items-center gap-3 text-[10px] font-black uppercase tracking-widest text-blue-500 bg-blue-500/5 border border-blue-500/10 hover:bg-blue-600 hover:text-white transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            EXPORT PDF (F4)
                        </button>
                    </div>
                </header>

                <div
                    class="flex-1 rounded-[3rem] border border-slate-200 flex items-center justify-center bg-white overflow-x-auto custom-scrollbar relative p-4 shadow-xl">
                    <div id="bracketVisualArea"
                        class="bracket-container w-full h-full flex items-center justify-center transition-all duration-700 bg-white">
                        <!-- Generated by JavaScript -->
                    </div>
                </div>

                <footer class="mt-12 flex justify-end space-x-6 items-center">
                    <p class="text-[9px] font-black uppercase tracking-[0.2em] text-white/10 italic mr-auto">Power
                        by
                        Spartan Tournament Engine v2.0</p>
                    <button onclick="window.goBackToDetail()"
                        class="px-10 py-5 rounded-2xl neu-button text-[10px] font-black uppercase tracking-[0.2em] opacity-50 hover:opacity-100 transition-all">Batalkan</button>
                    <button id="btnSaveBracket" onclick="saveBracket()"
                        class="px-16 py-5 rounded-2xl bg-blue-500 text-white text-[10px] font-black uppercase tracking-[0.4em] shadow-[0_20px_40px_rgba(59,130,246,0.3)] hover:scale-105 active:scale-95 transition-all flex items-center gap-3">
                        <span id="saveStatus">SIMPAN & SELESAI</span>
                    </button>
                </footer>
            </section>
        </div>
    </main>
    <!-- UI: Kensho Voice Lounge Panel -->
    <div id="voice-lounge-panel" class="p-6">
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-red-400/20 flex items-center justify-center text-red-400">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                    </svg>
                </div>
                <div>
                    <h4 class="text-xs font-black tracking-widest uppercase">Voice Lounge</h4>
                    <p class="text-[8px] font-bold opacity-30 uppercase tracking-[0.2em] mt-0.5">Live Coordination
                    </p>
                </div>
            </div>
            <button onclick="toggleVoiceLounge()" class="text-slate-500 hover:text-white transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </button>
        </div>

        <div id="voice-users-list" class="space-y-3 mb-8 max-h-48 overflow-y-auto custom-scrollbar">
            <!-- Joined users will appear here -->
            <div class="flex flex-col items-center justify-center py-6 opacity-20 italic">
                <p class="text-[10px] font-bold uppercase tracking-widest">Lounge Kosong</p>
            </div>
        </div>

        <div class="flex gap-3">
            <button id="btn-join-voice" onclick="handleJoinVoice()"
                class="flex-1 py-4 rounded-xl bg-red-500 text-white text-[10px] font-black uppercase tracking-widest hover:brightness-110 transition-all flex items-center justify-center gap-2">
                Join Lounge
            </button>
            <button id="btn-mute-voice" onclick="toggleMute()"
                class="hidden w-14 h-14 rounded-xl border border-white/10 flex items-center justify-center text-slate-500 hover:text-white transition-all">
                <svg id="mute-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                </svg>
            </button>
            <button id="btn-leave-voice" onclick="handleLeaveVoice()"
                class="hidden w-14 h-14 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center text-slate-500 hover:text-red-400 transition-all">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
            </button>
        </div>
    </div>

    <script type="module">
        import { db, auth } from './js/firebase-init.js';
        import { handleLogout } from './js/auth-helpers.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { collection, onSnapshot, query, where, getDocs, doc, getDoc, setDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { initVoiceLounge, joinVoice, leaveVoice, toggleMicMute } from './js/voice-chat.js';
        import { prepareBracketPrint } from './js/modules/print/print-bracket.js';
        import { getLogicalIdFromSVGId, getNextSlot, getTeamSlot } from './js/bracket-utils.js';

        window.handleLogout = handleLogout;
        let bracketListener = null;

        // Voice Lounge UI Logic
        window.toggleVoiceLounge = () => {
            const panel = document.getElementById('voice-lounge-panel');
            panel.classList.toggle('active');
            const btn = document.getElementById('btn-voice');
            btn.classList.toggle('active');
        };

        window.handleJoinVoice = async () => {
            const user = auth.currentUser;
            if (!user) return;
            const btnJoin = document.getElementById('btn-join-voice');
            btnJoin.disabled = true;
            try {
                await joinVoice(user);
                btnJoin.classList.add('hidden');
                document.getElementById('btn-mute-voice').classList.remove('hidden');
                document.getElementById('btn-leave-voice').classList.remove('hidden');
            } catch (err) {
                alert("Gagal join Voice Lounge: " + err.message);
                btnJoin.disabled = false;
            }
        };

        window.handleLeaveVoice = async () => {
            await leaveVoice();
            document.getElementById('btn-join-voice').classList.remove('hidden');
            document.getElementById('btn-join-voice').disabled = false;
            document.getElementById('btn-mute-voice').classList.add('hidden');
            document.getElementById('btn-leave-voice').classList.add('hidden');
        };

        window.toggleMute = () => {
            const isMuted = toggleMicMute();
            const icon = document.getElementById('mute-icon');
            const btn = document.getElementById('btn-mute-voice');
            if (isMuted) {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-3.674m0 0L3 21m0-18l18 18" />';
                btn.classList.add('text-red-400');
            } else {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />';
                btn.classList.remove('text-red-400');
            }
        };

        window.goBackToDetail = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('id');
            if (eventId) {
                window.location.href = `event-detail.html?id=${eventId}&tab=bracket`;
            } else {
                window.history.back();
            }
        };

        // Get Context from URL

        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('id');
        const classId = urlParams.get('classId');
        const initialClass = urlParams.get('class');
        let currentClassCode = classId || "";

        if (!eventId) {
            alert("ID Event tidak ditemukan!");
            window.location.href = 'data-pertandingan.html';
        }

        // Protect Route
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                // Load Data
                loadEventContext();
            }
        });

        async function loadEventContext() {
            // 1. Load Event Info
            const eventDoc = await getDoc(doc(db, "events", eventId));
            if (eventDoc.exists()) {
                const eventData = eventDoc.data();
                document.getElementById('bracketEventLabel').innerText = eventData.name;
                // Simpan host kontingen secara global
                window.hostKontingen = eventData.settings?.hostKontingen || "";
                // Breadcrumb
                const breadcrumbEvent = document.querySelector('a[href*="event-detail.html"], a[onclick*="history.back"]');
                if (breadcrumbEvent) {
                    breadcrumbEvent.innerText = eventData.name;
                    breadcrumbEvent.href = `event-detail.html?id=${eventId}&tab=bracket`;
                    breadcrumbEvent.onclick = (e) => {
                        e.preventDefault();
                        window.goBackToDetail();
                    };
                }
            }

            // 2. Load All Classes for Dropdown
            const qClasses = query(collection(db, `events/${eventId}/classes`), orderBy("name", "asc"));
            const classSnap = await getDocs(qClasses);
            const categorySelect = document.querySelector('select');
            categorySelect.innerHTML = '<option value="">Pilih Kategori...</option>';

            classSnap.forEach(snap => {
                const cls = snap.data();
                const option = document.createElement('option');
                option.value = cls.name;
                option.textContent = cls.name;
                if (initialClass && cls.name === initialClass) option.selected = true;
                categorySelect.appendChild(option);
            });

            // 3. Listener for Change
            categorySelect.addEventListener('change', (e) => {
                if (e.target.value) loadAthletesForClass(e.target.value);
            });

            // 4. Load Schedule for Tatami Automation (Before initial class load)
            try {
                const scheduleSnap = await getDoc(doc(db, `events/${eventId}/metadata`, 'schedule'));
                if (scheduleSnap.exists()) {
                    window.currentEventSchedule = scheduleSnap.data().schedule || [];
                    console.log(`ðŸ“… Schedule loaded: ${window.currentEventSchedule.length} entries`);
                }
            } catch (err) {
                console.error("Error loading schedule:", err);
            }

            // 5. Initial Load if class is set
            if (initialClass) {
                await loadAthletesForClass(initialClass);
            }
        }

        async function loadAthletesForClass(className) {
            currentClass = className;
            // Update the visual label in the bracket area
            if (document.getElementById('bracketCategoryLabel')) {
                document.getElementById('bracketCategoryLabel').innerText = className;
            }

            // 1. Dapatkan Kode Kelas Terlebih Dahulu
            let classCode = "";
            try {
                const qClass = query(collection(db, `events/${eventId}/classes`), where("name", "==", className));
                const classSnap = await getDocs(qClass);
                if (!classSnap.empty) {
                    const classData = classSnap.docs[0].data();
                    classCode = classData.code || "";
                    currentClassCode = classCode;
                }
            } catch (err) { console.error("Error getting class code:", err); }

            // 2. Cari Atlet Berdasarkan Kode (Utama) atau Nama (Lama)
            let athletes = [];
            try {
                // Mencari atlet yang memiliki classCode sama ATAU className sama
                const qAthletes = query(collection(db, `events/${eventId}/athletes`));
                const snap = await getDocs(qAthletes);

                snap.forEach(docSnap => {
                    const d = docSnap.data();
                    // Cocokkan berdasarkan Kode (F01) atau Nama (KATA...)
                    if ((classCode && d.classCode === classCode) || (d.className === className)) {
                        athletes.push({
                            name: d.name,
                            team: d.team || d.kontingen || "-"
                        });
                    }
                });
            } catch (err) { console.error("Error loading athletes:", err); }

            // Check if this class is BEREGU or FESTIVAL
            try {
                const qClass = query(collection(db, `events/${eventId}/classes`), where("name", "==", className));
                const classSnap = await getDocs(qClass);
                const magicBtn = document.getElementById('tabBtnMagic');
                const bracketArea = document.getElementById('bracketVisualArea');

                if (!classSnap.empty) {
                    const classData = classSnap.docs[0].data();
                    currentClassCode = classData.code || "";

                    if (classData.type === 'BEREGU') {
                        if (magicBtn) magicBtn.classList.remove('hidden');
                    } else {
                        if (magicBtn) magicBtn.classList.add('hidden');
                    }
                }
            } catch (err) { console.error("Error checking class type:", err); }

            // Simpan ke peserta global
            participants = JSON.parse(JSON.stringify(athletes));
            console.log(`Loaded ${participants.length} athletes for class "${className}"`);

            // Update UI
            document.getElementById('participantCount').value = Math.max(2, athletes.length);
            document.getElementById('manualNames').value = athletes.map((a, i) => `${i + 1}. ${a.name} [${a.team}]`).join('\n');
            renderAthleteList();

            // CRITICAL: Load SVG first before fetching saved data
            if (!svgDoc) {
                console.log("ðŸ“„ Loading SVG template...");
                await loadSVG();
            }

            // Sinkronisasi dengan Firebase (Ambil urutan & data terakhir)
            console.log("Fetching saved bracket for:", className);
            await fetchSavedBracket(className.trim());

            // Only generate if no cloud data was found
            if (!window.isBracketDrawn) {
                const isFestival = (currentClassCode || "").toString().toUpperCase().startsWith('F');
                if (isFestival && participants.length >= 2) {
                    console.log("Festival class detected, performing auto-draw...");
                    smartDrawParticipants();
                } else {
                    console.log("No saved bracket found, showing empty template");
                    await generateBracket();
                }
            }

            // Real-time Listener for updates from Scoring Console
            if (bracketListener) bracketListener(); // Unsubscribe prev
            const listenerId = currentClassCode || className.trim();
            console.log(`ðŸ“¡ Attaching Real-Time Listener for "${className}" [${listenerId}]...`);
            bracketListener = onSnapshot(doc(db, `events/${eventId}/brackets`, listenerId), (snap) => {
                if (snap.exists() && !snap.metadata.hasPendingWrites) {
                    console.log("ðŸ”„ Bracket update detected from Cloud!");
                    fetchSavedBracket(className.trim());
                }
            });
        }

        function syncHeadersToSVG() {
            if (!svgDoc) return;

            const eventName = document.getElementById('bracketEventLabel')?.innerText || "";
            const className = document.getElementById('bracketCategoryLabel')?.innerText || "";

            // Populate SVG IDs - Pakai querySelector dan dukung tspan agar teks muncul dengan benar
            const eventEl = svgDoc.querySelector('#Nama_event');
            if (eventEl) {
                const target = eventEl.querySelector('tspan') || eventEl;
                target.textContent = eventName;
            }

            const classEl = svgDoc.querySelector('#Kelas_Kategori');
            if (classEl) {
                const target = classEl.querySelector('tspan') || classEl;
                target.textContent = className;
            }

            // --- Tatami & Pool Automation ---
            let tatamiValue = "-";
            if (window.currentEventSchedule) {
                const targetName = (className || "").trim().toUpperCase();

                // Find class in schedule using Code (Primary) or Name (Fallback)
                const scheduleEntry = window.currentEventSchedule.find(entry =>
                    entry.classes && entry.classes.some(cls =>
                        (currentClassCode && cls.code === currentClassCode) ||
                        (cls.name && targetName === cls.name.trim().toUpperCase())
                    )
                );

                if (scheduleEntry) {
                    tatamiValue = scheduleEntry.arena || "-";
                } else {
                    console.warn(`âš ï¸ Kategori "${className}" [${currentClassCode}] tidak ditemukan di jadwal.`);
                }
            }

            // Update SVG: #tatami
            const tatamiEl = svgDoc.querySelector('#tatami');
            if (tatamiEl) {
                const target = tatamiEl.querySelector('tspan') || tatamiEl;
                target.textContent = tatamiValue.toString();
            }

            // Update SVG: #pool
            const poolEl = svgDoc.querySelector('#pool');
            if (poolEl) {
                const target = poolEl.querySelector('tspan') || poolEl;
                // Permintaan USER: 1/1 jika peserta tidak melebihi 16
                if (participants && participants.length <= 16) {
                    target.textContent = "1/1";
                } else {
                    target.textContent = "1";
                }
            }
        }

        // Global variable declarations
        let currentClass = initialClass;
        window.isBracketDrawn = false;
        let participants = [];
        let svgDoc = null;

        const names = [];

        function cleanSVGPlaceholders() {
            if (!svgDoc) return;
            const placeholders = [
                "NAMA PESERTA", "SKOR", "NAMA EVENT", "KONTINGEN PESERTA",
                "SENSHU / PENALTY", "NAMA KATA", "-", "DASH -", "SKOR 1", "SKOR 2",
                "KELAS KATEGORI", "18 AGUSTUS 2025", "08.30 - 08.30 (30 menit)", "1/1"
            ];

            const headerIds = ["Nama_event", "Kelas_Kategori", "tanggal", "durasi", "tatami", "pool"];

            svgDoc.querySelectorAll('text, tspan').forEach(el => {
                const text = el.textContent.trim();
                const id = el.id || (el.parentElement && el.parentElement.id);

                const isParticipantId = (id) => {
                    if (!id) return false;
                    // Babak R1 (P), R2 (Q), R3 (S), R4 (F)
                    return id.startsWith('p_n_') || id.startsWith('p_k_') || id.startsWith('n_k_') || id.startsWith('s_') || id.startsWith('sp_') ||
                        id.startsWith('q_n_') || id.startsWith('q_k_') || id.startsWith('q_n_k_') || id.startsWith('q_s_') || id.startsWith('q_s_p_') ||
                        id.startsWith('s_n_') || id.startsWith('s_k_') || id.startsWith('s_n_k_') || id.startsWith('s_s_') || id.startsWith('s_s_p_') ||
                        id.startsWith('f_n_') || id.startsWith('f_k_') || id.startsWith('f_n_k_') || id.startsWith('f_s_') || id.startsWith('f_s_p_') ||
                        id.startsWith('qn') || id.startsWith('sn') || id.startsWith('fn') || // Fallback old IDs
                        id.startsWith('winner_') || id.startsWith('nama_juara_') || id.startsWith('kontingen_juara_');
                };

                if (placeholders.includes(text) || headerIds.includes(id) || isParticipantId(id)) {
                    el.textContent = "";
                }
            });
        }

        /**
         * DYNAMIC LAYOUT ENGINE
         * Mengatur visibilitas komponen bagan secara cerdas.
         */
        /**
         * SMART PATH VISIBILITY ENGINE
         * Menghitung dan menampilkan hanya jalur pertandingan yang relevan dari titik mulai peserta.
         */
        function applyBracketMapping(mapping) {
            if (!svgDoc || !mapping) return;

            const visibleSlots = new Set();

            // 1. Hitung Jalur Hilir (Downstream Path) untuk setiap peserta
            Object.values(mapping).forEach(startId => {
                if (!startId) return;

                let current = startId;
                visibleSlots.add(current);

                // Jalur ke Kualifikasi (Q)
                if (current.startsWith('p_n_')) {
                    let x = parseInt(current.replace('p_n_', ''));
                    current = 'qn' + Math.ceil(x / 2);
                    visibleSlots.add(current);
                }
                // Jalur ke Semi Final (S)
                if (current.startsWith('qn')) {
                    let x = parseInt(current.replace('qn', ''));
                    current = 'sn' + Math.ceil(x / 2);
                    visibleSlots.add(current);
                }
                // Jalur ke Final (F)
                if (typeof current === 'string' && current.startsWith('sn')) {
                    let x = parseInt(current.replace('sn', ''));
                    current = 'fn' + (x <= 2 ? '1' : '2');
                    visibleSlots.add(current);
                }
            });

            // 2. Terapkan Visibilitas ke seluruh SVG berdasarkan Logical Slots
            // Reset semua (Sembunyikan)
            toggleAllLogicalSlots(false);

            // Tampilkan yang masuk dalam path
            visibleSlots.forEach(slotId => {
                const componentIds = getComponentsForSlot(slotId);
                componentIds.forEach(id => toggleSVG(id, true));
            });
        }

        function getComponentsForSlot(slotId) {
            // P Round (Penyisihan 16 Besar)
            if (slotId.startsWith('p_n_')) {
                const x = slotId.replace('p_n_', '');
                return [`p_n_${x}`, `p_k_${x}`, `n_k_${x}`, `s_${x}`, `sp_${x}`];
            }
            // Q Round (8 Besar)
            if (slotId.startsWith('qn')) {
                const x = slotId.replace('qn', '');
                return [`q_n_${x}`, `q_k_${x}`, `q_n_k_${x}`, `q_s_${x}`, `q_s_p_${x}`];
            }
            // S Round (Semi Final)
            if (slotId.startsWith('sn')) {
                const x = slotId.replace('sn', '');
                return [`s_n_${x}`, `s_k_${x}`, `s_n_k_${x}`, `s_s_${x}`, `s_s_p_${x}`];
            }
            // F Round (Final)
            if (slotId.startsWith('fn')) {
                const x = slotId.replace('fn', '');
                return [`f_n_${x}`, `f_k_${x}`, `f_n_k_${x}`, `f_s_${x}`, `f_s_p_${x}`];
            }

            // Juara 1 (Final Result Center / Highlit)
            if (slotId === 'winner_nama') {
                return [`winner_nama`, `winner_kontingen`, `nama_juara_1`, `kontingen_juara_1`];
            }

            return [];
        }

        function toggleAllLogicalSlots(active) {
            for (let i = 1; i <= 16; i++) {
                getComponentsForSlot(`p_n_${i}`).forEach(id => toggleSVG(id, active));
                if (i <= 8) getComponentsForSlot(`qn${i}`).forEach(id => toggleSVG(id, active));
                if (i <= 4) getComponentsForSlot(`sn${i}`).forEach(id => toggleSVG(id, active));
                if (i <= 2) getComponentsForSlot(`fn${i}`).forEach(id => toggleSVG(id, active));
            }
        }

        function toggleSVG(id, active) {
            const el = svgDoc.getElementById(id);
            if (el) {
                el.style.opacity = active ? "1" : "0";
                el.style.pointerEvents = active ? "auto" : "none";
                console.log(`    ${active ? 'âœ…' : 'âŒ'} #${id} opacity=${el.style.opacity}`);
            } else {
                console.warn(`    âš ï¸ Element #${id} not found in SVG!`);
            }
        }

        async function loadSVG() {
            const visualArea = document.getElementById('bracketVisualArea');
            try {
                const response = await fetch('assets/Master.svg');
                if (!response.ok) throw new Error('File not found');
                const svgText = await response.text();
                visualArea.innerHTML = svgText;
                svgDoc = visualArea.querySelector('svg');

                if (svgDoc) {
                    svgDoc.style.display = 'block';
                    svgDoc.style.margin = 'auto';

                    // Ukuran normal untuk browser (tidak ada scrolling)
                    svgDoc.style.width = '1000px';
                    svgDoc.style.height = '620px';
                    svgDoc.setAttribute('preserveAspectRatio', 'xMidYMid meet');
                }

                setupSVGInteractivity();
                cleanSVGPlaceholders();
                syncHeadersToSVG();

                // After SVG is ready, try to load saved state
                // Moved fetchSavedBracket to loadAthletesForClass
            } catch (error) {
                console.error('Error loading SVG:', error);
                visualArea.innerHTML = '<p class="text-red-400 font-bold text-xs uppercase text-center mt-10">Gagal memuat file assets/Master.svg.<br>Harap pastikan file tersebut ada di folder assets.</p>';
            }
        }

        function setupSVGInteractivity() {
            if (!svgDoc) return;

            // List of all logical slots to bind
            const logicalPrefixes = ['p_n_', 'qn', 'sn', 'fn'];
            const maxCounts = { 'p_n_': 16, 'qn': 8, 'sn': 4, 'fn': 2 };

            logicalPrefixes.forEach(prefix => {
                for (let i = 1; i <= maxCounts[prefix]; i++) {
                    const logicalId = `${prefix}${i}`;
                    const components = getComponentsForSlot(logicalId);
                    const nameId = components[0];

                    if (nameId) {
                        const textEl = svgDoc.getElementById(nameId);
                        if (textEl) {
                            textEl.style.cursor = 'pointer';
                            textEl.addEventListener('click', () => handleWinnerClick(logicalId));

                            textEl.addEventListener('mouseenter', () => {
                                const content = textEl.textContent.trim();
                                if (content !== "" && content !== "-") {
                                    textEl.style.filter = 'brightness(1.5)';
                                    textEl.style.transition = 'all 0.2s ease';
                                }
                            });
                            textEl.addEventListener('mouseleave', () => {
                                textEl.style.filter = 'none';
                            });
                        }
                    }
                }
            });
        }

        function handleWinnerClick(id) {
            // Normalize ID
            const logicalId = getLogicalIdFromSVGId(id);
            if (!logicalId) return;

            const components = getComponentsForSlot(logicalId);
            const nameId = components[0];
            const teamId = components[1];

            const el = svgDoc ? svgDoc.getElementById(nameId) : document.getElementById(nameId);
            if (!el) return;
            const name = el.textContent.trim();
            if (name === "" || name === "-") return;

            // Find current Team name
            let teamName = "-";
            if (teamId) {
                const teamEl = svgDoc ? svgDoc.getElementById(teamId) : document.getElementById(teamId);
                if (teamEl) teamName = teamEl.textContent.trim();
            }

            const targetId = getNextSlot(logicalId);
            if (targetId) {
                const targetComponents = getComponentsForSlot(targetId);

                // Propagate to all relevant target name slots (could be multiple e.g. winner + podium)
                targetComponents.forEach((comp, index) => {
                    const targetEl = svgDoc ? svgDoc.getElementById(comp) : document.getElementById(comp);
                    if (!targetEl) return;

                    const tspan = targetEl.querySelector('tspan') || targetEl;

                    // index 0 and 2 are usually names, 1 and 3 are kontingen in winner_nama mapping
                    if (targetId === 'winner_nama') {
                        if (index === 0 || index === 2) {
                            tspan.textContent = name;
                            targetEl.setAttribute('fill', '#f87171');
                        } else if (index === 1 || index === 3) {
                            tspan.textContent = teamName;
                            targetEl.setAttribute('fill', '#f87171');
                        }
                    } else {
                        // Standard round progression
                        if (index === 0) {
                            tspan.textContent = name;
                            targetEl.setAttribute('fill', '#f87171');
                        } else if (index === 1) {
                            tspan.textContent = teamName;
                        }
                    }
                    targetEl.style.opacity = "1";
                });
            }
        }

        async function handleExcelUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];

                // Convert to JSON
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                // Extract names from first column
                let namesFromExcel = jsonData
                    .map(row => row[0]) // First column
                    .filter(cell => cell && cell.toString().trim() !== ""); // Filter empty

                // Optional: Skip header if it looks like a label
                if (namesFromExcel.length > 0) {
                    const first = namesFromExcel[0].toString().toLowerCase();
                    if (first.includes("nama") || first.includes("name") || first.includes("peserta")) {
                        namesFromExcel.shift();
                    }
                }

                if (namesFromExcel.length === 0) {
                    alert("Tidak ada data nama yang ditemukan di kolom pertama Excel.");
                    return;
                }

                // Limit to 16 and set count
                const count = Math.min(namesFromExcel.length, 16);
                document.getElementById('participantCount').value = count;
                document.getElementById('manualNames').value = namesFromExcel.slice(0, 16).join('\n');

                // Trigger generation
                await generateBracket();
            };
            reader.readAsArrayBuffer(file);
        }

        function resetBracket() {
            document.getElementById('participantCount').value = 8;
            document.getElementById('manualNames').value = '';
            document.getElementById('excelFile').value = ''; // Clear file input
            participants = [];
            window.isBracketDrawn = false;
            window.festivalResults = {}; // Clear festival results on reset
            generateBracket();
        }

        const GOLDEN_PRESETS = {
            2: ['fn1', 'fn2'],
            3: ['sn3', 'sn4', 'fn1'],
            4: ['sn1', 'sn2', 'sn3', 'sn4'],
            5: ['qn7', 'qn8', 'sn1', 'sn2', 'sn3'],
            6: ['qn3', 'qn4', 'qn7', 'qn8', 'sn1', 'sn3'],
            7: ['qn3', 'qn4', 'qn5', 'qn6', 'qn7', 'qn8', 'sn1'],
            8: ['qn1', 'qn2', 'qn3', 'qn4', 'qn5', 'qn6', 'qn7', 'qn8'],
            9: ['p_n_15', 'p_n_16', 'qn1', 'qn2', 'qn3', 'qn4', 'qn5', 'qn6', 'qn7'],
            10: ['p_n_7', 'p_n_8', 'p_n_15', 'p_n_16', 'qn1', 'qn2', 'qn3', 'qn5', 'qn6', 'qn7'],
            11: ['p_n_7', 'p_n_8', 'p_n_11', 'p_n_12', 'p_n_15', 'p_n_16', 'qn1', 'qn2', 'qn3', 'qn5', 'qn7'],
            12: ['p_n_3', 'p_n_4', 'p_n_7', 'p_n_8', 'p_n_11', 'p_n_12', 'p_n_15', 'p_n_16', 'qn1', 'qn3', 'qn5', 'qn7'],
            13: ['p_n_3', 'p_n_4', 'p_n_7', 'p_n_8', 'p_n_11', 'p_n_12', 'p_n_13', 'p_n_14', 'p_n_15', 'p_n_16', 'qn1', 'qn3', 'qn5'],
            14: ['p_n_3', 'p_n_4', 'p_n_5', 'p_n_6', 'p_n_7', 'p_n_8', 'p_n_11', 'p_n_12', 'p_n_13', 'p_n_14', 'p_n_15', 'p_n_16', 'qn1', 'qn5'],
            15: ['p_n_3', 'p_n_4', 'p_n_5', 'p_n_6', 'p_n_7', 'p_n_8', 'p_n_9', 'p_n_10', 'p_n_11', 'p_n_12', 'p_n_13', 'p_n_14', 'p_n_15', 'p_n_16', 'qn1'],
            16: ['p_n_1', 'p_n_2', 'p_n_3', 'p_n_4', 'p_n_5', 'p_n_6', 'p_n_7', 'p_n_8', 'p_n_9', 'p_n_10', 'p_n_11', 'p_n_12', 'p_n_13', 'p_n_14', 'p_n_15', 'p_n_16']
        };

        window.setFestivalWinner = (matchIdx, side) => {
            if (!window.festivalResults) window.festivalResults = {};
            if (window.festivalResults[matchIdx] === side) {
                // If already selected, deselect
                delete window.festivalResults[matchIdx];
            } else {
                window.festivalResults[matchIdx] = side;
            }
            renderFestivalTable();
        };

        function renderFestivalTable() {
            const visualArea = document.getElementById('bracketVisualArea');
            if (!visualArea) return;

            // Sync Textarea with participants first
            document.getElementById('manualNames').value = participants.map((p, i) => `${i + 1}. ${p.name} [${p.team}]`).join('\n');
            renderAthleteList();

            const groups = {};
            participants.forEach(p => {
                const t = p.team || "-";
                if (!groups[t]) groups[t] = [];
                groups[t].push(p);
            });
            const totalAthletes = participants.length;

            let html = `
                <div class="w-full h-full p-8 overflow-y-auto custom-scrollbar bg-white text-slate-900">
                    <table class="w-full text-left border-collapse border-[3px] border-slate-900">
                        <thead class="bg-slate-900 text-[9px] font-black uppercase tracking-widest text-white">
                            <tr>
                                <th class="p-4 text-center border-2 border-slate-700 w-24">HASIL AKA</th>
                                <th class="p-4 text-center border-2 border-slate-700 bg-red-600">PESERTA (AKA)</th>
                                <th class="p-4 text-center border-2 border-slate-700 bg-red-600">KONTINGEN</th>
                                <th class="p-4 text-center border-2 border-slate-700 bg-red-600 w-16">AKSI</th>
                                <th class="p-4 text-center border-2 border-slate-700 w-12 bg-slate-800">VS</th>
                                <th class="p-4 text-center border-2 border-slate-700 bg-blue-600 w-16">AKSI</th>
                                <th class="p-4 text-center border-2 border-slate-700 bg-blue-600">PESERTA (AO)</th>
                                <th class="p-4 text-center border-2 border-slate-700 bg-blue-600">KONTINGEN</th>
                                <th class="p-4 text-center border-2 border-slate-700 w-24">HASIL AO</th>
                            </tr>
                        </thead>
                        <tbody class="text-slate-900 font-black italic uppercase text-[10px]">
            `;

            for (let i = 0; i < participants.length; i += 2) {
                const matchIdx = i / 2;
                const aka = participants[i];
                const ao = participants[i + 1];
                const winnerSide = (window.festivalResults || {})[matchIdx]; // 'aka' or 'ao'

                // Smart Alert Logic
                const isSameTeam = ao && aka.team === ao.team && aka.team !== "-";
                const isForced = isSameTeam && (groups[aka.team].length > Math.ceil(totalAthletes / 2));
                const showAlert = isSameTeam && !isForced;

                const rowStyle = showAlert ? 'background: #fee2e2; border: 3px solid #ef4444;' : '';
                const alertBanner = showAlert ? `<div style="color: #ef4444; font-size: 8px; font-weight: 900; margin-top: 4px;">âš ï¸ SESAMA TIM (BISA DIPISAH)</div>` : '';

                // Result Badges
                let akaResult = `<div class="text-slate-300 opacity-20">. . .</div>`;
                let aoResult = `<div class="text-slate-300 opacity-20">. . .</div>`;

                if (winnerSide === 'aka') {
                    akaResult = `<div class="px-2 py-1 bg-yellow-400 text-black text-[8px] font-black rounded shadow-sm">JUARA 1</div>`;
                    aoResult = `<div class="px-2 py-1 bg-slate-200 text-slate-600 text-[8px] font-black rounded">JUARA 2</div>`;
                } else if (winnerSide === 'ao') {
                    aoResult = `<div class="px-2 py-1 bg-yellow-400 text-black text-[8px] font-black rounded shadow-sm">JUARA 1</div>`;
                    akaResult = `<div class="px-2 py-1 bg-slate-200 text-slate-600 text-[8px] font-black rounded">JUARA 2</div>`;
                }

                html += `
                    <tr class="border-b-2 border-slate-900 hover:bg-slate-50 transition-colors" style="${rowStyle}">
                        <td class="p-4 text-center border-r-2 border-slate-900">
                            ${akaResult}
                        </td>
                        <td class="p-4 text-red-600 border-r-2 border-slate-900">
                            ${document.getElementById('useShortName')?.checked ? shortenName(aka.name) : aka.name}
                            ${alertBanner}
                        </td>
                        <td class="p-4 text-slate-500 border-r-2 border-slate-900">${aka.team || '-'}</td>
                        <td class="p-4 text-center border-r-2 border-slate-900">
                             <button onclick="window.setFestivalWinner(${matchIdx}, 'aka')" class="w-8 h-8 rounded ${winnerSide === 'aka' ? 'bg-red-600 text-white shadow-lg scale-110' : 'bg-slate-100 text-slate-400 hover:bg-red-500 hover:text-white'} transition-all text-[10px] font-black">W</button>
                        </td>
                        <td class="p-4 text-center font-black bg-slate-100 border-r-2 border-slate-900">VS</td>
                        <td class="p-4 text-center border-r-2 border-slate-900">
                             <button onclick="window.setFestivalWinner(${matchIdx}, 'ao')" class="w-8 h-8 rounded ${winnerSide === 'ao' ? 'bg-blue-600 text-white shadow-lg scale-110' : 'bg-slate-100 text-slate-400 hover:bg-blue-500 hover:text-white'} transition-all text-[10px] font-black">W</button>
                        </td>
                        <td class="p-4 text-blue-600 border-r-2 border-slate-900 text-right">${ao ? (document.getElementById('useShortName')?.checked ? shortenName(ao.name) : ao.name) : 'BYE'}</td>
                        <td class="p-4 text-slate-500 border-r-2 border-slate-900 text-right">${ao ? ao.team : '-'}</td>
                        <td class="p-4 text-center">
                            ${aoResult}
                        </td>
                    </tr>
                `;
            }

            html += `</tbody></table></div>`;
            visualArea.innerHTML = html;
        }

        async function generateBracket() {
            const count = parseInt(document.getElementById('participantCount').value);
            const isFestival = (currentClassCode || "").toString().toUpperCase().startsWith('F');

            const visualArea = document.getElementById('bracketVisualArea');
            if (isFestival) {
                renderFestivalTable();
                return;
            }

            if (count < 2 || count > 16) return;

            console.log(`\ud83d\udc68\u200d\ud83d\udcbb generateBracket called:`, {
                participantsLength: participants.length,
                participantCountInput: count,
                isBracketDrawn: window.isBracketDrawn
            });

            // Get names from textarea OR use the already populated global participants
            const manualInput = document.getElementById('manualNames').value.trim();
            if (manualInput && (!participants || participants.length === 0 || manualInput.split('\n').length !== participants.length)) {
                // Parser Cerdas: Mengabaikan '1. ' dan menangkap 'NAMA [TEAM]'
                // Versi Tangguh: mendukung spasi maupun tanpa spasi sebelum '['
                const parsed = manualInput.split('\n').filter(n => n.trim() !== '').map(lineTxt => {
                    const line = lineTxt.trim();
                    // Regex Baru: mendukung opsional nomor di awal, nama, dan opsional [team] tanpa haris spasi kaku
                    const match = line.match(/^(?:\d+\.\s*)?([^\[\]]+)(?:\s*\[(.*)\])?$/);
                    if (match) {
                        return {
                            name: match[1].trim(),
                            team: match[2] ? match[2].trim() : "-"
                        };
                    }
                    return { name: line.trim(), team: "-" };
                });
                if (parsed.length > 0) participants = parsed.slice(0, count);
            }

            // Sync Nomor kembali ke Textarea agar admin tahu urutan realnya
            document.getElementById('manualNames').value = participants.map((p, i) => `${i + 1}. ${p.name} [${p.team}]`).join('\n');

            renderAthleteList();

            if (!svgDoc) {
                await loadSVG();
            }
            if (!svgDoc) return;

            // Update bracket title with event/category
            const categorySelect = document.querySelector('select');
            const categoryName = categorySelect.options[categorySelect.selectedIndex].text;
            const categoryLabel = document.getElementById('bracketCategoryLabel');
            if (categoryLabel) categoryLabel.textContent = categoryName;

            currentClass = categoryName;

            // 1. Ambil Pola Emas berdasarkan jumlah peserta
            const pattern = GOLDEN_PRESETS[participants.length] || [];
            console.log(`ðŸ“Š Pattern for ${participants.length} participants:`, pattern);

            // 2. Reset All Visuals
            toggleAllLogicalSlots(false);
            console.log(`ðŸ”’ All slots hidden`);

            // 2.1 Sync Headers (Event Name & Class Name) back to SVG
            syncHeadersToSVG();

            // 3. Create Mapping & Apply Path Visibility
            const mapping = {};
            pattern.forEach((slotId, i) => {
                if (participants[i]) mapping[i + 1] = slotId;
            });

            // Make mapped slots visible
            console.log(`ðŸ”“ Making ${Object.keys(mapping).length} slots visible:`);
            Object.values(mapping).forEach(slotId => {
                console.log(`  ðŸ‘ï¸ Showing slot: ${slotId}`);
                const components = getComponentsForSlot(slotId);
                components.forEach(id => toggleSVG(id, true));
            });

            // 4. Hitung Penomoran Visual (Berdasarkan urutan Kiri-ke-Kanan, Atas-ke-Bawah)
            const getSlotPriority = (id) => {
                if (id.startsWith('p_n_')) return 100 + parseInt(id.replace('p_n_', ''));
                if (id.startsWith('qn')) return 200 + parseInt(id.replace('qn', ''));
                if (id.startsWith('sn')) return 300 + parseInt(id.replace('sn', ''));
                if (id === 'fn1') return 401;
                if (id === 'fn2') return 402;
                return 999;
            };

            const activeSlots = Object.entries(mapping).sort((a, b) => getSlotPriority(a[1]) - getSlotPriority(b[1]));
            window.currentActiveSlots = activeSlots; // For mapping table

            // 5. Fill Participant Names & Kontingen to SVG (ONLY IF DRAWN)
            if (window.isBracketDrawn) {
                console.log(`ðŸŽ¨ Filling ${activeSlots.length} slots with participant names...`);
                activeSlots.forEach(([idx, slotId], displayIndex) => {
                    const athlete = participants[idx - 1];
                    if (!athlete) return;

                    const componentIds = getComponentsForSlot(slotId);
                    const nameId = componentIds[0];
                    const teamId = componentIds[1];

                    // Fill Name
                    const nameEl = svgDoc.getElementById(nameId);
                    if (nameEl) {
                        const tspan = nameEl.querySelector('tspan') || nameEl;
                        const useShort = document.getElementById('useShortName')?.checked;
                        const displayName = useShort ? shortenName(athlete.name) : athlete.name;
                        tspan.textContent = displayName;
                        nameEl.style.opacity = "1";
                        console.log(`  âœï¸ [${slotId}] Filled name: "${athlete.name}" â†’ #${nameId}`);
                    } else {
                        console.warn(`âŒ Name element not found: ${nameId}`);
                    }

                    // Fill Team/Kontingen
                    const teamEl = svgDoc.getElementById(teamId);
                    if (teamEl) {
                        const tspan = teamEl.querySelector('tspan') || teamEl;
                        tspan.textContent = athlete.team;
                        teamEl.style.opacity = "1";
                        console.log(`  âœï¸ [${slotId}] Filled team: "${athlete.team}" â†’ #${teamId}`);
                    }
                });

                // 6. Apply Current Font Sizes
                updateBracketTextSizes();
            } else {
                console.log(`â¸ï¸ Skipping name fill (isBracketDrawn = false)`);
            }
        }

        async function saveBracket() {
            if (!currentClass || !eventId) return;

            const btn = document.getElementById('btnSaveBracket');
            const label = document.getElementById('saveStatus');
            btn.disabled = true;
            label.innerText = "MENYIMPAN... â³";

            // Extract all data from SVG - AUTOMATIC CAPTURE
            const bracketData = {};

            if (svgDoc) {
                // Capture ALL text elements automatically
                const allTextElements = svgDoc.querySelectorAll('text');
                allTextElements.forEach(el => {
                    const id = el.id;
                    if (id && id.trim() !== '') {
                        const tspan = el.querySelector('tspan') || el;
                        const val = tspan.textContent.trim();
                        if (val !== "" && val !== "-") {
                            bracketData[id] = val;
                        }
                    }
                });
            }

            const isFestival = (currentClassCode || "").toString().toUpperCase().startsWith('F');

            console.log("Saving bracket data:", {
                eventId,
                currentClass,
                participantsCount: participants.length,
                bracketDataKeys: Object.keys(bracketData).length,
                isDrawn: window.isBracketDrawn,
                isFestival: isFestival,
                festivalResultsKeys: isFestival ? Object.keys(window.festivalResults || {}).length : 0
            });

            // Validation: Prevent saving empty brackets
            if (!isFestival && !window.isBracketDrawn) {
                label.innerText = "GAGAL âŒ";
                btn.disabled = false;
                alert("âš ï¸ Bracket belum di-generate!\n\nSilakan klik tombol SMART DRAW terlebih dahulu untuk mengisi nama peserta ke dalam bagan.");
                return;
            }

            if (!isFestival && Object.keys(bracketData).length < 5) {
                label.innerText = "GAGAL âŒ";
                btn.disabled = false;
                alert("âš ï¸ Data bracket terlalu sedikit!\n\nPastikan:\n1. Tombol SMART DRAW sudah ditekan\n2. Nama peserta muncul di bagan\n3. Baru klik SIMPAN & SELESAI");
                return;
            }

            try {
                const docId = currentClassCode || currentClass;
                const path = `events/${eventId}/brackets/${docId}`;

                const dataToSave = {
                    class: currentClass,
                    data: bracketData,
                    participants: participants,
                    athleteCount: participants.length, // Store athlete count for revision monitoring
                    isDrawn: window.isBracketDrawn,
                    status: 'complete',  // Track bracket completion status
                    lastModified: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                if (isFestival) {
                    dataToSave.festivalResults = window.festivalResults || {};
                }

                await setDoc(doc(db, `events/${eventId}/brackets`, docId), dataToSave);

                console.log("âœ… Save successful:", path);
                label.innerText = "TERSIMPAN! âœ…";
                setTimeout(() => { label.innerText = "SIMPAN & SELESAI"; }, 2000);
            } catch (err) {
                console.error("âŒ Save failed:", err);
                alert("Gagal menyimpan bagan: " + err.message);
                label.innerText = "GAGAL SIMPAN âŒ";
            } finally {
                btn.disabled = false;
            }
        }

        async function fetchSavedBracket(className) {
            if (!eventId || !className || !svgDoc) return;

            // Try fetching by classCode first, fallback to className
            const docId = currentClassCode || className;
            let snap = await getDoc(doc(db, `events/${eventId}/brackets`, docId));

            if (!snap.exists() && currentClassCode) {
                // Try legacy className fallback
                snap = await getDoc(doc(db, `events/${eventId}/brackets`, className));
            }

            if (snap.exists()) {
                const cloudData = snap.data();
                const saved = cloudData.data;
                const cloudParticipants = cloudData.participants;
                const cloudIsDrawn = cloudData.isDrawn;
                const isFestival = (className || "").toString().toUpperCase().startsWith('F');

                console.log(`â˜ï¸ Cloud data found for "${className}":`, {
                    participantsCount: cloudParticipants?.length || 0,
                    isDrawn: cloudIsDrawn,
                    svgKeysCount: Object.keys(saved || {}).length,
                    isFestival: isFestival,
                    festivalResultsKeys: isFestival ? Object.keys(cloudData.festivalResults || {}).length : 0
                });

                // Restore festival results if any
                if (isFestival) {
                    window.festivalResults = cloudData.festivalResults || {};
                }

                // 1. Data Integrity Check: Compare Saved with Current Athletes
                const currentAthletes = [...participants]; // 'participants' here is from loadEventContext (latest athletes)
                const savedParticipants = cloudParticipants || [];

                let isDataValid = true;
                if (savedParticipants.length !== currentAthletes.length) {
                    isDataValid = false;
                } else {
                    // Cek detail nama & team
                    const currentKeys = currentAthletes.map(a => `${a.name}|${a.team}`).sort();
                    const savedKeys = savedParticipants.map(a => `${a.name}|${a.team}`).sort();
                    if (JSON.stringify(currentKeys) !== JSON.stringify(savedKeys)) {
                        isDataValid = false;
                    }
                }

                if (!isDataValid) {
                    console.warn("âš ï¸ Data mismatch detected! Saved bracket is outdated.");
                    window.isBracketDrawn = false;
                    // Keep participants from loadEventContext
                } else {
                    // Restore exact order from cloud if valid
                    participants = savedParticipants;
                    window.isBracketDrawn = cloudIsDrawn || false;
                    console.log(`âœ… Restored ${participants.length} participants from cloud (Data Valid)`);
                }

                // Update UI state based on validation
                document.getElementById('manualNames').value = participants.map((p, i) => `${i + 1}. ${p.name} [${p.team}]`).join('\n');
                document.getElementById('participantCount').value = participants.length;

                if (participants.length > 0 && participants[0].members) {
                    renderMagicTeams(participants);
                }

                renderAthleteList();

                if (!isDataValid && window.isBracketDrawn === false) {
                    const label = document.getElementById('saveStatus');
                    if (label) {
                        label.innerText = "âš ï¸ PERLU REVISI";
                        label.classList.add('text-red-500');
                    }
                    console.log("Setting REVISI status for outdated bracket");
                }

                // 2. ALWAYS Redraw if we found cloud data to ensure names are filled
                await generateBracket();

                // 3. Restore ALL SVG Text from cloud (scores, winners, etc.)
                if (saved && svgDoc) {
                    console.log(`ðŸ“¥ Restoring ${Object.keys(saved).length} SVG elements from cloud:`);
                    Object.entries(saved).forEach(([id, text]) => {
                        // Support both Logical and SVG IDs in storage
                        const logicalId = getLogicalIdFromSVGId(id) || id;
                        const components = getComponentsForSlot(logicalId);
                        const targetId = (components && components.length > 0) ? components[0] : id;

                        const el = svgDoc.getElementById(targetId);
                        if (el) {
                            const tspan = el.querySelector('tspan') || el;
                            tspan.textContent = text;
                            el.style.opacity = "1";
                            console.log(`  ðŸ“ #${targetId} (via ${id}) â† "${text}"`);
                            // Highlight winners
                            if (!targetId.startsWith('p_') && !targetId.startsWith('qn') && !targetId.startsWith('Nama_') && !targetId.startsWith('Kelas_') && !targetId.startsWith('tanggal') && !targetId.startsWith('durasi') && !targetId.startsWith('tatami') && !targetId.startsWith('pool')) {
                                el.setAttribute('fill', '#f87171');
                            }
                        } else {
                            console.warn(`  âš ï¸ Element #${targetId} (from ${id}) not found in SVG`);
                        }
                    });
                    console.log(`âœ… Restored ${Object.keys(saved).length} SVG text elements`);
                }

                const label = document.getElementById('saveStatus');
                if (label) label.innerText = "LOADED FROM CLOUD â˜ï¸";
                setTimeout(() => { if (label) label.innerText = "SIMPAN & SELESAI"; }, 2000);
            } else {
                console.log(`â„¹ï¸ No cloud data for "${className}"`);
            }
        }

        async function exportToPremium(format = 'pdf', event) {
            const area = document.getElementById('bracketVisualArea');
            if (!area) {
                alert("Data bagan belum siap.");
                return;
            }

            const isFestival = (currentClassCode || "").toString().toUpperCase().startsWith('F');

            // Gunakan event.currentTarget agar lebih aman (elemen button itu sendiri)
            const btn = (event && (event.currentTarget || event.target)) || null;
            const originalText = btn ? btn.innerHTML : "EXPORT";

            if (btn) {
                btn.innerHTML = "PREPARING... â³";
                btn.disabled = true;
            }

            // Simpan status class asli
            const originalClasses = area.className;
            const originalStyle = area.getAttribute('style');

            try {
                if (isFestival) {
                    // Optimized for Festival Table Capture
                    area.classList.remove('w-full', 'h-full', 'flex', 'items-center', 'justify-center');
                    area.style.width = '1200px'; // Wide enough for the table
                    area.style.height = 'auto';
                    area.style.display = 'block';
                    area.style.background = '#ffffff';
                } else {
                    // TRIK 'Shrink-to-Fit' for SVG
                    area.classList.remove('w-full', 'h-full', 'flex', 'items-center', 'justify-center');
                    area.style.display = 'inline-block';
                    area.style.width = 'auto';
                    area.style.height = 'auto';
                }

                const capture = await html2canvas(area, {
                    backgroundColor: '#ffffff',
                    scale: 3,
                    useCORS: true,
                    logging: false
                });

                const imgData = capture.toDataURL('image/png');

                if (format === 'pdf') {
                    const { jsPDF } = window.jspdf;
                    const pdfWidthMm = 330; // F4 Width (Landscape roughly)
                    const pdfHeightMm = 210;
                    const pdf = new jsPDF('l', 'mm', [pdfWidthMm, pdfHeightMm]);

                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidthMm, pdfHeightMm);
                    pdf.save(`Kensho_Bagan_${currentClass}_${new Date().getTime()}.pdf`);
                }

            } catch (err) {
                console.error("Export failed:", err);
                alert("Gagal ekspor: " + (err ? (err.message || err.toString()) : "Unknown Error"));
            } finally {
                // Kembalikan tampilan browser ke semula
                area.className = originalClasses;
                if (originalStyle) area.setAttribute('style', originalStyle);
                else area.removeAttribute('style');

                if (btn) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        }

        window.handlePreviewFestival = async () => {
            const btn = document.getElementById('btnPreviewFestival');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = 'GATHERING DATA... â³';
            btn.disabled = true;

            try {
                // 1. Get All Festival Classes
                const qClasses = query(collection(db, `events/${eventId}/classes`), orderBy("code", "asc"));
                const classSnap = await getDocs(qClasses);
                const allFestivalClasses = [];
                classSnap.forEach(s => {
                    const d = s.data();
                    if ((d.code || "").toString().toUpperCase().startsWith('F')) {
                        allFestivalClasses.push(d);
                    }
                });

                if (allFestivalClasses.length === 0) {
                    alert("Tidak ada kelas Festival yang ditemukan.");
                    return;
                }

                // 2. Get All Athletes for the event (to ensure we have data for all classes)
                const qAthletes = query(collection(db, `events/${eventId}/athletes`));
                const athleteSnap = await getDocs(qAthletes);
                const allAthletes = [];
                athleteSnap.forEach(s => allAthletes.push(s.data()));

                // 3. Get All Saved Brackets
                const qBrackets = query(collection(db, `events/${eventId}/brackets`));
                const bracketSnap = await getDocs(qBrackets);
                const bracketsMap = {};
                bracketSnap.forEach(s => {
                    const d = s.data();
                    bracketsMap[d.class] = d;
                });

                // 4. Call Print Module
                const eventDoc = await getDoc(doc(db, "events", eventId));
                const eventData = eventDoc.data();

                prepareBracketPrint(allAthletes, allFestivalClasses, eventData.name, eventData.logo, bracketsMap);

            } catch (err) {
                console.error("Preview failed:", err);
                alert("Gagal memuat pratinjau: " + err.message);
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        };

        let selectedAthleteIndex = null;



        function smartDrawParticipants() {
            if (participants.length < 2) return;
            window.isBracketDrawn = true;

            const isFestival = (currentClassCode || "").toString().toUpperCase().startsWith('F');

            // 1. Group by Kontingen
            const groups = {};
            participants.forEach(p => {
                const t = p.team || "-";
                if (!groups[t]) groups[t] = [];
                groups[t].push(p);
            });

            if (isFestival) {
                // LOGIKA FESTIVAL: Priority Separation (Greedy Pairing)
                let newOrder = [];
                const sortedTeamNames = Object.keys(groups).sort((a, b) => groups[b].length - groups[a].length);

                // Copy members to work with them
                const teamQueues = {};
                sortedTeamNames.forEach(name => {
                    teamQueues[name] = [...groups[name]].sort(() => Math.random() - 0.5);
                });

                let pool = [];
                // Process largest team first against others
                const mainTeamName = sortedTeamNames[0];
                const mainQueue = teamQueues[mainTeamName];

                // Gather all other athletes
                let otherAthletes = [];
                for (let i = 1; i < sortedTeamNames.length; i++) {
                    otherAthletes = otherAthletes.concat(teamQueues[sortedTeamNames[i]]);
                }
                // Shuffle others to randomize pairings
                otherAthletes.sort(() => Math.random() - 0.5);

                // Pair Main Team with Others
                while (mainQueue.length > 0 && otherAthletes.length > 0) {
                    newOrder.push(mainQueue.pop());
                    newOrder.push(otherAthletes.shift());
                }

                // If main team still has athletes, they get BYE (paired with null)
                while (mainQueue.length > 0) {
                    newOrder.push(mainQueue.pop());
                    newOrder.push(null); // BYE
                }

                // If other teams still have athletes, pair them among themselves
                while (otherAthletes.length > 0) {
                    newOrder.push(otherAthletes.shift());
                    if (otherAthletes.length > 0) {
                        newOrder.push(otherAthletes.shift());
                    } else {
                        newOrder.push(null); // BYE
                    }
                }

                participants = newOrder.filter(p => p !== null);
            } else {
                // LOGIKA PRESTASI (Eksisting): Split Top & Bottom
                const total = participants.length;
                const mid = Math.floor(total / 2);

                let newOrder = new Array(total).fill(null);
                let topAvailable = Array.from({ length: mid }, (_, i) => i);
                let bottomAvailable = Array.from({ length: total - mid }, (_, i) => i + mid);

                const sortedTeams = Object.keys(groups).sort((a, b) => {
                    if (a === window.hostKontingen) return -1;
                    if (b === window.hostKontingen) return 1;
                    return groups[b].length - groups[a].length;
                });

                sortedTeams.forEach(team => {
                    const members = groups[team].sort(() => Math.random() - 0.5);
                    const toTopCount = Math.floor(members.length / 2);
                    const toBottomCount = members.length - toTopCount;

                    for (let i = 0; i < toTopCount; i++) {
                        if (topAvailable.length > 0) newOrder[topAvailable.shift()] = members.pop();
                        else if (bottomAvailable.length > 0) newOrder[bottomAvailable.shift()] = members.pop();
                    }
                    for (let i = 0; i < toBottomCount; i++) {
                        if (bottomAvailable.length > 0) newOrder[bottomAvailable.shift()] = members.pop();
                        else if (topAvailable.length > 0) newOrder[topAvailable.shift()] = members.pop();
                    }
                });
                participants = newOrder.filter(p => p !== null);
            }

            document.getElementById('manualNames').value = participants.map((a, i) => `${i + 1}. ${a.name} [${a.team}]`).join('\n');
            generateBracket();
        }

        function handleAthleteClick(index) {
            if (selectedAthleteIndex === null) {
                // First selection
                selectedAthleteIndex = index;
                renderAthleteList(); // Re-render to show active state
            } else {
                // Second selection - SWAP
                if (selectedAthleteIndex !== index) {
                    window.isBracketDrawn = true;
                    const temp = participants[selectedAthleteIndex];
                    participants[selectedAthleteIndex] = participants[index];
                    participants[index] = temp;

                    document.getElementById('manualNames').value = participants.map((a, i) => `${i + 1}. ${a.name} [${a.team}]`).join('\n');
                    generateBracket();
                }
                selectedAthleteIndex = null;
                renderAthleteList();
            }
        }

        function renderAthleteList() {
            const list = document.getElementById('athleteTags');
            const totalLabel = document.getElementById('athleteTotalLabel');
            if (!list || !totalLabel) return;

            list.innerHTML = '';
            totalLabel.innerText = `${participants.length} ATLET`;

            // Reset list container class for match-based layout
            list.className = "flex flex-col gap-4 max-h-[600px] overflow-y-auto p-2 custom-scrollbar";

            // Calculation for Conflict Detection
            const groups = {};
            participants.forEach(p => {
                const t = p.team || "-";
                if (!groups[t]) groups[t] = [];
                groups[t].push(p);
            });
            const totalAthletes = participants.length;

            for (let i = 0; i < participants.length; i += 2) {
                const matchIndex = Math.floor(i / 2) + 1;

                // Pair Logic
                const aka = participants[i];
                const ao = participants[i + 1];

                const isSameTeam = aka && ao && aka.team === ao.team && aka.team !== "-";
                const isForced = isSameTeam && (groups[aka.team].length > Math.ceil(totalAthletes / 2));
                const matchConflict = isSameTeam && !isForced;

                const matchDiv = document.createElement('div');
                matchDiv.className = `p-4 rounded-[2rem] border-2 transition-all ${matchConflict ? 'bg-red-50/50 border-red-200' : 'bg-slate-50/50 border-slate-100'} flex flex-col gap-3`;

                let html = `
                    <div class="flex justify-between items-center px-4">
                        <span class="text-[9px] font-black ${matchConflict ? 'text-red-500' : 'text-slate-400'} uppercase tracking-[0.3em]">PARTAI #${matchIndex} ${matchConflict ? 'âš ï¸ BENTROK KONTINGEN' : ''}</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                `;

                // Sub-function to render Card
                const getCardHTML = (idx, label, colorClass) => {
                    const athlete = participants[idx];
                    if (!athlete) return `<div class="p-4 border-2 border-dashed border-slate-200 rounded-2xl flex items-center justify-center text-[10px] font-black opacity-20 uppercase italic">BYE / KOSONG</div>`;

                    const isSelected = selectedAthleteIndex === idx;
                    let cardBorder = isSelected ? 'border-blue-500 shadow-lg scale-[1.02]' : 'border-slate-200';
                    let cardBg = isSelected ? 'bg-blue-50' : 'bg-white';

                    return `
                        <div onclick="window.handleAthleteClick(${idx})" class="p-4 rounded-2xl border-2 ${cardBorder} ${cardBg} cursor-pointer transition-all hover:border-blue-400 relative group">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-[8px] font-black ${colorClass} uppercase tracking-widest">${label}</span>
                                <span class="text-[10px] font-black text-slate-300 italic">#${(idx + 1).toString().padStart(2, '0')}</span>
                            </div>
                            <div class="text-[11px] font-black text-slate-800 uppercase italic truncate">${athlete.name}</div>
                            <div class="text-[9px] font-bold text-slate-400 uppercase tracking-widest truncate">${athlete.team}</div>
                        </div>
                    `;
                };

                html += `
                        <div class="relative">
                            ${getCardHTML(i, "AKA (MERAH)", "text-red-500")}
                        </div>
                        <div class="relative">
                            <div class="absolute -left-6 top-1/2 -translate-y-1/2 hidden md:flex w-8 h-8 rounded-full bg-slate-200 border-4 border-slate-50 items-center justify-center text-[8px] font-black text-slate-500 z-10">VS</div>
                            ${getCardHTML(i + 1, "AO (BIRU)", "text-blue-500")}
                        </div>
                    </div>
                `;

                matchDiv.innerHTML = html;
                list.appendChild(matchDiv);
            }
        }

        let currentStep2Tab = 'text';
        function switchStep2Tab(tab) {
            currentStep2Tab = tab;
            const textTab = document.getElementById('step2TabText');
            const visualTab = document.getElementById('step2TabVisual');
            const magicTab = document.getElementById('step2TabMagic');
            const textBtn = document.getElementById('tabBtnText');
            const visualBtn = document.getElementById('tabBtnVisual');
            const magicBtn = document.getElementById('tabBtnMagic');

            // Hide all tabs
            [textTab, visualTab, magicTab].forEach(t => t && (t.style.display = 'none'));

            // Reset all buttons style
            [textBtn, visualBtn, magicBtn].forEach(btn => {
                if (btn) {
                    btn.classList.remove('bg-white', 'text-blue-600', 'shadow-md');
                    btn.classList.add('text-slate-400');
                    btn.classList.remove('text-blue-600');
                }
            });

            if (tab === 'text') {
                textTab.style.display = 'block';
                textBtn.classList.add('bg-white', 'text-blue-600', 'shadow-md');
                textBtn.classList.remove('text-slate-400');
            } else if (tab === 'visual') {
                visualTab.style.display = 'block';
                visualBtn.classList.add('bg-white', 'text-blue-600', 'shadow-md');
                visualBtn.classList.remove('text-slate-400');
            } else if (tab === 'magic') {
                magicTab.style.display = 'block';
                magicBtn.classList.add('bg-white', 'text-blue-600', 'shadow-md');
                magicBtn.classList.remove('text-slate-400');
            }
        }

        function shortenName(fullName) {
            if (!fullName) return "";

            // Bersihkan nama dari spasi berlebih dan ubah ke UPPERCASE
            const name = fullName.trim().toUpperCase().replace(/\s+/g, ' ');
            const words = name.split(' ');

            if (words.length <= 1) return name;

            // Daftar prefiks yang umum disingkat
            const prefixes = ["MUHAMMAD", "MUHAMAD", "MUH", "MOCH", "MOH", "M"];
            let firstWord = words[0].replace(/\.$/, ''); // Hilangkan titik jika ada
            let isPrefix = prefixes.includes(firstWord);

            if (isPrefix) {
                // Aturan Prefiks: M + Kata Kedua Utuh + Sisanya Inisial
                // Contoh: M ADITYA PRASWORO -> M ADITYA P
                let result = "M";
                if (words.length >= 2) {
                    result += " " + words[1];
                }
                for (let i = 2; i < words.length; i++) {
                    const initial = words[i][0];
                    if (initial) result += " " + initial;
                }
                return result;
            } else {
                // Aturan Non-Prefiks: Kata Pertama Utuh + Sisanya Inisial
                // Contoh: ANANDA PUJANGGA RESTU PERTIWI -> ANANDA P R P
                let result = words[0];
                for (let i = 1; i < words.length; i++) {
                    const initial = words[i][0];
                    if (initial) result += " " + initial;
                }
                return result;
            }
        }

        function getFirstName(fullName) {
            if (!fullName) return "";
            // Ambil kata pertama, bersihkan dari angka atau simbol, dan ubah ke UPPERCASE
            return fullName.trim().split(' ')[0].split('-')[0].replace(/[^a-zA-Z]/g, '').toUpperCase();
        }

        window.groupAthletesByTeamMagic = () => {
            if (participants.length === 0) {
                alert("Tidak ada data atlet untuk diproses.");
                return;
            }

            // Group by Kontingen
            const groups = {};
            participants.forEach(p => {
                const t = p.team || "-";
                if (!groups[t]) groups[t] = [];
                groups[t].push(p);
            });

            const magicTeams = [];
            Object.keys(groups).forEach(teamName => {
                const members = groups[teamName];
                // Split into groups of 3
                for (let i = 0; i < members.length; i += 3) {
                    const chunk = members.slice(i, i + 3);
                    const teamNum = Math.floor(i / 3) + 1;

                    // Format: Team Dominores 1 - AFIF, RIZAL, RONAL
                    const namesStr = chunk.map(m => getFirstName(m.name)).join(', ');
                    const formattedTeamName = `TEAM ${teamName} ${teamNum} - ${namesStr}`;

                    magicTeams.push({
                        name: formattedTeamName,
                        team: teamName,
                        members: chunk
                    });
                }
            });

            // Update global participants with these teams
            participants = JSON.parse(JSON.stringify(magicTeams));
            window.isBracketDrawn = true; // Mark as drawn so names appear

            // Sync to textarea & UI
            document.getElementById('manualNames').value = participants.map((p, i) => `${i + 1}. ${p.name}`).join('\n');
            document.getElementById('participantCount').value = participants.length;

            renderMagicTeams(magicTeams);
            renderAthleteList();
            generateBracket();

            alert(`ðŸª„ Magic Berhasil! ${magicTeams.length} Tim telah terbentuk.`);
        };

        function renderMagicTeams(teams) {
            const container = document.getElementById('magicTeamList');
            if (!container) return;
            container.innerHTML = '';

            teams.forEach((t, i) => {
                const card = document.createElement('div');
                card.className = "neu-flat p-6 rounded-2xl border border-white/5 flex flex-col gap-3 group hover:border-blue-500/30 transition-all";
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <span class="text-[9px] font-black text-blue-500 uppercase tracking-widest">TIM #${i + 1}</span>
                        <span class="text-[8px] font-bold opacity-30 italic truncate max-w-[100px]">${t.team}</span>
                    </div>
                    <div class="text-sm font-black text-slate-200 leading-tight">${t.name}</div>
                    <div class="flex flex-wrap gap-2 mt-4">
                        ${t.members.map(m => `<span class="px-3 py-1.5 rounded-xl bg-white/5 text-[9px] font-black text-blue-400 uppercase tracking-widest border border-blue-500/10">${getFirstName(m.name)}</span>`).join('')}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updateBracketTextSizes() {
            const nameEl = document.getElementById('fontSizeName');
            const teamEl = document.getElementById('fontSizeTeam');
            if (!nameEl || !teamEl) return;

            const nameSize = nameEl.value;
            const teamSize = teamEl.value;

            document.getElementById('fontSizeNameVal').innerText = nameSize + "PX";
            document.getElementById('fontSizeTeamVal').innerText = teamSize + "PX";

            // Preview pada SVG
            const nodes = document.querySelectorAll('text');
            nodes.forEach(node => {
                const id = node.id || "";
                // Match qn1, q_n_1, p_n_1, etc.
                if (id.match(/^(([qsf]_?)?n_?|p_n_)\d+$/)) {
                    node.style.fontSize = nameSize + "px";
                }
                // Match qk1, q_k_1, p_k_1, etc.
                else if (id.match(/^(([qsf]_?)?k_?|p_k_)\d+$/)) {
                    node.style.fontSize = teamSize + "px";
                }
            });
        }

        // Export all functions to global scope (MUST be after all function definitions)
        window.loadSVG = loadSVG;
        window.setupSVGInteractivity = setupSVGInteractivity;
        window.generateBracket = generateBracket;
        window.handleWinnerClick = handleWinnerClick;
        window.handleExcelUpload = handleExcelUpload;
        window.resetBracket = resetBracket;
        window.saveBracket = saveBracket;
        window.fetchSavedBracket = fetchSavedBracket;
        window.exportToPremium = exportToPremium;
        window.smartDrawParticipants = smartDrawParticipants;
        window.handleAthleteClick = handleAthleteClick;
        window.renderAthleteList = renderAthleteList;
        window.switchStep2Tab = switchStep2Tab;
        window.updateBracketTextSizes = updateBracketTextSizes;
        window.groupAthletesByTeamMagic = groupAthletesByTeamMagic;
        window.renderMagicTeams = renderMagicTeams;

        // NOTE: Initial loading is handled by loadEventContext() 
        // which is called from the auth state listener below
        // DO NOT add window.onload handler here as it will conflict!

    </script>
</body>

</html>