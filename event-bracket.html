<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Bagan | Spartan Sport</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/window-controls.css">
    <style>
        :root {
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e5e7eb;
            --text: #0f172a;
            --muted: #6b7280;
            --accent: #2563eb;
        }

        .dark {
            --bg: #0f172a;
            --card: #111827;
            --border: #1f2937;
            --text: #e5e7eb;
            --muted: #9ca3af;
            --accent: #3b82f6;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Plus Jakarta Sans', sans-serif;
            transition: background .25s ease, color .25s ease;
        }

        .neu-flat {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 20px;
            transition: .25s ease;
        }

        .neu-inset {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 16px;
        }

        .neu-button {
            background: var(--card);
            border: 1px solid var(--border);
            transition: .2s ease;
            cursor: pointer;
            color: var(--text);
        }

        .neu-button:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        aside {
            background: var(--card) !important;
            border-right: 1px solid var(--border) !important;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }

        /* BRACKET VISUAL SYSTEM */
        .bracket-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            width: 100%;
            aspect-ratio: 1.57;
            padding: 20px;
            position: relative;
        }

        .bracket-round {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            height: 100%;
            position: relative;
        }

        .bracket-match {
            display: flex;
            flex-direction: column;
            position: relative;
            margin-bottom: 30px;
        }

        .bracket-node {
            width: 190px;
            padding: 12px 18px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            margin: 6px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            position: relative;
            z-index: 2;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .bracket-node:hover {
            transform: translateX(5px);
            border-color: var(--accent);
        }

        .bracket-node.winner {
            color: var(--accent);
            border-color: var(--accent);
        }

        .bracket-node.empty {
            border-style: dashed !important;
            opacity: 0.15;
        }

        /* Connectors */
        .bracket-match::after {
            content: '';
            position: absolute;
            right: -30px;
            top: 50%;
            width: 30px;
            height: 2px;
            background: var(--border);
            z-index: 1;
        }

        .bracket-round:not(:last-child) .bracket-match:nth-child(odd)::before,
        .bracket-round:not(:last-child) .bracket-match:nth-child(even)::before {
            content: '';
            position: absolute;
            right: -30px;
            width: 2px;
            background: var(--border);
            z-index: 1;
        }

        .round-1 .bracket-match:nth-child(odd)::before {
            top: 50%;
            height: calc(50% + 23px);
        }

        .round-1 .bracket-match:nth-child(even)::before {
            bottom: 50%;
            height: calc(50% + 23px);
        }

        .round-2 .bracket-match:nth-child(odd)::before {
            top: 50%;
            height: calc(50% + 60px);
        }

        .round-2 .bracket-match:nth-child(even)::before {
            bottom: 50%;
            height: calc(50% + 60px);
        }

        .round-3 .bracket-match:nth-child(odd)::before {
            top: 50%;
            height: calc(50% + 140px);
        }

        .round-3 .bracket-match:nth-child(even)::before {
            bottom: 50%;
            height: calc(50% + 140px);
        }

        .bracket-round:last-child .bracket-match::after {
            display: none;
        }

        @media print {

            aside,
            header,
            .no-print {
                display: none !important;
            }

            body {
                background: white !important;
                color: black !important;
                padding: 0 !important;
            }

            .neu-flat,
            .neu-inset,
            .bracket-node {
                border: 1px solid #333 !important;
                background: white !important;
                color: black !important;
                box-shadow: none !important;
            }

            .bracket-match::after,
            .bracket-round div::before {
                background: #333 !important;
            }

            @page {
                size: 215.9mm 330.2mm;
                margin: 10mm;
            }
        }
    </style>
</head>

<body class="min-h-screen flex">
    <script src="js/window-controls.js"></script>

    <main class="flex-1 p-10 overflow-y-auto custom-scrollbar">
        <header class="flex justify-between items-center mb-10">
            <h1 class="text-xl font-semibold tracking-tight">
                Generator Bagan <span id="bracketEventLabel" class="text-gray-400 font-normal ml-2"></span>
            </h1>

            <div class="flex items-center gap-4">
                <button onclick="window.history.back()"
                    class="text-sm text-gray-500 hover:text-black dark:hover:text-white transition">
                    Kembali
                </button>

                <button onclick="toggleTheme()"
                    class="text-sm text-gray-500 hover:text-black dark:hover:text-white transition">
                    üåì
                </button>
            </div>
        </header>

        <section class="border-b border-gray-200 dark:border-gray-800 py-8">
            <div class="flex flex-wrap items-center gap-6 text-sm">
                <div class="flex flex-col">
                    <label class="text-xs text-gray-500 mb-1">Kategori</label>
                    <select id="categorySelect"
                        class="px-3 py-2 border rounded-lg bg-transparent outline-none focus:ring-2 focus:ring-blue-500/20 cursor-pointer min-w-[200px]">
                        <option value="">Pilih Kategori...</option>
                    </select>
                </div>

                <div class="flex items-center gap-3 mt-5">
                    <input type="checkbox" id="filterNeedsEdit" onchange="window.renderCategoryDropdown()"
                        class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
                    <label for="filterNeedsEdit" class="text-xs text-gray-500 cursor-pointer select-none">Hanya Perlu
                        Diedit</label>
                </div>

                <div class="flex flex-col">
                    <label class="text-xs text-gray-500 mb-1">Jumlah Peserta</label>
                    <input id="participantCount" type="number" readonly
                        class="px-3 py-2 border rounded-lg w-24 bg-transparent outline-none focus:ring-2 focus:ring-blue-500/20">
                </div>

                <div class="flex items-center gap-3">
                    <button onclick="smartDrawParticipants()"
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-all shadow-lg shadow-blue-500/20">
                        Generate
                    </button>

                    <button id="btnSaveBracket" onclick="saveBracket()"
                        class="px-6 py-2 bg-emerald-600 text-white rounded-lg text-sm font-medium hover:bg-emerald-700 transition-all shadow-lg shadow-emerald-500/20">
                        <span id="saveStatus">Simpan & Selesai</span>
                    </button>
                </div>
            </div>
        </section>

        <div class="mt-10">
            <h2 class="text-sm font-semibold mb-4 flex justify-between items-center">
                <span>Peserta</span>
                <span id="athleteTotalLabel" class="text-[10px] font-normal text-gray-400 uppercase tracking-widest">0
                    ATLET</span>
            </h2>

            <textarea id="manualNames" readonly
                class="w-full border rounded-lg p-4 text-sm bg-transparent outline-none focus:ring-2 focus:ring-blue-500/20 custom-scrollbar resize-none font-mono"
                rows="6" placeholder="Daftar peserta akan muncul di sini...">
            </textarea>
        </div>

        <div class="mt-12">
            <h2 class="text-sm font-semibold mb-6 flex items-center justify-between">
                <span>Visualisasi Bagan</span>
                <span id="bracketCategoryLabel"
                    class="text-xs font-normal text-blue-500 uppercase tracking-widest"></span>
            </h2>

            <div class="border rounded-xl p-6 overflow-x-auto bg-white/50 dark:bg-black/20">
                <div id="bracketVisualArea" class="bracket-container"></div>
            </div>
        </div>
    </main>

    <script>
        function toggleTheme() {
            const html = document.documentElement;
            html.classList.toggle('dark');

            if (html.classList.contains('dark')) {
                localStorage.setItem('theme', 'dark');
            } else {
                localStorage.setItem('theme', 'light');
            }
        }

        (function () {
            const saved = localStorage.getItem('theme');
            if (saved === 'dark') {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>

    <script type="module">
        import { db, auth } from './js/firebase-init.js';
        import { handleLogout } from './js/auth-helpers.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { collection, onSnapshot, query, where, getDocs, doc, getDoc, setDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { prepareBracketPrint } from './js/modules/print/print-bracket.js';
        import { getLogicalIdFromSVGId, getNextSlot, getTeamSlot } from './js/bracket-utils.js';

        window.handleLogout = handleLogout;
        let bracketListener = null;
        let allEventClasses = [];
        let allEventAthletes = [];
        let allEventBrackets = [];

        window.renderCategoryDropdown = () => {
            const select = document.getElementById('categorySelect');
            const filterEnabled = document.getElementById('filterNeedsEdit').checked;
            const currentVal = select.value;

            select.innerHTML = '<option value="">Pilih Kategori...</option>';

            allEventClasses.forEach(cls => {
                const classAthletes = allEventAthletes.filter(a => (cls.code && a.classCode === cls.code) || (a.className === cls.name));
                const athleteCount = classAthletes.length;

                if (athleteCount === 0) return; // Skip classes with no participants

                const bracket = allEventBrackets.find(b => b.id === (cls.code || cls.name));
                const isComplete = bracket && bracket.status === 'complete' && bracket.athleteCount === athleteCount;

                if (filterEnabled && isComplete) return;

                const option = document.createElement('option');
                option.value = cls.name;
                option.textContent = `${cls.name} (${athleteCount})${!isComplete ? ' ‚ö†Ô∏è' : ''}`;
                if (cls.name === currentVal || (initialClass && cls.name === initialClass)) option.selected = true;
                select.appendChild(option);
            });
        };

        window.goBackToDetail = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('id');
            if (eventId) {
                window.location.href = `event-detail.html?id=${eventId}&tab=bracket`;
            } else {
                window.history.back();
            }
        };

        // Get Context from URL

        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('id');
        const classId = urlParams.get('classId');
        const initialClass = urlParams.get('class');
        let currentClassCode = classId || "";

        if (!eventId) {
            alert("ID Event tidak ditemukan!");
            window.location.href = 'data-pertandingan.html';
        }

        // Protect Route
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                // Load Data
                loadEventContext();
            }
        });

        async function loadEventContext() {
            // 1. Load Event Info
            const eventDoc = await getDoc(doc(db, "events", eventId));
            if (eventDoc.exists()) {
                const eventData = eventDoc.data();
                document.getElementById('bracketEventLabel').innerText = eventData.name;
                window.hostKontingen = eventData.settings?.hostKontingen || "";
                const breadcrumbEvent = document.querySelector('a[href*="event-detail.html"], a[onclick*="history.back"]');
                if (breadcrumbEvent) {
                    breadcrumbEvent.innerText = eventData.name;
                    breadcrumbEvent.href = `event-detail.html?id=${eventId}&tab=bracket`;
                    breadcrumbEvent.onclick = (e) => {
                        e.preventDefault();
                        window.goBackToDetail();
                    };
                }
            }

            // 2. Pre-fetch Event Data for Smart Filtering
            const [classSnap, athleteSnap, bracketSnap] = await Promise.all([
                getDocs(query(collection(db, `events/${eventId}/classes`), orderBy("name", "asc"))),
                getDocs(collection(db, `events/${eventId}/athletes`)),
                getDocs(collection(db, `events/${eventId}/brackets`))
            ]);

            allEventClasses = classSnap.docs.map(d => d.data());
            allEventAthletes = athleteSnap.docs.map(d => d.data());
            allEventBrackets = bracketSnap.docs.map(d => ({ id: d.id, ...d.data() }));

            // 3. Render Dropdown
            window.renderCategoryDropdown();

            // 4. Change Listener
            const categorySelect = document.getElementById('categorySelect');
            categorySelect.addEventListener('change', (e) => {
                if (e.target.value) loadAthletesForClass(e.target.value);
            });

            // 5. Load Schedule for Tatami Automation
            try {
                const scheduleSnap = await getDoc(doc(db, `events/${eventId}/metadata`, 'schedule'));
                if (scheduleSnap.exists()) {
                    window.currentEventSchedule = scheduleSnap.data().schedule || [];
                }
            } catch (err) {
                console.error("Error loading schedule:", err);
            }

            // 6. Initial Load if class is set
            if (initialClass) {
                await loadAthletesForClass(initialClass);
            }
        }

        async function loadAthletesForClass(className) {
            currentClass = className;
            // Update the visual label in the bracket area
            if (document.getElementById('bracketCategoryLabel')) {
                document.getElementById('bracketCategoryLabel').innerText = className;
            }

            // 1. Dapatkan Kode Kelas Terlebih Dahulu
            let classCode = "";
            try {
                const qClass = query(collection(db, `events/${eventId}/classes`), where("name", "==", className));
                const classSnap = await getDocs(qClass);
                if (!classSnap.empty) {
                    const classData = classSnap.docs[0].data();
                    classCode = classData.code || "";
                    currentClassCode = classCode;
                }
            } catch (err) { console.error("Error getting class code:", err); }

            // 2. Cari Atlet Berdasarkan Kode (Utama) atau Nama (Lama)
            let athletes = [];
            try {
                // Mencari atlet yang memiliki classCode sama ATAU className sama
                const qAthletes = query(collection(db, `events/${eventId}/athletes`));
                const snap = await getDocs(qAthletes);

                snap.forEach(docSnap => {
                    const d = docSnap.data();
                    // Cocokkan berdasarkan Kode (F01) atau Nama (KATA...)
                    if ((classCode && d.classCode === classCode) || (d.className === className)) {
                        athletes.push({
                            name: d.name,
                            team: d.team || d.kontingen || "-"
                        });
                    }
                });
            } catch (err) { console.error("Error loading athletes:", err); }

            // Check if this class is BEREGU or FESTIVAL
            try {
                const qClass = query(collection(db, `events/${eventId}/classes`), where("name", "==", className));
                const classSnap = await getDocs(qClass);
                const magicBtn = document.getElementById('tabBtnMagic');
                const bracketArea = document.getElementById('bracketVisualArea');

                if (!classSnap.empty) {
                    const classData = classSnap.docs[0].data();
                    currentClassCode = classData.code || "";

                    if (classData.type === 'BEREGU') {
                        if (magicBtn) magicBtn.classList.remove('hidden');
                    } else {
                        if (magicBtn) magicBtn.classList.add('hidden');
                    }
                }
            } catch (err) { console.error("Error checking class type:", err); }

            // Simpan ke peserta global
            participants = JSON.parse(JSON.stringify(athletes));
            console.log(`Loaded ${participants.length} athletes for class "${className}"`);

            // Update UI
            document.getElementById('participantCount').value = Math.max(2, athletes.length);
            document.getElementById('manualNames').value = athletes.map((a, i) => `${i + 1}. ${a.name} [${a.team}]`).join('\n');
            renderAthleteList();

            // CRITICAL: Load SVG first before fetching saved data
            if (!svgDoc) {
                console.log("üìÑ Loading SVG template...");
                await loadSVG();
            }

            // Sinkronisasi dengan Firebase (Ambil urutan & data terakhir)
            console.log("Fetching saved bracket for:", className);
            await fetchSavedBracket(className.trim());

            // Only generate if no cloud data was found
            if (!window.isBracketDrawn) {
                const isFestival = (currentClassCode || "").toString().toUpperCase().startsWith('F');
                if (isFestival && participants.length >= 2) {
                    console.log("Festival class detected, performing auto-draw...");
                    smartDrawParticipants();
                } else {
                    console.log("No saved bracket found, showing empty template");
                    await generateBracket();
                }
            }

            // Real-time Listener for updates from Scoring Console
            if (bracketListener) bracketListener(); // Unsubscribe prev
            const listenerId = currentClassCode || className.trim();
            console.log(`üì° Attaching Real-Time Listener for "${className}" [${listenerId}]...`);
            bracketListener = onSnapshot(doc(db, `events/${eventId}/brackets`, listenerId), (snap) => {
                if (snap.exists() && !snap.metadata.hasPendingWrites) {
                    console.log("üîÑ Bracket update detected from Cloud!");
                    fetchSavedBracket(className.trim());
                }
            });
        }

        function syncHeadersToSVG() {
            if (!svgDoc) return;

            const eventName = document.getElementById('bracketEventLabel')?.innerText || "";
            const className = document.getElementById('bracketCategoryLabel')?.innerText || "";

            // Populate SVG IDs - Pakai querySelector dan dukung tspan agar teks muncul dengan benar
            const eventEl = svgDoc.querySelector('#Nama_event');
            if (eventEl) {
                const target = eventEl.querySelector('tspan') || eventEl;
                target.textContent = eventName;
            }

            const classEl = svgDoc.querySelector('#Kelas_Kategori');
            if (classEl) {
                const target = classEl.querySelector('tspan') || classEl;
                target.textContent = className;
            }

            // --- Tatami & Pool Automation ---
            let tatamiValue = "-";
            if (window.currentEventSchedule) {
                const targetName = (className || "").trim().toUpperCase();

                // Find class in schedule using Code (Primary) or Name (Fallback)
                const scheduleEntry = window.currentEventSchedule.find(entry =>
                    entry.classes && entry.classes.some(cls =>
                        (currentClassCode && cls.code === currentClassCode) ||
                        (cls.name && targetName === cls.name.trim().toUpperCase())
                    )
                );

                if (scheduleEntry) {
                    tatamiValue = scheduleEntry.arena || "-";
                } else {
                    console.warn(`‚ö†Ô∏è Kategori "${className}" [${currentClassCode}] tidak ditemukan di jadwal.`);
                }
            }

            // Update SVG: #tatami
            const tatamiEl = svgDoc.querySelector('#tatami');
            if (tatamiEl) {
                const target = tatamiEl.querySelector('tspan') || tatamiEl;
                target.textContent = tatamiValue.toString();
            }

            // Update SVG: #pool
            const poolEl = svgDoc.querySelector('#pool');
            if (poolEl) {
                const target = poolEl.querySelector('tspan') || poolEl;
                // Permintaan USER: 1/1 jika peserta tidak melebihi 16
                if (participants && participants.length <= 16) {
                    target.textContent = "1/1";
                } else {
                    target.textContent = "1";
                }
            }
        }

        // Global variable declarations
        let currentClass = initialClass;
        window.isBracketDrawn = false;
        let participants = [];
        let svgDoc = null;

        const names = [];

        function cleanSVGPlaceholders() {
            if (!svgDoc) return;
            const placeholders = [
                "NAMA PESERTA", "SKOR", "NAMA EVENT", "KONTINGEN PESERTA",
                "SENSHU / PENALTY", "NAMA KATA", "-", "DASH -", "SKOR 1", "SKOR 2",
                "KELAS KATEGORI", "18 AGUSTUS 2025", "08.30 - 08.30 (30 menit)", "1/1"
            ];

            const headerIds = ["Nama_event", "Kelas_Kategori", "tanggal", "durasi", "tatami", "pool"];

            svgDoc.querySelectorAll('text, tspan').forEach(el => {
                const text = el.textContent.trim();
                const id = el.id || (el.parentElement && el.parentElement.id);

                const isParticipantId = (id) => {
                    if (!id) return false;
                    // Babak R1 (P), R2 (Q), R3 (S), R4 (F)
                    return id.startsWith('p_n_') || id.startsWith('p_k_') || id.startsWith('n_k_') || id.startsWith('s_') || id.startsWith('sp_') ||
                        id.startsWith('q_n_') || id.startsWith('q_k_') || id.startsWith('q_n_k_') || id.startsWith('q_s_') || id.startsWith('q_s_p_') ||
                        id.startsWith('s_n_') || id.startsWith('s_k_') || id.startsWith('s_n_k_') || id.startsWith('s_s_') || id.startsWith('s_s_p_') ||
                        id.startsWith('f_n_') || id.startsWith('f_k_') || id.startsWith('f_n_k_') || id.startsWith('f_s_') || id.startsWith('f_s_p_') ||
                        id.startsWith('qn') || id.startsWith('sn') || id.startsWith('fn') || // Fallback old IDs
                        id.startsWith('winner_') || id.startsWith('nama_juara_') || id.startsWith('kontingen_juara_');
                };

                if (placeholders.includes(text) || headerIds.includes(id) || isParticipantId(id)) {
                    el.textContent = "";
                }
            });
        }

        /**
         * DYNAMIC LAYOUT ENGINE
         * Mengatur visibilitas komponen bagan secara cerdas.
         */
        /**
         * SMART PATH VISIBILITY ENGINE
         * Menghitung dan menampilkan hanya jalur pertandingan yang relevan dari titik mulai peserta.
         */
        function applyBracketMapping(mapping) {
            if (!svgDoc || !mapping) return;

            const visibleSlots = new Set();

            // 1. Hitung Jalur Hilir (Downstream Path) untuk setiap peserta
            Object.values(mapping).forEach(startId => {
                if (!startId) return;

                let current = startId;
                visibleSlots.add(current);

                // Jalur ke Kualifikasi (Q)
                if (current.startsWith('p_n_')) {
                    let x = parseInt(current.replace('p_n_', ''));
                    current = 'qn' + Math.ceil(x / 2);
                    visibleSlots.add(current);
                }
                // Jalur ke Semi Final (S)
                if (current.startsWith('qn')) {
                    let x = parseInt(current.replace('qn', ''));
                    current = 'sn' + Math.ceil(x / 2);
                    visibleSlots.add(current);
                }
                // Jalur ke Final (F)
                if (typeof current === 'string' && current.startsWith('sn')) {
                    let x = parseInt(current.replace('sn', ''));
                    current = 'fn' + (x <= 2 ? '1' : '2');
                    visibleSlots.add(current);
                }
            });

            // 2. Terapkan Visibilitas ke seluruh SVG berdasarkan Logical Slots
            // Reset semua (Sembunyikan)
            toggleAllLogicalSlots(false);

            // Tampilkan yang masuk dalam path
            visibleSlots.forEach(slotId => {
                const componentIds = getComponentsForSlot(slotId);
                componentIds.forEach(id => toggleSVG(id, true));
            });
        }

        function getComponentsForSlot(slotId) {
            // P Round (Penyisihan 16 Besar)
            if (slotId.startsWith('p_n_')) {
                const x = slotId.replace('p_n_', '');
                return [`p_n_${x}`, `p_k_${x}`, `n_k_${x}`, `s_${x}`, `sp_${x}`];
            }
            // Q Round (8 Besar)
            if (slotId.startsWith('qn')) {
                const x = slotId.replace('qn', '');
                return [`q_n_${x}`, `q_k_${x}`, `q_n_k_${x}`, `q_s_${x}`, `q_s_p_${x}`];
            }
            // S Round (Semi Final)
            if (slotId.startsWith('sn')) {
                const x = slotId.replace('sn', '');
                return [`s_n_${x}`, `s_k_${x}`, `s_n_k_${x}`, `s_s_${x}`, `s_s_p_${x}`];
            }
            // F Round (Final)
            if (slotId.startsWith('fn')) {
                const x = slotId.replace('fn', '');
                return [`f_n_${x}`, `f_k_${x}`, `f_n_k_${x}`, `f_s_${x}`, `f_s_p_${x}`];
            }

            // Juara 1 (Final Result Center / Highlit)
            if (slotId === 'winner_nama') {
                return [`winner_nama`, `winner_kontingen`, `nama_juara_1`, `kontingen_juara_1`];
            }

            return [];
        }

        function toggleAllLogicalSlots(active) {
            for (let i = 1; i <= 16; i++) {
                getComponentsForSlot(`p_n_${i}`).forEach(id => toggleSVG(id, active));
                if (i <= 8) getComponentsForSlot(`qn${i}`).forEach(id => toggleSVG(id, active));
                if (i <= 4) getComponentsForSlot(`sn${i}`).forEach(id => toggleSVG(id, active));
                if (i <= 2) getComponentsForSlot(`fn${i}`).forEach(id => toggleSVG(id, active));
            }
        }

        function toggleSVG(id, active) {
            const el = svgDoc.getElementById(id);
            if (el) {
                el.style.opacity = active ? "1" : "0";
                el.style.pointerEvents = active ? "auto" : "none";
                console.log(`    ${active ? '‚úÖ' : '‚ùå'} #${id} opacity=${el.style.opacity}`);
            } else {
                console.warn(`    ‚ö†Ô∏è Element #${id} not found in SVG!`);
            }
        }

        async function loadSVG() {
            const visualArea = document.getElementById('bracketVisualArea');
            try {
                const response = await fetch('assets/Master.svg');
                if (!response.ok) throw new Error('File not found');
                const svgText = await response.text();
                visualArea.innerHTML = svgText;
                svgDoc = visualArea.querySelector('svg');

                if (svgDoc) {
                    svgDoc.style.display = 'block';
                    svgDoc.style.margin = 'auto';

                    // Ukuran normal untuk browser (tidak ada scrolling)
                    svgDoc.style.width = '1000px';
                    svgDoc.style.height = '620px';
                    svgDoc.setAttribute('preserveAspectRatio', 'xMidYMid meet');
                }

                setupSVGInteractivity();
                cleanSVGPlaceholders();
                syncHeadersToSVG();

                // After SVG is ready, try to load saved state
                // Moved fetchSavedBracket to loadAthletesForClass
            } catch (error) {
                console.error('Error loading SVG:', error);
                visualArea.innerHTML = '<p class="text-red-400 font-bold text-xs uppercase text-center mt-10">Gagal memuat file assets/Master.svg.<br>Harap pastikan file tersebut ada di folder assets.</p>';
            }
        }

        function setupSVGInteractivity() {
            if (!svgDoc) return;

            // List of all logical slots to bind
            const logicalPrefixes = ['p_n_', 'qn', 'sn', 'fn'];
            const maxCounts = { 'p_n_': 16, 'qn': 8, 'sn': 4, 'fn': 2 };

            logicalPrefixes.forEach(prefix => {
                for (let i = 1; i <= maxCounts[prefix]; i++) {
                    const logicalId = `${prefix}${i}`;
                    const components = getComponentsForSlot(logicalId);
                    const nameId = components[0];

                    if (nameId) {
                        const textEl = svgDoc.getElementById(nameId);
                        if (textEl) {
                            textEl.style.cursor = 'pointer';
                            textEl.addEventListener('click', () => handleWinnerClick(logicalId));

                            textEl.addEventListener('mouseenter', () => {
                                const content = textEl.textContent.trim();
                                if (content !== "" && content !== "-") {
                                    textEl.style.filter = 'brightness(1.5)';
                                    textEl.style.transition = 'all 0.2s ease';
                                }
                            });
                            textEl.addEventListener('mouseleave', () => {
                                textEl.style.filter = 'none';
                            });
                        }
                    }
                }
            });
        }

        function handleWinnerClick(id) {
            // Normalize ID
            const logicalId = getLogicalIdFromSVGId(id);
            if (!logicalId) return;

            const components = getComponentsForSlot(logicalId);
            const nameId = components[0];
            const teamId = components[1];

            const el = svgDoc ? svgDoc.getElementById(nameId) : document.getElementById(nameId);
            if (!el) return;
            const name = el.textContent.trim();
            if (name === "" || name === "-") return;

            // Find current Team name
            let teamName = "-";
            if (teamId) {
                const teamEl = svgDoc ? svgDoc.getElementById(teamId) : document.getElementById(teamId);
                if (teamEl) teamName = teamEl.textContent.trim();
            }

            const targetId = getNextSlot(logicalId);
            if (targetId) {
                const targetComponents = getComponentsForSlot(targetId);

                // Propagate to all relevant target name slots (could be multiple e.g. winner + podium)
                targetComponents.forEach((comp, index) => {
                    const targetEl = svgDoc ? svgDoc.getElementById(comp) : document.getElementById(comp);
                    if (!targetEl) return;

                    const tspan = targetEl.querySelector('tspan') || targetEl;

                    // index 0 and 2 are usually names, 1 and 3 are kontingen in winner_nama mapping
                    if (targetId === 'winner_nama') {
                        if (index === 0 || index === 2) {
                            tspan.textContent = name;
                            targetEl.setAttribute('fill', '#f87171');
                        } else if (index === 1 || index === 3) {
                            tspan.textContent = teamName;
                            targetEl.setAttribute('fill', '#f87171');
                        }
                    } else {
                        // Standard round progression
                        if (index === 0) {
                            tspan.textContent = name;
                            targetEl.setAttribute('fill', '#f87171');
                        } else if (index === 1) {
                            tspan.textContent = teamName;
                        }
                    }
                    targetEl.style.opacity = "1";
                });
            }
        }

        async function handleExcelUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];

                // Convert to JSON
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                // Extract names from first column
                let namesFromExcel = jsonData
                    .map(row => row[0]) // First column
                    .filter(cell => cell && cell.toString().trim() !== ""); // Filter empty

                // Optional: Skip header if it looks like a label
                if (namesFromExcel.length > 0) {
                    const first = namesFromExcel[0].toString().toLowerCase();
                    if (first.includes("nama") || first.includes("name") || first.includes("peserta")) {
                        namesFromExcel.shift();
                    }
                }

                if (namesFromExcel.length === 0) {
                    alert("Tidak ada data nama yang ditemukan di kolom pertama Excel.");
                    return;
                }

                // Limit to 16 and set count
                const count = Math.min(namesFromExcel.length, 16);
                document.getElementById('participantCount').value = count;
                document.getElementById('manualNames').value = namesFromExcel.slice(0, 16).join('\n');

                // Trigger generation
                await generateBracket();
            };
            reader.readAsArrayBuffer(file);
        }

        function resetBracket() {
            document.getElementById('participantCount').value = 8;
            document.getElementById('manualNames').value = '';
            document.getElementById('excelFile').value = ''; // Clear file input
            participants = [];
            window.isBracketDrawn = false;
            window.festivalResults = {}; // Clear festival results on reset
            generateBracket();
        }

        const GOLDEN_PRESETS = {
            2: ['fn1', 'fn2'],
            3: ['sn3', 'sn4', 'fn1'],
            4: ['sn1', 'sn2', 'sn3', 'sn4'],
            5: ['qn7', 'qn8', 'sn1', 'sn2', 'sn3'],
            6: ['qn3', 'qn4', 'qn7', 'qn8', 'sn1', 'sn3'],
            7: ['qn3', 'qn4', 'qn5', 'qn6', 'qn7', 'qn8', 'sn1'],
            8: ['qn1', 'qn2', 'qn3', 'qn4', 'qn5', 'qn6', 'qn7', 'qn8'],
            9: ['p_n_15', 'p_n_16', 'qn1', 'qn2', 'qn3', 'qn4', 'qn5', 'qn6', 'qn7'],
            10: ['p_n_7', 'p_n_8', 'p_n_15', 'p_n_16', 'qn1', 'qn2', 'qn3', 'qn5', 'qn6', 'qn7'],
            11: ['p_n_7', 'p_n_8', 'p_n_11', 'p_n_12', 'p_n_15', 'p_n_16', 'qn1', 'qn2', 'qn3', 'qn5', 'qn7'],
            12: ['p_n_3', 'p_n_4', 'p_n_7', 'p_n_8', 'p_n_11', 'p_n_12', 'p_n_15', 'p_n_16', 'qn1', 'qn3', 'qn5', 'qn7'],
            13: ['p_n_3', 'p_n_4', 'p_n_7', 'p_n_8', 'p_n_11', 'p_n_12', 'p_n_13', 'p_n_14', 'p_n_15', 'p_n_16', 'qn1', 'qn3', 'qn5'],
            14: ['p_n_3', 'p_n_4', 'p_n_5', 'p_n_6', 'p_n_7', 'p_n_8', 'p_n_11', 'p_n_12', 'p_n_13', 'p_n_14', 'p_n_15', 'p_n_16', 'qn1', 'qn5'],
            15: ['p_n_3', 'p_n_4', 'p_n_5', 'p_n_6', 'p_n_7', 'p_n_8', 'p_n_9', 'p_n_10', 'p_n_11', 'p_n_12', 'p_n_13', 'p_n_14', 'p_n_15', 'p_n_16', 'qn1'],
            16: ['p_n_1', 'p_n_2', 'p_n_3', 'p_n_4', 'p_n_5', 'p_n_6', 'p_n_7', 'p_n_8', 'p_n_9', 'p_n_10', 'p_n_11', 'p_n_12', 'p_n_13', 'p_n_14', 'p_n_15', 'p_n_16']
        };

        window.setFestivalWinner = (matchIdx, side) => {
            if (!window.festivalResults) window.festivalResults = {};
            if (window.festivalResults[matchIdx] === side) {
                // If already selected, deselect
                delete window.festivalResults[matchIdx];
            } else {
                window.festivalResults[matchIdx] = side;
            }
            renderFestivalTable();
        };

        function renderFestivalTable() {
            const visualArea = document.getElementById('bracketVisualArea');
            if (!visualArea) return;

            // Sync Textarea with participants first
            document.getElementById('manualNames').value = participants.map((p, i) => `${i + 1}. ${p.name} [${p.team}]`).join('\n');
            renderAthleteList();

            const groups = {};
            participants.forEach(p => {
                const t = p.team || "-";
                if (!groups[t]) groups[t] = [];
                groups[t].push(p);
            });
            const totalAthletes = participants.length;

            let html = `
                <div class="w-full h-full p-8 overflow-y-auto custom-scrollbar bg-white text-slate-900">
                    <table class="w-full text-left border-collapse border-[3px] border-slate-900">
                        <thead class="bg-slate-900 text-[9px] font-black uppercase tracking-widest text-white">
                            <tr>
                                <th class="p-4 text-center border-2 border-slate-700 w-24">HASIL AKA</th>
                                <th class="p-4 text-center border-2 border-slate-700 bg-red-600">PESERTA (AKA)</th>
                                <th class="p-4 text-center border-2 border-slate-700 bg-red-600">KONTINGEN</th>
                                <th class="p-4 text-center border-2 border-slate-700 bg-red-600 w-16">AKSI</th>
                                <th class="p-4 text-center border-2 border-slate-700 w-12 bg-slate-800">VS</th>
                                <th class="p-4 text-center border-2 border-slate-700 bg-blue-600 w-16">AKSI</th>
                                <th class="p-4 text-center border-2 border-slate-700 bg-blue-600">PESERTA (AO)</th>
                                <th class="p-4 text-center border-2 border-slate-700 bg-blue-600">KONTINGEN</th>
                                <th class="p-4 text-center border-2 border-slate-700 w-24">HASIL AO</th>
                            </tr>
                        </thead>
                        <tbody class="text-slate-900 font-black italic uppercase text-[10px]">
            `;

            for (let i = 0; i < participants.length; i += 2) {
                const matchIdx = i / 2;
                const aka = participants[i];
                const ao = participants[i + 1];
                const winnerSide = (window.festivalResults || {})[matchIdx]; // 'aka' or 'ao'

                // Smart Alert Logic
                const isSameTeam = ao && aka.team === ao.team && aka.team !== "-";
                const isForced = isSameTeam && (groups[aka.team].length > Math.ceil(totalAthletes / 2));
                const showAlert = isSameTeam && !isForced;

                const rowStyle = showAlert ? 'background: #fee2e2; border: 3px solid #ef4444;' : '';
                const alertBanner = showAlert ? `<div style="color: #ef4444; font-size: 8px; font-weight: 900; margin-top: 4px;">‚ö†Ô∏è SESAMA TIM (BISA DIPISAH)</div>` : '';

                // Result Badges
                let akaResult = `<div class="text-slate-300 opacity-20">. . .</div>`;
                let aoResult = `<div class="text-slate-300 opacity-20">. . .</div>`;

                if (winnerSide === 'aka') {
                    akaResult = `<div class="px-2 py-1 bg-yellow-400 text-black text-[8px] font-black rounded shadow-sm">JUARA 1</div>`;
                    aoResult = `<div class="px-2 py-1 bg-slate-200 text-slate-600 text-[8px] font-black rounded">JUARA 2</div>`;
                } else if (winnerSide === 'ao') {
                    aoResult = `<div class="px-2 py-1 bg-yellow-400 text-black text-[8px] font-black rounded shadow-sm">JUARA 1</div>`;
                    akaResult = `<div class="px-2 py-1 bg-slate-200 text-slate-600 text-[8px] font-black rounded">JUARA 2</div>`;
                }

                html += `
                    <tr class="border-b-2 border-slate-900 hover:bg-slate-50 transition-colors" style="${rowStyle}">
                        <td class="p-4 text-center border-r-2 border-slate-900">
                            ${akaResult}
                        </td>
                        <td class="p-4 text-red-600 border-r-2 border-slate-900">
                            ${document.getElementById('useShortName')?.checked ? shortenName(aka.name) : aka.name}
                            ${alertBanner}
                        </td>
                        <td class="p-4 text-slate-500 border-r-2 border-slate-900">${aka.team || '-'}</td>
                        <td class="p-4 text-center border-r-2 border-slate-900">
                             <button onclick="window.setFestivalWinner(${matchIdx}, 'aka')" class="w-8 h-8 rounded ${winnerSide === 'aka' ? 'bg-red-600 text-white shadow-lg scale-110' : 'bg-slate-100 text-slate-400 hover:bg-red-500 hover:text-white'} transition-all text-[10px] font-black">W</button>
                        </td>
                        <td class="p-4 text-center font-black bg-slate-100 border-r-2 border-slate-900">VS</td>
                        <td class="p-4 text-center border-r-2 border-slate-900">
                             <button onclick="window.setFestivalWinner(${matchIdx}, 'ao')" class="w-8 h-8 rounded ${winnerSide === 'ao' ? 'bg-blue-600 text-white shadow-lg scale-110' : 'bg-slate-100 text-slate-400 hover:bg-blue-500 hover:text-white'} transition-all text-[10px] font-black">W</button>
                        </td>
                        <td class="p-4 text-blue-600 border-r-2 border-slate-900 text-right">${ao ? (document.getElementById('useShortName')?.checked ? shortenName(ao.name) : ao.name) : 'BYE'}</td>
                        <td class="p-4 text-slate-500 border-r-2 border-slate-900 text-right">${ao ? ao.team : '-'}</td>
                        <td class="p-4 text-center">
                            ${aoResult}
                        </td>
                    </tr>
                `;
            }

            html += `</tbody></table></div>`;
            visualArea.innerHTML = html;
        }

        async function generateBracket() {
            const count = parseInt(document.getElementById('participantCount').value);
            const isFestival = (currentClassCode || "").toString().toUpperCase().startsWith('F');

            const visualArea = document.getElementById('bracketVisualArea');
            if (isFestival) {
                renderFestivalTable();
                return;
            }

            if (count < 2 || count > 16) return;

            console.log(`\ud83d\udc68\u200d\ud83d\udcbb generateBracket called:`, {
                participantsLength: participants.length,
                participantCountInput: count,
                isBracketDrawn: window.isBracketDrawn
            });

            // Get names from textarea OR use the already populated global participants
            const manualInput = document.getElementById('manualNames').value.trim();
            if (manualInput && (!participants || participants.length === 0 || manualInput.split('\n').length !== participants.length)) {
                // Parser Cerdas: Mengabaikan '1. ' dan menangkap 'NAMA [TEAM]'
                // Versi Tangguh: mendukung spasi maupun tanpa spasi sebelum '['
                const parsed = manualInput.split('\n').filter(n => n.trim() !== '').map(lineTxt => {
                    const line = lineTxt.trim();
                    // Regex Baru: mendukung opsional nomor di awal, nama, dan opsional [team] tanpa haris spasi kaku
                    const match = line.match(/^(?:\d+\.\s*)?([^\[\]]+)(?:\s*\[(.*)\])?$/);
                    if (match) {
                        return {
                            name: match[1].trim(),
                            team: match[2] ? match[2].trim() : "-"
                        };
                    }
                    return { name: line.trim(), team: "-" };
                });
                if (parsed.length > 0) participants = parsed.slice(0, count);
            }

            // Sync Nomor kembali ke Textarea agar admin tahu urutan realnya
            document.getElementById('manualNames').value = participants.map((p, i) => `${i + 1}. ${p.name} [${p.team}]`).join('\n');

            renderAthleteList();

            if (!svgDoc) {
                await loadSVG();
            }
            if (!svgDoc) return;

            // Update bracket title with event/category
            const categorySelect = document.querySelector('select');
            const categoryName = categorySelect.options[categorySelect.selectedIndex].text;
            const categoryLabel = document.getElementById('bracketCategoryLabel');
            if (categoryLabel) categoryLabel.textContent = categoryName;

            currentClass = categoryName;

            // 1. Ambil Pola Emas berdasarkan jumlah peserta
            const pattern = GOLDEN_PRESETS[participants.length] || [];
            console.log(`üìä Pattern for ${participants.length} participants:`, pattern);

            // 2. Reset All Visuals
            toggleAllLogicalSlots(false);
            console.log(`üîí All slots hidden`);

            // 2.1 Sync Headers (Event Name & Class Name) back to SVG
            syncHeadersToSVG();

            // 3. Create Mapping & Apply Path Visibility
            const mapping = {};
            pattern.forEach((slotId, i) => {
                if (participants[i]) mapping[i + 1] = slotId;
            });

            // Make mapped slots visible
            console.log(`üîì Making ${Object.keys(mapping).length} slots visible:`);
            Object.values(mapping).forEach(slotId => {
                console.log(`  üëÅÔ∏è Showing slot: ${slotId}`);
                const components = getComponentsForSlot(slotId);
                components.forEach(id => toggleSVG(id, true));
            });

            // 4. Hitung Penomoran Visual (Berdasarkan urutan Kiri-ke-Kanan, Atas-ke-Bawah)
            const getSlotPriority = (id) => {
                if (id.startsWith('p_n_')) return 100 + parseInt(id.replace('p_n_', ''));
                if (id.startsWith('qn')) return 200 + parseInt(id.replace('qn', ''));
                if (id.startsWith('sn')) return 300 + parseInt(id.replace('sn', ''));
                if (id === 'fn1') return 401;
                if (id === 'fn2') return 402;
                return 999;
            };

            const activeSlots = Object.entries(mapping).sort((a, b) => getSlotPriority(a[1]) - getSlotPriority(b[1]));
            window.currentActiveSlots = activeSlots; // For mapping table

            // 5. Fill Participant Names & Kontingen to SVG (ONLY IF DRAWN)
            if (window.isBracketDrawn) {
                console.log(`üé® Filling ${activeSlots.length} slots with participant names...`);
                activeSlots.forEach(([idx, slotId], displayIndex) => {
                    const athlete = participants[idx - 1];
                    if (!athlete) return;

                    const componentIds = getComponentsForSlot(slotId);
                    const nameId = componentIds[0];
                    const teamId = componentIds[1];

                    // Fill Name
                    const nameEl = svgDoc.getElementById(nameId);
                    if (nameEl) {
                        const tspan = nameEl.querySelector('tspan') || nameEl;
                        const useShort = document.getElementById('useShortName')?.checked;
                        const displayName = useShort ? shortenName(athlete.name) : athlete.name;
                        tspan.textContent = displayName;
                        nameEl.style.opacity = "1";
                        console.log(`  ‚úèÔ∏è [${slotId}] Filled name: "${athlete.name}" ‚Üí #${nameId}`);
                    } else {
                        console.warn(`‚ùå Name element not found: ${nameId}`);
                    }

                    // Fill Team/Kontingen
                    const teamEl = svgDoc.getElementById(teamId);
                    if (teamEl) {
                        const tspan = teamEl.querySelector('tspan') || teamEl;
                        tspan.textContent = athlete.team;
                        teamEl.style.opacity = "1";
                        console.log(`  ‚úèÔ∏è [${slotId}] Filled team: "${athlete.team}" ‚Üí #${teamId}`);
                    }
                });

                // 6. Apply Current Font Sizes
                updateBracketTextSizes();
            } else {
                console.log(`‚è∏Ô∏è Skipping name fill (isBracketDrawn = false)`);
            }
        }

        async function saveBracket() {
            if (!currentClass || !eventId) return;

            const btn = document.getElementById('btnSaveBracket');
            const label = document.getElementById('saveStatus');
            btn.disabled = true;
            label.innerText = "MENYIMPAN... ‚è≥";

            // Extract all data from SVG - AUTOMATIC CAPTURE
            const bracketData = {};

            if (svgDoc) {
                // Capture ALL text elements automatically
                const allTextElements = svgDoc.querySelectorAll('text');
                allTextElements.forEach(el => {
                    const id = el.id;
                    if (id && id.trim() !== '') {
                        const tspan = el.querySelector('tspan') || el;
                        const val = tspan.textContent.trim();
                        if (val !== "" && val !== "-") {
                            bracketData[id] = val;
                        }
                    }
                });
            }

            const isFestival = (currentClassCode || "").toString().toUpperCase().startsWith('F');

            console.log("Saving bracket data:", {
                eventId,
                currentClass,
                participantsCount: participants.length,
                bracketDataKeys: Object.keys(bracketData).length,
                isDrawn: window.isBracketDrawn,
                isFestival: isFestival,
                festivalResultsKeys: isFestival ? Object.keys(window.festivalResults || {}).length : 0
            });

            // Validation: Prevent saving empty brackets
            if (!isFestival && !window.isBracketDrawn) {
                label.innerText = "GAGAL ‚ùå";
                btn.disabled = false;
                alert("‚ö†Ô∏è Bracket belum di-generate!\n\nSilakan klik tombol SMART DRAW terlebih dahulu untuk mengisi nama peserta ke dalam bagan.");
                return;
            }

            if (!isFestival && Object.keys(bracketData).length < 5) {
                label.innerText = "GAGAL ‚ùå";
                btn.disabled = false;
                alert("‚ö†Ô∏è Data bracket terlalu sedikit!\n\nPastikan:\n1. Tombol SMART DRAW sudah ditekan\n2. Nama peserta muncul di bagan\n3. Baru klik SIMPAN & SELESAI");
                return;
            }

            try {
                const docId = currentClassCode || currentClass;
                const path = `events/${eventId}/brackets/${docId}`;

                const dataToSave = {
                    class: currentClass,
                    data: bracketData,
                    participants: participants,
                    athleteCount: participants.length, // Store athlete count for revision monitoring
                    isDrawn: window.isBracketDrawn,
                    status: 'complete',  // Track bracket completion status
                    lastModified: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                if (isFestival) {
                    dataToSave.festivalResults = window.festivalResults || {};
                }

                await setDoc(doc(db, `events/${eventId}/brackets`, docId), dataToSave);

                console.log("‚úÖ Save successful:", path);
                label.innerText = "TERSIMPAN! ‚úÖ";
                setTimeout(() => { label.innerText = "SIMPAN & SELESAI"; }, 2000);
            } catch (err) {
                console.error("‚ùå Save failed:", err);
                alert("Gagal menyimpan bagan: " + err.message);
                label.innerText = "GAGAL SIMPAN ‚ùå";
            } finally {
                btn.disabled = false;
            }
        }

        async function fetchSavedBracket(className) {
            if (!eventId || !className || !svgDoc) return;

            // Try fetching by classCode first, fallback to className
            const docId = currentClassCode || className;
            let snap = await getDoc(doc(db, `events/${eventId}/brackets`, docId));

            if (!snap.exists() && currentClassCode) {
                // Try legacy className fallback
                snap = await getDoc(doc(db, `events/${eventId}/brackets`, className));
            }

            if (snap.exists()) {
                const cloudData = snap.data();
                const saved = cloudData.data;
                const cloudParticipants = cloudData.participants;
                const cloudIsDrawn = cloudData.isDrawn;
                const isFestival = (className || "").toString().toUpperCase().startsWith('F');

                console.log(`‚òÅÔ∏è Cloud data found for "${className}":`, {
                    participantsCount: cloudParticipants?.length || 0,
                    isDrawn: cloudIsDrawn,
                    svgKeysCount: Object.keys(saved || {}).length,
                    isFestival: isFestival,
                    festivalResultsKeys: isFestival ? Object.keys(cloudData.festivalResults || {}).length : 0
                });

                // Restore festival results if any
                if (isFestival) {
                    window.festivalResults = cloudData.festivalResults || {};
                }

                // 1. Data Integrity Check: Compare Saved with Current Athletes
                const currentAthletes = [...participants]; // 'participants' here is from loadEventContext (latest athletes)
                const savedParticipants = cloudParticipants || [];

                let isDataValid = true;
                if (savedParticipants.length !== currentAthletes.length) {
                    isDataValid = false;
                } else {
                    // Cek detail nama & team
                    const currentKeys = currentAthletes.map(a => `${a.name}|${a.team}`).sort();
                    const savedKeys = savedParticipants.map(a => `${a.name}|${a.team}`).sort();
                    if (JSON.stringify(currentKeys) !== JSON.stringify(savedKeys)) {
                        isDataValid = false;
                    }
                }

                if (!isDataValid) {
                    console.warn("‚ö†Ô∏è Data mismatch detected! Saved bracket is outdated.");
                    window.isBracketDrawn = false;
                    // Keep participants from loadEventContext
                } else {
                    // Restore exact order from cloud if valid
                    participants = savedParticipants;
                    window.isBracketDrawn = cloudIsDrawn || false;
                    console.log(`‚úÖ Restored ${participants.length} participants from cloud (Data Valid)`);
                }

                // Update UI state based on validation
                document.getElementById('manualNames').value = participants.map((p, i) => `${i + 1}. ${p.name} [${p.team}]`).join('\n');
                document.getElementById('participantCount').value = participants.length;

                if (participants.length > 0 && participants[0].members) {
                    renderMagicTeams(participants);
                }

                renderAthleteList();

                if (!isDataValid && window.isBracketDrawn === false) {
                    const label = document.getElementById('saveStatus');
                    if (label) {
                        label.innerText = "‚ö†Ô∏è PERLU REVISI";
                        label.classList.add('text-red-500');
                    }
                    console.log("Setting REVISI status for outdated bracket");
                }

                // 2. ALWAYS Redraw if we found cloud data to ensure names are filled
                await generateBracket();

                // 3. Restore ALL SVG Text from cloud (scores, winners, etc.)
                if (saved && svgDoc) {
                    console.log(`üì• Restoring ${Object.keys(saved).length} SVG elements from cloud:`);
                    Object.entries(saved).forEach(([id, text]) => {
                        // Support both Logical and SVG IDs in storage
                        const logicalId = getLogicalIdFromSVGId(id) || id;
                        const components = getComponentsForSlot(logicalId);
                        const targetId = (components && components.length > 0) ? components[0] : id;

                        const el = svgDoc.getElementById(targetId);
                        if (el) {
                            const tspan = el.querySelector('tspan') || el;
                            tspan.textContent = text;
                            el.style.opacity = "1";
                            console.log(`  üìù #${targetId} (via ${id}) ‚Üê "${text}"`);
                            // Highlight winners
                            if (!targetId.startsWith('p_') && !targetId.startsWith('qn') && !targetId.startsWith('Nama_') && !targetId.startsWith('Kelas_') && !targetId.startsWith('tanggal') && !targetId.startsWith('durasi') && !targetId.startsWith('tatami') && !targetId.startsWith('pool')) {
                                el.setAttribute('fill', '#f87171');
                            }
                        } else {
                            console.warn(`  ‚ö†Ô∏è Element #${targetId} (from ${id}) not found in SVG`);
                        }
                    });
                    console.log(`‚úÖ Restored ${Object.keys(saved).length} SVG text elements`);
                }

                const label = document.getElementById('saveStatus');
                if (label) label.innerText = "LOADED FROM CLOUD ‚òÅÔ∏è";
                setTimeout(() => { if (label) label.innerText = "SIMPAN & SELESAI"; }, 2000);
            } else {
                console.log(`‚ÑπÔ∏è No cloud data for "${className}"`);
            }
        }

        async function exportToPremium(format = 'pdf', event) {
            const area = document.getElementById('bracketVisualArea');
            if (!area) {
                alert("Data bagan belum siap.");
                return;
            }

            const isFestival = (currentClassCode || "").toString().toUpperCase().startsWith('F');

            // Gunakan event.currentTarget agar lebih aman (elemen button itu sendiri)
            const btn = (event && (event.currentTarget || event.target)) || null;
            const originalText = btn ? btn.innerHTML : "EXPORT";

            if (btn) {
                btn.innerHTML = "PREPARING... ‚è≥";
                btn.disabled = true;
            }

            // Simpan status class asli
            const originalClasses = area.className;
            const originalStyle = area.getAttribute('style');

            try {
                if (isFestival) {
                    // Optimized for Festival Table Capture
                    area.classList.remove('w-full', 'h-full', 'flex', 'items-center', 'justify-center');
                    area.style.width = '1200px'; // Wide enough for the table
                    area.style.height = 'auto';
                    area.style.display = 'block';
                    area.style.background = '#ffffff';
                } else {
                    // TRIK 'Shrink-to-Fit' for SVG
                    area.classList.remove('w-full', 'h-full', 'flex', 'items-center', 'justify-center');
                    area.style.display = 'inline-block';
                    area.style.width = 'auto';
                    area.style.height = 'auto';
                }

                const capture = await html2canvas(area, {
                    backgroundColor: '#ffffff',
                    scale: 3,
                    useCORS: true,
                    logging: false
                });

                const imgData = capture.toDataURL('image/png');

                if (format === 'pdf') {
                    const { jsPDF } = window.jspdf;
                    const pdfWidthMm = 330; // F4 Width (Landscape roughly)
                    const pdfHeightMm = 210;
                    const pdf = new jsPDF('l', 'mm', [pdfWidthMm, pdfHeightMm]);

                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidthMm, pdfHeightMm);
                    pdf.save(`Kensho_Bagan_${currentClass}_${new Date().getTime()}.pdf`);
                }

            } catch (err) {
                console.error("Export failed:", err);
                alert("Gagal ekspor: " + (err ? (err.message || err.toString()) : "Unknown Error"));
            } finally {
                // Kembalikan tampilan browser ke semula
                area.className = originalClasses;
                if (originalStyle) area.setAttribute('style', originalStyle);
                else area.removeAttribute('style');

                if (btn) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        }

        window.handlePreviewFestival = async () => {
            const btn = document.getElementById('btnPreviewFestival');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = 'GATHERING DATA... ‚è≥';
            btn.disabled = true;

            try {
                // 1. Get All Festival Classes
                const qClasses = query(collection(db, `events/${eventId}/classes`), orderBy("code", "asc"));
                const classSnap = await getDocs(qClasses);
                const allFestivalClasses = [];
                classSnap.forEach(s => {
                    const d = s.data();
                    if ((d.code || "").toString().toUpperCase().startsWith('F')) {
                        allFestivalClasses.push(d);
                    }
                });

                if (allFestivalClasses.length === 0) {
                    alert("Tidak ada kelas Festival yang ditemukan.");
                    return;
                }

                // 2. Get All Athletes for the event (to ensure we have data for all classes)
                const qAthletes = query(collection(db, `events/${eventId}/athletes`));
                const athleteSnap = await getDocs(qAthletes);
                const allAthletes = [];
                athleteSnap.forEach(s => allAthletes.push(s.data()));

                // 3. Get All Saved Brackets
                const qBrackets = query(collection(db, `events/${eventId}/brackets`));
                const bracketSnap = await getDocs(qBrackets);
                const bracketsMap = {};
                bracketSnap.forEach(s => {
                    const d = s.data();
                    bracketsMap[d.class] = d;
                });

                // 4. Call Print Module
                const eventDoc = await getDoc(doc(db, "events", eventId));
                const eventData = eventDoc.data();

                prepareBracketPrint(allAthletes, allFestivalClasses, eventData.name, eventData.logo, bracketsMap);

            } catch (err) {
                console.error("Preview failed:", err);
                alert("Gagal memuat pratinjau: " + err.message);
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        };

        let selectedAthleteIndex = null;



        function smartDrawParticipants() {
            if (participants.length < 2) return;
            window.isBracketDrawn = true;

            const isFestival = (currentClassCode || "").toString().toUpperCase().startsWith('F');

            // 1. Group by Kontingen
            const groups = {};
            participants.forEach(p => {
                const t = p.team || "-";
                if (!groups[t]) groups[t] = [];
                groups[t].push(p);
            });

            if (isFestival) {
                // LOGIKA FESTIVAL: Priority Separation (Greedy Pairing)
                let newOrder = [];
                const sortedTeamNames = Object.keys(groups).sort((a, b) => groups[b].length - groups[a].length);

                // Copy members to work with them
                const teamQueues = {};
                sortedTeamNames.forEach(name => {
                    teamQueues[name] = [...groups[name]].sort(() => Math.random() - 0.5);
                });

                let pool = [];
                // Process largest team first against others
                const mainTeamName = sortedTeamNames[0];
                const mainQueue = teamQueues[mainTeamName];

                // Gather all other athletes
                let otherAthletes = [];
                for (let i = 1; i < sortedTeamNames.length; i++) {
                    otherAthletes = otherAthletes.concat(teamQueues[sortedTeamNames[i]]);
                }
                // Shuffle others to randomize pairings
                otherAthletes.sort(() => Math.random() - 0.5);

                // Pair Main Team with Others
                while (mainQueue.length > 0 && otherAthletes.length > 0) {
                    newOrder.push(mainQueue.pop());
                    newOrder.push(otherAthletes.shift());
                }

                // If main team still has athletes, they get BYE (paired with null)
                while (mainQueue.length > 0) {
                    newOrder.push(mainQueue.pop());
                    newOrder.push(null); // BYE
                }

                // If other teams still have athletes, pair them among themselves
                while (otherAthletes.length > 0) {
                    newOrder.push(otherAthletes.shift());
                    if (otherAthletes.length > 0) {
                        newOrder.push(otherAthletes.shift());
                    } else {
                        newOrder.push(null); // BYE
                    }
                }

                participants = newOrder.filter(p => p !== null);
            } else {
                // LOGIKA PRESTASI (Eksisting): Split Top & Bottom
                const total = participants.length;
                const mid = Math.floor(total / 2);

                let newOrder = new Array(total).fill(null);
                let topAvailable = Array.from({ length: mid }, (_, i) => i);
                let bottomAvailable = Array.from({ length: total - mid }, (_, i) => i + mid);

                const sortedTeams = Object.keys(groups).sort((a, b) => {
                    if (a === window.hostKontingen) return -1;
                    if (b === window.hostKontingen) return 1;
                    return groups[b].length - groups[a].length;
                });

                sortedTeams.forEach(team => {
                    const members = groups[team].sort(() => Math.random() - 0.5);
                    const toTopCount = Math.floor(members.length / 2);
                    const toBottomCount = members.length - toTopCount;

                    for (let i = 0; i < toTopCount; i++) {
                        if (topAvailable.length > 0) newOrder[topAvailable.shift()] = members.pop();
                        else if (bottomAvailable.length > 0) newOrder[bottomAvailable.shift()] = members.pop();
                    }
                    for (let i = 0; i < toBottomCount; i++) {
                        if (bottomAvailable.length > 0) newOrder[bottomAvailable.shift()] = members.pop();
                        else if (topAvailable.length > 0) newOrder[topAvailable.shift()] = members.pop();
                    }
                });
                participants = newOrder.filter(p => p !== null);
            }

            document.getElementById('manualNames').value = participants.map((a, i) => `${i + 1}. ${a.name} [${a.team}]`).join('\n');
            generateBracket();
        }

        function handleAthleteClick(index) {
            if (selectedAthleteIndex === null) {
                // First selection
                selectedAthleteIndex = index;
                renderAthleteList(); // Re-render to show active state
            } else {
                // Second selection - SWAP
                if (selectedAthleteIndex !== index) {
                    window.isBracketDrawn = true;
                    const temp = participants[selectedAthleteIndex];
                    participants[selectedAthleteIndex] = participants[index];
                    participants[index] = temp;

                    document.getElementById('manualNames').value = participants.map((a, i) => `${i + 1}. ${a.name} [${a.team}]`).join('\n');
                    generateBracket();
                }
                selectedAthleteIndex = null;
                renderAthleteList();
            }
        }

        function renderAthleteList() {
            const list = document.getElementById('athleteTags');
            const totalLabel = document.getElementById('athleteTotalLabel');
            if (!list || !totalLabel) return;

            list.innerHTML = '';
            totalLabel.innerText = `${participants.length} ATLET`;

            // Reset list container class for match-based layout
            list.className = "flex flex-col gap-4 max-h-[600px] overflow-y-auto p-2 custom-scrollbar";

            // Calculation for Conflict Detection
            const groups = {};
            participants.forEach(p => {
                const t = p.team || "-";
                if (!groups[t]) groups[t] = [];
                groups[t].push(p);
            });
            const totalAthletes = participants.length;

            for (let i = 0; i < participants.length; i += 2) {
                const matchIndex = Math.floor(i / 2) + 1;

                // Pair Logic
                const aka = participants[i];
                const ao = participants[i + 1];

                const isSameTeam = aka && ao && aka.team === ao.team && aka.team !== "-";
                const isForced = isSameTeam && (groups[aka.team].length > Math.ceil(totalAthletes / 2));
                const matchConflict = isSameTeam && !isForced;

                const matchDiv = document.createElement('div');
                matchDiv.className = `p-4 rounded-[2rem] border-2 transition-all ${matchConflict ? 'bg-red-50/50 border-red-200' : 'bg-slate-50/50 border-slate-100'} flex flex-col gap-3`;

                let html = `
                    <div class="flex justify-between items-center px-4">
                        <span class="text-[9px] font-black ${matchConflict ? 'text-red-500' : 'text-slate-400'} uppercase tracking-[0.3em]">PARTAI #${matchIndex} ${matchConflict ? '‚ö†Ô∏è BENTROK KONTINGEN' : ''}</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                `;

                // Sub-function to render Card
                const getCardHTML = (idx, label, colorClass) => {
                    const athlete = participants[idx];
                    if (!athlete) return `<div class="p-4 border-2 border-dashed border-slate-200 rounded-2xl flex items-center justify-center text-[10px] font-black opacity-20 uppercase italic">BYE / KOSONG</div>`;

                    const isSelected = selectedAthleteIndex === idx;
                    let cardBorder = isSelected ? 'border-blue-500 shadow-lg scale-[1.02]' : 'border-slate-200';
                    let cardBg = isSelected ? 'bg-blue-50' : 'bg-white';

                    return `
                        <div onclick="window.handleAthleteClick(${idx})" class="p-4 rounded-2xl border-2 ${cardBorder} ${cardBg} cursor-pointer transition-all hover:border-blue-400 relative group">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-[8px] font-black ${colorClass} uppercase tracking-widest">${label}</span>
                                <span class="text-[10px] font-black text-slate-300 italic">#${(idx + 1).toString().padStart(2, '0')}</span>
                            </div>
                            <div class="text-[11px] font-black text-slate-800 uppercase italic truncate">${athlete.name}</div>
                            <div class="text-[9px] font-bold text-slate-400 uppercase tracking-widest truncate">${athlete.team}</div>
                        </div>
                    `;
                };

                html += `
                        <div class="relative">
                            ${getCardHTML(i, "AKA (MERAH)", "text-red-500")}
                        </div>
                        <div class="relative">
                            <div class="absolute -left-6 top-1/2 -translate-y-1/2 hidden md:flex w-8 h-8 rounded-full bg-slate-200 border-4 border-slate-50 items-center justify-center text-[8px] font-black text-slate-500 z-10">VS</div>
                            ${getCardHTML(i + 1, "AO (BIRU)", "text-blue-500")}
                        </div>
                    </div>
                `;

                matchDiv.innerHTML = html;
                list.appendChild(matchDiv);
            }
        }

        let currentStep2Tab = 'text';
        function switchStep2Tab(tab) {
            currentStep2Tab = tab;
            const textTab = document.getElementById('step2TabText');
            const visualTab = document.getElementById('step2TabVisual');
            const magicTab = document.getElementById('step2TabMagic');
            const textBtn = document.getElementById('tabBtnText');
            const visualBtn = document.getElementById('tabBtnVisual');
            const magicBtn = document.getElementById('tabBtnMagic');

            // Hide all tabs
            [textTab, visualTab, magicTab].forEach(t => t && (t.style.display = 'none'));

            // Reset all buttons style
            [textBtn, visualBtn, magicBtn].forEach(btn => {
                if (btn) {
                    btn.classList.remove('bg-white', 'text-blue-600', 'shadow-md');
                    btn.classList.add('text-slate-400');
                    btn.classList.remove('text-blue-600');
                }
            });

            if (tab === 'text') {
                textTab.style.display = 'block';
                textBtn.classList.add('bg-white', 'text-blue-600', 'shadow-md');
                textBtn.classList.remove('text-slate-400');
            } else if (tab === 'visual') {
                visualTab.style.display = 'block';
                visualBtn.classList.add('bg-white', 'text-blue-600', 'shadow-md');
                visualBtn.classList.remove('text-slate-400');
            } else if (tab === 'magic') {
                magicTab.style.display = 'block';
                magicBtn.classList.add('bg-white', 'text-blue-600', 'shadow-md');
                magicBtn.classList.remove('text-slate-400');
            }
        }

        function shortenName(fullName) {
            if (!fullName) return "";

            // Bersihkan nama dari spasi berlebih dan ubah ke UPPERCASE
            const name = fullName.trim().toUpperCase().replace(/\s+/g, ' ');
            const words = name.split(' ');

            if (words.length <= 1) return name;

            // Daftar prefiks yang umum disingkat
            const prefixes = ["MUHAMMAD", "MUHAMAD", "MUH", "MOCH", "MOH", "M"];
            let firstWord = words[0].replace(/\.$/, ''); // Hilangkan titik jika ada
            let isPrefix = prefixes.includes(firstWord);

            if (isPrefix) {
                // Aturan Prefiks: M + Kata Kedua Utuh + Sisanya Inisial
                // Contoh: M ADITYA PRASWORO -> M ADITYA P
                let result = "M";
                if (words.length >= 2) {
                    result += " " + words[1];
                }
                for (let i = 2; i < words.length; i++) {
                    const initial = words[i][0];
                    if (initial) result += " " + initial;
                }
                return result;
            } else {
                // Aturan Non-Prefiks: Kata Pertama Utuh + Sisanya Inisial
                // Contoh: ANANDA PUJANGGA RESTU PERTIWI -> ANANDA P R P
                let result = words[0];
                for (let i = 1; i < words.length; i++) {
                    const initial = words[i][0];
                    if (initial) result += " " + initial;
                }
                return result;
            }
        }

        function getFirstName(fullName) {
            if (!fullName) return "";
            // Ambil kata pertama, bersihkan dari angka atau simbol, dan ubah ke UPPERCASE
            return fullName.trim().split(' ')[0].split('-')[0].replace(/[^a-zA-Z]/g, '').toUpperCase();
        }

        window.groupAthletesByTeamMagic = () => {
            if (participants.length === 0) {
                alert("Tidak ada data atlet untuk diproses.");
                return;
            }

            // Group by Kontingen
            const groups = {};
            participants.forEach(p => {
                const t = p.team || "-";
                if (!groups[t]) groups[t] = [];
                groups[t].push(p);
            });

            const magicTeams = [];
            Object.keys(groups).forEach(teamName => {
                const members = groups[teamName];
                // Split into groups of 3
                for (let i = 0; i < members.length; i += 3) {
                    const chunk = members.slice(i, i + 3);
                    const teamNum = Math.floor(i / 3) + 1;

                    // Format: Team Dominores 1 - AFIF, RIZAL, RONAL
                    const namesStr = chunk.map(m => getFirstName(m.name)).join(', ');
                    const formattedTeamName = `TEAM ${teamName} ${teamNum} - ${namesStr}`;

                    magicTeams.push({
                        name: formattedTeamName,
                        team: teamName,
                        members: chunk
                    });
                }
            });

            // Update global participants with these teams
            participants = JSON.parse(JSON.stringify(magicTeams));
            window.isBracketDrawn = true; // Mark as drawn so names appear

            // Sync to textarea & UI
            document.getElementById('manualNames').value = participants.map((p, i) => `${i + 1}. ${p.name}`).join('\n');
            document.getElementById('participantCount').value = participants.length;

            renderMagicTeams(magicTeams);
            renderAthleteList();
            generateBracket();

            alert(`ü™Ñ Magic Berhasil! ${magicTeams.length} Tim telah terbentuk.`);
        };

        function renderMagicTeams(teams) {
            const container = document.getElementById('magicTeamList');
            if (!container) return;
            container.innerHTML = '';

            teams.forEach((t, i) => {
                const card = document.createElement('div');
                card.className = "neu-flat p-6 rounded-2xl border border-white/5 flex flex-col gap-3 group hover:border-blue-500/30 transition-all";
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <span class="text-[9px] font-black text-blue-500 uppercase tracking-widest">TIM #${i + 1}</span>
                        <span class="text-[8px] font-bold opacity-30 italic truncate max-w-[100px]">${t.team}</span>
                    </div>
                    <div class="text-sm font-black text-slate-200 leading-tight">${t.name}</div>
                    <div class="flex flex-wrap gap-2 mt-4">
                        ${t.members.map(m => `<span class="px-3 py-1.5 rounded-xl bg-white/5 text-[9px] font-black text-blue-400 uppercase tracking-widest border border-blue-500/10">${getFirstName(m.name)}</span>`).join('')}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updateBracketTextSizes() {
            const nameEl = document.getElementById('fontSizeName');
            const teamEl = document.getElementById('fontSizeTeam');
            if (!nameEl || !teamEl) return;

            const nameSize = nameEl.value;
            const teamSize = teamEl.value;

            document.getElementById('fontSizeNameVal').innerText = nameSize + "PX";
            document.getElementById('fontSizeTeamVal').innerText = teamSize + "PX";

            // Preview pada SVG
            const nodes = document.querySelectorAll('text');
            nodes.forEach(node => {
                const id = node.id || "";
                // Match qn1, q_n_1, p_n_1, etc.
                if (id.match(/^(([qsf]_?)?n_?|p_n_)\d+$/)) {
                    node.style.fontSize = nameSize + "px";
                }
                // Match qk1, q_k_1, p_k_1, etc.
                else if (id.match(/^(([qsf]_?)?k_?|p_k_)\d+$/)) {
                    node.style.fontSize = teamSize + "px";
                }
            });
        }

        // Export all functions to global scope (MUST be after all function definitions)
        window.loadSVG = loadSVG;
        window.setupSVGInteractivity = setupSVGInteractivity;
        window.generateBracket = generateBracket;
        window.handleWinnerClick = handleWinnerClick;
        window.handleExcelUpload = handleExcelUpload;
        window.resetBracket = resetBracket;
        window.saveBracket = saveBracket;
        window.fetchSavedBracket = fetchSavedBracket;
        window.exportToPremium = exportToPremium;
        window.smartDrawParticipants = smartDrawParticipants;
        window.handleAthleteClick = handleAthleteClick;
        window.renderAthleteList = renderAthleteList;
        window.switchStep2Tab = switchStep2Tab;
        window.updateBracketTextSizes = updateBracketTextSizes;
        window.groupAthletesByTeamMagic = groupAthletesByTeamMagic;
        window.renderMagicTeams = renderMagicTeams;

        // NOTE: Initial loading is handled by loadEventContext() 
        // which is called from the auth state listener below
        // DO NOT add window.onload handler here as it will conflict!

    </script>
</body>

</html>