<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Kelas Pertandingan - Kensho Tech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/scoring.css">
    <style>
        body {
            background-color: #020617;
            color: #f8fafc;
            font-family: 'Plus Jakarta Sans', sans-serif;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .search-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: #ef4444;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
            outline: none;
        }

        .tab-btn {
            padding: 0.75rem 2rem;
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            border-radius: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            color: #64748b;
            transition: all 0.3s;
            cursor: pointer;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #94a3b8;
        }

        .tab-btn.active {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.2);
        }

        .class-card {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }

        .class-card:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .class-header {
            padding: 1.5rem 2rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .participants-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .participants-list.expanded {
            max-height: 2000px;
            transition: max-height 0.5s ease-in;
        }

        .participant-row {
            padding: 1rem 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.03);
            display: grid;
            grid-template-columns: 2fr 1fr 2fr auto;
            gap: 1rem;
            align-items: center;
        }

        .participant-row:hover {
            background: rgba(239, 68, 68, 0.03);
        }

        .kata-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            color: #f8fafc;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .kata-input:focus {
            outline: none;
            border-color: #ef4444;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.2);
        }

        .kata-input::placeholder {
            color: #475569;
        }

        .round-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            font-size: 9px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border-radius: 0.5rem;
            border: 1px solid;
        }

        .round-penyisihan {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
            color: #3b82f6;
        }

        .round-penyisihan_2 {
            background: rgba(168, 85, 247, 0.1);
            border-color: rgba(168, 85, 247, 0.3);
            color: #a855f7;
        }

        .round-semifinal {
            background: rgba(234, 179, 8, 0.1);
            border-color: rgba(234, 179, 8, 0.3);
            color: #eab308;
        }

        .round-final {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .save-btn {
            padding: 0.5rem 1.5rem;
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            font-size: 9px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .save-btn:hover {
            background: rgba(239, 68, 68, 0.25);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
        }

        .save-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #020617;
        }

        ::-webkit-scrollbar-thumb {
            background: #1e293b;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #334155;
        }

        .shimmer-text {
            background: linear-gradient(90deg, #f8fafc 0%, #ef4444 50%, #f8fafc 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shine 3s linear infinite;
        }

        @keyframes shine {
            to {
                background-position: 200% center;
            }
        }

        .loading-shimmer {
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.03) 25%, rgba(255, 255, 255, 0.08) 50%, rgba(255, 255, 255, 0.03) 75%);
            background-size: 400% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% {
                background-position: 100% 0;
            }

            100% {
                background-position: -100% 0;
            }
        }

        .expand-icon {
            transition: transform 0.3s;
        }

        .expand-icon.rotated {
            transform: rotate(180deg);
        }
    </style>
</head>

<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto space-y-8">
        <!-- Aurora Background -->
        <div id="aurora-container"
            style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.3;">
            <div class="aurora aurora-1"></div>
            <div class="aurora aurora-2"></div>
            <div class="aurora aurora-3"></div>
        </div>

        <!-- HEADER -->
        <div class="flex flex-col md:flex-row md:items-end justify-between gap-6">
            <div>
                <a href="javascript:history.back()"
                    class="inline-flex items-center gap-2 text-[10px] font-black uppercase tracking-widest text-slate-500 hover:text-red-500 transition-colors mb-4">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
                    </svg>
                    Kembali
                </a>
                <h1 class="text-4xl font-black italic tracking-tighter uppercase leading-none shimmer-text mb-2">
                    Daftar Kelas Tanding
                </h1>
                <p id="eventTitle" class="text-xs font-bold uppercase tracking-widest text-slate-500 opacity-60">
                    Memuat data event...
                </p>
            </div>

            <div class="flex flex-col gap-4 min-w-[320px]">
                <div class="relative">
                    <input type="text" id="globalSearch" placeholder="Cari nama kelas..."
                        class="w-full search-input py-4 px-14 rounded-2xl text-sm font-bold tracking-wider placeholder:text-slate-600">
                    <svg class="absolute left-5 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-500" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
            </div>
        </div>

        <!-- LIST PESERTA SECTION -->
        <div class="glass-card rounded-[2.5rem] overflow-hidden p-8">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-black italic tracking-tight uppercase text-white mb-1">List Peserta</h2>
                    <p class="text-[9px] font-bold uppercase tracking-widest text-slate-500">Semua Peserta Per Kelas</p>
                </div>
                <div class="flex items-center gap-4">
                    <select id="classFilter"
                        class="search-input py-3 px-6 rounded-xl text-[10px] font-bold uppercase tracking-wider">
                        <option value="">Semua Kelas</option>
                    </select>
                    <span id="participantCount"
                        class="text-xs font-bold text-slate-400 bg-white/5 px-4 py-2 rounded-full border border-white/5">
                        0 Peserta
                    </span>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-white/10">
                            <th
                                class="text-left py-4 px-4 text-[9px] font-black uppercase tracking-[0.2em] text-slate-500">
                                No</th>
                            <th
                                class="text-left py-4 px-4 text-[9px] font-black uppercase tracking-[0.2em] text-slate-500">
                                Nama Atlet</th>
                            <th
                                class="text-left py-4 px-4 text-[9px] font-black uppercase tracking-[0.2em] text-slate-500">
                                Kontingen</th>
                            <th
                                class="text-left py-4 px-4 text-[9px] font-black uppercase tracking-[0.2em] text-slate-500">
                                Kelas</th>
                            <th
                                class="text-center py-4 px-4 text-[9px] font-black uppercase tracking-[0.2em] text-slate-500">
                                Babak</th>
                            <th
                                class="text-center py-4 px-4 text-[9px] font-black uppercase tracking-[0.2em] text-slate-500">
                                Status</th>
                        </tr>
                    </thead>
                    <tbody id="participantTableBody">
                        <tr>
                            <td colspan="6"
                                class="py-12 text-center text-[10px] font-bold uppercase tracking-widest text-slate-600">
                                <div class="loading-shimmer h-12 w-full rounded-xl"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- DIVIDER -->
        <div class="flex items-center gap-4 my-4">
            <div class="flex-1 h-px bg-white/10"></div>
            <span class="text-[9px] font-black uppercase tracking-[0.3em] text-slate-600">Kata Input</span>
            <div class="flex-1 h-px bg-white/10"></div>
        </div>

        <!-- TAB SYSTEM -->
        <div class="flex gap-4">
            <button id="tab-active" class="tab-btn active" onclick="switchTab('active')">
                Active Participants
            </button>
            <button id="tab-history" class="tab-btn" onclick="switchTab('history')">
                History
            </button>
        </div>

        <!-- CONTENT AREA -->
        <div class="glass-card rounded-[2.5rem] overflow-hidden">
            <div id="classContainer" class="max-h-[70vh] overflow-y-auto custom-scrollbar">
                <!-- Loading state -->
                <div id="loadingState" class="p-10 space-y-4">
                    <div class="h-20 w-full loading-shimmer rounded-2xl"></div>
                    <div class="h-20 w-full loading-shimmer rounded-2xl"></div>
                    <div class="h-20 w-full loading-shimmer rounded-2xl"></div>
                </div>
            </div>
        </div>

        <p class="text-[9px] text-center font-black text-slate-600 uppercase tracking-[0.4em] py-8">
            Kensho Tech Tournament Management System &copy; 2026
        </p>
    </div>

    <script type="module">
        import { db } from './js/firebase-init.js';
        import { collection, query, orderBy, onSnapshot, getDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- DATA & STATE ---
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('id');
        let classes = [];
        let athletes = [];
        let currentTab = 'active';
        let expandedClasses = new Set();

        // --- INITIALIZATION ---
        if (!eventId) {
            document.body.innerHTML = `
                <div class="h-screen flex items-center justify-center text-center p-8 bg-[#020617]">
                    <div class="glass-card p-12 rounded-[3rem] border-red-500/20">
                        <div class="w-20 h-20 bg-red-500/10 rounded-3xl flex items-center justify-center mx-auto mb-8 shadow-[0_0_50px_rgba(239,68,68,0.2)]">
                            <svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                        </div>
                        <h1 class="text-2xl font-black uppercase tracking-widest text-white mb-4 italic">Konteks Event Hilang</h1>
                        <p class="text-slate-400 max-w-sm mx-auto mb-10 leading-relaxed">System tidak menemukan ID Event. Silakan buka halaman ini melalui Dashboard Event atau Hub Scoring.</p>
                        <a href="javascript:history.back()" class="inline-block py-4 px-12 bg-red-600 text-white text-[10px] font-black uppercase tracking-[0.2em] rounded-2xl shadow-[0_10px_30px_rgba(220,38,38,0.3)] hover:scale-105 transition-all">Kembali</a>
                    </div>
                </div>
            `;
            throw new Error("Missing Event ID");
        }

        const fetchEventDetails = async () => {
            try {
                const eventDoc = await getDoc(doc(db, "events", eventId));
                if (eventDoc.exists()) {
                    document.getElementById('eventTitle').innerText = eventDoc.data().name + " - Kata List";
                }
            } catch (err) { console.error(err); }
        };

        const syncData = () => {
            // Listen to classes
            const qClasses = query(collection(db, `events/${eventId}/classes`), orderBy("name", "asc"));
            onSnapshot(qClasses, (snapshot) => {
                classes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateView();
                populateClassFilter();
            });

            // Listen to athletes
            const qAthletes = query(collection(db, `events/${eventId}/athletes`), orderBy("name", "asc"));
            onSnapshot(qAthletes, (snapshot) => {
                athletes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateView();
                updateParticipantList();
                populateClassFilter();
            });
        };

        // --- RENDER FUNCTIONS ---
        const updateView = () => {
            const container = document.getElementById('classContainer');
            const loadingState = document.getElementById('loadingState');
            const searchValue = document.getElementById('globalSearch').value.toLowerCase();

            // Hide loading
            if (loadingState) {
                loadingState.remove();
            }

            // Filter classes
            const filteredClasses = classes.filter(c =>
                c.name.toLowerCase().includes(searchValue) ||
                c.ageCategory.toLowerCase().includes(searchValue)
            );

            if (filteredClasses.length === 0) {
                container.innerHTML = `<div class="py-24 text-center text-[11px] font-black uppercase tracking-[0.3em] text-slate-600 italic">Tidak ada kelas tanding ditemukan</div>`;
                return;
            }

            container.innerHTML = filteredClasses.map(c => {
                // Get athletes for this class
                const classAthletes = athletes.filter(a => a.className === c.name);

                // Filter by tab (active or eliminated)
                const filteredAthletes = classAthletes.filter(a => {
                    const status = a.tournamentStatus || 'active';
                    if (currentTab === 'active') {
                        return status === 'active';
                    } else {
                        return status === 'eliminated' || status === 'champion';
                    }
                });

                const isExpanded = expandedClasses.has(c.id);

                return `
                    <div class="class-card">
                        <div class="class-header" onclick="toggleClass('${c.id}')">
                            <div>
                                <h3 class="text-xl font-black italic tracking-tight text-slate-100 uppercase">${c.name}</h3>
                                <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest mt-1">${c.ageCategory} â€¢ ${c.gender}</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="text-xs font-bold text-slate-400 bg-white/5 px-4 py-1.5 rounded-full border border-white/5">
                                    ${filteredAthletes.length} Peserta
                                </span>
                                <svg class="w-5 h-5 text-slate-500 expand-icon ${isExpanded ? 'rotated' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </div>
                        <div id="participants-${c.id}" class="participants-list ${isExpanded ? 'expanded' : ''}">
                            ${filteredAthletes.length === 0
                        ? `<div class="py-12 text-center text-[10px] font-bold uppercase tracking-widest text-slate-600">Tidak ada peserta ${currentTab === 'active' ? 'aktif' : 'di history'}</div>`
                        : filteredAthletes.map(a => renderParticipantRow(a)).join('')
                    }
                        </div>
                    </div>
                `;
            }).join('');
        };

        const renderParticipantRow = (athlete) => {
            const round = athlete.currentRound || 'penyisihan';
            const kataValue = athlete.kataChoices?.[round] || '';
            const isActive = (athlete.tournamentStatus || 'active') === 'active';

            return `
                <div class="participant-row">
                    <div>
                        <p class="text-sm font-black uppercase text-slate-100">${athlete.name}</p>
                        <p class="text-[9px] font-bold text-slate-500 uppercase tracking-wider mt-0.5">${athlete.team}</p>
                    </div>
                    <div>
                        <span class="round-badge round-${round}">
                            ${getRoundLabel(round)}
                        </span>
                    </div>
                    ${isActive ? `
                        <input type="text" 
                               value="${kataValue}"
                               placeholder="Masukkan nama kata..." 
                               data-athlete-id="${athlete.id}" 
                               data-round="${round}"
                               class="kata-input" 
                               onchange="markKataChanged(this)" />
                        <button onclick="saveKata('${athlete.id}', '${round}')" 
                                id="save-btn-${athlete.id}"
                                class="save-btn" 
                                disabled>
                            Simpan
                        </button>
                    ` : `
                        <div class="text-[10px] font-bold text-slate-600 uppercase tracking-wider">
                            ${kataValue || '-'}
                        </div>
                        <div class="text-[9px] font-black uppercase tracking-widest ${athlete.tournamentStatus === 'champion' ? 'text-yellow-500' : 'text-slate-600'}">
                            ${athlete.tournamentStatus === 'champion' ? 'Champion' : 'Eliminated'}
                        </div>
                    `}
                </div>
            `;
        };

        const getRoundLabel = (round) => {
            const labels = {
                'penyisihan': 'Penyisihan 1',
                'penyisihan_2': 'Penyisihan 2',
                'semifinal': 'Semi-Final',
                'final': 'Final'
            };
            return labels[round] || 'Penyisihan 1';
        };

        // --- PARTICIPANT LIST FUNCTIONS ---
        const updateParticipantList = () => {
            const tableBody = document.getElementById('participantTableBody');
            const classFilterValue = document.getElementById('classFilter').value;

            // Filter athletes by class
            let filteredAthletes = athletes;
            if (classFilterValue) {
                filteredAthletes = athletes.filter(a => a.className === classFilterValue);
            }

            // Update count
            document.getElementById('participantCount').innerText = `${filteredAthletes.length} Peserta`;

            if (filteredAthletes.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="py-12 text-center text-[10px] font-bold uppercase tracking-widest text-slate-600">
                            Tidak ada peserta ditemukan
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = filteredAthletes.map((athlete, index) => {
                const round = athlete.currentRound || 'penyisihan';
                const status = athlete.tournamentStatus || 'active';
                const statusLabel = status === 'champion' ? 'Champion' : status === 'eliminated' ? 'Eliminated' : 'Active';
                const statusColor = status === 'champion' ? 'text-yellow-500' : status === 'eliminated' ? 'text-red-500' : 'text-green-500';

                return `
                    <tr class="border-b border-white/5 hover:bg-white/5 transition-colors">
                        <td class="py-4 px-4 text-[11px] font-bold text-slate-400">${index + 1}</td>
                        <td class="py-4 px-4">
                            <p class="text-sm font-black uppercase text-white">${athlete.name}</p>
                            <p class="text-[9px] font-bold text-slate-500 uppercase tracking-wider mt-0.5">ID: ${athlete.id.substring(0, 8)}</p>
                        </td>
                        <td class="py-4 px-4 text-[11px] font-bold text-slate-300 uppercase">${athlete.team || '-'}</td>
                        <td class="py-4 px-4">
                            <span class="text-[10px] font-black uppercase text-blue-500 tracking-wider bg-blue-500/10 px-3 py-1 rounded-full border border-blue-500/20">
                                ${athlete.className || '-'}
                            </span>
                        </td>
                        <td class="py-4 px-4 text-center">
                            <span class="round-badge round-${round}">
                                ${getRoundLabel(round)}
                            </span>
                        </td>
                        <td class="py-4 px-4 text-center">
                            <span class="text-[9px] font-black uppercase tracking-widest ${statusColor}">
                                ${statusLabel}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        };

        const populateClassFilter = () => {
            const classFilter = document.getElementById('classFilter');
            const currentValue = classFilter.value;

            // Get unique class names
            const uniqueClasses = [...new Set(classes.map(c => c.name))].sort();

            classFilter.innerHTML = '<option value="">Semua Kelas</option>' +
                uniqueClasses.map(className =>
                    `<option value="${className}" ${currentValue === className ? 'selected' : ''}>${className}</option>`
                ).join('');
        };

        // --- INTERACTION ---
        window.toggleClass = (classId) => {
            if (expandedClasses.has(classId)) {
                expandedClasses.delete(classId);
            } else {
                expandedClasses.add(classId);
            }
            updateView();
        };

        window.switchTab = (tab) => {
            currentTab = tab;
            document.getElementById('tab-active').classList.toggle('active', tab === 'active');
            document.getElementById('tab-history').classList.toggle('active', tab === 'history');
            updateView();
        };

        window.markKataChanged = (input) => {
            const athleteId = input.dataset.athleteId;
            const saveBtn = document.getElementById(`save-btn-${athleteId}`);
            if (saveBtn) {
                saveBtn.disabled = false;
            }
        };

        window.saveKata = async (athleteId, round) => {
            const input = document.querySelector(`input[data-athlete-id="${athleteId}"]`);
            const saveBtn = document.getElementById(`save-btn-${athleteId}`);

            if (!input || !saveBtn) return;

            const kataName = input.value.trim();
            if (!kataName) {
                alert('Nama kata tidak boleh kosong!');
                return;
            }

            try {
                saveBtn.disabled = true;
                saveBtn.innerText = 'Menyimpan...';

                const athleteRef = doc(db, `events/${eventId}/athletes`, athleteId);
                await updateDoc(athleteRef, {
                    [`kataChoices.${round}`]: kataName
                });

                saveBtn.innerText = 'Tersimpan!';
                setTimeout(() => {
                    saveBtn.innerText = 'Simpan';
                }, 2000);
            } catch (err) {
                console.error(err);
                alert('Gagal menyimpan: ' + err.message);
                saveBtn.disabled = false;
                saveBtn.innerText = 'Simpan';
            }
        };

        document.getElementById('globalSearch').addEventListener('input', () => {
            updateView();
        });

        document.getElementById('classFilter').addEventListener('change', () => {
            updateParticipantList();
        });

        // --- BOOTSTRAP ---
        fetchEventDetails();
        syncData();
    </script>
</body>

</html>