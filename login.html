<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masuk | Kensho Tech Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/window-controls.css">
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #0B1220;
            color: #f8fafc;
            overflow: hidden;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.2);
            border-radius: 10px;
        }
    </style>
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
</head>

<body class="min-h-screen bg-[#0B1220] flex items-center justify-center">

    <script src="js/window-controls.js"></script>

    <div class="w-full max-w-sm px-6">

        <!-- Logo + Title -->
        <div class="text-center mb-10 pt-12">
            <img src="kensho-logo.png" class="w-12 mx-auto mb-6 drop-shadow-2xl">
            <h1 class="text-lg font-semibold text-white tracking-tight">
                Kensho Tech Manager
            </h1>
            <p class="text-slate-400 text-[10px] mt-1 font-medium italic">
                Sistem Manajemen Pertandingan
            </p>
        </div>

        <!-- Login Box -->
        <div class="bg-[#111827] border border-white/5 rounded-2xl p-6 shadow-2xl relative overflow-hidden group">
            <div
                class="absolute -right-10 -top-10 w-24 h-24 bg-blue-500/5 rounded-full blur-2xl group-hover:bg-blue-500/10 transition-all">
            </div>

            <form id="loginForm" class="space-y-5" onsubmit="handleLogin(event)">

                <!-- Email -->
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-slate-500 font-bold">
                        Email Address
                    </label>
                    <input type="email" id="email" required
                        class="mt-2 w-full px-4 py-2.5 rounded-xl bg-[#0B1220] border border-white/5 text-white text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 transition-all placeholder:text-slate-700"
                        placeholder="nama@email.com">
                </div>

                <!-- Password -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[10px] uppercase tracking-widest text-slate-500 font-bold">
                            Password Key
                        </label>
                        <button type="button" onclick="handleForgotPassword()"
                            class="text-[9px] font-bold text-blue-500 hover:text-blue-400 uppercase tracking-widest transition-all">Lupa
                            Password?</button>
                    </div>
                    <div class="relative">
                        <input type="password" id="password" required
                            class="w-full px-4 py-2.5 rounded-xl bg-[#0B1220] border border-white/5 text-white text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 transition-all placeholder:text-slate-700 font-mono"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        <button type="button" onclick="togglePassword()"
                            class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 hover:text-white transition-all">
                            <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke-width="2" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Button -->
                <button type="submit" id="btnSubmit"
                    class="w-full bg-blue-600 hover:bg-blue-500 text-white text-[11px] font-black uppercase tracking-widest py-3 rounded-xl transition-all active:scale-[0.98] shadow-lg shadow-blue-600/20">
                    <span id="btnText">Masuk</span>
                </button>

                <!-- Launch in Browser Button (Only for Electron) -->
                <div id="electronOnly" class="hidden pt-1">
                    <button type="button" onclick="launchInBrowser()"
                        class="w-full py-2.5 rounded-xl border border-white/5 text-slate-500 text-[9px] font-bold uppercase tracking-widest hover:bg-white/5 hover:text-white transition-all flex items-center justify-center gap-2">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                        Versi Browser
                    </button>
                </div>

            </form>

            <!-- Serial -->
            <div class="mt-6 pt-5 border-t border-white/5">
                <div
                    class="flex items-center justify-between bg-black/30 pl-4 pr-1 py-1 rounded-xl border border-white/5">
                    <span id="displaySerial" class="text-[10px] font-mono text-blue-500/70 truncate tracking-tight">
                        MENUNGGU...
                    </span>
                    <button onclick="copySerial()"
                        class="px-3 py-1.5 rounded-lg text-[9px] font-black uppercase tracking-widest text-blue-500 hover:bg-blue-500 hover:text-white transition-all">
                        Copy
                    </button>
                </div>
            </div>

        </div>

        <!-- Version -->
        <div class="text-center mt-8 text-[9px] font-black uppercase tracking-widest text-slate-700">
            v4.0.0 &bull; Kensho Tech
        </div>

    </div>

    <!-- Modal: Premium Action Confirmation (Replaces native confirm/prompt) -->
    <div id="modal-confirm"
        class="fixed inset-0 z-[150] flex items-center justify-center bg-slate-950/90 backdrop-blur-md hidden">
        <div
            class="bg-[#111827] border border-white/10 w-full max-w-sm p-8 rounded-3xl shadow-2xl relative mx-4 text-center">
            <div id="confirm-icon-container"
                class="w-12 h-12 rounded-xl bg-slate-900 flex items-center justify-center text-blue-500 mx-auto mb-6 border border-white/5">
                <svg id="confirm-icon-danger" class="w-6 h-6 text-red-500 hidden" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <svg id="confirm-icon-info" class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <h2 id="confirm-title" class="text-lg font-bold text-white uppercase tracking-tight">Konfirmasi</h2>
            <p id="confirm-message" class="text-xs text-slate-400 mt-2 leading-relaxed px-4">Pesan konfirmasi...</p>
            <div id="confirm-prompt-container" class="mt-6 mb-2 hidden">
                <input type="text" id="confirm-input"
                    class="w-full bg-[#0B1220] border border-white/5 px-4 py-3 rounded-xl outline-none text-xs text-center uppercase tracking-widest text-white focus:border-blue-500 transition-all font-bold">
            </div>
            <div class="flex gap-3 mt-8">
                <button type="button" id="confirm-cancel-btn"
                    class="flex-1 py-3 rounded-xl bg-slate-900 text-slate-500 text-[10px] font-black uppercase tracking-widest hover:text-white transition-all">Batal</button>
                <button id="confirm-action-btn"
                    class="flex-1 py-3 rounded-xl bg-blue-600 text-white text-[10px] font-black uppercase tracking-widest shadow-lg shadow-blue-600/20">Lanjut</button>
            </div>
        </div>
    </div>


    <!-- Modal: Activation / Input License -->
    <div id="modal-activation"
        class="fixed inset-0 z-[200] flex items-center justify-center bg-slate-950/95 backdrop-blur-xl hidden">
        <div class="w-full max-w-sm px-6 text-center">

            <div class="mb-10">
                <div
                    class="w-16 h-16 bg-blue-600/20 rounded-2xl flex items-center justify-center mx-auto mb-6 border border-blue-500/30">
                    <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                    </svg>
                </div>
                <h2 class="text-xl font-bold text-white uppercase tracking-tight">Aktivasi Produk</h2>
                <p class="text-[10px] text-slate-400 mt-2 font-medium">Silakan masukkan Serial Number Anda untuk
                    melanjutkan.</p>
            </div>

            <div class="bg-[#111827] border border-white/5 rounded-3xl p-8 shadow-2xl relative overflow-hidden group">
                <form onsubmit="handleActivate(event)" class="space-y-6">
                    <div class="px-2">
                        <label
                            class="text-[9px] uppercase tracking-[0.2em] text-slate-500 font-black block mb-4 text-center">Serial
                            Number Key</label>
                        <div class="flex items-center justify-center gap-2">
                            <input type="text" value="KENSHO" readonly
                                class="w-24 py-4 rounded-xl bg-black/40 border border-white/10 text-blue-500 text-xs font-black text-center tracking-widest outline-none">
                            <span class="text-slate-800 font-bold">-</span>
                            <input type="text" id="inputSerialP1" maxlength="4" required
                                class="w-24 py-4 rounded-xl bg-black/40 border border-white/5 text-white text-xs focus:outline-none focus:border-blue-500 transition-all font-mono text-center uppercase tracking-widest"
                                placeholder="XXXX">
                            <span class="text-slate-800 font-bold">-</span>
                            <input type="text" id="inputSerialP2" maxlength="3" required
                                class="w-16 py-4 rounded-xl bg-black/40 border border-white/5 text-white text-xs focus:outline-none focus:border-blue-500 transition-all font-mono text-center uppercase tracking-widest"
                                placeholder="123">
                        </div>
                    </div>

                    <button type="submit" id="btnActivate"
                        class="w-full bg-blue-600 hover:bg-blue-500 text-white text-[11px] font-black uppercase tracking-widest py-4 rounded-xl transition-all active:scale-[0.98] shadow-lg shadow-blue-600/20">
                        <span id="btnActivateText">Aktifkan Sekarang</span>
                    </button>

                    <div class="text-center pt-2">
                        <p class="text-[9px] text-slate-500 font-medium">Maksimal 5 Perangkat per Lisensi</p>
                    </div>
                </form>
            </div>

            <p class="text-center mt-8 text-[9px] text-slate-600 font-black uppercase tracking-widest">
                Hubungi Admin untuk mendapatkan Lisensi Resmi.
            </p>
        </div>
    </div>


    <script type="module">
        import { auth, db } from './js/firebase-init.js';
        import { signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { doc, getDoc, setDoc, updateDoc, serverTimestamp, onSnapshot, collection, query, where, getDocs, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { logActivity } from './js/activity-logger.js';


        // Helper: Premium Custom Dialog
        window.customConfirm = ({ title = "Konfirmasi", message = "", confirmText = "Ya", cancelText = "Batal", type = "danger", promptWord = null }) => {
            return new Promise((resolve) => {
                const modal = document.getElementById('modal-confirm');
                const titleEl = document.getElementById('confirm-title');
                const messageEl = document.getElementById('confirm-message');
                const confirmBtn = document.getElementById('confirm-action-btn');
                const cancelBtn = document.getElementById('confirm-cancel-btn');
                const promptContainer = document.getElementById('confirm-prompt-container');
                const promptInput = document.getElementById('confirm-input');
                const iconDanger = document.getElementById('confirm-icon-danger');
                const iconInfo = document.getElementById('confirm-icon-info');

                titleEl.innerText = title;
                messageEl.innerText = message;
                confirmBtn.innerText = confirmText;
                cancelBtn.innerText = cancelText;

                if (!cancelText) cancelBtn.classList.add('hidden'); else cancelBtn.classList.remove('hidden');

                if (type === 'danger') {
                    confirmBtn.className = "flex-1 py-4 rounded-xl bg-red-600 text-white text-[10px] font-black uppercase tracking-[0.2em] shadow-[0_15px_30px_rgba(220,38,38,0.3)] hover:scale-[1.02] transition-all";
                    iconDanger.classList.remove('hidden'); iconInfo.classList.add('hidden');
                } else {
                    confirmBtn.className = "flex-1 py-4 rounded-xl bg-blue-600 text-white text-[10px] font-black uppercase tracking-[0.2em] shadow-[0_15px_30px_rgba(59,130,246,0.3)] hover:scale-[1.02] transition-all";
                    iconDanger.classList.add('hidden'); iconInfo.classList.remove('hidden');
                }

                if (promptWord) {
                    promptContainer.classList.remove('hidden');
                    promptInput.value = "";
                    confirmBtn.disabled = true; confirmBtn.style.opacity = "0.3";
                    promptInput.oninput = () => {
                        if (promptInput.value.toUpperCase().trim() === promptWord.toUpperCase().trim()) {
                            confirmBtn.disabled = false; confirmBtn.style.opacity = "1";
                        } else {
                            confirmBtn.disabled = true; confirmBtn.style.opacity = "0.3";
                        }
                    };
                } else {
                    promptContainer.classList.add('hidden');
                    confirmBtn.disabled = false; confirmBtn.style.opacity = "1";
                }

                modal.classList.remove('hidden'); modal.classList.add('flex');

                const cleanup = () => {
                    modal.classList.add('hidden'); modal.classList.remove('flex');
                    confirmBtn.onclick = null; cancelBtn.onclick = null;
                };

                confirmBtn.onclick = () => { cleanup(); resolve(true); };
                cancelBtn.onclick = () => { cleanup(); resolve(false); };
            });
        };

        window.customAlert = (message, title = "Informasi", type = "info") => {
            return window.customConfirm({ title, message, confirmText: "Dimengerti", cancelText: "", type });
        };

        // Cek jika sudah login
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.location.href = 'dashboard.html';
            }
        });

        // Fungsi Show/Hide Password
        window.togglePassword = function () {
            const pwInput = document.getElementById('password');
            const icon = document.getElementById('eyeIcon');

            if (pwInput.type === 'password') {
                pwInput.type = 'text';
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 0 0 1.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.451 10.451 0 0 1 12 4.5c4.756 0 8.773 3.162 10.065 7.498a10.522 10.522 0 0 1-4.293 5.774M6.228 6.228 3 3m3.228 3.228 3.65 3.65m7.894 7.894L21 21m-3.228-3.228-3.65-3.65m0 0a3 3 0 1 0-4.243-4.243m4.242 4.242L9.88 9.88" />';
            } else {
                pwInput.type = 'password';
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>';
            }
        }

        window.copySerial = function () {
            const serial = document.getElementById('displaySerial').innerText;
            if (serial === 'MENUNGGU...' || serial === 'BELUM AKTIF') return;
            navigator.clipboard.writeText(serial);
            alert("Serial Number disalin ke clipboard!");
        }


        // Global state for license
        let currentHwid = "";
        let boundEmail = "";
        let licenseStatus = "pending";
        let isExpired = false;

        // Fungsi Login Firebase
        window.handleLogin = async function (e) {
            e.preventDefault();

            // SECURITY CHECK: License State (ALL PLATFORMS)
            // Both desktop and web browser require device activation
            const isLocalDev = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            if (licenseStatus !== 'active' && !isLocalDev) {
                alert("Lisensi Anda belum aktif. Silakan aktifkan produk Anda.");
                return;
            }
            if (isExpired) {
                alert("Masa berlaku lisensi Anda telah habis.");
                return;
            }

            const btn = document.getElementById('btnSubmit');
            const text = document.getElementById('btnText');
            const email = document.getElementById('email').value.toLowerCase();
            const password = document.getElementById('password').value;

            // Check Binding: 1 Email = 1 HWID
            if (boundEmail && boundEmail !== email) {
                alert("‚ö†Ô∏è AKSES DITOLAK\n\nPerangkat ini sudah terikat dengan email: " + boundEmail + ".\nSilakan gunakan email tersebut untuk login.");
                return;
            }

            // Beri efek loading
            const originalText = text.innerHTML;
            text.innerHTML = '<div class="flex items-center justify-center"><svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';
            btn.classList.add('opacity-80', 'cursor-not-allowed');
            btn.disabled = true;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // 1. Check License (Desktop Only)
                if (window.electronAPI) {
                    if (licenseStatus !== 'active' || isExpired) {
                        await signOut(auth);
                        alert("Lisensi aplikasi tidak aktif atau kedaluwarsa.");
                        location.reload();
                        return;
                    }
                }

                // 2. Find User in Firestore (admins or users)
                // We need to query by email since doc ID might not match email

                let userData = null;
                let userDocPath = null;

                // Check admins collection
                const qAdmin = query(collection(db, "admins"), where("email", "==", email));
                const snapAdmin = await getDocs(qAdmin);
                if (!snapAdmin.empty) {
                    userData = snapAdmin.docs[0].data();
                    userDocPath = doc(db, "admins", snapAdmin.docs[0].id);
                } else {
                    // Check users collection
                    const qUser = query(collection(db, "users"), where("email", "==", email));
                    const snapUser = await getDocs(qUser);
                    if (!snapUser.empty) {
                        userData = snapUser.docs[0].data();
                        userDocPath = doc(db, "users", snapUser.docs[0].id);
                    }
                }

                if (!userData) {
                    await signOut(auth);
                    alert("Akun Anda tidak ditemukan di database Spartan.");
                    location.reload();
                    return;
                }

                // 3. Check Account Status
                if (userData.status === 'pending') {
                    await signOut(auth);
                    alert("‚è≥ AKUN MENUNGGU PERSETUJUAN\n\nAkun Anda sedang diverifikasi oleh Owner. Silakan hubungi Spartan Sport.");
                    location.reload();
                    return;
                }
                if (userData.status === 'blocked') {
                    await signOut(auth);
                    alert("üö´ AKUN DIBLOKIR\n\nAkun Anda telah dinonaktifkan.");
                    location.reload();
                    return;
                }

                // 4. Session Management (Single Login)
                const sessionId = Date.now().toString() + "_" + Math.random().toString(36).substring(2, 7);
                await updateDoc(userDocPath, {
                    currentSessionId: sessionId,
                    lastLogin: serverTimestamp()
                });
                localStorage.setItem('kensho_session_id', sessionId);
                localStorage.setItem('kensho_login_time', Date.now().toString());

                // 5. Desktop-HWID Binding (if applicable)
                if (window.electronAPI && !boundEmail) {
                    const licenseKey = localStorage.getItem('kensho_license_key');
                    if (licenseKey) {
                        await updateDoc(doc(db, "licenses", licenseKey), {
                            boundEmail: email
                        });
                    }
                }

                console.log("Login Success:", user.uid);
                await logActivity("Masuk ke Sistem", `Admin ${email} berhasil masuk.`);

                // Manual redirect because onAuthStateChanged might be too fast
                window.location.href = 'dashboard.html';

            } catch (error) {
                console.error("Login Error:", error);
                let errorMsg = "Login Gagal. Silakan periksa email dan password Anda.";

                if (error.code === 'auth/invalid-credential') {
                    errorMsg = "Email atau password salah, atau akun tidak ditemukan. Pastikan Anda sudah mendaftar.";
                } else if (error.code === 'auth/user-disabled') {
                    errorMsg = "Akun ini telah dinonaktifkan.";
                } else if (error.code === 'auth/network-request-failed') {
                    errorMsg = "Koneksi gagal. Periksa jaringan Anda.";
                }

                await customAlert(errorMsg, "Login Gagal", "danger");
                text.innerHTML = originalText;
                btn.classList.remove('opacity-80', 'cursor-not-allowed');
                btn.disabled = false;

                // FIX: Focus and select the password input
                const pwField = document.getElementById('password');
                if (pwField) {
                    pwField.focus();
                    pwField.select();
                }
            }
        }

        // Dynamic Greeting Rotation
        const greetings = [
            "Senang melihat Anda lagi!",
            "Siap untuk mengelola pertandingan?",
            "Ayo Kerja Yang Benar!",
            "Dibalik Kesalahan Inputmu, terdapat Jiwa yang nanti Pusing lihat Kertas Bagan.",
            "Tetap Semangat untuk event hari ini!"
        ];
        let greetingIndex = 0;
        const greetingEl = document.getElementById('dynamicGreeting');

        if (greetingEl) {
            setInterval(() => {
                greetingEl.classList.add('opacity-0');
                setTimeout(() => {
                    greetingIndex = (greetingIndex + 1) % greetings.length;
                    greetingEl.innerText = greetings[greetingIndex];
                    greetingEl.classList.remove('opacity-0');
                }, 500);
            }, 4000);
        }

        // Check if running in Electron
        const isElectron = window.electronAPI !== undefined;
        if (isElectron) {
            document.getElementById('electronOnly').classList.remove('hidden');
        }

        window.launchInBrowser = function () {
            // Buka versi website produksi dengan meneruskan HWID untuk keamanan lisensi
            const url = `https://kensho-scoring.web.app?hwid=${currentHwid}`;
            window.electronAPI.openInBrowser(url);
        };

        // Licencing & Hardware ID Logic
        const APP_VERSION = "4.0.0";

        // Generate Browser Device ID (fingerprint)
        function generateBrowserDeviceId() {
            // Combine multiple browser characteristics for unique ID
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('fingerprint', 2, 2);
            const canvasData = canvas.toDataURL();

            const fingerprint = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                screenResolution: `${screen.width}x${screen.height}`,
                colorDepth: screen.colorDepth,
                canvas: canvasData.substring(0, 50)
            };

            // Generate hash from fingerprint
            const fpString = JSON.stringify(fingerprint);
            let hash = 0;
            for (let i = 0; i < fpString.length; i++) {
                const char = fpString.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }

            return 'WEB-' + Math.abs(hash).toString(16).toUpperCase().padStart(12, '0');
        }

        // Fungsi Aktivasi License
        window.handleActivate = async function (e) {
            e.preventDefault();
            const btn = document.getElementById('btnActivate');
            const text = document.getElementById('btnActivateText');
            const p1 = document.getElementById('inputSerialP1').value.trim().toUpperCase();
            const p2 = document.getElementById('inputSerialP2').value.trim();

            if (!p1 || !p2) return;
            const serialInput = `KENSHO-${p1}-${p2}`;

            const originalBtnText = text.innerText;
            text.innerText = "Memverifikasi...";
            btn.disabled = true;

            try {
                const docRef = doc(db, "licenses", serialInput);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    throw new Error("Serial Number tidak valid. Pastikan input benar.");
                }

                const data = docSnap.data();
                if (data.status === 'blocked') {
                    throw new Error("Serial Number ini telah diblokir.");
                }

                // Check Device Limit
                const registeredDevices = data.registered_devices || [];
                const maxDevices = data.max_devices || 5;

                if (!registeredDevices.includes(currentHwid)) {
                    if (registeredDevices.length >= maxDevices) {
                        throw new Error(`Batas maksimal perangkat (${maxDevices}) telah tercapai.`);
                    }

                    // Register this device
                    await updateDoc(docRef, {
                        registered_devices: arrayUnion(currentHwid),
                        lastActive: serverTimestamp()
                    });
                }

                // Success! Save to local and refresh
                localStorage.setItem('kensho_license_key', serialInput);
                await customAlert("Aktivasi Berhasil! Selamat menggunakan Kensho Tech.", "Berhasil", "info");
                location.reload();

            } catch (err) {
                alert("‚ùå AKTIVASI GAGAL\n\n" + err.message);
                text.innerText = originalBtnText;
                btn.disabled = false;
            }
        };

        async function checkLicense() {
            // Jika di Browser (PWA Mode)
            if (!window.electronAPI) {
                // Generate or retrieve browser device ID
                currentHwid = localStorage.getItem('kensho_browser_device_id');
                if (!currentHwid) {
                    currentHwid = generateBrowserDeviceId();
                    localStorage.setItem('kensho_browser_device_id', currentHwid);
                    console.log('Browser Device ID Generated:', currentHwid);
                }
            }

            try {
                // Version Check
                const settingsSnap = await getDoc(doc(db, "settings", "app"));
                if (settingsSnap.exists()) {
                    const minVer = settingsSnap.data().minVersion;
                    if (minVer && APP_VERSION < minVer) {
                        const btn = document.getElementById('btnSubmit');
                        const btnText = document.getElementById('btnText');
                        btn.disabled = true;
                        btnText.innerHTML = 'UPDATE APLIKASI';
                        btn.classList.add('opacity-50', 'bg-slate-800');
                        alert("‚ö†Ô∏è VERSI KEDALUWARSA\n\nVersi aplikasi Anda (v" + APP_VERSION + ") sudah tidak didukung. Silakan unduh versi terbaru untuk melanjutkan.");
                        return;
                    }
                }

                if (window.electronAPI) {
                    currentHwid = await window.electronAPI.getMachineId();
                }

                // 1. Get License Key from LocalStorage
                const savedLicense = localStorage.getItem('kensho_license_key');
                if (!savedLicense) {
                    document.getElementById('modal-activation').classList.remove('hidden');
                    document.getElementById('displaySerial').innerText = "BELUM AKTIF";
                    return;
                }

                const docRef = doc(db, "licenses", savedLicense);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    localStorage.removeItem('kensho_license_key');
                    document.getElementById('modal-activation').classList.remove('hidden');
                    return;
                }

                // Subscribe to changes (Real-time Kill Switch)
                onSnapshot(docRef, (snapshot) => {
                    if (!snapshot.exists()) {
                        localStorage.removeItem('kensho_license_key');
                        location.reload();
                        return;
                    }

                    const data = snapshot.data();
                    licenseStatus = data.status;
                    boundEmail = data.boundEmail;
                    const devices = data.registered_devices || [];

                    // Verify if current device is still registered
                    if (!devices.includes(currentHwid)) {
                        localStorage.removeItem('kensho_license_key');
                        location.reload();
                        return;
                    }

                    // Expiry Check
                    isExpired = false;
                    if (data.expiryDate) {
                        const expiry = data.expiryDate.toDate();
                        if (new Date() > expiry) isExpired = true;
                    }

                    // Update UI Real-time
                    const btn = document.getElementById('btnSubmit');
                    const btnText = document.getElementById('btnText');
                    const displaySerial = document.getElementById('displaySerial');
                    if (displaySerial) displaySerial.innerText = data.serial || savedLicense;

                    if (licenseStatus === 'blocked' || isExpired) {
                        btn.disabled = true;
                        btnText.innerHTML = isExpired ? 'LISENSI EXPIRED' : 'AKSES DIBLOKIR';
                        btn.classList.add('opacity-50', 'bg-slate-800');
                        // Force Logout if already inside
                        if (auth.currentUser) signOut(auth);
                    } else if (licenseStatus === 'pending') {
                        btn.disabled = true;
                        btnText.innerHTML = 'MENUNGGU AKTIVASI';
                        btn.classList.add('opacity-50', 'bg-amber-600');
                    } else {
                        btn.disabled = false;
                        btnText.innerHTML = 'Log In';
                        btn.classList.remove('opacity-50', 'bg-slate-800', 'bg-amber-600');
                    }
                });

            } catch (err) {
                console.error("License Check Error:", err);
            }
        }

        import { initUpdater } from './js/modules/updater-client.js';

        // ... existing auth code ... (keeping it clean)

        window.handleForgotPassword = async function () {
            const email = document.getElementById('email').value.trim();
            if (!email) {
                alert("Silakan masukkan email Anda terlebih dahulu di kotak input.");
                document.getElementById('email').focus();
                return;
            }

            if (confirm(`Kirim link reset password ke email: ${email}?`)) {
                try {
                    await sendPasswordResetEmail(auth, email);
                    await customAlert("Link reset password telah dikirim! Silakan cek Inbox atau folder Spam email Anda.", "Email Dikirim", "info");
                } catch (err) {
                    alert("Gagal mengirim email reset: " + err.message);
                }
            }
        };

        // Run license check
        checkLicense();

        // Run Updater (Electron Only)
        initUpdater();

        // Register Service Worker
    </script>


</body>

</html>