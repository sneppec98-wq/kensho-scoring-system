<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoring Monitor | Kensho Tech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/window-controls.css">

    <style>
        :root {
            --aka-color: #ef4444;
            --ao-color: #3b82f6;
            --bg-dark: #020617;
        }

        body {
            margin: 0;
            overflow: hidden;
            background: var(--bg-dark);
            color: white;
            font-family: 'Plus Jakarta Sans', sans-serif;
            height: 100vh;
            width: 100vw;
        }

        /* SCORE FONT - Monospace as requested */
        #monitorScoreAka,
        #monitorScoreAo {
            font-family: 'Courier New', Courier, monospace;
            letter-spacing: -10px;
            line-height: 0.8;
            font-weight: 900;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .kata-score {
            font-size: 28vh !important;
            letter-spacing: 0px !important;
        }

        /* TIMER FONT */
        #monitorTimer {
            font-family: 'Courier New', Courier, monospace;
            font-weight: 900;
        }

        /* PENALTY TEXT LABELS */
        .penalty-label {
            font-size: 2vh;
            font-weight: 900;
            color: rgba(255, 255, 255, 0.2);
            padding: 0.5vh 1.2vh;
            border-radius: 0.5vh;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 5vh;
            text-align: center;
        }

        .penalty-label.active {
            color: white;
            background: #f59e0b;
            border-color: #fbbf24;
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.6);
        }

        .penalty-label.active-red {
            background: #ef4444 !important;
            border-color: #f87171 !important;
            box-shadow: 0 0 25px rgba(239, 68, 68, 0.8) !important;
        }

        .penalty-label.active-yellow {
            background: #f59e0b !important;
            border-color: #fbbf24 !important;
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.6) !important;
        }

        /* SENSHU LABELS */
        .senshu-label {
            font-size: 1.8vh;
            font-weight: 900;
            padding: 0.6vh 2.5vh;
            border-radius: 1vh;
            text-transform: uppercase;
            letter-spacing: 0.3em;
            transition: all 0.4s ease;
        }

        .senshu-ao {
            background: #2563eb !important;
            color: white !important;
            box-shadow: 0 0 30px rgba(37, 99, 235, 0.6) !important;
        }

        .senshu-aka {
            background: #dc2626 !important;
            color: white !important;
            box-shadow: 0 0 30px rgba(220, 38, 38, 0.6) !important;
        }


        /* SHIMMER EFFECT */
        .shimmer-text {
            background: linear-gradient(90deg, #fff 0%, #94a3b8 50%, #fff 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmer 3s linear infinite;
        }

        @keyframes shimmer {
            to {
                background-position: 200% center;
            }
        }

        /* OVERLAYS */
        .winner-banner {
            position: fixed;
            inset: 0;
            z-index: 500;
            background: radial-gradient(circle at center, rgba(15, 23, 42, 0.98) 0%, rgba(2, 6, 23, 1) 100%);
            backdrop-filter: blur(60px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .winner-banner.show {
            display: flex;
            animation: fadeIn 0.8s ease-out forwards;
        }

        #restTimerOverlay {
            position: fixed;
            inset: 0;
            z-index: 999;
            background: #020617;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .rest-timer-label {
            font-size: 5vh;
            font-weight: 900;
            letter-spacing: 1.2em;
            color: #f59e0b;
            text-transform: uppercase;
            margin-bottom: 2vh;
            padding-left: 1.2em;
        }

        .rest-timer-clock {
            font-size: 45vh;
            font-family: 'Courier New', Courier, monospace;
            font-weight: 900;
            line-height: 1;
            padding-right: 0.1em;
            /* Anti-clipping */
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* INTRO ANIMATIONS */
        @keyframes slideFromLeft {
            0% {
                transform: translateX(-100%);
                opacity: 0;
            }

            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideFromRight {
            0% {
                transform: translateX(100%);
                opacity: 0;
            }

            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes vsPulse {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(45deg);
                opacity: 0;
            }

            70% {
                transform: translate(-50%, -50%) scale(1.1) rotate(-5deg);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -50%) scale(1) rotate(0);
                opacity: 1;
            }
        }

        @keyframes slideToLeft {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(-100%);
                opacity: 0;
            }
        }

        @keyframes slideToRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @keyframes fadeDown {
            from {
                transform: translate(-50%, 0);
                opacity: 1;
            }

            to {
                transform: translate(-50%, 40px);
                opacity: 0;
            }
        }

        @keyframes vsExit {
            from {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }

            to {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
        }

        .ao-panel-intro {
            background: linear-gradient(135deg, #1e3a8a 0%, #020617 100%);
            border-right: 4px solid #3b82f6;
            animation: slideFromLeft 1s cubic-bezier(0.23, 1, 0.32, 1) forwards;
            animation-delay: 0.2s;
            opacity: 0;
        }

        .aka-panel-intro {
            background: linear-gradient(-135deg, #7f1d1d 0%, #020617 100%);
            border-left: 4px solid #ef4444;
            animation: slideFromRight 1s cubic-bezier(0.23, 1, 0.32, 1) forwards;
            animation-delay: 0.4s;
            opacity: 0;
        }

        .intro-category-box {
            animation: moveUp 0.8s ease-out forwards 1.8s;
            opacity: 0;
        }

        .vs-badge-intro {
            animation: vsPulse 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            animation-delay: 1s;
            opacity: 0;
            z-index: 1000;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .intro-text-ao {
            animation: moveUp 0.8s ease-out forwards 1.3s;
            opacity: 0;
        }

        .intro-text-aka {
            animation: moveUp 0.8s ease-out forwards 1.5s;
            opacity: 0;
        }

        /* EXIT CLASSES Pak! Pak! Pak! */
        #introOverlay.closing .ao-panel-intro {
            animation: slideToLeft 0.8s cubic-bezier(0.7, 0, 0.84, 0) forwards;
        }

        #introOverlay.closing .aka-panel-intro {
            animation: slideToRight 0.8s cubic-bezier(0.7, 0, 0.84, 0) forwards;
        }

        #introOverlay.closing .vs-badge-intro {
            animation: vsExit 0.5s ease-in forwards;
        }

        #introOverlay.closing .intro-category-box {
            animation: fadeDown 0.5s ease-in forwards;
        }

        #introOverlay.closing .intro-text-ao,
        #introOverlay.closing .intro-text-aka {
            opacity: 0;
            transition: opacity 0.3s;
        }

        @keyframes moveUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }


        /* KATA OVERLAY */
        #kataTimerOverlay {
            position: fixed;
            inset: 0;
            z-index: 400;
            background: radial-gradient(circle at center, rgba(2, 6, 23, 0.95), rgba(0, 0, 0, 1));
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* AURORA BACKGROUND */
        .aurora {
            position: absolute;
            width: 80vw;
            height: 80vh;
            border-radius: 50%;
            filter: blur(150px);
            opacity: 0.1;
            pointer-events: none;
            z-index: -1;
        }
    </style>
</head>

<body>
    <script src="js/window-controls.js"></script>

    <!-- AURORA DECO -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="aurora bg-blue-600 top-[-20%] left-[-10%] animate-[pulse_15s_infinite]"></div>
        <div class="aurora bg-red-600 bottom-[-20%] right-[-10%] animate-[pulse_20s_infinite_reverse]"></div>
    </div>

    <!-- MAIN INTERFACE (COLUMNS) -->
    <div class="h-screen w-screen flex flex-col p-10 relative">

        <!-- CATEGORY HEADER -->
        <div id="matchInfoHeader" class="text-center mb-4">
            <h1 id="monitorCategory" class="text-[6vh] font-black uppercase tracking-widest text-white/90">
                ---
            </h1>
        </div>

        <!-- SCORE AREA -->
        <div id="centerUI" class="flex-1 flex items-center justify-center">

            <div class="flex items-center gap-[8vw] w-full max-w-[95vw]">

                <!-- AO (LEFT) -->
                <div id="sideAo" class="flex-1 text-center">
                    <div class="text-blue-500 text-[3.5vh] font-black tracking-[0.5em] mb-4">AO</div>

                    <div class="h-[12vh] flex flex-col justify-center mb-6">
                        <h2 id="monitorNameAo" class="text-[5vh] font-black uppercase leading-none truncate">ATLET AO
                        </h2>
                        <p id="monitorTeamAo" class="text-[2.5vh] font-bold uppercase opacity-60 tracking-[0.2em] mt-2">
                            TEAM</p>
                    </div>

                    <div id="monitorScoreAo" class="text-[35vh] leading-none text-blue-500">00</div>

                    <!-- VR Indicator AO -->
                    <div class="flex flex-col items-center gap-2 mt-4">
                        <div id="mon_vrAo"
                            class="hidden px-6 py-2 bg-yellow-500 text-black font-black italic rounded-xl text-[2vh]">
                            VR</div>
                        <div id="mon_senshuBadgeAo" class="hidden senshu-label senshu-ao">SENSHU</div>
                    </div>
                </div>

                <!-- TIMER (CENTER) -->
                <div class="flex flex-col items-center min-w-[25vw]">
                    <div id="monitorTimer" class="text-[12vh] font-black text-white shimmer-text">
                        01:00
                    </div>
                    <div id="atoshiLabel"
                        class="hidden mt-4 px-10 py-2 bg-red-600 text-white text-[1.5vh] font-black tracking-[0.5em] rounded-full animate-pulse shadow-lg">
                        ATOSHI BARAKU
                    </div>

                    <!-- SENSHU INDICATORS REMOVED FROM CENTER -->
                </div>

                <!-- AKA (RIGHT) -->
                <div id="sideAka" class="flex-1 text-center">
                    <div class="text-red-500 text-[3.5vh] font-black tracking-[0.5em] mb-4">AKA</div>

                    <div class="h-[12vh] flex flex-col justify-center mb-6">
                        <h2 id="monitorNameAka" class="text-[5vh] font-black uppercase leading-none truncate">ATLET AKA
                        </h2>
                        <p id="monitorTeamAka"
                            class="text-[2.5vh] font-bold uppercase opacity-60 tracking-[0.2em] mt-2">TEAM</p>
                    </div>

                    <div id="monitorScoreAka" class="text-[35vh] leading-none text-red-500">00</div>

                    <!-- VR Indicator AKA -->
                    <div class="flex flex-col items-center gap-2 mt-4">
                        <div id="mon_vrAka"
                            class="hidden px-6 py-2 bg-yellow-500 text-black font-black italic rounded-xl text-[2vh]">
                            VR</div>
                        <div id="mon_senshuBadgeAka" class="hidden senshu-label senshu-aka">SENSHU</div>
                    </div>
                </div>

            </div>

        </div>

        <!-- FOOTER: PENALTIES -->
        <div class="flex justify-between items-end px-[5vw] pb-4">

            <!-- Penalties AO -->
            <div id="mon_penaltiesAo" class="flex gap-2">
                <div id="mon_ao_c1" class="penalty-label">C1</div>
                <div id="mon_ao_c2" class="penalty-label">C2</div>
                <div id="mon_ao_c3" class="penalty-label">C3</div>
                <div id="mon_ao_hc" class="penalty-label">HC</div>
                <div id="mon_ao_h" class="penalty-label">H</div>
            </div>

            <!-- TATAMI LABEL -->
            <div class="text-[2.5vh] font-black opacity-30 tracking-widest uppercase">
                TATAMI <span id="tatamiLabel">1</span>
            </div>

            <!-- Penalties AKA -->
            <div id="mon_penaltiesAka" class="flex gap-2">
                <div id="mon_aka_c1" class="penalty-label">C1</div>
                <div id="mon_aka_c2" class="penalty-label">C2</div>
                <div id="mon_aka_c3" class="penalty-label">C3</div>
                <div id="mon_aka_hc" class="penalty-label">HC</div>
                <div id="mon_aka_h" class="penalty-label">H</div>
            </div>

        </div>

    </div>

    <!-- OVERLAYS: KATA -->
    <div id="kataTimerOverlay">
        <p id="overlayClass"
            class="text-[4vh] font-black mb-8 px-12 py-2 bg-white/10 rounded-full tracking-widest uppercase">---</p>
        <h1 id="overlayTimer" class="text-[30vh] font-black italic shimmer-text leading-none mb-10">01:00</h1>
        <h2 id="overlayName" class="text-[8vh] font-black uppercase max-w-[90vw] text-center">ATLET NAME</h2>
        <p id="overlayTeam" class="text-[4vh] font-bold text-slate-400 mt-2 tracking-widest">TEAM NAME</p>
        <div id="overlayKata"
            class="mt-12 px-10 py-3 bg-blue-600/20 border border-blue-500/30 rounded-xl text-[4vh] font-black italic text-blue-400">
            KATA</div>
    </div>

    <!-- OVERLAYS: WINNER -->
    <div id="winnerBanner" class="winner-banner">
        <div class="absolute inset-0 overflow-hidden pointer-events-none -z-10">
            <div class="aurora bg-white/10 w-full h-full scale-150 animate-pulse"></div>
        </div>
        <div id="winnerSideLabel" class="text-[4vh] font-black tracking-[1em] opacity-40 mb-10 text-white">CHAMPION
        </div>
        <h1 id="winnerName"
            class="text-[10vh] font-black uppercase italic tracking-tighter text-center max-w-[90vw] shimmer-text">NAME
            HERE</h1>
        <p id="winnerTeam" class="text-[4vh] font-bold opacity-60 uppercase mb-20 tracking-widest">TEAM NAME</p>

        <div class="p-16 rounded-[4rem] bg-white/5 border border-white/10 backdrop-blur-xl shadow-2xl">
            <p id="winnerScore" class="text-[12vh] font-black italic tracking-widest leading-none">08 - 00</p>
        </div>
    </div>

    <!-- OVERLAYS: REST TIMER -->
    <div id="restTimerOverlay">
        <div class="rest-timer-label">REST PERIOD</div>
        <h1 id="restTimerDisplay" class="rest-timer-clock shimmer-text">01:00</h1>
        <div class="w-64 h-2 bg-amber-500/30 rounded-full mt-10 overflow-hidden">
            <div class="h-full bg-amber-500 shadow-[0_0_20px_#f59e0b]"></div>
        </div>
    </div>

    <!-- EVENT MEDIA OVERLAY -->
    <div id="eventMediaOverlay" class="fixed inset-0 z-[900] hidden items-center justify-center bg-black">
        <video id="eventMediaVideo" class="w-full h-full object-contain hidden" loop muted autoplay></video>
        <img id="eventMediaImage" class="w-full h-full object-contain hidden" alt="Event Media">
    </div>

    <!-- OVERLAYS: INTRO -->
    <div id="introOverlay" class="fixed inset-0 z-[1000] flex hidden">
        <div class="ao-panel-intro flex-1 flex flex-col items-center justify-center relative overflow-hidden">
            <div class="intro-text-ao text-center">
                <h2 id="introNameAo" class="text-[10vh] font-black uppercase leading-tight text-white"></h2>
                <p id="introTeamAo" class="text-[4vh] font-bold uppercase opacity-60 tracking-widest mt-4 text-white">
                </p>
            </div>
        </div>
        <div class="aka-panel-intro flex-1 flex flex-col items-center justify-center relative overflow-hidden">
            <div class="intro-text-aka text-center">
                <h2 id="introNameAka" class="text-[10vh] font-black uppercase leading-tight text-white"></h2>
                <p id="introTeamAka" class="text-[4vh] font-bold uppercase opacity-60 tracking-widest mt-4 text-white">
                </p>
            </div>
        </div>
        <div class="vs-badge-intro absolute flex items-center justify-center">
            <div
                class="w-[20vh] h-[20vh] bg-white text-black flex items-center justify-center rounded-[3rem] shadow-[0_0_100px_rgba(255,255,255,0.4)] border-[6px] border-slate-900 group">
                <span
                    class="text-[10vh] font-black italic tracking-tighter text-slate-900 pr-2 transition-all transform">VS</span>
            </div>
        </div>
        <div class="absolute bottom-12 left-0 w-full flex justify-center z-[1100]">
            <div
                class="intro-category-box px-12 py-4 bg-white/10 border border-white/20 rounded-2xl backdrop-blur-md shadow-2xl whitespace-nowrap">
                <p id="introCategory" class="text-[4vh] font-black tracking-widest uppercase text-white"></p>
            </div>
        </div>
    </div>

    <!-- UTILITY BUTTONS -->
    <button onclick="toggleFullscreen()"
        class="fixed bottom-6 left-1/2 -translate-x-1/2 p-4 bg-white/5 hover:bg-white/10 rounded-full opacity-0 hover:opacity-100 transition-opacity z-[1000]">
        <svg class="w-6 h-6" fill="white" viewBox="0 0 24 24">
            <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z" />
        </svg>
    </button>

    <!-- CORE LOGIC -->
    <script type="module">
        import { listenToScoreUpdates } from './js/scoring-firebase.js';

        const urlParams = new URLSearchParams(window.location.search);
        const tatamiId = urlParams.get('tatami') || '1';
        document.getElementById('tatamiLabel').innerText = tatamiId.replace('tatami', '');

        listenToScoreUpdates(tatamiId, (data) => {
            if (!data) return;
            updateUI(data);
        });

        // Offline storage fallback
        window.addEventListener('storage', (e) => {
            if (e.key === 'karate_score_update' && e.newValue) {
                try { updateUI(JSON.parse(e.newValue)); } catch (err) { }
            }
        });

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        let wasIntroActive = false;
        let isIntroClosing = false;

        function updateUI(data) {
            const hasData = s => s && s !== '-' && s !== '---';

            // 1. PRE-MATCH INTRO OVERLAY
            const introOverlay = document.getElementById('introOverlay');
            if (data.isIntroActive) {
                isIntroClosing = false;
                introOverlay.classList.remove('closing');
                if (introOverlay.classList.contains('hidden')) {
                    introOverlay.classList.remove('hidden');
                    // Update dynamic data
                    const nameAo = (data.nameAo || 'ATLET AO').toUpperCase();
                    const partsAo = nameAo.split(' ');
                    document.getElementById('introNameAo').innerHTML = `${partsAo[0]}<br><span class="text-blue-500 underline decoration-blue-500/30 underline-offset-8">${partsAo.slice(1).join(' ') || 'AO'}</span>`;
                    document.getElementById('introTeamAo').innerText = (data.teamAo || 'TEAM').toUpperCase();

                    const nameAka = (data.nameAka || 'ATLET AKA').toUpperCase();
                    const partsAka = nameAka.split(' ');
                    document.getElementById('introNameAka').innerHTML = `${partsAka[0]}<br><span class="text-red-500 underline decoration-red-500/30 underline-offset-8">${partsAka.slice(1).join(' ') || 'AKA'}</span>`;
                    document.getElementById('introTeamAka').innerText = (data.teamAka || 'TEAM').toUpperCase();

                    document.getElementById('introCategory').innerText = (data.category || 'CATEGORY').toUpperCase();
                }
                wasIntroActive = true;
                return;
            } else {
                if (wasIntroActive && !isIntroClosing) {
                    isIntroClosing = true;
                    introOverlay.classList.add('closing');
                    setTimeout(() => {
                        introOverlay.classList.add('hidden');
                        introOverlay.classList.remove('closing');
                        isIntroClosing = false;
                        wasIntroActive = false;
                    }, 800);
                } else if (!isIntroClosing) {
                    introOverlay.classList.add('hidden');
                }
            }

            // 2. REST TIMER OVERLAY (Priority)
            const restOverlay = document.getElementById('restTimerOverlay');
            if (data.isRestTimerActive) {
                restOverlay.style.display = 'flex';
                document.getElementById('restTimerDisplay').innerText = formatTime(data.restTimeLeft);
                // Hide others
                document.getElementById('winnerBanner').classList.remove('show');
                document.getElementById('kataTimerOverlay').style.display = 'none';
                return;
            } else {
                restOverlay.style.display = 'none';
            }

            // 3. KATA OVERLAY
            const kataOverlay = document.getElementById('kataTimerOverlay');
            if (data.scoringMode === 'kata' && data.isTimerEnabled) {
                kataOverlay.style.display = 'flex';
                document.getElementById('overlayTimer').innerText = data.timerText || "00:00";

                const isAo = data.activeKataPerformer === 'ao';
                document.getElementById('overlayName').innerText = (isAo ? data.nameAo : data.nameAka || '').toUpperCase();
                document.getElementById('overlayTeam').innerText = (isAo ? data.teamAo : data.teamAka || '').toUpperCase();
                document.getElementById('overlayKata').innerText = `KATA: ${isAo ? data.kataAo : data.kataAka || ''}`;
                document.getElementById('overlayKata').style.color = isAo ? '#3b82f6' : '#ef4444';
                document.getElementById('overlayClass').innerText = (data.category || '').toUpperCase();

                // Hide main UI
                document.getElementById('centerUI').classList.add('invisible');
            } else {
                kataOverlay.style.display = 'none';
                document.getElementById('centerUI').classList.remove('invisible');
            }

            // 3. WINNER BANNER
            const winnerBanner = document.getElementById('winnerBanner');
            if (data.isWinnerDeclared && data.winnerSide && data.winnerSide !== 'draw') {
                winnerBanner.classList.add('show');
                const winnerName = data.winnerSide === 'aka' ? data.nameAka : data.nameAo;
                const winnerTeam = data.winnerSide === 'aka' ? data.teamAka : data.teamAo;

                document.getElementById('winnerName').innerText = (winnerName || '').toUpperCase();
                document.getElementById('winnerTeam').innerText = (winnerTeam || '').toUpperCase();

                let scoreText = `${data.aoScore || 0} - ${data.akaScore || 0}`;
                if (data.scoringMode === 'kata') {
                    scoreText = data.kataType === 'flag'
                        ? `${data.aoFlags || 0} - ${data.akaFlags || 0}`
                        : `${(data.kataScoreAo || 0).toFixed(1)} - ${(data.kataScoreAka || 0).toFixed(1)}`;
                }

                if (data.isHanteiResult && data.hanteiScore) {
                    document.getElementById('winnerSideLabel').innerText = 'HANTEI';
                    document.getElementById('winnerScore').innerText = data.hanteiScore;
                } else {
                    document.getElementById('winnerSideLabel').innerText = 'CHAMPION';
                    document.getElementById('winnerScore').innerText = scoreText;
                }
            } else {
                winnerBanner.classList.remove('show');
            }

            // 4. EVENT MEDIA OVERLAY
            const mediaOverlay = document.getElementById('eventMediaOverlay');
            const mediaVideo = document.getElementById('eventMediaVideo');
            const mediaImage = document.getElementById('eventMediaImage');

            if (data.showEventMedia && data.eventMediaUrl) {
                mediaOverlay.style.display = 'flex';

                if (data.eventMediaType === 'video') {
                    mediaVideo.src = data.eventMediaUrl;
                    mediaVideo.classList.remove('hidden');
                    mediaImage.classList.add('hidden');
                    // Force play
                    mediaVideo.play().catch(e => console.log('[Media] Autoplay blocked:', e));
                } else if (data.eventMediaType === 'image') {
                    mediaImage.src = data.eventMediaUrl;
                    mediaImage.classList.remove('hidden');
                    mediaVideo.classList.add('hidden');
                }
            } else {
                mediaOverlay.style.display = 'none';
                mediaVideo.src = '';
                mediaImage.src = '';
            }

            // 5. MAIN SCOREBOARD DATA
            document.getElementById('monitorCategory').innerText = (data.category || '').toUpperCase();
            document.getElementById('monitorTimer').innerText = data.timerText || "00:00";
            document.getElementById('atoshiLabel').classList.toggle('hidden', !data.isAtoshiBaraku);

            // AO Side
            document.getElementById('monitorNameAo').innerText = (data.nameAo || 'ATLET AO').toUpperCase();
            document.getElementById('monitorTeamAo').innerText = hasData(data.teamAo) ? data.teamAo.toUpperCase() : "TEAM";

            let scoreAo = data.scoringMode === 'kata'
                ? (data.kataType === 'flag' ? (data.aoFlags || 0) : (data.kataScoreAo || 0).toFixed(1))
                : (data.aoScore < 10 ? "0" + data.aoScore : data.aoScore);

            const aoEl = document.getElementById('monitorScoreAo');
            aoEl.innerText = scoreAo;

            // AKA Side
            document.getElementById('monitorNameAka').innerText = (data.nameAka || 'ATLET AKA').toUpperCase();
            document.getElementById('monitorTeamAka').innerText = hasData(data.teamAka) ? data.teamAka.toUpperCase() : "TEAM";

            let scoreAka = data.scoringMode === 'kata'
                ? (data.kataType === 'flag' ? (data.akaFlags || 0) : (data.kataScoreAka || 0).toFixed(1))
                : (data.akaScore < 10 ? "0" + data.akaScore : data.akaScore);

            const akaEl = document.getElementById('monitorScoreAka');

            akaEl.innerText = scoreAka;
            akaEl.classList.toggle('kata-score', data.scoringMode === 'kata' && data.kataType !== 'flag');
            aoEl.classList.toggle('kata-score', data.scoringMode === 'kata' && data.kataType !== 'flag');


            // Indicators
            document.getElementById('mon_vrAo').classList.toggle('hidden', !data.vrAo);
            document.getElementById('mon_vrAka').classList.toggle('hidden', !data.vrAka);
            document.getElementById('mon_senshuBadgeAo').classList.toggle('hidden', data.senshu !== 'ao');
            document.getElementById('mon_senshuBadgeAka').classList.toggle('hidden', data.senshu !== 'aka');

            // Penalties
            const levels = ['c1', 'c2', 'c3', 'hc', 'h'];
            levels.forEach(l => {
                const aoDot = document.getElementById(`mon_ao_${l}`);
                const akaDot = document.getElementById(`mon_aka_${l}`);

                if (aoDot) {
                    aoDot.classList.toggle('active', !!(data.penaltiesAo && data.penaltiesAo[l]));
                    if (data.penaltiesAo && data.penaltiesAo[l]) {
                        if (l === 'h') aoDot.classList.add('active-red');
                        else if (l === 'hc') aoDot.classList.add('active-yellow');
                    } else {
                        aoDot.classList.remove('active-red', 'active-yellow');
                    }
                }

                if (akaDot) {
                    akaDot.classList.toggle('active', !!(data.penaltiesAka && data.penaltiesAka[l]));
                    if (data.penaltiesAka && data.penaltiesAka[l]) {
                        if (l === 'h') akaDot.classList.add('active-red');
                        else if (l === 'hc') akaDot.classList.add('active-yellow');
                    } else {
                        akaDot.classList.remove('active-red', 'active-yellow');
                    }
                }
            });
        }

        window.toggleFullscreen = function () {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        }

        // ONE-CLICK FULLSCREEN FEATURE
        document.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.warn(`Fullscreen failed: ${err.message}`);
                });
            }
        });
    </script>
</body>

</html>