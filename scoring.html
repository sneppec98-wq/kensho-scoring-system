<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Scoring | Kensho Tech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/window-controls.css">
    <link rel="stylesheet" href="css/scoring.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<body class="h-screen overflow-hidden text-slate-100 bg-[#020617]">
    <script src="js/window-controls.js"></script>
    <!-- Aurora Background -->
    <div id="aurora-container">
        <div class="aurora aurora-1"></div>
        <div class="aurora aurora-2"></div>
        <div class="aurora aurora-3"></div>
    </div>

    <!-- SIDEBAR REMOVED FOR SCORING CONSOLE FOCUS -->

    <!-- CONTENT -->
    <!-- CONTENT -->
    <main class="w-full h-screen p-4 md:p-8 flex flex-col overflow-hidden relative">
        <!-- BACK BUTTON REMOVED AS PER REQUEST -->

        <header class="flex justify-between items-center mb-6">
            <!-- LEFT: BREADCRUMB -->
            <div class="flex-1 flex items-center justify-start">
                <a href="scoring-home.html"
                    class="flex items-center gap-3 px-4 py-2 rounded-2xl bg-white/5 border border-white/5 hover:bg-white/10 hover:border-white/10 transition-all group">
                    <svg class="w-4 h-4 text-slate-400 group-hover:text-red-500 group-hover:-translate-x-1 transition-all"
                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
                    </svg>
                    <span
                        class="text-[10px] font-black uppercase tracking-widest text-slate-500 group-hover:text-slate-200 transition-colors">Pusat
                        Scoring</span>
                </a>
            </div>

            <!-- CENTER: CONTROL REGISTRY -->
            <div
                class="flex items-center gap-2 px-3 py-2 rounded-[2rem] bg-slate-900/50 backdrop-blur-xl border border-white/5 shadow-2xl mx-4">
                <!-- MODE SWITCH -->
                <div class="flex p-1 rounded-xl bg-black/40 border border-white/5 min-w-[180px]">
                    <button id="modeKumiteBtn" onclick="setScoringMode('kumite')"
                        class="flex-1 py-2 rounded-lg text-[8px] font-black uppercase tracking-widest transition-all mode-active">KUMITE</button>
                    <button id="modeKataBtn" onclick="setScoringMode('kata')"
                        class="flex-1 py-2 rounded-lg text-[8px] font-black uppercase tracking-widest transition-all text-slate-500">KATA</button>
                </div>



            </div>

            <!-- RIGHT: TATAMI BADGE -->
            <div class="flex-1 flex items-center justify-end gap-3">
                <!-- Sync Indicator -->
                <div id="syncBadge" onclick="window.syncAll()" title="Klik untuk sinkronisasi manual"
                    style="cursor: pointer"
                    class="flex items-center gap-2 px-3 py-2 rounded-xl bg-white/5 border border-white/5 text-[7px] font-black uppercase tracking-[0.2em] text-slate-500 transition-all hover:bg-white/10 active:scale-95">
                    <div id="syncDot" class="w-1.5 h-1.5 rounded-full bg-slate-500"></div>
                    <span id="syncText">Offline Mode</span>
                </div>

                <div
                    class="flex items-center gap-4 pl-6 pr-2 py-2 rounded-2xl bg-red-600/5 border border-red-500/10 shadow-[0_0_30px_rgba(220,38,38,0.05)] relative group overflow-hidden">
                    <div
                        class="absolute inset-0 bg-gradient-to-r from-transparent via-red-500/5 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-1000">
                    </div>
                    <div class="text-right relative z-10">
                        <p
                            class="text-[7px] font-black uppercase opacity-40 tracking-[0.3em] leading-none mb-1 text-red-500">
                            Arena Aktif</p>
                        <p
                            class="text-xs font-black uppercase tracking-widest text-red-500 group-hover:scale-105 transition-transform">
                            TATAMI <span id="activeTatamiLabel" class="ml-1">-</span>
                        </p>
                    </div>
                    <div
                        class="w-8 h-8 rounded-xl bg-red-600/10 border border-red-500/20 flex items-center justify-center relative z-10">
                        <div class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></div>
                    </div>
                </div>
            </div>
        </header>

        <div id="mainScoringGrid" class="flex-1 flex flex-col gap-2 overflow-hidden">
            <!-- TOP: MATCH STATUS & SCOREBOARD -->
            <div id="scoringMainArea"
                class="flex-1 flex flex-col space-y-2 overflow-y-auto custom-scrollbar transition-all duration-500 pr-2">
                <!-- SCOREBOARD SPLIT-PANEL -->
                <div class="flex-1 grid grid-cols-12 gap-0 rounded-[3rem] overflow-hidden shadow-2xl border border-white/5 relative bg-slate-900/40 backdrop-blur-xl mb-2"
                    style="display: flex;">
                    <!-- AKA PANEL (Default: RIGHT side to match monitor) -->
                    <div id="panelContainerAka" style="order: 3; flex: 1.5;"
                        class="col-span-12 md:col-span-5 flex flex-col items-center justify-between py-6 px-8 bg-red-950/20 relative group border-l border-white/5 premium-gradient-red overflow-hidden">
                        <!-- DECORATIVE GLOW -->
                        <div
                            class="absolute -top-24 -right-24 w-48 h-48 bg-red-600/10 blur-[80px] rounded-full pointer-events-none">
                        </div>

                        <!-- HANTEI BUTTON (Minimalist) -->
                        <button id="btnHanteiAka" onclick="setHanteiWinner('aka')"
                            class="absolute top-0 right-0 px-6 py-2.5 bg-red-600 shadow-[0_8px_20px_rgba(220,38,38,0.4)] text-white rounded-bl-[2rem] border-l border-b border-white/20 hidden transition-all hover:scale-105 active:scale-95 z-50">
                            <span class="text-[10px] font-black italic tracking-[0.2em] uppercase">Kachi</span>
                        </button>

                        <div
                            class="absolute top-0 right-0 w-full h-1.5 bg-gradient-to-l from-red-600 to-transparent shadow-[0_5px_20px_rgba(220,38,38,0.4)]">
                        </div>

                        <!-- TOP: Name & Label -->
                        <div id="panelAka" class="text-center w-full relative z-10">
                            <p class="text-[11px] font-black uppercase tracking-[0.5em] text-red-500/50 mb-1.5 italic">
                                AKA</p>
                            <h2 id="nameAkaDisplay"
                                class="text-3xl font-black uppercase italic tracking-tight text-white truncate px-4 drop-shadow-lg">
                                ---</h2>
                            <p id="teamAkaDisplay"
                                class="text-[11px] font-black uppercase text-white/80 tracking-[0.2em] mt-1 truncate px-10">
                                ---</p>
                            <input type="text" id="inputKataAka" placeholder="Input Nama Kata"
                                oninput="checkKataShortcut(this)" onchange="broadcastData()"
                                class="w-auto min-w-[200px] bg-red-500/10 border border-red-500/20 rounded-2xl px-6 py-3 text-xs font-black uppercase tracking-widest text-red-400 mt-3 focus:bg-red-500/20 focus:border-red-500/50 focus:scale-105 focus:outline-none placeholder:text-red-500/30 transition-all text-center hidden shadow-inner">
                        </div>

                        <!-- CENTER: Score (Anchor) -->
                        <div id="scoreAka"
                            class="text-[180px] score-digit text-red-500 leading-none drop-shadow-[0_20px_60px_rgba(248,113,113,0.4)] select-none my-auto transition-all duration-300">
                            00</div>

                        <!-- BOTTOM: Controls -->
                        <div id="kumiteControlsAka" class="w-full relative z-10 space-y-4 px-4">
                            <!-- Score Buttons -->
                            <div class="grid grid-cols-4 gap-3">
                                <button onclick="addScore('aka', 1)"
                                    class="neu-button py-4 rounded-2xl group border-white/10">
                                    <span
                                        class="text-2xl font-black group-hover:scale-110 transition-transform text-red-400">+1</span>
                                </button>
                                <button onclick="addScore('aka', 2)"
                                    class="neu-button py-4 rounded-2xl group border-red-500/30">
                                    <span
                                        class="text-2xl font-black text-red-500 group-hover:scale-110 transition-transform">+2</span>
                                </button>
                                <button onclick="addScore('aka', 3)"
                                    class="neu-button py-4 rounded-2xl group border-red-500/50">
                                    <span
                                        class="text-2xl font-black text-red-600 group-hover:scale-110 transition-transform">+3</span>
                                </button>
                                <button onclick="addScore('aka', -1)"
                                    class="neu-button py-4 rounded-2xl group bg-white/5 opacity-40 border-white/5">
                                    <span
                                        class="text-2xl font-black text-slate-500 group-hover:scale-110 transition-transform">-1</span>
                                </button>
                            </div>

                            <!-- Penalty & Status Buttons -->
                            <div id="penAka" class="grid grid-cols-7 gap-2">
                                <button id="senshuAka" onclick="setSenshu('aka')"
                                    class="py-4 rounded-xl neu-button text-[12px] font-black opacity-70 hover:opacity-100 transition-opacity">S</button>
                                <button id="aka_c1" onclick="togglePenalty('aka', 'c1')"
                                    class="py-4 rounded-xl neu-button text-[12px] font-black opacity-60 bg-black/40 border-white/5 transition-all hover:opacity-100">C1</button>
                                <button id="aka_c2" onclick="togglePenalty('aka', 'c2')"
                                    class="py-4 rounded-xl neu-button text-[12px] font-black opacity-60 bg-black/40 border-white/5 transition-all hover:opacity-100">C2</button>
                                <button id="aka_c3" onclick="togglePenalty('aka', 'c3')"
                                    class="py-4 rounded-xl neu-button text-[12px] font-black opacity-60 bg-black/40 border-white/5 transition-all hover:opacity-100">C3</button>
                                <button id="aka_hc" onclick="togglePenalty('aka', 'hc')"
                                    class="py-4 rounded-xl neu-button text-[12px] font-black opacity-60 bg-black/40 border-white/5 transition-all hover:opacity-100">HC</button>
                                <button id="aka_h" onclick="togglePenalty('aka', 'h')"
                                    class="py-4 rounded-xl neu-button text-[12px] font-black opacity-60 bg-black/40 border-white/5 transition-all hover:opacity-100">H</button>
                                <button id="vrAka" onclick="toggleVR('aka')"
                                    class="py-4 rounded-xl neu-button text-[12px] font-black opacity-50 text-yellow-500 transition-all hover:opacity-100">VR</button>
                            </div>
                        </div>

                        <!-- KATA CONTROLS AKA (Integrated) -->
                        <div id="kataControlsAka" class="hidden w-full relative z-10 space-y-4 px-2">
                            <div class="grid grid-cols-5 gap-3">
                                <input type="text" id="judgeBtnAka0" value="0.0"
                                    oninput="window.updateKataJudgeScoreManual(this, 'aka', 0)" onfocus="this.select()"
                                    inputmode="decimal"
                                    class="oled-panel rounded-2xl py-4 text-center text-lg font-black text-red-500 hover:glow-red focus:glow-red focus:ring-2 focus:ring-red-500/50 outline-none transition-all bg-transparent">
                                <input type="text" id="judgeBtnAka1" value="0.0"
                                    oninput="window.updateKataJudgeScoreManual(this, 'aka', 1)" onfocus="this.select()"
                                    inputmode="decimal"
                                    class="oled-panel rounded-2xl py-4 text-center text-lg font-black text-red-500 hover:glow-red focus:glow-red focus:ring-2 focus:ring-red-500/50 outline-none transition-all bg-transparent">
                                <input type="text" id="judgeBtnAka2" value="0.0"
                                    oninput="window.updateKataJudgeScoreManual(this, 'aka', 2)" onfocus="this.select()"
                                    inputmode="decimal"
                                    class="oled-panel rounded-2xl py-4 text-center text-lg font-black text-red-500 hover:glow-red focus:glow-red focus:ring-2 focus:ring-red-500/50 outline-none transition-all bg-transparent">
                                <input type="text" id="judgeBtnAka3" value="0.0"
                                    oninput="window.updateKataJudgeScoreManual(this, 'aka', 3)" onfocus="this.select()"
                                    inputmode="decimal"
                                    class="oled-panel rounded-2xl py-4 text-center text-lg font-black text-red-500 hover:glow-red focus:glow-red focus:ring-2 focus:ring-red-500/50 outline-none transition-all bg-transparent">
                                <input type="text" id="judgeBtnAka4" value="0.0"
                                    oninput="window.updateKataJudgeScoreManual(this, 'aka', 4)" onfocus="this.select()"
                                    inputmode="decimal"
                                    class="oled-panel rounded-2xl py-4 text-center text-lg font-black text-red-500 hover:glow-red focus:glow-red focus:ring-2 focus:ring-red-500/50 outline-none transition-all bg-transparent">
                            </div>
                            <div
                                class="p-3.5 rounded-2xl bg-red-600/10 border border-red-500/20 flex justify-between items-center shadow-inner">
                                <div class="flex flex-col">
                                    <span
                                        class="text-[10px] font-black uppercase tracking-[0.2em] text-red-500/50">TOTAL
                                        SCORE</span>
                                    <button onclick="window.checkKataAutoWinner()"
                                        class="text-[8px] font-black text-red-500/80 hover:text-red-400 text-left">AUTO-CALC</button>
                                </div>
                                <span id="kataTotalAka" class="text-2xl font-black text-red-500 score-digit">0.0</span>
                            </div>
                        </div>

                        <!-- KATA FLAG CONTROLS AKA -->
                        <div id="kataFlagControlsAka" class="hidden w-full relative z-10 space-y-3 px-4">
                            <p class="text-[8px] font-black uppercase tracking-widest text-red-500/50 text-center">
                                VOTING BENDERA AKA</p>
                            <div class="grid grid-cols-6 gap-2">
                                <button onclick="setKataFlagsAka(0)"
                                    class="flag-btn-aka py-3 rounded-xl bg-white/5 text-red-500 text-lg font-black border border-white/10 hover:border-red-500 hover:bg-red-500/20 transition-all"
                                    data-val="0">0</button>
                                <button onclick="setKataFlagsAka(1)"
                                    class="flag-btn-aka py-3 rounded-xl bg-white/5 text-red-500 text-lg font-black border border-white/10 hover:border-red-500 hover:bg-red-500/20 transition-all"
                                    data-val="1">1</button>
                                <button onclick="setKataFlagsAka(2)"
                                    class="flag-btn-aka py-3 rounded-xl bg-white/5 text-red-500 text-lg font-black border border-white/10 hover:border-red-500 hover:bg-red-500/20 transition-all"
                                    data-val="2">2</button>
                                <button onclick="setKataFlagsAka(3)"
                                    class="flag-btn-aka py-3 rounded-xl bg-white/5 text-red-500 text-lg font-black border border-white/10 hover:border-red-500 hover:bg-red-500/20 transition-all"
                                    data-val="3">3</button>
                                <button onclick="setKataFlagsAka(4)"
                                    class="flag-btn-aka py-3 rounded-xl bg-white/5 text-red-500 text-lg font-black border border-white/10 hover:border-red-500 hover:bg-red-500/20 transition-all"
                                    data-val="4">4</button>
                                <button onclick="setKataFlagsAka(5)"
                                    class="flag-btn-aka py-3 rounded-xl bg-white/5 text-red-500 text-lg font-black border border-white/10 hover:border-red-500 hover:bg-red-500/20 transition-all"
                                    data-val="5">5</button>
                            </div>
                        </div>
                    </div>

                    <!-- CENTER STRIP: TIMER & ROUND -->
                    <div id="panelContainerCenter" style="order: 2; flex: 1; min-width: 210px;"
                        class="col-span-12 md:col-span-2 flex flex-col items-center justify-start py-4 px-3 bg-slate-950/40 border-x border-white/5 relative overflow-hidden gap-2.5 backdrop-blur-xl">

                        <!-- DECORATIVE CENTER BACKGROUND -->
                        <div
                            class="absolute inset-0 bg-[radial-gradient(circle_at_center,_rgba(30,41,59,0.3)_0%,_transparent_70%)] pointer-events-none">
                        </div>
                        <div
                            class="absolute inset-0 bg-gradient-to-b from-blue-500/5 via-transparent to-red-500/5 pointer-events-none opacity-30">
                        </div>

                        <!-- 1. CATEGORY HEADER -->
                        <div class="relative z-10 w-full">
                            <div
                                class="bg-white/[0.03] border border-white/10 px-3 py-1.5 rounded-xl flex flex-col items-center shadow-xl backdrop-blur-md">
                                <p id="categoryDisplay"
                                    class="text-[10px] font-black italic tracking-[0.3em] text-slate-100 uppercase overflow-hidden whitespace-nowrap text-ellipsis max-w-full">
                                    KUMITE</p>
                                <div class="w-10 h-0.5 bg-red-500 mt-1 rounded-full opacity-40"></div>
                            </div>
                        </div>

                        <!-- 2. UTILITY STRIP -->
                        <div
                            class="relative z-10 flex items-center gap-2 bg-white/[0.03] p-1 rounded-[1.25rem] border border-white/5 shadow-inner">
                            <button onclick="flipPanels()" id="btnFlipPanels"
                                class="w-10 h-10 rounded-lg bg-white/5 text-purple-400 flex items-center justify-center hover:bg-purple-600 hover:text-white transition-all shadow-lg border border-white/5"
                                title="Tukar Posisi AKA/AO">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                        d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                                </svg>
                            </button>
                            <button onclick="handleMonitor()" id="btnMonitor"
                                class="w-10 h-10 rounded-lg bg-white/5 text-blue-400 flex items-center justify-center hover:bg-blue-600 hover:text-white transition-all shadow-lg border border-white/5"
                                title="Open Monitor">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                        d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                </svg>
                            </button>
                            <button onclick="toggleSettingsModal()" id="btnOpenSettings"
                                class="w-10 h-10 rounded-lg bg-white/5 text-orange-400 flex items-center justify-center hover:bg-orange-600 hover:text-white transition-all shadow-lg border border-white/5"
                                title="Pengaturan Pertandingan">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </button>
                        </div>

                        <!-- 3. TIMER DISPLAY CARD -->
                        <div
                            class="relative z-10 w-full bg-white/[0.02] border border-white/5 rounded-[2rem] py-3 px-1.5 flex flex-col items-center shadow-2xl overflow-hidden group">
                            <div
                                class="absolute top-0 left-0 w-full h-0.5 bg-gradient-to-r from-transparent via-blue-500 to-transparent opacity-20">
                            </div>

                            <p class="text-[7px] font-black uppercase tracking-[0.6em] text-white/20 mb-1.5 ml-0.5">
                                TIMER</p>

                            <div class="flex flex-col items-center w-full">
                                <input id="timerDisplay" type="text" value="01:00" onblur="handleTimerBlur(this)"
                                    onkeydown="handleTimerKey(event, this)"
                                    class="text-5xl font-black italic shimmer-text leading-none w-full text-center bg-transparent focus:outline-none cursor-text select-all drop-shadow-[0_0_10px_rgba(255,255,255,0.08)]">

                                <!-- QUICK ADJUST -->
                                <div
                                    class="flex gap-2 mt-2 opacity-0 group-hover:opacity-100 transition-all duration-500 transform translate-y-2 group-hover:translate-y-0">
                                    <button onclick="adjustTimer(-60)"
                                        class="w-10 h-8 rounded-lg bg-white/5 flex items-center justify-center text-[8px] font-black hover:bg-red-500/20 hover:text-red-400 transition-all border border-white/5 shadow-lg">-1M</button>
                                    <button onclick="adjustTimer(-1)"
                                        class="w-10 h-8 rounded-lg bg-white/5 flex items-center justify-center text-[8px] font-black hover:bg-red-500/20 hover:text-red-400 transition-all border border-white/5 shadow-lg">-1S</button>
                                    <button onclick="adjustTimer(1)"
                                        class="w-10 h-8 rounded-lg bg-white/5 flex items-center justify-center text-[8px] font-black hover:bg-green-500/20 hover:text-green-400 transition-all border border-white/5 shadow-lg">+1S</button>
                                    <button onclick="adjustTimer(60)"
                                        class="w-10 h-8 rounded-lg bg-white/5 flex items-center justify-center text-[8px] font-black hover:bg-green-500/20 hover:text-green-400 transition-all border border-white/5 shadow-lg">+1M</button>
                                </div>
                            </div>

                            <div
                                class="mt-3 flex items-center gap-2 bg-black/40 px-3 py-1.5 rounded-full border border-white/5 shadow-inner">
                                <span id="timerStatusDot"
                                    class="w-2 h-2 rounded-full bg-slate-500 animate-pulse"></span>
                                <p id="timerLabel"
                                    class="text-[8px] font-black uppercase tracking-widest text-slate-400 whitespace-nowrap">
                                    STANDBY</p>
                            </div>
                        </div>

                        <!-- 4. ACTION CONTROLS (TIMER & MATCH) -->
                        <div
                            class="relative z-10 flex items-center justify-center gap-2.5 bg-white/[0.03] p-1.5 rounded-[1.5rem] border border-white/5 shadow-inner">
                            <!-- FINISH MATCH / NEXT -->
                            <button onclick="finishMatch()" id="btnFinishMatch"
                                class="w-11 h-11 rounded-xl bg-emerald-600 text-white flex items-center justify-center shadow-lg hover:scale-110 active:scale-95 transition-all border-t border-white/20"
                                title="Selesaikan Match & Simpan Data">
                                <i id="finishIcon" class="fa-solid fa-check text-xl"></i>
                            </button>

                            <!-- PLAY/PAUSE TIMER -->
                            <button onclick="toggleTimer()" id="btnTimerControl"
                                class="w-11 h-11 rounded-xl bg-red-600 text-white flex items-center justify-center shadow-lg hover:scale-110 active:scale-95 transition-all border-t border-white/20"
                                title="Play/Pause Timer">
                                <svg id="timerIcon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M8 5v14l11-7z" />
                                </svg>
                            </button>

                            <!-- RESET TIMER ONLY -->
                            <button onclick="resetTimer()" id="btnResetTimerControl"
                                class="w-11 h-11 rounded-xl bg-white/5 text-yellow-500/50 flex items-center justify-center border border-white/10 hover:bg-white/[0.08] hover:text-yellow-400 transition-all shadow-lg"
                                title="Reset Timer Only">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.5"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </button>

                            <!-- RESET FULL MATCH -->
                            <button onclick="resetMatch()" id="btnResetControl"
                                class="w-11 h-11 rounded-xl bg-white/5 text-slate-400 flex items-center justify-center border border-white/10 hover:bg-white/[0.08] hover:text-white transition-all shadow-lg"
                                title="Reset Full Match (Scores, Penalties & Timer)">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                            </button>
                        </div>

                        <!-- 5. MODE SPECIFIC CONTROLS (DYNAMIC) -->
                        <div class="relative z-10 w-full flex flex-col gap-2">

                            <!-- TIMER QUICK TOGGLE (KATA ONLY) -->
                            <div id="timerToggleContainer"
                                class="hidden flex items-center justify-between w-full px-4 py-2.5 bg-white/[0.03] rounded-[1.5rem] border border-white/5 shadow-inner">
                                <div class="flex items-center gap-2">
                                    <div id="timerToggleStatus"
                                        class="w-2 h-2 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.5)]">
                                    </div>
                                    <p class="text-[8px] font-black uppercase tracking-widest text-slate-400">AUTO TIMER
                                    </p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="timerEnableSwitch" class="sr-only peer" checked
                                        onchange="toggleTimerSetting(this.checked)">
                                    <div
                                        class="w-9 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-red-600">
                                    </div>
                                </label>
                            </div>

                            <!-- CONSOLIDATED KATA CONTROLS ROW -->
                            <div id="consolidatedKataControls"
                                class="hidden w-full flex flex-row items-stretch gap-3 p-3 bg-white/[0.03] rounded-[2rem] border border-white/5 shadow-inner">

                                <!-- KATA MODE SELECTOR -->
                                <div class="flex-none flex flex-col items-center gap-1.5 min-w-[80px]">
                                    <p class="text-[7px] font-black uppercase tracking-[0.2em] text-slate-500">MODE</p>
                                    <div id="kataTypeSwitch"
                                        class="flex w-full h-10 bg-white/[0.02] p-1 rounded-xl border border-white/5 shadow-inner">
                                        <button id="kataTypeScoreBtn" onclick="setKataType('score')"
                                            class="flex-1 rounded-lg text-[8px] font-black uppercase transition-all mode-active italic"
                                            title="Score Points">1.0</button>
                                        <button id="kataTypeFlagBtn" onclick="setKataType('flag')"
                                            class="flex-1 rounded-lg text-[10px] font-black transition-all text-slate-500 italic"
                                            title="Flag Voting">üö©</button>
                                    </div>
                                </div>

                                <div class="w-[1px] h-14 bg-white/10 shrink-0 self-center"></div>

                                <!-- KATA PERFORMER SELECTOR -->
                                <div class="flex-none flex flex-col items-center gap-1.5 min-w-[100px]">
                                    <p class="text-[7px] font-black uppercase tracking-[0.2em] text-slate-500">PLAYER
                                    </p>
                                    <div id="performerSelector" class="flex gap-1.5 w-full h-10">
                                        <button id="performerAkaBtn" onclick="setKataPerformer('aka')"
                                            class="flex-1 rounded-lg bg-white/5 text-red-500 flex items-center justify-center hover:text-white transition-all border border-white/5 shadow-md">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                                <path
                                                    d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                                            </svg>
                                        </button>
                                        <button id="performerAoBtn" onclick="setKataPerformer('ao')"
                                            class="flex-1 rounded-lg bg-white/5 text-blue-500 flex items-center justify-center hover:text-white transition-all border border-white/5 shadow-md">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                                <path
                                                    d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- HANTEI FLAG CONTROLS (Hidden by default, shows on draw) -->
                            <div id="hanteiControls"
                                class="hidden w-full flex flex-col gap-3 p-4 bg-yellow-500/10 rounded-[2rem] border border-yellow-500/30 shadow-inner">
                                <p class="text-[8px] font-black uppercase tracking-[0.3em] text-yellow-500 text-center">
                                    ‚öñÔ∏è HANTEI - KEPUTUSAN WASIT ‚öñÔ∏è
                                </p>
                                <div class="flex items-center justify-center gap-6">
                                    <!-- AKA FLAGS INPUT -->
                                    <div class="flex flex-col items-center gap-1">
                                        <p class="text-[7px] font-black uppercase text-red-500">AKA</p>
                                        <input type="number" id="hanteiInputAka" min="0" max="5" value="0"
                                            onchange="checkHanteiResult()"
                                            class="w-14 h-12 text-center text-2xl font-black bg-red-500/20 text-red-500 border-2 border-red-500/50 rounded-xl focus:outline-none focus:border-red-500 transition-all" />
                                    </div>
                                    <span class="text-2xl font-black text-yellow-500/50">-</span>
                                    <!-- AO FLAGS INPUT -->
                                    <div class="flex flex-col items-center gap-1">
                                        <p class="text-[7px] font-black uppercase text-blue-500">AO</p>
                                        <input type="number" id="hanteiInputAo" min="0" max="5" value="0"
                                            onchange="checkHanteiResult()"
                                            class="w-14 h-12 text-center text-2xl font-black bg-blue-500/20 text-blue-500 border-2 border-blue-500/50 rounded-xl focus:outline-none focus:border-blue-500 transition-all" />
                                    </div>
                                </div>
                                <button onclick="confirmHantei()" id="btnConfirmHantei"
                                    class="w-full py-2 rounded-xl bg-yellow-500 text-black text-[9px] font-black uppercase tracking-widest hover:bg-yellow-400 active:scale-95 transition-all shadow-lg">
                                    Konfirmasi Pemenang
                                </button>
                            </div>

                        </div>

                        <!-- FOOTER INFO -->
                        <div class="mt-auto pt-2 text-center opacity-5">
                            <p class="text-[6px] font-black uppercase tracking-[0.8em]">KENSHO SCORING SYSTEM</p>
                        </div>
                    </div>

                    <!-- AO PANEL (Default: LEFT side to match monitor) -->
                    <div id="panelContainerAo" style="order: 1; flex: 1.5;"
                        class="col-span-12 md:col-span-5 flex flex-col items-center justify-between py-6 px-8 bg-blue-950/20 relative group border-r border-white/5 premium-gradient-blue overflow-hidden">
                        <!-- DECORATIVE GLOW -->
                        <div
                            class="absolute -top-24 -left-24 w-48 h-48 bg-blue-600/10 blur-[80px] rounded-full pointer-events-none">
                        </div>

                        <!-- HANTEI BUTTON (Minimalist) -->
                        <button id="btnHanteiAo" onclick="setHanteiWinner('ao')"
                            class="absolute top-0 left-0 px-6 py-2.5 bg-blue-600 shadow-[0_8px_20px_rgba(37,99,235,0.4)] text-white rounded-br-[2rem] border-r border-b border-white/20 hidden transition-all hover:scale-105 active:scale-95 z-50">
                            <span class="text-[10px] font-black italic tracking-[0.2em] uppercase">Kachi</span>
                        </button>

                        <div
                            class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-blue-600 to-transparent shadow-[0_5px_20px_rgba(37,99,235,0.4)]">
                        </div>

                        <!-- TOP: Name & Label -->
                        <div id="panelAo" class="text-center w-full relative z-10">
                            <p class="text-[11px] font-black uppercase tracking-[0.5em] text-blue-500/50 mb-1.5 italic">
                                AO</p>
                            <h2 id="nameAoDisplay"
                                class="text-3xl font-black uppercase italic tracking-tight text-white truncate px-4 drop-shadow-lg">
                                ---</h2>
                            <p id="teamAoDisplay"
                                class="text-[11px] font-black uppercase text-white/80 tracking-[0.2em] mt-1 truncate px-10">
                                ---</p>
                            <input type="text" id="inputKataAo" placeholder="Input Nama Kata"
                                oninput="checkKataShortcut(this)" onchange="broadcastData()"
                                class="w-auto min-w-[200px] bg-blue-500/10 border border-blue-500/20 rounded-2xl px-6 py-3 text-xs font-black uppercase tracking-widest text-blue-400 mt-3 focus:bg-blue-500/20 focus:border-blue-500/50 focus:scale-105 focus:outline-none placeholder:text-blue-500/30 transition-all text-center hidden shadow-inner">
                        </div>

                        <!-- CENTER: Score (Anchor) -->
                        <div id="scoreAo"
                            class="text-[180px] score-digit text-blue-500 leading-none drop-shadow-[0_20px_60px_rgba(59,130,246,0.4)] select-none my-auto transition-all duration-300">
                            00</div>

                        <!-- BOTTOM: Controls -->
                        <div id="kumiteControlsAo" class="w-full relative z-10 space-y-4 px-4">
                            <!-- Score Buttons -->
                            <div class="grid grid-cols-4 gap-3">
                                <button onclick="addScore('ao', 1)"
                                    class="neu-button py-4 rounded-2xl group border-white/10">
                                    <span
                                        class="text-2xl font-black group-hover:scale-110 transition-transform text-blue-400">+1</span>
                                </button>
                                <button onclick="addScore('ao', 2)"
                                    class="neu-button py-4 rounded-2xl group border-blue-500/30">
                                    <span
                                        class="text-2xl font-black text-blue-500 group-hover:scale-110 transition-transform">+2</span>
                                </button>
                                <button onclick="addScore('ao', 3)"
                                    class="neu-button py-4 rounded-2xl group border-blue-500/50">
                                    <span
                                        class="text-2xl font-black text-blue-600 group-hover:scale-110 transition-transform">+3</span>
                                </button>
                                <button onclick="addScore('ao', -1)"
                                    class="neu-button py-4 rounded-2xl group bg-white/5 opacity-40 border-white/5">
                                    <span
                                        class="text-2xl font-black text-slate-500 group-hover:scale-110 transition-transform">-1</span>
                                </button>
                            </div>

                            <!-- Penalty & Status Buttons -->
                            <div id="penAo" class="grid grid-cols-7 gap-2">
                                <button id="senshuAo" onclick="setSenshu('ao')"
                                    class="py-4 rounded-xl neu-button text-[12px] font-black opacity-70 hover:opacity-100 transition-opacity">S</button>
                                <button id="ao_c1" onclick="togglePenalty('ao', 'c1')"
                                    class="py-4 rounded-xl neu-button text-[12px] font-black opacity-60 bg-black/40 border-white/5 transition-all hover:opacity-100">C1</button>
                                <button id="ao_c2" onclick="togglePenalty('ao', 'c2')"
                                    class="py-4 rounded-xl neu-button text-[12px] font-black opacity-60 bg-black/40 border-white/5 transition-all hover:opacity-100">C2</button>
                                <button id="ao_c3" onclick="togglePenalty('ao', 'c3')"
                                    class="py-4 rounded-xl neu-button text-[12px] font-black opacity-60 bg-black/40 border-white/5 transition-all hover:opacity-100">C3</button>
                                <button id="ao_hc" onclick="togglePenalty('ao', 'hc')"
                                    class="py-4 rounded-xl neu-button text-[12px] font-black opacity-60 bg-black/40 border-white/5 transition-all hover:opacity-100">HC</button>
                                <button id="ao_h" onclick="togglePenalty('ao', 'h')"
                                    class="py-4 rounded-xl neu-button text-[12px] font-black opacity-60 bg-black/40 border-white/5 transition-all hover:opacity-100">H</button>
                                <button id="vrAo" onclick="toggleVR('ao')"
                                    class="py-4 rounded-xl neu-button text-[12px] font-black opacity-50 text-yellow-500 transition-all hover:opacity-100">VR</button>
                            </div>
                        </div>

                        <!-- KATA CONTROLS AO (Integrated) -->
                        <div id="kataControlsAo" class="hidden w-full relative z-10 space-y-4 px-2">
                            <div class="grid grid-cols-5 gap-3">
                                <input type="text" id="judgeBtnAo0" value="0.0"
                                    oninput="window.updateKataJudgeScoreManual(this, 'ao', 0)" onfocus="this.select()"
                                    inputmode="decimal"
                                    class="oled-panel rounded-2xl py-4 text-center text-lg font-black text-blue-500 hover:glow-blue focus:glow-blue focus:ring-2 focus:ring-blue-500/50 outline-none transition-all bg-transparent">
                                <input type="text" id="judgeBtnAo1" value="0.0"
                                    oninput="window.updateKataJudgeScoreManual(this, 'ao', 1)" onfocus="this.select()"
                                    inputmode="decimal"
                                    class="oled-panel rounded-2xl py-4 text-center text-lg font-black text-blue-500 hover:glow-blue focus:glow-blue focus:ring-2 focus:ring-blue-500/50 outline-none transition-all bg-transparent">
                                <input type="text" id="judgeBtnAo2" value="0.0"
                                    oninput="window.updateKataJudgeScoreManual(this, 'ao', 2)" onfocus="this.select()"
                                    inputmode="decimal"
                                    class="oled-panel rounded-2xl py-4 text-center text-lg font-black text-blue-500 hover:glow-blue focus:glow-blue focus:ring-2 focus:ring-blue-500/50 outline-none transition-all bg-transparent">
                                <input type="text" id="judgeBtnAo3" value="0.0"
                                    oninput="window.updateKataJudgeScoreManual(this, 'ao', 3)" onfocus="this.select()"
                                    inputmode="decimal"
                                    class="oled-panel rounded-2xl py-4 text-center text-lg font-black text-blue-500 hover:glow-blue focus:glow-blue focus:ring-2 focus:ring-blue-500/50 outline-none transition-all bg-transparent">
                                <input type="text" id="judgeBtnAo4" value="0.0"
                                    oninput="window.updateKataJudgeScoreManual(this, 'ao', 4)" onfocus="this.select()"
                                    inputmode="decimal"
                                    class="oled-panel rounded-2xl py-4 text-center text-lg font-black text-blue-500 hover:glow-blue focus:glow-blue focus:ring-2 focus:ring-blue-500/50 outline-none transition-all bg-transparent">
                            </div>
                            <div
                                class="p-3.5 rounded-2xl bg-blue-600/10 border border-blue-500/20 flex justify-between items-center shadow-inner">
                                <div class="flex flex-col">
                                    <span
                                        class="text-[10px] font-black uppercase tracking-[0.2em] text-blue-500/50">TOTAL
                                        SCORE</span>
                                    <button onclick="window.checkKataAutoWinner()"
                                        class="text-[8px] font-black text-blue-500/80 hover:text-blue-400 text-left">AUTO-CALC</button>
                                </div>
                                <span id="kataTotalAo" class="text-2xl font-black text-blue-500 score-digit">0.0</span>
                            </div>
                        </div>
                        <!-- KATA FLAG CONTROLS AO -->
                        <div id="kataFlagControlsAo" class="hidden w-full relative z-10 space-y-3 px-4">
                            <p class="text-[8px] font-black uppercase tracking-widest text-blue-500/50 text-center">
                                VOTING BENDERA AO</p>
                            <div class="grid grid-cols-6 gap-2">
                                <button onclick="setKataFlagsAo(0)"
                                    class="flag-btn-ao py-3 rounded-xl bg-white/5 text-blue-500 text-lg font-black border border-white/10 hover:border-blue-500 hover:bg-blue-500/20 transition-all"
                                    data-val="0">0</button>
                                <button onclick="setKataFlagsAo(1)"
                                    class="flag-btn-ao py-3 rounded-xl bg-white/5 text-blue-500 text-lg font-black border border-white/10 hover:border-blue-500 hover:bg-blue-500/20 transition-all"
                                    data-val="1">1</button>
                                <button onclick="setKataFlagsAo(2)"
                                    class="flag-btn-ao py-3 rounded-xl bg-white/5 text-blue-500 text-lg font-black border border-white/10 hover:border-blue-500 hover:bg-blue-500/20 transition-all"
                                    data-val="2">2</button>
                                <button onclick="setKataFlagsAo(3)"
                                    class="flag-btn-ao py-3 rounded-xl bg-white/5 text-blue-500 text-lg font-black border border-white/10 hover:border-blue-500 hover:bg-blue-500/20 transition-all"
                                    data-val="3">3</button>
                                <button onclick="setKataFlagsAo(4)"
                                    class="flag-btn-ao py-3 rounded-xl bg-white/5 text-blue-500 text-lg font-black border border-white/10 hover:border-blue-500 hover:bg-blue-500/20 transition-all"
                                    data-val="4">4</button>
                                <button onclick="setKataFlagsAo(5)"
                                    class="flag-btn-ao py-3 rounded-xl bg-white/5 text-blue-500 text-lg font-black border border-white/10 hover:border-blue-500 hover:bg-blue-500/20 transition-all"
                                    data-val="5">5</button>
                            </div>
                        </div>
                    </div>
                </div>



            </div> <!-- End of scoringMainArea -->


        </div> <!-- End of mainScoringGrid -->

        <!-- PARTICIPANT LIST MODAL -->
        <div id="participantModal"
            class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden">
            <div
                class="glass-card rounded-[3rem] w-[90vw] max-w-5xl max-h-[85vh] flex flex-col overflow-hidden shadow-2xl border border-white/10">
                <!-- Modal Header -->
                <div class="flex justify-between items-center p-6 border-b border-white/10">
                    <div>
                        <h2 class="text-2xl font-black italic tracking-tight uppercase text-white mb-1">List Peserta
                        </h2>
                        <p class="text-[9px] font-bold uppercase tracking-widest text-slate-500">Kelas Tanding Aktif</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <span id="participantCountModal"
                            class="text-xs font-bold text-slate-400 bg-white/5 px-4 py-2 rounded-full border border-white/5">
                            0 Peserta
                        </span>
                        <button onclick="toggleParticipantModal()"
                            class="w-10 h-10 rounded-xl bg-red-500/10 border border-red-500/20 flex items-center justify-center text-red-500 hover:bg-red-500/20 transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Modal Body -->
                <div class="flex-1 overflow-y-auto p-6">
                    <table class="w-full">
                        <thead class="sticky top-0 bg-slate-900/80 backdrop-blur-md">
                            <tr class="border-b border-white/10">
                                <th
                                    class="text-left py-3 px-4 text-[9px] font-black uppercase tracking-[0.2em] text-slate-500">
                                    Partai</th>
                                <th
                                    class="text-left py-3 px-4 text-[9px] font-black uppercase tracking-[0.2em] text-slate-500">
                                    Peserta AKA</th>
                                <th
                                    class="text-center py-3 px-2 text-[9px] font-black uppercase tracking-[0.2em] text-slate-500">
                                    VS</th>
                                <th
                                    class="text-left py-3 px-4 text-[9px] font-black uppercase tracking-[0.2em] text-slate-500">
                                    Peserta AO</th>
                                <th
                                    class="text-center py-3 px-4 text-[9px] font-black uppercase tracking-[0.2em] text-slate-500">
                                    Action</th>
                            </tr>
                        </thead>
                        <tbody id="participantTableModal">
                            <tr>
                                <td colspan="6"
                                    class="py-12 text-center text-[10px] font-bold uppercase tracking-widest text-slate-600">
                                    Pilih kelas dari Pengaturan Pertandingan
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


    </main>

    <!-- CUSTOM MODAL HTML -->
    <div id="customModal">
        <div class="modal-content">
            <div class="w-16 h-16 bg-red-500/10 rounded-2xl flex items-center justify-center mx-auto mb-6">
                <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h3 id="modalTitle" class="text-xl font-black uppercase tracking-widest text-white mb-2">Konfirmasi</h3>
            <p id="modalMessage" class="text-sm font-medium text-slate-400 leading-relaxed mb-8">Apakah Anda yakin ingin
                mengganti pertandingan?</p>
            <div class="flex gap-4">
                <button id="modalCancel"
                    class="flex-1 py-3 rounded-xl neu-button text-[10px] font-black uppercase tracking-widest text-slate-500">Batal</button>
                <button id="modalConfirm"
                    class="flex-1 py-3 rounded-xl bg-red-500 text-white text-[10px] font-black uppercase tracking-widest shadow-[0_8px_15px_rgba(248,113,113,0.3)]">Lanjutkan</button>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal"
        class="fixed inset-0 z-[100] hidden items-center justify-center p-4 bg-slate-950/80 backdrop-blur-md transition-all duration-300">
        <div class="bg-slate-900/90 border border-white/10 rounded-[2.5rem] w-full max-w-lg p-8 neu-flat animate-pop">
            <h3 class="text-xl font-black uppercase tracking-widest text-white mb-6 italic shimmer-text">Pengaturan
                Pertandingan</h3>

            <div class="space-y-6">
                <div class="autocomplete-container">
                    <label class="block text-[8px] font-black uppercase tracking-[0.4em] text-white/30 mb-2 ml-1">Nama
                        Kelas / Kategori</label>
                    <input type="text" id="inputCategory" placeholder="Cari Kelas... (Contoh: Male Kumite)"
                        autocomplete="off" onfocus="showCategoryDropdown()" oninput="filterCategories(this.value)"
                        class="w-full bg-black/40 border border-white/10 rounded-2xl px-6 py-4 text-sm font-bold text-white focus:border-red-500/50 focus:bg-black/60 outline-none transition-all">

                    <div id="categoryDropdown" class="custom-scrollbar">
                        <!-- Items dynamically populated -->
                    </div>
                </div>

                <!-- ATHLETE INPUTS -->
                <div class="grid grid-cols-2 gap-4">
                    <!-- AKA SIDE -->
                    <div class="space-y-3">
                        <label class="block text-[8px] font-black uppercase tracking-[0.4em] text-red-500 mb-2 ml-1">üî¥
                            AKA / RED</label>

                        <div class="relative">
                            <label
                                class="block text-[7px] font-bold uppercase tracking-wider text-white/30 mb-1 ml-1">Nama
                                Atlet</label>
                            <input type="text" id="inputNameAka" placeholder="Ketik nama..."
                                oninput="filterAthletes('aka')" onfocus="showAthleteDropdown('aka')" autocomplete="off"
                                class="w-full bg-black/40 border border-red-500/20 rounded-xl px-4 py-3 text-xs font-bold text-white focus:border-red-500/50 focus:bg-black/60 outline-none transition-all">
                            <div id="athleteDropdownAka"
                                class="hidden absolute top-full left-0 right-0 mt-1 bg-slate-900/95 backdrop-blur-xl border border-red-500/30 rounded-xl max-h-40 overflow-y-auto custom-scrollbar shadow-2xl z-50">
                            </div>
                        </div>

                        <div>
                            <label
                                class="block text-[7px] font-bold uppercase tracking-wider text-white/30 mb-1 ml-1">Kontingen</label>
                            <input type="text" id="inputTeamAka" placeholder="Team AKA"
                                class="w-full bg-black/40 border border-red-500/20 rounded-xl px-4 py-3 text-xs font-bold text-white focus:border-red-500/50 focus:bg-black/60 outline-none transition-all">
                        </div>
                    </div>

                    <!-- AO SIDE -->
                    <div class="space-y-3">
                        <label class="block text-[8px] font-black uppercase tracking-[0.4em] text-blue-500 mb-2 ml-1">üîµ
                            AO / BLUE</label>

                        <div class="relative">
                            <label
                                class="block text-[7px] font-bold uppercase tracking-wider text-white/30 mb-1 ml-1">Nama
                                Atlet</label>
                            <input type="text" id="inputNameAo" placeholder="Ketik nama..."
                                oninput="filterAthletes('ao')" onfocus="showAthleteDropdown('ao')" autocomplete="off"
                                class="w-full bg-black/40 border border-blue-500/20 rounded-xl px-4 py-3 text-xs font-bold text-white focus:border-blue-500/50 focus:bg-black/60 outline-none transition-all">
                            <div id="athleteDropdownAo"
                                class="hidden absolute top-full left-0 right-0 mt-1 bg-slate-900/95 backdrop-blur-xl border border-blue-500/30 rounded-xl max-h-40 overflow-y-auto custom-scrollbar shadow-2xl z-50">
                            </div>
                        </div>

                        <div>
                            <label
                                class="block text-[7px] font-bold uppercase tracking-wider text-white/30 mb-1 ml-1">Kontingen</label>
                            <input type="text" id="inputTeamAo" placeholder="Team AO"
                                class="w-full bg-black/40 border border-blue-500/20 rounded-xl px-4 py-3 text-xs font-bold text-white focus:border-blue-500/50 focus:bg-black/60 outline-none transition-all">
                        </div>
                    </div>
                </div>

            </div>

            <div class="flex gap-4 mt-10">
                <button onclick="toggleSettingsModal()"
                    class="flex-1 py-4 rounded-xl neu-button text-[10px] font-black uppercase tracking-widest text-slate-500">Tutup</button>
                <button type="button" id="btnSaveSettings"
                    class="flex-1 py-4 rounded-xl bg-red-600 text-white text-[10px] font-black uppercase tracking-widest shadow-[0_10px_20px_rgba(220,38,38,0.3)]">Simpan
                    Pengaturan</button>
            </div>
        </div>
    </div>

    <!-- JUDGE KEYPAD MODAL -->
    <div id="judgeKeypadModal"
        class="fixed inset-0 z-[110] hidden items-center justify-center p-4 bg-slate-950/95 backdrop-blur-2xl transition-all duration-300">
        <div
            class="bg-slate-900/40 border border-white/10 rounded-[3.5rem] w-full max-w-5xl p-1 md:p-12 shadow-[0_0_100px_rgba(0,0,0,0.8)] overflow-hidden max-h-[92vh] flex flex-col relative">

            <!-- DECORATIVE BG GLOW -->
            <div id="keypadGlow"
                class="absolute -top-40 -left-40 w-80 h-80 bg-red-500/10 blur-[100px] rounded-full pointer-events-none transition-all duration-500">
            </div>

            <div class="flex justify-between items-start mb-10 px-6 pt-6 md:pt-0">
                <div>
                    <h3 class="text-3xl font-black uppercase tracking-tight text-white italic shimmer-text">INPUT NILAI
                        KATA</h3>
                    <div id="keypadSubtitleContainer" class="flex items-center gap-3 mt-2">
                        <span id="keypadBadge"
                            class="px-3 py-1 bg-red-500/20 text-red-500 text-[10px] font-black uppercase tracking-widest rounded-full border border-red-500/30">AKA</span>
                        <p id="keypadSubtitle"
                            class="text-[11px] font-black uppercase tracking-[0.3em] text-slate-400 italic">JUDGE 1</p>
                    </div>
                </div>
                <button onclick="closeJudgeKeypad()"
                    class="w-14 h-14 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center text-slate-400 hover:text-white hover:bg-white/10 hover:scale-110 active:scale-95 transition-all shadow-xl">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div id="keypadGrid"
                class="flex-1 overflow-y-auto px-6 pb-6 custom-scrollbar flex flex-col items-center justify-center space-y-8">
                <!-- Display Area -->
                <div class="flex items-center gap-6">
                    <div id="digitPrimer"
                        class="w-24 h-32 rounded-3xl bg-white/5 border-2 border-white/10 flex items-center justify-center text-7xl font-black text-white shadow-inner">
                        _</div>
                    <div class="text-6xl font-black text-white/20">.</div>
                    <div id="digitDecimal"
                        class="w-24 h-32 rounded-3xl bg-white/5 border-2 border-white/10 flex items-center justify-center text-7xl font-black text-white shadow-inner">
                        _</div>
                </div>

                <!-- Numpad Area -->
                <div class="grid grid-cols-3 gap-4 md:gap-6 max-w-sm w-full">
                    <button onclick="handleNumpad(1)" class="numpad-btn">1</button>
                    <button onclick="handleNumpad(2)" class="numpad-btn">2</button>
                    <button onclick="handleNumpad(3)" class="numpad-btn">3</button>
                    <button onclick="handleNumpad(4)" class="numpad-btn">4</button>
                    <button onclick="handleNumpad(5)" class="numpad-btn">5</button>
                    <button onclick="handleNumpad(6)" class="numpad-btn">6</button>
                    <button onclick="handleNumpad(7)" class="numpad-btn">7</button>
                    <button onclick="handleNumpad(8)" class="numpad-btn">8</button>
                    <button onclick="handleNumpad(9)" class="numpad-btn">9</button>
                    <div class="invisible"></div>
                    <button onclick="handleNumpad(0)" class="numpad-btn">0</button>
                    <button onclick="clearNumpad()" class="numpad-btn text-red-500 text-sm">CLR</button>
                </div>
            </div>

            <style>
                .numpad-btn {
                    width: 100%;
                    aspect-ratio: 1 / 1;
                    border-radius: 1.5rem;
                    background-color: rgba(255, 255, 255, 0.05);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 1.875rem;
                    font-weight: 900;
                    color: white;
                    transition: all 0.2s;
                    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
                }

                @media (min-width: 768px) {
                    .numpad-btn {
                        width: 6rem;
                        height: 6rem;
                    }
                }

                .numpad-btn:hover {
                    background-color: rgba(255, 255, 255, 0.1);
                    transform: scale(1.05);
                }

                .numpad-btn:active {
                    transform: scale(0.95);
                }

                .digit-active {
                    border-color: rgba(239, 68, 68, 0.5) !important;
                    background-color: rgba(239, 68, 68, 0.05) !important;
                    box-shadow: 0 0 30px rgba(239, 68, 68, 0.2) !important;
                }
            </style>

            <script>
                window.closeJudgeKeypad = function () {
                    const modal = document.getElementById('judgeKeypadModal');
                    if (modal) {
                        modal.classList.add('opacity-0');
                        setTimeout(() => {
                            modal.classList.add('hidden');
                            modal.classList.remove('opacity-0');
                        }, 300);
                    }
                }
            </script>

            <!-- Footer indicator -->
            <div class="p-6 border-t border-white/5 text-center">
                <p class="text-[9px] font-black uppercase tracking-[0.5em] text-slate-600">KENSHO SCORING SYSTEM ‚Ä¢
                    PREMIUM EDITION</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { rtdb, auth, db } from './js/firebase-init.js';
        import { handleLogout } from './js/auth-helpers.js';
        import { ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { collection, query, where, getDocs, orderBy, getDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { logActivity } from './js/activity-logger.js';
        import { broadcastScoreData } from './js/scoring-firebase.js';
        import { playBuzzer, playBeep, formatTime, resumeAudio } from './js/scoring-utils.js';
        import { GOLDEN_PRESETS, getNextSlot, ROUND_MATCH_IDS } from './js/bracket-utils.js';
        import { syncEngine } from './js/sync-engine.js';

        window.handleLogout = handleLogout;
        window.resumeAudio = resumeAudio;

        // Expose Firestore functions for participant list
        window.db = db;
        window.query = query;
        window.collection = collection;
        window.where = where;
        window.getDocs = getDocs;
        window.orderBy = orderBy;
        window.getDoc = getDoc;
        window.doc = doc;

        // üÜï State for tracking auto-loaded matches
        window.activeMatchId = null;
        window.GOLDEN_PRESETS = GOLDEN_PRESETS;
        window.getNextSlot = getNextSlot;
        window.ROUND_MATCH_IDS = ROUND_MATCH_IDS;
        window.syncAll = () => syncEngine.syncAll();

        // Protect Route
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'login.html';
            }
        });

        // Initial theme logic was removed since we are now permanent dark mode.

        // --- LOGIKA KONSOL SCORING ---
        window.akaScore = 0;
        window.aoScore = 0;
        window.timeLeft = 60; // 1 menit (Default User)
        window.timerId = null;
        window.isTimerRunning = false;
        window.isTimerEnabled = true;
        window.penaltiesAka = { c1: false, c2: false, c3: false, hc: false, h: false };
        window.penaltiesAo = { c1: false, c2: false, c3: false, hc: false, h: false };
        window.currentTatami = 1;
        window.monitorWindow = null;
        window.nameAka = "";
        window.nameAo = "";
        window.teamAka = "";
        window.teamAo = "";
        window.slotAka = null;
        window.slotAo = null;
        window.matchCategory = "";
        window.activeKataPerformer = null;
        window.scoringMode = 'kumite'; // 'kumite' or 'kata'
        window.kataType = 'score'; // 'score' or 'flag'
        window.kataScoreAka = 0.0;
        window.kataScoreAo = 0.0;
        window.judgeScoresAka = [0.0, 0.0, 0.0, 0.0, 0.0];
        window.judgeScoresAo = [0.0, 0.0, 0.0, 0.0, 0.0];
        window.akaFlags = 0;
        window.aoFlags = 0;
        window.senshu = null; // 'aka', 'ao', or null
        window.isWinnerDeclared = false;
        window.winnerSide = null;
        window.showWinnerBanner = false;
        window.vrAka = false;
        window.vrAo = false;
        window.isHantei = false;
        window.isQueueVisible = true;

        // --- SOUND EFFECTS (using modular functions) ---
        window.playBuzzer = playBuzzer;
        window.playBeep = playBeep;

        // --- SEARCHABLE DROPDOWN LOGIC ---
        window.matchCategories = [];
        window.eventId = new URLSearchParams(window.location.search).get('id');

        window.loadMatchCategories = async function () {
            if (!window.eventId) {
                console.warn('[Scoring] No eventId found in URL. Autocomplete disabled.');
                return;
            }
            try {
                const q = query(collection(db, `events/${window.eventId}/classes`), orderBy("name", "asc"));
                const snap = await getDocs(q);
                window.matchCategories = snap.docs.map(doc => doc.data().name);
                // console.log('[Scoring] Loaded categories:', window.matchCategories.length);
            } catch (err) {
                console.error('[Scoring] Error loading categories:', err);
            }
        };

        window.showCategoryDropdown = function () {
            const dropdown = document.getElementById('categoryDropdown');
            if (dropdown) dropdown.classList.add('active');
            window.filterCategories(document.getElementById('inputCategory').value);
        };

        window.filterCategories = function (queryText) {
            const dropdown = document.getElementById('categoryDropdown');
            if (!dropdown) return;

            const filtered = window.matchCategories.filter(cat =>
                cat.toLowerCase().includes(queryText.toLowerCase())
            );

            if (filtered.length === 0 && queryText === "") {
                dropdown.innerHTML = window.matchCategories.map(cat =>
                    `<div class="dropdown-item" onclick="selectCategory('${cat.replace(/'/g, "\\'")}')">${cat}</div>`
                ).join('');
            } else {
                dropdown.innerHTML = filtered.map(cat =>
                    `<div class="dropdown-item" onclick="selectCategory('${cat.replace(/'/g, "\\'")}')">${cat}</div>`
                ).join('');
            }

            dropdown.classList.toggle('active', filtered.length > 0 || (queryText === "" && window.matchCategories.length > 0));
        };

        window.selectCategory = function (name) {
            const input = document.getElementById('inputCategory');
            if (input) input.value = name;
            const dropdown = document.getElementById('categoryDropdown');
            if (dropdown) dropdown.classList.remove('active');

            // Load athletes for selected category
            window.loadAthletesForClass(name);
        };

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.autocomplete-container')) {
                const dropdown = document.getElementById('categoryDropdown');
                if (dropdown) dropdown.classList.remove('active');
            }
        });

        // --- CLASS SELECTOR LOGIC ---
        window.eventClasses = [];
        window.allEventClasses = []; // For filtering
        window.selectedClass = null;
        window.classAthletes = []; // Athletes from selected class

        // Toggle Class Selector Sidebar
        window.toggleClassSelector = function () {
            const sidebar = document.getElementById('classSelectorSidebar');
            if (!sidebar) return;

            const isOpen = !sidebar.classList.contains('translate-x-full');
            if (isOpen) {
                sidebar.classList.add('translate-x-full');
            } else {
                sidebar.classList.remove('translate-x-full');
                // Load classes if not yet loaded
                if (window.allEventClasses.length === 0) {
                    loadEventClasses();
                }
            }
        };

        // Load Event Classes from Firestore
        window.loadEventClasses = async function () {
            if (!window.eventId) {
                console.warn('[ClassSelector] No eventId found');
                return;
            }

            const container = document.getElementById('classListContainer');
            if (!container) return;

            try {
                container.innerHTML = '<div class="py-20 text-center opacity-20 italic text-[10px] font-black uppercase tracking-widest">Memuat...</div>';

                const q = query(collection(db, `events/${window.eventId}/classes`), orderBy("name", "asc"));
                const snap = await getDocs(q);

                window.allEventClasses = snap.docs.map(doc => ({
                    id: doc.id,
                    name: doc.data().name,
                    category: doc.data().category || 'unknown',
                }));

                window.eventClasses = [...window.allEventClasses];

                console.log(`[ClassSelector] Loaded ${window.eventClasses.length} classes`);
                renderClassList();

            } catch (err) {
                console.error('[ClassSelector] Error loading classes:', err);
                container.innerHTML = '<div class="py-20 text-center text-red-500 italic text-[10px] font-black uppercase">Error: ' + err.message + '</div>';
            }
        };

        // Render Class List
        window.renderClassList = function () {
            const container = document.getElementById('classListContainer');
            if (!container) return;

            if (window.eventClasses.length === 0) {
                container.innerHTML = '<div class="py-20 text-center opacity-20 italic text-[10px] font-black uppercase tracking-widest">Tidak ada kelas</div>';
                return;
            }

            const html = window.eventClasses.map(cls => {
                const isSelected = window.selectedClass && window.selectedClass.id === cls.id;
                const badge = cls.category === 'kumite' ?
                    '<span class="text-[7px] px-2 py-0.5 bg-red-500/20 text-red-500 rounded uppercase font-black">Kumite</span>' :
                    '<span class="text-[7px] px-2 py-0.5 bg-blue-500/20 text-blue-500 rounded uppercase font-black">Kata</span>';

                return `
                    <button onclick="selectClass('${cls.id}')" 
                        class="w-full text-left px-4 py-3 rounded-xl transition-all ${isSelected ?
                        'bg-gradient-to-r from-purple-600/30 to-red-600/30 border border-purple-500/50' :
                        'bg-white/5 border border-white/5 hover:bg-white/10 hover:border-purple-500/30'
                    }">
                        <div class="flex items-center justify-between gap-2">
                            <p class="text-xs font-bold text-white leading-tight flex-1">${cls.name}</p>
                            ${badge}
                        </div>
                    </button>
                `;
            }).join('');

            container.innerHTML = html;
        };

        // Filter Class List
        window.filterClassList = function () {
            const input = document.getElementById('classSearchInput');
            if (!input) return;

            const query = input.value.toLowerCase().trim();

            if (query === '') {
                window.eventClasses = [...window.allEventClasses];
            } else {
                window.eventClasses = window.allEventClasses.filter(cls =>
                    cls.name.toLowerCase().includes(query)
                );
            }

            renderClassList();
        };

        // Select Class
        window.selectClass = async function (classId) {
            const classData = window.allEventClasses.find(c => c.id === classId);
            if (!classData) return;

            window.selectedClass = classData;

            // Update UI
            const badge = document.getElementById('selectedClassInfo');
            const name = document.getElementById('selectedClassName');
            if (badge && name) {
                badge.classList.remove('hidden');
                name.textContent = classData.name;
            }

            // Update category display in main panel
            const categoryDisplay = document.getElementById('categoryDisplay');
            if (categoryDisplay) {
                categoryDisplay.textContent = classData.name;
            }

            // Update match category in window state
            window.matchCategory = classData.name;

            // Re-render to show selected state
            renderClassList();

            console.log(`[ClassSelector] Selected class: ${classData.name}`);

            // Load athletes for this class (for autocomplete)
            await loadAthletesForClass(classData.name);

            // Broadcast category change
            window.broadcastData();
        };

        // Load Athletes for Selected Class
        window.loadAthletesForClass = async function (className) {
            try {
                // Query athletes collection for this class
                const q = query(
                    collection(db, 'athletes'),
                    where('class', '==', className)
                );
                const snap = await getDocs(q);

                window.classAthletes = snap.docs.map(doc => ({
                    id: doc.id,
                    name: doc.data().name || doc.data().fullName || '',
                    team: doc.data().team || doc.data().kontingen || doc.data().contingent || '',
                }));

                console.log(`[ClassSelector] Loaded ${window.classAthletes.length} athletes for "${className}"`);
            } catch (err) {
                console.error('[ClassSelector] Error loading athletes:', err);
                window.classAthletes = [];
            }
        };


        // --- ADMIN REKAP & QUEUE INTEGRATION DISABLED ---
        const matchQueue = [];

        window.setupQueueListener = function () {
            // Disabled: Admin Rekap feature disabled
        };

        window.updateQueueUI = function (queue) {
            // Disabled: Admin Rekap feature disabled
        };

        window.loadAdminMatch = async function (match) {
            // Disabled: Admin Rekap feature disabled
        };

        window.loadNextMatchFromQueue = function () {
            // Disabled: Admin Rekap feature disabled
        };

        window.toggleQueueSidebar = function () {
            // Disabled: Admin Rekap feature disabled
        };

        // Load data on init
        window.loadMatchCategories();
        // window.setupQueueListener(); // Obsolete
        if (window.updateKataListLink) window.updateKataListLink();

        window.broadcastData = function () {
            const scoreData = {
                akaScore: window.akaScore,
                aoScore: window.aoScore,
                timeLeft: window.timeLeft,
                timerText: document.getElementById('timerDisplay')?.value || '00:00',
                isTimerRunning: window.isTimerRunning,
                isTimerEnabled: window.isTimerEnabled,
                penaltiesAka: window.penaltiesAka,
                penaltiesAo: window.penaltiesAo,
                tatami: window.currentTatami,
                nameAka: window.nameAka,
                nameAo: window.nameAo,
                teamAka: window.teamAka,
                teamAo: window.teamAo,
                activeKataPerformer: window.activeKataPerformer,
                category: window.matchCategory,
                kataAka: document.getElementById('inputKataAka')?.value || '',
                kataAo: document.getElementById('inputKataAo')?.value || '',
                senshu: window.senshu,
                isAtoshiBaraku: window.timeLeft <= 15 && window.timeLeft > 0,
                isWinnerDeclared: window.isWinnerDeclared,
                winnerSide: window.winnerSide,
                vrAka: window.vrAka,
                vrAo: window.vrAo,
                isHantei: window.isHantei,
                isHanteiResult: window.isHanteiResult || false,
                hanteiScore: window.hanteiScore || null,
                scoringMode: window.scoringMode,
                kataType: window.kataType,
                kataScoreAka: window.kataScoreAka,
                kataScoreAo: window.kataScoreAo,
                judgeScoresAka: window.judgeScoresAka,
                judgeScoresAo: window.judgeScoresAo,
                akaFlags: window.akaFlags,
                aoFlags: window.aoFlags,
                showWinnerBanner: window.showWinnerBanner
            };

            // Trigger internal UI updates IMMEDIATELY (Optimistic UI)
            if (window.updateBroadcastUI) window.updateBroadcastUI();

            // Offline-Ready Broadcast via localStorage (Instant)
            localStorage.setItem('karate_score_update', JSON.stringify(scoreData));

            // Use modular Firebase function with a small throttle
            if (window._broadcastTimeout) {
                // Throttled
            }
            clearTimeout(window._broadcastTimeout);
            window._broadcastTimeout = setTimeout(() => {
                broadcastScoreData(scoreData)
                    .catch(err => console.error('[Scoring] Broadcast failed:', err));
            }, 800);
        };

        window.updateBroadcastUI = function () {
            window.updateConsoleWinnerUI();

            // Sync Name & Team Displays (Console)
            const dAka = document.getElementById('nameAkaDisplay');
            const dAo = document.getElementById('nameAoDisplay');
            const tAka = document.getElementById('teamAkaDisplay');
            const tAo = document.getElementById('teamAoDisplay');
            if (dAka) dAka.innerText = (window.nameAka || '---').toUpperCase();
            if (dAo) dAo.innerText = (window.nameAo || '---').toUpperCase();
            if (tAka) tAka.innerText = (window.teamAka === '-' || !window.teamAka) ? '---' : window.teamAka.toUpperCase();
            if (tAo) tAo.innerText = (window.teamAo === '-' || !window.teamAo) ? '---' : window.teamAo.toUpperCase();

            // Hantei Buttons visibility
            const btnHaka = document.getElementById('btnHanteiAka');
            const btnHao = document.getElementById('btnHanteiAo');
            if (btnHaka) btnHaka.classList.toggle('hidden', !window.isHantei);
            if (btnHao) btnHao.classList.toggle('hidden', !window.isHantei);

            // Hantei Controls visibility (center panel flag voting)
            const hanteiControls = document.getElementById('hanteiControls');
            if (hanteiControls) {
                hanteiControls.classList.toggle('hidden', !window.isHantei);
                hanteiControls.classList.toggle('flex', window.isHantei);
            }

            // Update Performer Buttons (No text to keep it compact)
            const akaBtn = document.getElementById('performerAkaBtn');
            const aoBtn = document.getElementById('performerAoBtn');
            // Logic handled by setKataPerformer and updateBroadcastUI classes
        }

        window.updateConsoleWinnerUI = function () {
            // Updated: Console no longer shows Winner badge/glow to reduce clutter
            // The WINNER announcement is now handled directly on the Monitor

            const btnFinish = document.getElementById('btnFinishMatch');
            const iconFinish = document.getElementById('finishIcon');

            if (btnFinish && iconFinish) {
                if (window.isWinnerDeclared) {
                    btnFinish.title = "Pertandingan Berikutnya (Reset)";
                    btnFinish.classList.remove('bg-emerald-600');
                    btnFinish.classList.add('bg-blue-600');
                    iconFinish.className = "fa-solid fa-forward text-xl";
                } else {
                    btnFinish.title = "Selesaikan Match & Simpan Data";
                    btnFinish.classList.remove('bg-blue-600');
                    btnFinish.classList.add('bg-emerald-600');
                    iconFinish.className = "fa-solid fa-check text-xl";
                }
            }

            // Update Winner Selector Buttons (No text to keep it compact)
            const winAkaBtn = document.getElementById('winAkaBtn');
            const winAoBtn = document.getElementById('winAoBtn');

            const announceBtn = document.getElementById('btnAnnounceWinner');
            if (announceBtn) {
                announceBtn.classList.toggle('hidden', !window.isWinnerDeclared || window.showWinnerBanner);
            }
        }


        const initDashboard = () => {
            const urlParams = new URLSearchParams(window.location.search);
            window.currentTatami = urlParams.get('tatami') || 1;
            window.eventId = urlParams.get('id');
            const classParam = urlParams.get('class');

            if (document.getElementById('activeTatamiLabel')) {
                document.getElementById('activeTatamiLabel').innerText = `${window.currentTatami}`;
            }

            // Update Kata List links
            if (window.updateKataListLink) window.updateKataListLink();

            window.resetMatch();

            // Sync mode from URL
            const modeParam = urlParams.get('mode');
            if (modeParam === 'kata_score') {
                window.setScoringMode('kata');
                window.setKataType('score');
            } else if (modeParam === 'kata_flag') {
                window.setScoringMode('kata');
                window.setKataType('flag');
            } else {
                window.setScoringMode('kumite'); // Default
            }

            // Check loadMode parameter (declare once at function scope)
            const loadMode = urlParams.get('loadMode');

            // Sync Class from URL
            if (classParam) {
                const decodedClass = decodeURIComponent(classParam);
                window.matchCategory = decodedClass;
                const catDisplay = document.getElementById('categoryDisplay');
                if (catDisplay) catDisplay.innerText = decodedClass;
                const inputCat = document.getElementById('inputCategory');
                if (inputCat) inputCat.value = decodedClass;

                // NEW: Auto-load participants only if loadMode is 'auto' or not specified
                if (loadMode !== 'blank') {
                    setTimeout(() => {
                        window.autoLoadParticipants(decodedClass);
                    }, 1000);
                } else {
                    console.log('[Scoring] Blank mode selected - skipping auto-load');
                }
            }

            // Blank mode hiding logic removed
            // console.log('[Scoring] Blank mode logic disabled - all elements visible');

            // Restore panel layout preference
            const savedLayout = localStorage.getItem('panelLayout');
            if (savedLayout === 'flipped') {
                setTimeout(() => {
                    flipPanels(); // Apply flipped layout if previously saved
                    console.log('[Panel Layout] Restored flipped layout from localStorage');
                }, 100);
            }
        };

        window.autoLoadParticipants = async function (className) {
            console.log('[Scoring] Attempting to auto-load participants for:', className);
            await loadParticipants();

            if (participantListData.length > 0) {
                const firstMatch = participantListData[0];
                const aka = firstMatch.aka;
                const ao = firstMatch.ao;

                console.log('[Scoring] Auto-loading Match #1:', (aka?.name || 'BYE'), 'vs', (ao?.name || 'BYE'));

                if (aka && aka.name && aka.name !== '-') {
                    window.nameAka = aka.name;
                    window.teamAka = aka.team || '';
                    window.slotAka = aka.slotId;
                    const display = document.getElementById('nameAkaDisplay');
                    if (display) display.innerText = aka.name.toUpperCase();
                }

                if (ao && ao.name && ao.name !== '-') {
                    window.nameAo = ao.name;
                    window.teamAo = ao.team || '';
                    window.slotAo = ao.slotId;
                    const display = document.getElementById('nameAoDisplay');
                    if (display) display.innerText = ao.name.toUpperCase();
                }

                window.matchCategory = className;
                if (window.broadcastData) window.broadcastData();
            } else {
                console.log('[Scoring] No match data available for auto-load');
            }
        };

        window.setScoringMode = function (mode) {
            const oldMode = window.scoringMode;
            window.scoringMode = mode;
            const isKata = mode === 'kata';

            // Reset match data if mode actually changes
            if (oldMode && oldMode !== mode) {
                console.log(`[Scoring] Mode changed from ${oldMode} to ${mode} - triggering reset`);
                window.resetMatch();
            }

            // UI Toggle Buttons with Safety
            const kumiteBtn = document.getElementById('modeKumiteBtn');
            const kataBtn = document.getElementById('modeKataBtn');
            const catDisplay = document.getElementById('categoryDisplay');
            const consolidatedKataControls = document.getElementById('consolidatedKataControls');

            if (kumiteBtn) {
                if (!isKata) {
                    kumiteBtn.className = "flex-1 py-2 rounded-lg text-[8px] font-black uppercase tracking-widest transition-all mode-active";
                } else {
                    kumiteBtn.className = "flex-1 py-2 rounded-lg text-[8px] font-black uppercase tracking-widest transition-all text-slate-500 hover:text-slate-300";
                }
            }
            if (kataBtn) {
                if (isKata) {
                    kataBtn.className = "flex-1 py-2 rounded-lg text-[8px] font-black uppercase tracking-widest transition-all mode-active";
                } else {
                    kataBtn.className = "flex-1 py-2 rounded-lg text-[8px] font-black uppercase tracking-widest transition-all text-slate-500 hover:text-slate-300";
                }
            }

            // Label Category
            if (catDisplay) catDisplay.innerText = isKata ? 'KATA' : 'KUMITE';

            // ... (rest of the function stays same or similar)
            if (consolidatedKataControls) {
                consolidatedKataControls.classList.toggle('hidden', !isKata);
                consolidatedKataControls.classList.toggle('flex', isKata); // Ensure flex is applied when visible
            }
            window.updateControlPanels();

            const timerToggle = document.getElementById('timerToggleContainer');
            if (timerToggle) {
                timerToggle.classList.toggle('hidden', !isKata);
                const switchInput = document.getElementById('timerEnableSwitch');
                if (isKata) {
                    window.toggleTimerSetting(false);
                    if (switchInput) switchInput.checked = false;
                } else {
                    window.toggleTimerSetting(true);
                    if (switchInput) switchInput.checked = true;
                }
            }

            const penAka = document.getElementById('penAka');
            const penAo = document.getElementById('penAo');
            if (penAka) penAka.classList.toggle('hidden', isKata);
            if (penAo) penAo.classList.toggle('hidden', isKata);

            const sAka = document.getElementById('scoreAka');
            const sAo = document.getElementById('scoreAo');

            if (isKata) {
                const iAka = document.getElementById('inputKataAka');
                const iAo = document.getElementById('inputKataAo');
                if (iAka) iAka.classList.remove('hidden');
                if (iAo) iAo.classList.remove('hidden');

                if (sAka && sAo) {
                    if (window.kataType === 'score') {
                        sAka.innerText = window.kataScoreAka.toFixed(1);
                        sAo.innerText = window.kataScoreAo.toFixed(1);
                    } else {
                        sAka.innerText = '--';
                        sAo.innerText = '--';
                    }
                    sAka.classList.add('text-6xl', 'md:text-[120px]');
                    sAo.classList.add('text-6xl', 'md:text-[120px]');
                    sAka.classList.remove('text-8xl', 'md:text-[180px]');
                    sAo.classList.remove('text-8xl', 'md:text-[180px]');
                }
            } else {
                const iAka = document.getElementById('inputKataAka');
                const iAo = document.getElementById('inputKataAo');
                if (iAka) iAka.classList.add('hidden');
                if (iAo) iAo.classList.add('hidden');

                if (sAka && sAo) {
                    sAka.innerText = window.akaScore.toString().padStart(2, '0');
                    sAo.innerText = window.aoScore.toString().padStart(2, '0');
                    sAka.classList.remove('text-6xl', 'md:text-8xl');
                    sAo.classList.remove('text-6xl', 'md:text-8xl');
                    sAka.classList.add('text-8xl', 'md:text-[180px]');
                    sAo.classList.add('text-8xl', 'md:text-[180px]');
                }
            }
            window.broadcastData();
        }

        window.setKataType = function (type) {
            window.kataType = type;
            const isFlag = type === 'flag';

            const scoreBtn = document.getElementById('kataTypeScoreBtn');
            const flagBtn = document.getElementById('kataTypeFlagBtn');

            if (scoreBtn) {
                if (!isFlag) {
                    scoreBtn.className = "flex-1 py-1.5 rounded-lg text-[8px] font-black uppercase transition-all mode-active italic";
                } else {
                    scoreBtn.className = "flex-1 py-1.5 rounded-lg text-[8px] font-black uppercase transition-all text-slate-500 italic hover:text-slate-300";
                }
            }
            if (flagBtn) {
                if (isFlag) {
                    flagBtn.className = "flex-1 py-1.5 rounded-lg text-[10px] font-black transition-all mode-active italic";
                } else {
                    flagBtn.className = "flex-1 py-1.5 rounded-lg text-[10px] font-black transition-all text-slate-500 italic hover:text-slate-300";
                }
            }

            window.updateControlPanels();

            // Refresh display
            if (window.scoringMode === 'kata') {
                if (isFlag) {
                    document.getElementById('scoreAka').innerText = window.isWinnerDeclared ? window.akaFlags : '--';
                    document.getElementById('scoreAo').innerText = window.isWinnerDeclared ? window.aoFlags : '--';
                } else {
                    document.getElementById('scoreAka').innerText = window.kataScoreAka.toFixed(1);
                    document.getElementById('scoreAo').innerText = window.kataScoreAo.toFixed(1);
                }
            }

            window.broadcastData();
        }

        window.updateControlPanels = function () {
            const isKata = window.scoringMode === 'kata';
            const isFlag = window.kataType === 'flag';

            // Performer & Winner Selector Visibility (now handled by parent consolidatedKataControls)
            // The individual elements within consolidatedKataControls are always present,
            // their parent's visibility is controlled by setScoringMode.

            // Aka Panels
            document.getElementById('kumiteControlsAka').classList.toggle('hidden', isKata);
            document.getElementById('kataControlsAka').classList.toggle('hidden', !isKata || isFlag);
            const flagControlsAka = document.getElementById('kataFlagControlsAka');
            if (flagControlsAka) flagControlsAka.classList.toggle('hidden', !isKata || !isFlag);

            // Ao Panels
            document.getElementById('kumiteControlsAo').classList.toggle('hidden', isKata);
            document.getElementById('kataControlsAo').classList.toggle('hidden', !isKata || isFlag);
            const flagControlsAo = document.getElementById('kataFlagControlsAo');
            if (flagControlsAo) flagControlsAo.classList.toggle('hidden', !isKata || !isFlag);
        }

        // Kata Shortcut List (WKF Standard Alphabetical)
        const WKF_KATA_LIST = {
            "1": "ANAN", "2": "ANAN DAI", "3": "ANANKO", "4": "ANNUN", "5": "AOYAGI",
            "6": "BASSAI DAI", "7": "BASSAI SHO", "8": "CHATANYARA KUSHANKU", "9": "CHINTO", "10": "CHINTE",
            "11": "EMPI", "12": "GANKAKU", "13": "GARYU", "14": "GEKISAI DAI ICHI", "15": "GEKISAI DAI NI",
            "16": "GOJUSHIHO DAI", "17": "GOJUSHIHO SHO", "18": "HAFFA", "19": "HAKKAKU", "20": "HANGETSU",
            "21": "HEIAN SHODAN", "22": "HEIAN NIDAN", "23": "HEIAN SANDAN", "24": "HEIAN YONDAN", "25": "HEIAN GODAN",
            "26": "HEIKU", "27": "ISHINE", "28": "ITOSU ROHAI SHODAN", "29": "ITOSU ROHAI NIDAN", "30": "ITOSU ROHAI SANDAN",
            "31": "JIIN", "32": "JION", "33": "JITTE", "34": "JUROKU", "35": "KANKU DAI",
            "36": "KANKU SHO", "37": "KANSHU", "38": "KOPPO", "39": "KOSOKUN DAI", "40": "KOSOKUN SHO",
            "41": "KOSOKUN SHIHO", "42": "KURURUNFA", "43": "KUSHANKU", "44": "MATSUKAZE", "45": "MATSUMURA BASSAI",
            "46": "MATSUMURA ROHAI", "47": "MEIKYO", "48": "MYOJO", "49": "NAIHANCHI SHODAN", "50": "NAIHANCHI NIDAN",
            "51": "NAIHANCHI SANDAN", "52": "NIPAIPO", "53": "NISEISHI", "54": "NIJUSHIHO", "55": "PAIKU",
            "56": "PAPUREN", "57": "PASSAI", "58": "PINAN SHODAN", "59": "PINAN NIDAN", "60": "PINAN SANDAN",
            "61": "PINAN YONDAN", "62": "PINAN GODAN", "63": "ROHAI", "64": "SAIFA", "65": "SANCHIN",
            "66": "SANSEIRU", "67": "SEICHIN", "68": "SEIENCHIN", "69": "SEIPAI", "70": "SEISAN",
            "71": "SEISHAN", "72": "SEIYUNCHIN", "73": "SHIHO KOSOKUN", "74": "SHISOCHIN", "75": "SOCHIN",
            "76": "SUPARINPEI", "77": "TENSHO", "78": "TOMARI BASSAI", "79": "UNSU", "80": "UNSHU",
            "81": "WANKAN", "82": "WANSHU"
        };

        window.checkKataShortcut = function (input) {
            const val = input.value.trim();
            if (WKF_KATA_LIST[val]) {
                input.value = WKF_KATA_LIST[val];
                if (input.id === 'inputKataAka') window.kataAka = input.value;
                if (input.id === 'inputKataAo') window.kataAo = input.value;
                if (window.broadcastData) window.broadcastData();
            }
        };

        // Kata Flag voting functions
        window.setKataFlagsAka = function (count) {
            window.akaFlags = count;
            window.aoFlags = 5 - count;

            // Update button styles
            document.querySelectorAll('.flag-btn-aka').forEach(btn => {
                const val = parseInt(btn.dataset.val);
                btn.classList.toggle('bg-red-500', val === count);
                btn.classList.toggle('text-white', val === count);
                btn.classList.toggle('bg-white/5', val !== count);
                btn.classList.toggle('text-red-500', val !== count);
            });
            document.querySelectorAll('.flag-btn-ao').forEach(btn => {
                const val = parseInt(btn.dataset.val);
                const aoVal = 5 - count;
                btn.classList.toggle('bg-blue-500', val === aoVal);
                btn.classList.toggle('text-white', val === aoVal);
                btn.classList.toggle('bg-white/5', val !== aoVal);
                btn.classList.toggle('text-blue-500', val !== aoVal);
            });

            // Determine winner
            window.isWinnerDeclared = true;
            window.showWinnerBanner = true;
            if (count > 2.5) window.winnerSide = 'aka';
            else if (count < 2.5) window.winnerSide = 'ao';
            else window.winnerSide = 'draw';

            // Update score display
            document.getElementById('scoreAka').innerText = count;
            document.getElementById('scoreAo').innerText = 5 - count;

            window.broadcastData();
        }

        window.setKataFlagsAo = function (count) {
            window.aoFlags = count;
            window.akaFlags = 5 - count;

            // Update button styles
            document.querySelectorAll('.flag-btn-ao').forEach(btn => {
                const val = parseInt(btn.dataset.val);
                btn.classList.toggle('bg-blue-500', val === count);
                btn.classList.toggle('text-white', val === count);
                btn.classList.toggle('bg-white/5', val !== count);
                btn.classList.toggle('text-blue-500', val !== count);
            });
            document.querySelectorAll('.flag-btn-aka').forEach(btn => {
                const val = parseInt(btn.dataset.val);
                const akaVal = 5 - count;
                btn.classList.toggle('bg-red-500', val === akaVal);
                btn.classList.toggle('text-white', val === akaVal);
                btn.classList.toggle('bg-white/5', val !== akaVal);
                btn.classList.toggle('text-red-500', val !== akaVal);
            });

            // Determine winner
            window.isWinnerDeclared = true;
            window.showWinnerBanner = true;
            if (count > 2.5) window.winnerSide = 'ao';
            else if (count < 2.5) window.winnerSide = 'aka';
            else window.winnerSide = 'draw';

            // Update score display
            document.getElementById('scoreAka').innerText = 5 - count;
            document.getElementById('scoreAo').innerText = count;

            window.broadcastData();
        }

        window.updateKataJudgeScoreManual = function (inputEl, side, index) {
            // Santize input: allow only numbers and dot
            let valStr = inputEl.value.replace(/[^0-9.]/g, '');
            inputEl.value = valStr;

            const val = parseFloat(valStr) || 0.0;
            if (side === 'aka') {
                window.judgeScoresAka[index] = val;
                window.kataScoreAka = window.calculateKataTotal('aka', window.judgeScoresAka);
                document.getElementById('kataTotalAka').innerText = window.kataScoreAka.toFixed(1);
                document.getElementById('scoreAka').innerText = window.kataScoreAka.toFixed(1);
            } else {
                window.judgeScoresAo[index] = val;
                window.kataScoreAo = window.calculateKataTotal('ao', window.judgeScoresAo);
                document.getElementById('kataTotalAo').innerText = window.kataScoreAo.toFixed(1);
                document.getElementById('scoreAo').innerText = window.kataScoreAo.toFixed(1);
            }

            // Auto-check for winner
            window.checkKataAutoWinner();

            window.broadcastData();
        }

        window.updateKataJudgeScore = function (side, index, value) {
            const val = parseFloat(value) || 0.0;
            const inputId = `judgeBtn${side.charAt(0).toUpperCase() + side.slice(1)}${index}`;
            const inputEl = document.getElementById(inputId);

            if (side === 'aka') {
                window.judgeScoresAka[index] = val;
                window.kataScoreAka = window.calculateKataTotal('aka', window.judgeScoresAka);
                if (inputEl) inputEl.value = val.toFixed(1); // Changed from .value to .innerText for buttons
                document.getElementById('kataTotalAka').innerText = window.kataScoreAka.toFixed(1);
                document.getElementById('scoreAka').innerText = window.kataScoreAka.toFixed(1);
            } else {
                window.judgeScoresAo[index] = val;
                window.kataScoreAo = window.calculateKataTotal('ao', window.judgeScoresAo);
                if (inputEl) inputEl.value = val.toFixed(1); // Changed from .value to .innerText for buttons
                document.getElementById('kataTotalAo').innerText = window.kataScoreAo.toFixed(1);
                document.getElementById('scoreAo').innerText = window.kataScoreAo.toFixed(1);
            }

            // Auto-check for winner
            window.checkKataAutoWinner();

            window.broadcastData();
        }

        window.checkKataAutoWinner = function () {
            if (window.scoringMode !== 'kata') return;

            // Per WKF/Judging rules, we usually wait for all scores to be filled.
            // Some systems allow 0.0, but here we assume non-zero means filled.
            const allAkaFilled = window.judgeScoresAka.every(s => s > 0);
            const allAoFilled = window.judgeScoresAo.every(s => s > 0);

            if (allAkaFilled && allAoFilled) {
                window.isWinnerDeclared = true;
                window.showWinnerBanner = true;

                // Compare calculated totals (which already dropped high/low)
                if (window.kataScoreAka > window.kataScoreAo) {
                    window.winnerSide = 'aka';
                } else if (window.kataScoreAo > window.kataScoreAka) {
                    window.winnerSide = 'ao';
                } else {
                    window.winnerSide = 'draw';
                }

                console.log(`[Auto-Winner] Kata Winner determined: ${window.winnerSide} (${window.kataScoreAka} vs ${window.kataScoreAo})`);
                window.updateConsoleWinnerUI();
                window.broadcastData();
            }
        }
        window.calculateKataTotal = function (side, scores) {
            // Find all indices that have a non-zero value
            const validIndices = scores.map((s, i) => ({ val: s, idx: i }));

            // Sort by value
            const sorted = [...validIndices].sort((a, b) => a.val - b.val);

            // Per WKF: Drop 1 highest and 1 lowest for 5 judges
            // For 7 judges, it would be 2 highest and 2 lowest.
            // Our current UI has 5 judge slots.

            const discardedIndices = [];
            if (sorted.length >= 3) {
                discardedIndices.push(sorted[0].idx); // Lowest
                discardedIndices.push(sorted[sorted.length - 1].idx); // Highest
            }

            // Calculate total from those not discarded
            let total = 0;
            const remaining = sorted.filter(item => !discardedIndices.includes(item.idx));
            total = remaining.reduce((sum, item) => sum + item.val, 0);

            // Update UI with marks
            for (let i = 0; i < scores.length; i++) {
                const btnId = `judgeBtn${side.charAt(0).toUpperCase() + side.slice(1)}${i}`;
                const btn = document.getElementById(btnId);
                if (btn) {
                    if (discardedIndices.includes(i) && scores[i] > 0) {
                        btn.classList.add('kata-discarded');
                    } else {
                        btn.classList.remove('kata-discarded');
                    }
                }
            }

            return parseFloat(total.toFixed(1));
        }


        window.toggleQueueVisibility = function () {
            window.isQueueVisible = !window.isQueueVisible;
            const mainArea = document.getElementById('scoringMainArea');
            const sidebar = document.getElementById('queueSidebarArea');
            const iconShow = document.getElementById('queueIconShow');
            const iconHide = document.getElementById('queueIconHide');

            if (window.isQueueVisible) {
                if (mainArea.classList.contains('col-span-12')) mainArea.classList.replace('col-span-12', 'col-span-9');
                if (sidebar) sidebar.classList.remove('hidden');
                if (iconShow) iconShow.classList.remove('hidden');
                if (iconHide) iconHide.classList.add('hidden');
            } else {
                if (mainArea.classList.contains('col-span-9')) mainArea.classList.replace('col-span-9', 'col-span-12');
                if (sidebar) sidebar.classList.add('hidden');
                if (iconShow) iconShow.classList.add('hidden');
                if (iconHide) iconHide.classList.remove('hidden');
            }
        };

        // --- SETTINGS MODAL FUNCTIONS ---
        window.toggleSettingsModal = function () {
            const modal = document.getElementById('settingsModal');
            if (!modal) return;

            const isHidden = modal.classList.contains('hidden');
            modal.classList.toggle('hidden', !isHidden);
            modal.classList.toggle('flex', isHidden);

            // If opening, populate current values
            if (isHidden) {
                const inputCategory = document.getElementById('inputCategory');
                const inputNameAka = document.getElementById('inputNameAka');
                const inputTeamAka = document.getElementById('inputTeamAka');
                const inputNameAo = document.getElementById('inputNameAo');
                const inputTeamAo = document.getElementById('inputTeamAo');

                if (inputCategory) inputCategory.value = window.matchCategory || '';
                if (inputNameAka) inputNameAka.value = window.nameAka || '';
                if (inputTeamAka) inputTeamAka.value = window.teamAka || '';
                if (inputNameAo) inputNameAo.value = window.nameAo || '';
                if (inputTeamAo) inputTeamAo.value = window.teamAo || '';
            }
        };

        window.saveMatchSettings = function () {
            console.log('[Settings] saveMatchSettings called');

            try {
                // Get values from inputs
                const category = document.getElementById('inputCategory')?.value || '';
                const nameAka = document.getElementById('inputNameAka')?.value || '';
                const teamAka = document.getElementById('inputTeamAka')?.value || '';
                const nameAo = document.getElementById('inputNameAo')?.value || '';
                const teamAo = document.getElementById('inputTeamAo')?.value || '';

                console.log('[Settings] Input values captured:', { category, nameAka, teamAka, nameAo, teamAo });

                // Update global state
                window.matchCategory = category;
                window.nameAka = nameAka;
                window.teamAka = teamAka;
                window.nameAo = nameAo;
                window.teamAo = teamAo;

                // Update display elements directly
                const elements = {
                    category: document.getElementById('categoryDisplay'),
                    nameAka: document.getElementById('nameAkaDisplay'),
                    teamAka: document.getElementById('teamAkaDisplay'),
                    nameAo: document.getElementById('nameAoDisplay'),
                    teamAo: document.getElementById('teamAoDisplay')
                };

                if (elements.category) elements.category.textContent = category || '---';

                if (elements.nameAka) {
                    elements.nameAka.textContent = nameAka || '---';
                    elements.nameAka.style.display = ''; // Force visible
                }
                if (elements.teamAka) elements.teamAka.textContent = teamAka || '---';

                if (elements.nameAo) {
                    elements.nameAo.textContent = nameAo || '---';
                    elements.nameAo.style.display = ''; // Force visible
                }
                if (elements.teamAo) elements.teamAo.textContent = teamAo || '---';

                console.log('[Settings] UI Elements updated');

                // Broadcast to RTDB
                if (typeof window.broadcastData === 'function') {
                    window.broadcastData();
                    console.log('[Settings] Data broadcasted to RTDB');
                }

                // Close modal
                window.toggleSettingsModal();

                // Update kata list link if function exists
                if (typeof window.updateKataListLink === 'function') {
                    window.updateKataListLink();
                }

                console.log('[Settings] Settings saved successfully');
            } catch (error) {
                console.error('[Settings] Error saving settings:', error);
            }
        };

        // Attach event listener for the save button
        setTimeout(() => {
            const btnSave = document.getElementById('btnSaveSettings');
            if (btnSave) {
                btnSave.addEventListener('click', () => {
                    console.log('[Settings] Save button clicked (via listener)');
                    window.saveMatchSettings();
                });
                console.log('[Settings] Save button listener attached');
            } else {
                console.error('[Settings] Save button (btnSaveSettings) not found!');
            }
        }, 1000);

        // --- ATHLETE AUTOCOMPLETE FUNCTIONS ---
        window.showAthleteDropdown = function (side) {
            const dropdownId = side === 'aka' ? 'athleteDropdownAka' : 'athleteDropdownAo';
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) return;

            // Only show if we have athletes loaded
            if (window.classAthletes && window.classAthletes.length > 0) {
                filterAthletes(side);
            } else {
                dropdown.innerHTML = '<div class="px-4 py-3 text-xs text-slate-500 text-center">Pilih kelas terlebih dahulu</div>';
                dropdown.classList.remove('hidden');
            }
        };

        window.filterAthletes = function (side) {
            const inputId = side === 'aka' ? 'inputNameAka' : 'inputNameAo';
            const dropdownId = side === 'aka' ? 'athleteDropdownAka' : 'athleteDropdownAo';

            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);

            if (!input || !dropdown) return;

            const query = input.value.toLowerCase().trim();

            // Filter athletes based on query
            const filtered = window.classAthletes.filter(athlete =>
                query === '' || athlete.name.toLowerCase().includes(query)
            );

            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="px-4 py-3 text-xs text-slate-500 text-center">Tidak ada hasil</div>';
                dropdown.classList.remove('hidden');
                return;
            }

            // Render dropdown items
            const html = filtered.map(athlete => {
                const color = side === 'aka' ? 'red' : 'blue';
                return `
                    <button type="button" onclick="selectAthlete('${side}', '${athlete.name.replace(/'/g, "\\'")}', '${(athlete.team || '').replace(/'/g, "\\'")}')"
                        class="w-full text-left px-4 py-2.5 hover:bg-${color}-500/20 transition-colors border-b border-white/5 last:border-0">
                        <p class="text-xs font-bold text-white">${athlete.name}</p>
                        <p class="text-[10px] text-slate-400 mt-0.5">${athlete.team || '(No team)'}</p>
                    </button>
                `;
            }).join('');

            dropdown.innerHTML = html;
            dropdown.classList.remove('hidden');
        };

        window.selectAthlete = function (side, name, team) {
            const inputNameId = side === 'aka' ? 'inputNameAka' : 'inputNameAo';
            const inputTeamId = side === 'aka' ? 'inputTeamAka' : 'inputTeamAo';
            const dropdownId = side === 'aka' ? 'athleteDropdownAka' : 'athleteDropdownAo';

            // Set input values
            const inputName = document.getElementById(inputNameId);
            const inputTeam = document.getElementById(inputTeamId);
            const dropdown = document.getElementById(dropdownId);

            if (inputName) inputName.value = name;
            if (inputTeam) inputTeam.value = team;
            if (dropdown) dropdown.classList.add('hidden');

            console.log(`[Autocomplete] Selected ${side.toUpperCase()}: ${name} (${team})`);
        };

        // Load Athletes for Selected Class
        window.loadAthletesForClass = async function (className) {
            if (!className || className.trim() === '') {
                console.log('[Autocomplete] No class selected, clearing athletes');
                window.classAthletes = [];
                return;
            }

            if (!window.eventId) {
                console.warn('[Autocomplete] No eventId available');
                window.classAthletes = [];
                return;
            }

            console.log(`[Autocomplete] Loading athletes for class: ${className}`);

            try {
                // Query athletes collection filtered by class
                // Athletes are stored in events/{eventId}/athletes subcollection
                const athletesQuery = query(
                    collection(db, `events/${window.eventId}/athletes`),
                    where('className', '==', className.trim())
                );

                const snapshot = await getDocs(athletesQuery);

                window.classAthletes = snapshot.docs.map(doc => ({
                    id: doc.id,
                    name: doc.data().name || doc.data().athleteName || 'Unknown',
                    team: doc.data().team || doc.data().kontingen || ''
                }));

                console.log(`[Autocomplete] Loaded ${window.classAthletes.length} athletes for ${className}`);

                if (window.classAthletes.length === 0) {
                    console.warn(`[Autocomplete] No athletes found for class: ${className}`);
                }
            } catch (error) {
                console.error('[Autocomplete] Error loading athletes:', error);
                window.classAthletes = [];
            }
        };

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#inputNameAka') && !e.target.closest('#athleteDropdownAka')) {
                const dropdown = document.getElementById('athleteDropdownAka');
                if (dropdown) dropdown.classList.add('hidden');
            }
            if (!e.target.closest('#inputNameAo') && !e.target.closest('#athleteDropdownAo')) {
                const dropdown = document.getElementById('athleteDropdownAo');
                if (dropdown) dropdown.classList.add('hidden');
            }
        });


        window.addScore = function (side, amount) {
            if (window.scoringMode === 'kata') return;

            if (side === 'aka') {
                window.akaScore = Math.max(0, window.akaScore + amount);
                document.getElementById('scoreAka').innerText = window.akaScore.toString().padStart(2, '0');
                window.animateScore(document.getElementById('scoreAka'));

                // Track Score Activity
                const detail = amount > 0 ? `AKA +${amount}` : `AKA -${Math.abs(amount)}`;
                logActivity("Update Skor", detail, window.currentTatami);
            } else {
                window.aoScore = Math.max(0, window.aoScore + amount);
                document.getElementById('scoreAo').innerText = window.aoScore.toString().padStart(2, '0');
                window.animateScore(document.getElementById('scoreAo'));

                // Track Score Activity
                const detail = amount > 0 ? `AO +${amount}` : `AO -${Math.abs(amount)}`;
                logActivity("Update Skor", detail, window.currentTatami);
            }

            // WKF RULE: 8 Point Gap (Kachi)
            if (Math.abs(window.akaScore - window.aoScore) >= 8) {
                window.isWinnerDeclared = true;
                window.showWinnerBanner = true;
                window.winnerSide = window.akaScore > window.aoScore ? 'aka' : 'ao';

                // Track Winner Activity
                const winnerName = window.winnerSide === 'aka' ? window.nameAka : window.nameAo;
                logActivity("Pemenang Dinyatakan", `${window.winnerSide.toUpperCase()} (${winnerName}) menang selisih poin.`, window.currentTatami);

                window.isTimerRunning = false;
                if (window.timerId) clearInterval(window.timerId);
                window.playBuzzer();
            }

            window.broadcastData();
        }

        window.toggleVR = function (side) {
            if (side === 'aka') window.vrAka = !window.vrAka;
            else window.vrAo = !window.vrAo;

            const btnId = `vr${side.charAt(0).toUpperCase() + side.slice(1)}`;
            const isActive = side === 'aka' ? window.vrAka : window.vrAo;

            document.getElementById(btnId).className = isActive ?
                "py-3 rounded-lg neu-button text-[10px] font-black text-yellow-400 bg-yellow-400/20 border-yellow-400/50" :
                "py-3 rounded-lg neu-button text-[10px] font-black opacity-50 text-yellow-500 transition-all hover:opacity-100";

            window.broadcastData();
        }

        window.animateScore = function (el) {
            el.classList.add('scale-125', 'brightness-150');
            setTimeout(() => el.classList.remove('scale-125', 'brightness-150'), 200);
        }

        window.setSenshu = function (side) {
            if (window.senshu === side) window.senshu = null;
            else window.senshu = side;

            // Update UI
            document.getElementById('senshuAka').className = window.senshu === 'aka' ?
                "py-3 rounded-lg bg-red-600 text-white text-[10px] font-black shadow-[0_0_20px_rgba(220,38,38,0.5)] border-white/20" :
                "py-3 rounded-lg neu-button text-[10px] font-black opacity-70 hover:opacity-100 transition-opacity";

            document.getElementById('senshuAo').className = window.senshu === 'ao' ?
                "py-3 rounded-lg bg-blue-600 text-white text-[10px] font-black shadow-[0_0_20px_rgba(37,99,235,0.5)] border-white/20" :
                "py-3 rounded-lg neu-button text-[10px] font-black opacity-70 hover:opacity-100 transition-opacity";

            window.broadcastData();
        }

        window.setKataPerformer = function (side) {
            if (side === null) {
                window.activeKataPerformer = null;
            } else if (window.activeKataPerformer === side) {
                window.activeKataPerformer = null;
            } else {
                window.activeKataPerformer = side;
            }

            const akaBtn = document.getElementById('performerAkaBtn');
            const aoBtn = document.getElementById('performerAoBtn');

            if (!akaBtn || !aoBtn) return;

            if (window.activeKataPerformer === 'aka') {
                akaBtn.className = "w-16 h-10 rounded-lg bg-red-600 text-white flex items-center justify-center transition-all border border-red-500/30 shadow-md shadow-red-500/20";
                aoBtn.className = "w-16 h-10 rounded-lg bg-white/5 text-blue-500 flex items-center justify-center hover:text-white transition-all border border-white/5 shadow-md";
            } else if (window.activeKataPerformer === 'ao') {
                aoBtn.className = "w-16 h-10 rounded-lg bg-blue-600 text-white flex items-center justify-center transition-all border border-blue-500/30 shadow-md shadow-blue-500/20";
                akaBtn.className = "w-16 h-10 rounded-lg bg-white/5 text-red-500 flex items-center justify-center hover:text-white transition-all border border-white/5 shadow-md";
            } else {
                akaBtn.className = "w-16 h-10 rounded-lg bg-white/5 text-red-500 flex items-center justify-center hover:text-white transition-all border border-white/5 shadow-md";
                aoBtn.className = "w-16 h-10 rounded-lg bg-white/5 text-blue-500 flex items-center justify-center hover:text-white transition-all border border-white/5 shadow-md";
            }

            window.broadcastData();
        };

        window.declareKataWinner = async function (side) {
            window.isWinnerDeclared = true;
            window.winnerSide = side;
            window.showWinnerBanner = true;
            window.broadcastData();
            window.updateConsoleWinnerUI();

            // Auto-save to database
            console.log(`[Winner] ${side.toUpperCase()} declared as winner, saving to database...`);

            const winnerName = side === 'aka' ? window.nameAka : window.nameAo;
            const winnerTeam = side === 'aka' ? window.teamAka : window.teamAo;
            const winnerSlot = side === 'aka' ? window.slotAka : window.slotAo;
            const winnerKata = side === 'aka' ? window.kataNameAka : window.kataNameAo;
            const winnerScore = side === 'aka' ? window.scoreAka : window.scoreAo;

            const loserName = side === 'aka' ? window.nameAo : window.nameAka;
            const loserTeam = side === 'aka' ? window.teamAo : window.teamAka;
            const loserSlot = side === 'aka' ? window.slotAo : window.slotAka;
            const loserKata = side === 'aka' ? window.kataNameAo : window.kataNameAka;
            const loserScore = side === 'aka' ? window.scoreAo : window.scoreAka;

            // Calculate next slot for auto-progression
            let nextSlot = null;
            if (winnerSlot && typeof getNextSlot === 'function') {
                nextSlot = getNextSlot(winnerSlot);
                console.log(`[Auto-Progression] Winner ${winnerName} ‚Üí Next Slot: ${nextSlot}`);
            }

            const matchData = {
                eventId: eventId,
                category: window.matchCategory || selectedClass,
                tatami: tatamiNumber,
                winner: winnerName,
                winnerTeam: winnerTeam,
                nextSlot: nextSlot,
                aka: {
                    name: window.nameAka,
                    team: window.teamAka,
                    kata: window.kataNameAka,
                    score: window.scoreAka,
                    slotId: window.slotAka
                },
                ao: {
                    name: window.nameAo,
                    team: window.teamAo,
                    kata: window.kataNameAo,
                    score: window.scoreAo,
                    slotId: window.slotAo
                },
                timestamp: Date.now()
            };

            // Save to IndexedDB via syncEngine
            if (syncEngine) {
                await syncEngine.save(matchData);
                console.log('[Winner] Match data saved to local database, will sync to Cloud soon.');
            } else {
                console.error('[Winner] SyncEngine not available!');
            }
        };

        // FLIP PANELS FUNCTION - Swap AKA and AO positions
        window.flipPanels = function () {
            const panelAka = document.getElementById('panelContainerAka');
            const panelAo = document.getElementById('panelContainerAo');

            if (!panelAka || !panelAo) return;

            // Get current orders
            const currentAkaOrder = parseInt(getComputedStyle(panelAka).order) || 3;
            const currentAoOrder = parseInt(getComputedStyle(panelAo).order) || 1;

            // Swap orders
            panelAka.style.order = currentAoOrder;
            panelAo.style.order = currentAkaOrder;

            console.log(`[Panel Flip] AKA now at order ${currentAoOrder}, AO now at order ${currentAkaOrder}`);

            // Optional: Store preference in localStorage
            localStorage.setItem('panelLayout', currentAkaOrder === 3 ? 'flipped' : 'default');
        };

        window.toggleTimerSetting = function (enabled) {
            window.isTimerEnabled = enabled;
            const display = document.getElementById('timerDisplay');
            const toggleStatus = document.getElementById('timerToggleStatus');

            // Targeted buttons
            const playBtn = document.getElementById('btnTimerControl');
            const resetTimerBtn = document.getElementById('btnResetTimerControl');
            const resetMatchBtn = document.getElementById('btnResetControl');

            if (display) {
                display.style.opacity = enabled ? '1' : '0.15';
                display.style.filter = enabled ? 'none' : 'grayscale(1)';
            }
            if (toggleStatus) {
                toggleStatus.classList.toggle('bg-red-500', enabled);
                toggleStatus.classList.toggle('bg-slate-600', !enabled);
                toggleStatus.classList.toggle('shadow-[0_0_8px_rgba(239,68,68,0.5)]', enabled);
            }

            // Only affect Timer specific buttons
            if (playBtn) {
                playBtn.style.opacity = enabled ? '1' : '0.3';
                playBtn.style.pointerEvents = enabled ? 'auto' : 'none';
            }
            if (resetTimerBtn) {
                resetTimerBtn.style.opacity = enabled ? '1' : '0.3';
                resetTimerBtn.style.pointerEvents = enabled ? 'auto' : 'none';
            }

            // Reset Match is ALWAYS active (based on user request)
            if (resetMatchBtn) {
                resetMatchBtn.style.opacity = '1';
                resetMatchBtn.style.pointerEvents = 'auto';
            }

            window.broadcastData();
        };

        window.toggleTimer = function () {
            if (typeof resumeAudio === 'function') resumeAudio();

            if (!window.isTimerEnabled) {
                alert("Timer saat ini dinonaktifkan dalam pengaturan.");
                return;
            }

            const btn = document.getElementById('btnTimerControl');
            const dot = document.getElementById('timerStatusDot');
            const label = document.getElementById('timerLabel');

            if (window.isTimerRunning) {
                if (window.timerId) clearInterval(window.timerId);
                window.isTimerRunning = false;

                // Update Icon to Play
                const icon = document.getElementById('timerIcon');
                if (icon) icon.innerHTML = '<path d="M8 5v14l11-7z"/>';

                btn.classList.remove('bg-red-600');
                btn.classList.add('bg-slate-700');
                dot.classList.replace('bg-green-500', 'bg-yellow-500');
                label.innerText = 'PAUSED';
                label.className = "text-[8px] font-black uppercase tracking-widest text-yellow-500 whitespace-nowrap";
            } else {
                // Enforce performer selection in Kata mode when starting
                if (window.scoringMode === 'kata' && !window.activeKataPerformer) {
                    alert("HARAP PILIH PENAMPIL (AKA / AO) TERLEBIH DAHULU!");
                    return;
                }

                window.timerId = setInterval(window.updateTimer, 1000);
                window.isTimerRunning = true;

                // Update Icon to Pause
                const icon = document.getElementById('timerIcon');
                if (icon) icon.innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';

                btn.classList.remove('bg-red-600');
                btn.classList.add('bg-slate-700');
                dot.classList.remove('bg-slate-500', 'bg-yellow-500');
                dot.classList.add('bg-green-500');
                label.innerText = 'RUNNING';
                label.className = "text-[8px] font-black uppercase tracking-widest text-green-500 whitespace-nowrap";
                dot.classList.add('pulse-red');
            }
            window.broadcastData();
        }

        window.updateTimer = async function () {
            if (window.timeLeft <= 0) {
                if (window.timerId) clearInterval(window.timerId);
                window.isTimerRunning = false;
                window.playBuzzer();

                // Declare winner automatically based on score
                window.isWinnerDeclared = true;
                if (window.akaScore > window.aoScore) {
                    window.winnerSide = 'aka';
                    window.showWinnerBanner = true;
                } else if (window.aoScore > window.akaScore) {
                    window.winnerSide = 'ao';
                    window.showWinnerBanner = true;
                } else if (window.senshu) {
                    window.winnerSide = window.senshu;
                    window.showWinnerBanner = true;
                } else {
                    // DRAW - Show Hantei panel for flag input
                    window.winnerSide = 'draw';
                    window.isHantei = true;
                    window.isWinnerDeclared = false; // Keep false until Hantei is confirmed
                    window.showWinnerBanner = false;

                    // Auto-show Hantei Controls panel
                    const hanteiControls = document.getElementById('hanteiControls');
                    if (hanteiControls) {
                        hanteiControls.classList.remove('hidden');
                        hanteiControls.classList.add('flex');
                    }
                }

                window.updateBroadcastUI();
                await window.broadcastData();
                return;
            }
            window.timeLeft--;
            if (window.timeLeft === 15) window.playBeep();

            const mins = Math.floor(window.timeLeft / 60);
            const secs = window.timeLeft % 60;
            const display = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            document.getElementById('timerDisplay').value = display;

            await window.broadcastData();
        }

        window.adjustTimer = function (secs) {
            if (window.isTimerRunning) return;
            window.timeLeft = Math.max(0, window.timeLeft + secs);
            const minsDisplay = Math.floor(window.timeLeft / 60);
            const secsDisplay = window.timeLeft % 60;
            document.getElementById('timerDisplay').value = `${minsDisplay.toString().padStart(2, '0')}:${secsDisplay.toString().padStart(2, '0')}`;
            window.broadcastData();
        }

        window.showCustomConfirm = function (title, message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                const titleEl = document.getElementById('modalTitle');
                const msgEl = document.getElementById('modalMessage');
                const btnConfirm = document.getElementById('modalConfirm');
                const btnCancel = document.getElementById('modalCancel');

                titleEl.innerText = title;
                msgEl.innerText = message;
                modal.style.display = 'flex';

                const close = (result) => {
                    modal.style.display = 'none';
                    resolve(result);
                };

                btnConfirm.onclick = () => close(true);
                btnCancel.onclick = () => close(false);
                modal.onclick = (e) => { if (e.target === modal) close(false); };
            });
        }

        window.loadMatch = async function (aka, ao, category, round, teamAka = "", teamAo = "") {
            const confirmed = await showCustomConfirm(
                'GANTI PERTANDINGAN?',
                `Tandandingkan: ${aka.toUpperCase()} VS ${ao.toUpperCase()}\nKategori: ${category.toUpperCase()}`
            );

            if (!confirmed) return;

            resetMatch();
            window.nameAka = aka;
            window.nameAo = ao;
            window.teamAka = teamAka;
            window.teamAo = teamAo;
            window.matchCategory = category;
            window.matchRound = round;

            document.getElementById('nameAkaDisplay').innerText = aka.toUpperCase();
            document.getElementById('nameAoDisplay').innerText = ao.toUpperCase();
            document.getElementById('categoryDisplay').innerText = category.split(' ')[0].toUpperCase();
            document.getElementById('roundDisplay').innerText = round.toUpperCase();

            broadcastData();
        }

        // Hantei Flag Voting Variables
        window.hanteiAkaFlags = 0;
        window.hanteiAoFlags = 0;

        // Check Hantei result from inputs (called on change)
        window.checkHanteiResult = function () {
            const akaInput = document.getElementById('hanteiInputAka');
            const aoInput = document.getElementById('hanteiInputAo');
            if (!akaInput || !aoInput) return;

            const akaFlags = parseInt(akaInput.value) || 0;
            const aoFlags = parseInt(aoInput.value) || 0;

            window.hanteiAkaFlags = akaFlags;
            window.hanteiAoFlags = aoFlags;
        };

        window.confirmHantei = async function () {
            const akaInput = document.getElementById('hanteiInputAka');
            const aoInput = document.getElementById('hanteiInputAo');

            const akaFlags = parseInt(akaInput?.value) || 0;
            const aoFlags = parseInt(aoInput?.value) || 0;

            if (akaFlags === aoFlags) {
                alert('Jumlah bendera harus berbeda! Tidak boleh seri.');
                return;
            }

            const winnerSide = akaFlags > aoFlags ? 'aka' : 'ao';
            const winnerName = winnerSide === 'aka' ? window.nameAka : window.nameAo;

            window.isWinnerDeclared = true;
            window.winnerSide = winnerSide;
            window.isHantei = false;

            // Store Hantei score for broadcast to monitor
            window.hanteiScore = `${akaFlags} - ${aoFlags}`;
            window.isHanteiResult = true;

            // Track Hantei Activity
            logActivity("Pemenang Hantei", `${winnerSide.toUpperCase()} (${winnerName}) menang bendera ${akaFlags}-${aoFlags}.`, window.currentTatami);

            // Hide Hantei Controls
            const hanteiControls = document.getElementById('hanteiControls');
            if (hanteiControls) hanteiControls.classList.add('hidden');

            window.broadcastData();
            window.updateConsoleWinnerUI();

            // Reset inputs for next match
            if (akaInput) akaInput.value = '0';
            if (aoInput) aoInput.value = '0';
        };

        window.setHanteiWinner = async function (side) {
            window.isWinnerDeclared = true;
            window.winnerSide = side;
            window.isHantei = false; // Reset Hantei state so winner banner can show

            // Get Hantei scores from inputs if available
            const akaInput = document.getElementById('hanteiInputAka');
            const aoInput = document.getElementById('hanteiInputAo');
            const akaFlags = parseInt(akaInput?.value) || 0;
            const aoFlags = parseInt(aoInput?.value) || 0;

            // Mark as Hantei result with the flag score
            window.isHanteiResult = true;
            window.hanteiScore = `${akaFlags} - ${aoFlags}`;

            // Track Hantei Activity
            const winnerName = side === 'aka' ? window.nameAka : window.nameAo;
            logActivity("Pemenang Hantei", `${side.toUpperCase()} (${winnerName}) menang keputusan wasit bendera ${akaFlags}-${aoFlags}.`, window.currentTatami);

            // Hide Hantei Controls
            const hanteiControls = document.getElementById('hanteiControls');
            if (hanteiControls) hanteiControls.classList.add('hidden');

            window.broadcastData();
            window.updateConsoleWinnerUI();

            // Reset inputs for next match
            if (akaInput) akaInput.value = '0';
            if (aoInput) aoInput.value = '0';
        }

        window.togglePenalty = async function (side, level) {
            const penalties = side === 'aka' ? window.penaltiesAka : window.penaltiesAo;
            const isAdding = !penalties[level];
            const levels = ['c1', 'c2', 'c3', 'hc', 'h'];
            const levelIdx = levels.indexOf(level);

            // Cascade set: if adding H, set HC, C3, C2, C1 too.
            if (isAdding && levelIdx !== -1) {
                for (let i = 0; i <= levelIdx; i++) {
                    penalties[levels[i]] = true;
                }
            } else {
                penalties[level] = !penalties[level];
            }

            // Track Penalty Activity
            const status = penalties[level] ? "DIBERIKAN" : "DICABUT";
            logActivity("Pelanggaran", `${side.toUpperCase()} ${level.toUpperCase()} ${status}`, window.currentTatami);

            // Update UI for ALL penalty buttons of this side
            levels.forEach(lvl => {
                const btn = document.getElementById(`${side}_${lvl}`);
                if (!btn) return;

                if (penalties[lvl]) {
                    btn.classList.remove('opacity-60', 'bg-black/40', 'border-white/5');
                    btn.classList.add('opacity-100', 'text-white', 'shadow-lg');

                    // Color mapping
                    if (lvl.startsWith('c')) {
                        btn.classList.add('bg-yellow-500', 'border-yellow-400');
                    } else if (lvl === 'hc') {
                        btn.classList.add('bg-orange-600', 'border-orange-500');
                    } else if (lvl === 'h') {
                        btn.classList.add('bg-red-600', 'border-red-500');
                    }
                } else {
                    btn.classList.add('opacity-60', 'bg-black/40', 'border-white/5');
                    btn.classList.remove('opacity-100', 'text-white', 'shadow-lg', 'bg-yellow-500', 'border-yellow-400', 'bg-orange-600', 'border-orange-500', 'bg-red-600', 'border-red-500');
                }
            });

            // HANSOKU (H) AUTO-LOSS LOGIC
            if (level === 'h' && penalties[level]) {
                const confirmed = await window.showCustomConfirm(
                    'HANSOKU (DISKUALIFIKASI)?',
                    `${side.toUpperCase()} mendapat Hansoku. Nyatakan ${side === 'aka' ? 'AO' : 'AKA'} sebagai pemenang?`
                );

                if (confirmed) {
                    window.isWinnerDeclared = true;
                    window.winnerSide = (side === 'aka' ? 'ao' : 'aka');
                    window.showWinnerBanner = true;

                    // Stop Timer
                    window.isTimerRunning = false;
                    if (window.timerId) clearInterval(window.timerId);
                    window.playBuzzer();

                    console.log(`[Hansoku] ${side.toUpperCase()} disqualified. Winner: ${window.winnerSide.toUpperCase()}`);
                } else {
                    // Revert penalty if not confirmed
                    penalties[level] = false;
                    const hBtn = document.getElementById(`${side}_h`);
                    if (hBtn) {
                        hBtn.classList.add('opacity-60', 'bg-black/40', 'border-white/5');
                        hBtn.classList.remove('opacity-100', 'text-white', 'shadow-lg', 'bg-red-600', 'border-red-500');
                    }
                }
            }

            window.broadcastData();
        }

        window.resetTimer = function () {
            if (window.timerId) clearInterval(window.timerId);
            window.isTimerRunning = false;

            // Set default time (01:00)
            window.timeLeft = 60;
            const display = document.getElementById('timerDisplay');
            if (display) display.value = '01:00';

            // Reset UI states for timer
            const btn = document.getElementById('btnTimerControl');
            const dot = document.getElementById('timerStatusDot');
            const label = document.getElementById('timerLabel');
            const icon = document.getElementById('timerIcon');

            if (icon) icon.innerHTML = '<path d="M8 5v14l11-7z"/>'; // Play icon

            if (btn) {
                btn.classList.remove('bg-slate-700');
                btn.classList.add('bg-red-600');
            }

            if (dot) {
                dot.classList.remove('bg-green-500', 'bg-yellow-500', 'pulse-red');
                dot.classList.add('bg-slate-500');
            }

            if (label) {
                label.innerText = 'STANDBY';
                label.className = "text-[8px] font-black uppercase tracking-widest text-slate-400 whitespace-nowrap";
            }

            window.broadcastData();
            console.log('[Timer] Timer reset to default.');
        };

        window.resetMatch = async function () {
            console.log('[Scoring] Resetting match data...');

            // Track Reset Activity
            if (window.akaScore > 0 || window.aoScore > 0) {
                logActivity("Reset Pertandingan", "Membersihkan skor dan timer untuk pertandingan baru.", window.currentTatami);
            }

            // Perform Timer Reset
            window.resetTimer();

            // Clear Global State
            window.akaScore = 0;
            window.aoScore = 0;
            window.kataScoreAka = 0.0;
            window.kataScoreAo = 0.0;
            window.judgeScoresAka = [0.0, 0.0, 0.0, 0.0, 0.0];
            window.judgeScoresAo = [0.0, 0.0, 0.0, 0.0, 0.0];
            window.akaFlags = 0;
            window.aoFlags = 0;
            window.senshu = null;
            window.isWinnerDeclared = false;
            window.winnerSide = null;
            window.showWinnerBanner = false;
            window.vrAka = false;
            window.vrAo = false;
            window.isHantei = false;
            window.setKataPerformer(null);
            window.penaltiesAka = { c1: false, c2: false, c3: false, hc: false, h: false };
            window.penaltiesAo = { c1: false, c2: false, c3: false, hc: false, h: false };

            // Clear Athlete Data
            window.nameAka = '';
            window.teamAka = '';
            window.nameAo = '';
            window.teamAo = '';
            window.matchCategory = '';
            window.kataAka = '';
            window.kataAo = '';

            // Update UI - Input Fields
            if (document.getElementById('inputNameAka')) document.getElementById('inputNameAka').value = '';
            if (document.getElementById('inputTeamAka')) document.getElementById('inputTeamAka').value = '';
            if (document.getElementById('inputNameAo')) document.getElementById('inputNameAo').value = '';
            if (document.getElementById('inputTeamAo')) document.getElementById('inputTeamAo').value = '';
            if (document.getElementById('inputCategory')) document.getElementById('inputCategory').value = '';
            if (document.getElementById('inputKataAka')) document.getElementById('inputKataAka').value = '';
            if (document.getElementById('inputKataAo')) document.getElementById('inputKataAo').value = '';

            // Update UI - Display Labels
            const displayIds = {
                nameAka: 'nameAkaDisplay',
                teamAka: 'teamAkaDisplay',
                nameAo: 'nameAoDisplay',
                teamAo: 'teamAoDisplay',
                category: 'categoryDisplay'
            };

            if (document.getElementById(displayIds.nameAka)) document.getElementById(displayIds.nameAka).innerText = '---';
            if (document.getElementById(displayIds.teamAka)) document.getElementById(displayIds.teamAka).innerText = '---';
            if (document.getElementById(displayIds.nameAo)) document.getElementById(displayIds.nameAo).innerText = '---';
            if (document.getElementById(displayIds.teamAo)) document.getElementById(displayIds.teamAo).innerText = '---';

            // Only reset category label to default for the current mode
            const catLabel = document.getElementById(displayIds.category);
            if (catLabel) {
                catLabel.innerText = window.scoringMode === 'kata' ? 'KATA' : 'KUMITE';
            }

            // Reset scores on UI
            const scoreAka = document.getElementById('scoreAka');
            const scoreAo = document.getElementById('scoreAo');
            if (scoreAka) scoreAka.innerText = window.scoringMode === 'kumite' ? '00' : '0.0';
            if (scoreAo) scoreAo.innerText = window.scoringMode === 'kumite' ? '00' : '0.0';

            // Reset Kata Judge Buttons & Totals
            for (let i = 0; i < 5; i++) {
                const bAka = document.getElementById('judgeBtnAka' + i);
                const bAo = document.getElementById('judgeBtnAo' + i);
                if (bAka) {
                    bAka.innerText = '0.0';
                    bAka.classList.remove('kata-discarded');
                }
                if (bAo) {
                    bAo.innerText = '0.0';
                    bAo.classList.remove('kata-discarded');
                }
            }
            if (document.getElementById('kataTotalAka')) document.getElementById('kataTotalAka').innerText = '0.0';
            if (document.getElementById('kataTotalAo')) document.getElementById('kataTotalAo').innerText = '0.0';

            // Clear Flag Button Highlights
            document.querySelectorAll('.flag-btn').forEach(btn => {
                btn.classList.remove('bg-red-600', 'text-white');
                btn.classList.add('bg-white/5', 'text-red-500');
            });

            // Reset UI Terpadu AKA/AO (Senshu, VR, Penalties)
            ['aka', 'ao'].forEach(side => {
                const senshuBtn = document.getElementById(`senshu${side.charAt(0).toUpperCase() + side.slice(1)}`);
                const vrBtn = document.getElementById(`vr${side.charAt(0).toUpperCase() + side.slice(1)}`);
                if (senshuBtn) senshuBtn.className = "py-3 rounded-lg neu-button text-[10px] font-black opacity-70 hover:opacity-100 transition-opacity";
                if (vrBtn) vrBtn.className = "py-3 rounded-lg neu-button text-[10px] font-black opacity-50 text-yellow-500 transition-all hover:opacity-100";

                ['c1', 'c2', 'c3', 'hc', 'h'].forEach(level => {
                    const btn = document.getElementById(`${side}_${level}`);
                    if (btn) {
                        btn.classList.add('opacity-60', 'bg-black/40', 'border-white/5');
                        btn.classList.remove('opacity-100', 'text-white', 'shadow-lg', 'bg-yellow-500', 'border-yellow-400', 'bg-orange-600', 'border-orange-500', 'bg-red-600', 'border-red-500');
                    }
                });
            });

            // Reset Timer UI
            const icon = document.getElementById('timerIcon');
            if (icon) icon.innerHTML = '<path d="M8 5v14l11-7z"/>';

            const btnTimer = document.getElementById('btnTimerControl');
            if (btnTimer) {
                btnTimer.classList.remove('bg-slate-700');
                btnTimer.classList.add('bg-red-500');
            }

            const dot = document.getElementById('timerStatusDot');
            const label = document.getElementById('timerLabel');
            if (dot) dot.className = "w-2.5 h-2.5 rounded-full bg-slate-600";
            if (label) {
                label.className = "text-[9px] font-black uppercase tracking-widest text-slate-500 whitespace-nowrap";
                label.innerText = 'SIAP BERTANDING';
            }

            // Final Sync & UI Update
            window.broadcastData();
            window.updateConsoleWinnerUI();

            console.log('[Scoring] Match data reset complete');
        }

        window.announceWinner = function () {
            window.showWinnerBanner = true;
            window.broadcastData();
        }

        window.handleMonitor = function () {
            if (window.monitorWindow && !window.monitorWindow.closed) {
                window.monitorWindow.close();
                window.monitorWindow = null;
                window.updateMonitorUI();
            } else {
                // Attempt to open on secondary monitor (assumed to be to the right)
                const screenLeft = window.screenLeft !== undefined ? window.screenLeft : window.screenX;
                const screenTop = window.screenTop !== undefined ? window.screenTop : window.screenY;

                // If we're on a multi-monitor setup, we can try to push it to the next screen
                const leftOffset = window.screen.width;

                const width = 1200;
                const height = 800;
                const left = screenLeft + leftOffset;
                const top = screenTop;

                const features = `width=${width},height=${height},left=${left},top=${top},menubar=no,toolbar=no,location=no,status=no,resizable=yes,scrollbars=no`;

                window.monitorWindow = window.open(`scoring-monitor.html?tatami=${window.currentTatami}`, 'ScoringMonitor', features);

                if (!window.monitorWindow) {
                    alert('Pop-up blocked! Please allow pop-ups for this site.');
                }

                window.updateMonitorUI();
            }
        }

        window.toggleSettingsModal = function () {
            const modal = document.getElementById('settingsModal');
            if (modal.classList.contains('hidden')) {
                // Populate inputs with current values
                document.getElementById('inputCategory').value = window.matchCategory || '';

                modal.classList.replace('hidden', 'flex');
                setTimeout(() => modal.classList.add('opacity-100'), 10);
            } else {
                modal.classList.remove('opacity-100');
                setTimeout(() => modal.classList.replace('flex', 'hidden'), 300);
            }
        }

        // Duplicate saveMatchSettings removed

        window.updateKataListLink = function () {
            const link = document.getElementById('kataListLink');
            if (link && window.eventId) {
                let href = `kata-list.html?id=${window.eventId}`;
                if (window.matchCategory) {
                    href += `&class=${encodeURIComponent(window.matchCategory)}`;
                }
                link.href = href;
            }
        };

        window.toggleMonitorFullscreen = function () {
            localStorage.setItem('karate_display_command', JSON.stringify({
                type: 'toggleFullscreen',
                timestamp: Date.now()
            }));
        }


        window.updateMonitorUI = function () {
            const btn = document.getElementById('btnMonitor');
            const fsBtn = document.getElementById('btnFullscreen');
            if (window.monitorWindow && !window.monitorWindow.closed) {
                if (btn) {
                    btn.classList.replace('bg-blue-600/20', 'bg-red-600/20');
                    btn.classList.replace('text-blue-400', 'text-red-400');
                    btn.classList.replace('border-blue-500/30', 'border-red-500/30');
                    btn.title = "Close Monitor";
                }
                if (fsBtn) fsBtn.classList.remove('hidden');
            } else {
                if (btn) {
                    btn.classList.replace('bg-red-600/20', 'bg-blue-600/20');
                    btn.classList.replace('text-red-400', 'text-blue-400');
                    btn.classList.replace('border-red-500/30', 'border-blue-500/30');
                    btn.title = "Open Monitor";
                }
                if (fsBtn) fsBtn.classList.add('hidden');
            }
        }

        // Check monitor window state periodically
        setInterval(() => {
            if (monitorWindow && monitorWindow.closed) {
                monitorWindow = null;
                updateMonitorUI();
            }
        }, 1000);

        window.finishMatch = async function () {
            // Jika pemenang sudah ditentukan (oleh skor, Kachi, atau Hantei),
            // tombol ini berfungsi untuk membersihkan papan skor dan lanjut ke match berikutnya.
            if (window.isWinnerDeclared) {
                const confirmed = await window.showCustomConfirm(
                    'PERTANDINGAN BERIKUTNYA?',
                    'Bersihkan papan skor dan siapkan pertandingan selanjutnya?'
                );
                if (confirmed) window.resetMatch();
                return;
            }

            const confirmed = await window.showCustomConfirm(
                'SELESAIKAN MATCH?',
                'Apakah Anda yakin ingin menyelesaikan pertandingan ini dan menyimpan hasilnya ke Admin Rekap?'
            );

            if (confirmed) {
                window.isWinnerDeclared = true;
                const scoreA = window.scoringMode === 'kata' ? window.kataScoreAka : window.akaScore;
                const scoreB = window.scoringMode === 'kata' ? window.kataScoreAo : window.aoScore;

                if (scoreA > scoreB) window.winnerSide = 'aka';
                else if (scoreB > scoreA) window.winnerSide = 'ao';
                else if (window.scoringMode === 'kumite' && window.senshu) window.winnerSide = window.senshu;
                else {
                    window.winnerSide = 'draw';
                    if (window.scoringMode === 'kumite') window.isHantei = true;
                }

                window.broadcastData();

                // --- Sync Engine Integration ---
                const winnerName = window.winnerSide === 'aka' ? window.nameAka : window.nameAo;
                const winnerTeam = window.winnerSide === 'aka' ? window.teamAka : window.teamAo;
                const winnerSlot = window.winnerSide === 'aka' ? window.slotAka : window.slotAo;
                const nextSlot = typeof getNextSlot === 'function' ? getNextSlot(winnerSlot) : null;

                syncEngine.saveMatchResult({
                    eventId: window.eventId,
                    category: window.matchCategory,
                    matchId: window.activeMatchId, // üÜï PASS THE MATCH ID
                    winner: {
                        name: winnerName,
                        team: winnerTeam,
                        side: window.winnerSide
                    },
                    aka: { name: window.nameAka, team: window.teamAka, score: scoreA },
                    ao: { name: window.nameAo, team: window.teamAo, score: scoreB },
                    nextSlot: nextSlot
                });

                // Force UI update for the Finish button
                window.updateConsoleWinnerUI();
            }
        };

        window.handleTimerBlur = function (el) {
            const text = el.value.trim();
            const parts = text.split(':');
            let mins = 0, secs = 0;
            if (parts.length >= 2) {
                mins = parseInt(parts[0]) || 0;
                secs = parseInt(parts[1]) || 0;
            } else {
                secs = parseInt(parts[0]) || 0;
            }
            window.timeLeft = (mins * 60) + secs;
            const displayMins = Math.floor(window.timeLeft / 60);
            const displaySecs = window.timeLeft % 60;
            el.value = `${displayMins.toString().padStart(2, '0')}:${displaySecs.toString().padStart(2, '0')}`;
            broadcastData();
        }

        window.handleTimerKey = function (e, el) {
            if (e.key === 'Enter') {
                e.preventDefault();
                el.blur();
            }
        }

        window.applyTimerSettings = function () {
            // Deprecated - using inline edit
        }

        // --- START INITIALIZATION ---
        initDashboard();
        // -----------------------------

        // --- JUDGE KEYPAD LOGIC (Integrated Numpad) ---
        let currentJudgeSide = 'aka';
        let currentJudgeIndex = 0;
        let primerDigit = null;
        let decimalDigit = null;

        window.openJudgeKeypad = function (side, index) {
            currentJudgeSide = side;
            currentJudgeIndex = index;
            primerDigit = null;
            decimalDigit = null;

            const modal = document.getElementById('judgeKeypadModal');
            const subtitle = document.getElementById('keypadSubtitle');
            const badge = document.getElementById('keypadBadge');
            const glow = document.getElementById('keypadGlow');

            if (badge) {
                badge.innerText = side.toUpperCase();
                badge.className = `px-4 py-1.5 text-[10px] font-black uppercase tracking-widest rounded-full border transition-all duration-500 ${side === 'aka' ? 'bg-red-500/20 text-red-500 border-red-500/30' : 'bg-blue-500/20 text-blue-500 border-blue-500/30'}`;
            }

            if (subtitle) {
                subtitle.innerText = `JUDGE ${index + 1}`;
                subtitle.className = `text-[11px] font-black uppercase tracking-[0.4em] text-slate-400 italic`;
            }

            if (glow) {
                glow.className = `absolute -top-40 -left-40 w-96 h-96 blur-[120px] rounded-full pointer-events-none transition-all duration-700 ${side === 'aka' ? 'bg-red-600/20' : 'bg-blue-600/20'}`;
            }

            updateNumpadDisplay();

            if (modal) {
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.add('opacity-100'), 10);
            }
        }

        window.updateNumpadDisplay = function () {
            const p = document.getElementById('digitPrimer');
            const d = document.getElementById('digitDecimal');
            if (p) {
                p.innerText = primerDigit !== null ? primerDigit : '_';
                p.classList.toggle('digit-active', primerDigit === null);
            }
            if (d) {
                d.innerText = decimalDigit !== null ? decimalDigit : '_';
                d.classList.toggle('digit-active', primerDigit !== null && decimalDigit === null);
            }
        }

        window.handleNumpad = function (num) {
            if (primerDigit === null) {
                // First digit: Score 5-9 or 1 (for 10)
                if (num === 1) {
                    primerDigit = 10; // Treat 1 as 10 for simplicity in this 5.0-10.0 scale
                    updateNumpadDisplay();
                } else if (num >= 5) {
                    primerDigit = num;
                    updateNumpadDisplay();
                }
            } else if (decimalDigit === null) {
                // Second digit: 0-9
                decimalDigit = num;
                updateNumpadDisplay();

                // Auto-save and advance
                setTimeout(() => {
                    const finalScore = primerDigit + (decimalDigit / 10);
                    window.saveJudgeScore(finalScore);
                }, 150);
            }
        }

        window.clearNumpad = function () {
            primerDigit = null;
            decimalDigit = null;
            updateNumpadDisplay();
        }

        window.saveJudgeScore = function (val) {
            // Update the score arrays
            if (currentJudgeSide === 'aka') {
                window.judgeScoresAka[currentJudgeIndex] = val;
                window.kataScoreAka = window.calculateKataTotal('aka', window.judgeScoresAka);
                if (document.getElementById('judgeBtnAka' + currentJudgeIndex)) document.getElementById('judgeBtnAka' + currentJudgeIndex).innerText = val.toFixed(1);
                if (document.getElementById('kataTotalAka')) document.getElementById('kataTotalAka').innerText = window.kataScoreAka.toFixed(1);
                if (document.getElementById('scoreAka')) document.getElementById('scoreAka').innerText = window.kataScoreAka.toFixed(1);
            } else {
                window.judgeScoresAo[currentJudgeIndex] = val;
                window.kataScoreAo = window.calculateKataTotal('ao', window.judgeScoresAo);
                if (document.getElementById('judgeBtnAo' + currentJudgeIndex)) document.getElementById('judgeBtnAo' + currentJudgeIndex).innerText = val.toFixed(1);
                if (document.getElementById('kataTotalAo')) document.getElementById('kataTotalAo').innerText = window.kataScoreAo.toFixed(1);
                if (document.getElementById('scoreAo')) document.getElementById('scoreAo').innerText = window.kataScoreAo.toFixed(1);
            }

            window.broadcastData();

            // Auto-advance logic
            const nextIndex = currentJudgeIndex + 1;
            if (nextIndex < 5) {
                // Move to next judge same side
                window.openJudgeKeypad(currentJudgeSide, nextIndex);
            } else if (currentJudgeSide === 'aka') {
                // Finish Aka, move to Ao J1
                window.openJudgeKeypad('ao', 0);
            } else {
                // Finish all 10 judges
                window.closeJudgeKeypad();

                // Check for winner using central function
                window.checkKataAutoWinner();
            }
        }

        window.setKataFlags = function (akaCount) {
            window.akaFlags = akaCount;
            window.aoFlags = Math.max(0, 5 - akaCount);

            if (window.akaFlags > window.aoFlags) {
                window.setHanteiWinner('aka');
            } else {
                window.setHanteiWinner('ao');
            }

            if (document.getElementById('scoreAka')) document.getElementById('scoreAka').innerText = window.akaFlags;
            if (document.getElementById('scoreAo')) document.getElementById('scoreAo').innerText = window.aoFlags;

            document.querySelectorAll('.flag-btn').forEach(btn => {
                const valAttr = btn.getAttribute('data-val');
                if (valAttr) {
                    const isSelected = parseInt(valAttr) === akaCount;
                    btn.classList.toggle('bg-red-600', isSelected);
                    btn.classList.toggle('text-white', isSelected);
                    btn.classList.toggle('bg-white/5', !isSelected);
                    btn.classList.toggle('text-red-500', !isSelected);
                }
            });

            window.broadcastData();
        }
    </script>

    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        .tab-active {
            box-shadow: inset 4px 4px 8px var(--dark), inset -4px -4px 8px var(--light) !important;
        }

        .punish-dot.opacity-100 {
            transform: scale(1.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Active Penalty Button Style (Simulated) */
        .neu-button:active,
        .neu-button.penalty-active {
            box-shadow: inset 2px 2px 5px var(--dark), inset -2px -2px 5px var(--light) !important;
            color: white !important;
        }

        /* MODAL STYLES */
        #timerModal {
            display: none;
            backdrop-filter: blur(8px);
            background: rgba(0, 0, 0, 0.4);
        }

        .modal-show {
            display: flex !important;
            animation: fadeIn 0.3s ease-out;
        }

        /* Kata Discarded Score Style */
        .kata-discarded {
            text-decoration: line-through;
            opacity: 0.3;
            filter: grayscale(1);
            position: relative;
        }

        .kata-discarded::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 10%;
            right: 10%;
            height: 2px;
            background: currentColor;
            transform: rotate(-15deg);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* TOGGLE SWITCH */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--light);
            transition: .4s;
            border-radius: 24px;
            box-shadow: inset 2px 2px 5px var(--dark);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: var(--text);
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--accent);
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        /* SEARCHABLE DROPDOWN STYLES */
        .autocomplete-container {
            position: relative;
            width: 100%;
        }

        #categoryDropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            margin-top: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.2s ease-out;
        }

        #categoryDropdown.active {
            display: block;
        }

        .dropdown-item {
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #ef4444;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>

    <script>
        // Participant List Modal Management
        let participantListData = [];

        window.toggleParticipantModal = async function () {
            const modal = document.getElementById('participantModal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                await loadParticipants();
                updateParticipantModal();
            } else {
                modal.classList.add('hidden');
            }
        };

        window.loadParticipants = async function () {
            // Get selected class from scoring console
            const categoryDisplay = document.getElementById('categoryDisplay');
            const selectedClass = categoryDisplay ? categoryDisplay.innerText.trim() : '';

            // Get event ID from URL
            const eventId = window.eventId || new URLSearchParams(window.location.search).get('id');

            if (!eventId) {
                console.warn('[Participant List] No event ID found');
                participantListData = [];
                return;
            }

            if (!selectedClass || selectedClass === 'KUMITE' || selectedClass === 'KATA') {
                console.log('[Participant List] No specific class selected');
                participantListData = [];
                return;
            }

            try {
                // 1. Try to fetch bracket data first (to get the exact bracket order)
                const bracketSnap = await getDoc(doc(db, `events/${eventId}/brackets`, selectedClass));

                if (bracketSnap.exists()) {
                    const bracketSnapData = bracketSnap.data();
                    const participants = bracketSnapData.participants || [];
                    const progression = bracketSnapData.data || {};

                    console.log(`[Participant List] Overhauling with full bracket progression for ${selectedClass}`);

                    const pattern = GOLDEN_PRESETS[participants.length] || [];
                    participantListData = [];

                    // Fetch Match Results for Kata/Scores
                    const matchResults = {};
                    try {
                        const resultsQuery = query(
                            collection(db, `events/${eventId}/match_results`),
                            where('category', '==', selectedClass)
                        );
                        const resultsSnap = await getDocs(resultsQuery);
                        resultsSnap.forEach(doc => {
                            const data = doc.data();
                            const key = `${data.aka?.name}_${data.ao?.name}`.toLowerCase();
                            matchResults[key] = data;
                        });
                    } catch (err) {
                        console.error('[Participant List] Error fetching match results:', err);
                    }

                    // Helper to get name from slot or pattern
                    const getAthleteAtSlot = (slotId, originalIdx) => {
                        if (progression[slotId]) return { name: progression[slotId], team: '', slotId: slotId };
                        if (originalIdx !== undefined && participants[originalIdx]) {
                            return { ...participants[originalIdx], slotId: slotId };
                        }
                        return { name: '-', team: '-', slotId: slotId };
                    };

                    // Helper to get match result data
                    const getMatchResult = (akaName, aoName) => {
                        const key1 = `${akaName}_${aoName}`.toLowerCase();
                        const key2 = `${aoName}_${akaName}`.toLowerCase();
                        return matchResults[key1] || matchResults[key2] || null;
                    };

                    // Determine initial round label based on first slot type
                    let initialRoundLabel = 'PENYISIHAN';
                    if (pattern.length > 0) {
                        const firstSlot = pattern[0];
                        if (firstSlot.startsWith('sn')) initialRoundLabel = 'SEMI FINAL';
                        else if (firstSlot.startsWith('qn')) initialRoundLabel = 'PEREMPAT FINAL';
                        else if (firstSlot.startsWith('fn')) initialRoundLabel = 'FINAL';
                    }

                    // 1. ROUND 1 (Initial Round)
                    for (let i = 0; i < participants.length; i += 2) {
                        const aka = getAthleteAtSlot(pattern[i], i);
                        const ao = getAthleteAtSlot(pattern[i + 1], i + 1);
                        const result = getMatchResult(aka.name, ao.name);

                        participantListData.push({
                            aka: aka,
                            ao: ao,
                            roundLabel: initialRoundLabel,
                            matchNum: Math.floor(i / 2) + 1,
                            result: result
                        });
                    }

                    // 2. HIGHER ROUNDS
                    const rounds = [
                        { key: 'quarter', label: 'PEREMPAT FINAL' },
                        { key: 'semi', label: 'SEMI FINAL' },
                        { key: 'final', label: 'FINAL' }
                    ].filter(r => r.label !== initialRoundLabel); // Prevent duplicates

                    rounds.forEach(r => {
                        const matches = ROUND_MATCH_IDS[r.key];
                        if (!matches) return;

                        let showRound = false;
                        if (r.key === 'quarter' && participants.length >= 5) showRound = true;
                        if (r.key === 'semi' && participants.length >= 3) showRound = true;
                        if (r.key === 'final' && participants.length >= 2) showRound = true;

                        if (showRound) {
                            matches.forEach((m, idx) => {
                                const aka = getAthleteAtSlot(m.aka);
                                const ao = getAthleteAtSlot(m.ao);

                                if (aka.name !== '-' || ao.name !== '-' || idx < (participants.length / (r.key === 'final' ? 2 : (r.key === 'semi' ? 4 : 8)))) {
                                    const result = getMatchResult(aka.name, ao.name);
                                    participantListData.push({
                                        aka: aka,
                                        ao: ao,
                                        roundLabel: r.label,
                                        matchNum: idx + 1,
                                        result: result
                                    });
                                }
                            });
                        }
                    });

                    return;
                }

                // 2. Fallback: Fetch athletes from Firestore filtered by className (no bracket found)
                console.log(`[Participant List] No bracket found for ${selectedClass}. Falling back to athlete list.`);
                const q = query(
                    collection(db, `events/${eventId}/athletes`),
                    where('className', '==', selectedClass)
                );

                const snapshot = await getDocs(q);
                participantListData = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        name: data.name || '-',
                        team: data.team || data.kontingen || '-',
                        className: data.className || '-',
                        round: data.currentRound || 'penyisihan',
                        roundLabel: getRoundLabel(data.currentRound || 'penyisihan'),
                        status: data.tournamentStatus || 'active'
                    };
                });

                // Sort by name in JavaScript if no bracket order
                participantListData.sort((a, b) => a.name.localeCompare(b.name));

                console.log(`[Participant List] Loaded ${participantListData.length} participants for class: ${selectedClass}`);
            } catch (err) {
                console.error('[Participant List] Error loading participants:', err);
                participantListData = [];
            }
        };

        function getRoundLabel(round) {
            const labels = {
                'penyisihan': 'Penyisihan 1',
                'penyisihan_2': 'Penyisihan 2',
                'semifinal': 'Semi-Final',
                'final': 'Final'
            };
            return labels[round] || 'P1';
        }

        window.updateParticipantModal = function () {
            const tableBody = document.getElementById('participantTableModal');
            const countBadge = document.getElementById('participantCountModal');

            if (participantListData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="py-12 text-center text-[10px] font-bold uppercase tracking-widest text-slate-600">
                            Pilih kelas yang sudah memiliki BAGAN (Bracket)
                        </td>
                    </tr>
                `;
                countBadge.innerText = '0 Partai';
                return;
            }

            countBadge.innerText = `${participantListData.length} Partai`;

            let html = '';
            let currentRoundId = '';

            participantListData.forEach((m, idx) => {
                // Show Round Header
                if (m.roundLabel !== currentRoundId) {
                    currentRoundId = m.roundLabel;
                    html += `
                <tr class="bg-white/5">
                    <td colspan="5" class="py-2 px-4 text-[9px] font-black uppercase tracking-[0.2em] text-yellow-500/80 border-y border-white/5">
                        ${currentRoundId}
                    </td>
                </tr>
                `;
                }

                const aka = m.aka;
                const ao = m.ao;

                const renderAthlete = (p, side, result) => {
                    if (!p || p.name === '-' || p.name === '') {
                        return `
                <div class="flex flex-col opacity-30">
                    <span class="text-[9px] font-black uppercase italic">BYE / KOSONG</span>
                </div>
                `;
                    }

                    let kataName = '';
                    let score = '';
                    if (result) {
                        const athleteData = side === 'aka' ? result.aka : result.ao;
                        if (athleteData) {
                            kataName = athleteData.kata || '';
                            score = athleteData.score !== undefined ? athleteData.score : '';
                        }
                    }

                    return `
                <div class="flex flex-col">
                    <span class="text-[11px] font-black uppercase text-white leading-tight">${p.name}</span>
                    <span class="text-[8px] font-bold text-slate-400 uppercase tracking-widest">${p.team || p.kontingen || p.teamName || '-'}</span>
                    ${kataName ? `<span class="text-[7px] font-bold text-blue-400 italic mt-0.5">Kata: ${kataName}</span>` : ''}
                    ${score !== '' ? `<span class="text-[7px] font-black text-yellow-400 mt-0.5">Score: ${score}</span>` : ''}
                </div>
                `;
                };

                const renderButtons = (pAka, pAo) => {
                    const matchData = encodeURIComponent(JSON.stringify({ aka: pAka, ao: pAo }));

                    const btnSelect = (pAka && pAka.name !== '-') || (pAo && pAo.name !== '-') ? `
                <button onclick="selectMatch('${matchData}')"
                    class="px-2.5 py-1 bg-yellow-500 hover:bg-yellow-400 text-[8px] font-black rounded text-slate-900 uppercase transition-all shadow-lg shadow-yellow-500/20">SELECT</button>
                ` : '';

                    const btnAka = pAka && pAka.name !== '-' ? `
                <button onclick="loadToSide('aka', '${pAka.name.replace(/\'/g, "\\\'")}', '${(pAka.team || pAka.kontingen || pAka.teamName || '').replace(/\'/g, "\\\'")}', '${pAka.slotId || ''}')" 
                                    class="px-2 py-1 bg-red-600/20 hover:bg-red-600 text-[7px] font-bold rounded text-red-500 hover:text-white uppercase transition-all">A</button>
        ` : '';

                    const btnAo = pAo && pAo.name !== '-' ? `
            <button onclick="loadToSide('ao', '${pAo.name.replace(/\'/g, "\\\'")}', '${(pAo.team || pAo.kontingen || pAo.teamName || '').replace(/\'/g, "\\\'")}', '${pAo.slotId || ''}')" 
        class="px-2 py-1 bg-blue-600/20 hover:bg-blue-600 text-[7px] font-bold rounded text-blue-500 hover:text-white uppercase transition-all" > B</button >
            ` : '';

                    return `
            < div class="flex items-center gap-1.5 justify-end" >
                ${btnAka}
                            ${btnAo}
        <div class="h-4 w-[1px] bg-white/10 mx-0.5"></div>
                            ${btnSelect}
                        </div >
            `;
                };

                html += `
            < tr class="border-b border-white/[0.03] hover:bg-white/[0.02] transition-colors group" >
                        <td class="py-2.5 px-4 text-[9px] font-black text-slate-500">#${m.matchNum}</td>
                        <td class="py-2.5 px-4">${renderAthlete(aka, 'aka', m.result)}</td>
                        <td class="py-2.5 px-4 text-center">
                            <span class="text-[8px] font-black italic text-slate-600">VS</span>
                        </td>
                        <td class="py-2.5 px-4">${renderAthlete(ao, 'ao', m.result)}</td>
                        <td class="py-2.5 px-4 text-right">${renderButtons(aka, ao)}</td>
                    </tr >
            `;
            });

            tableBody.innerHTML = html;
        };

        window.selectMatch = function (matchDataEncoded) {
            try {
                const match = JSON.parse(decodeURIComponent(matchDataEncoded));
                console.log('[Participant List] Selecting Match:', match);

                window.nameAka = match.aka?.name || '-';
                window.teamAka = match.aka?.team || match.aka?.kontingen || match.aka?.teamName || '-';
                window.nameAo = match.ao?.name || '-';
                window.teamAo = match.ao?.team || match.ao?.kontingen || match.ao?.teamName || '-';

                const dAka = document.getElementById('nameAkaDisplay');
                const dAo = document.getElementById('nameAoDisplay');
                const tAka = document.getElementById('teamAkaDisplay');
                const tAo = document.getElementById('teamAoDisplay');

                if (dAka) dAka.innerText = window.nameAka.toUpperCase();
                if (dAo) dAo.innerText = window.nameAo.toUpperCase();
                if (tAka) tAka.innerText = (window.teamAka === '-' || !window.teamAka) ? '---' : window.teamAka.toUpperCase();
                if (tAo) tAo.innerText = (window.teamAo === '-' || !window.teamAo) ? '---' : window.teamAo.toUpperCase();

                window.resetMatch();
                window.broadcastData();
                window.toggleParticipantModal();

                new Audio('assets/sounds/notification.mp3').play().catch(() => { });
            } catch (err) {
                console.error('[Participant List] Error selecting match:', err);
            }
        };

        window.loadToSide = function (side, name, team, slotId) {
            console.log(`[Participant List] Loading to ${side.toUpperCase()}:`, name);

            if (side === 'aka') {
                window.nameAka = name;
                window.teamAka = team;
                const d = document.getElementById('nameAkaDisplay');
                const t = document.getElementById('teamAkaDisplay');
                if (d) d.innerText = name.toUpperCase();
                if (t) t.innerText = (team === '-' || !team) ? '---' : team.toUpperCase();
            } else {
                window.nameAo = name;
                window.teamAo = team;
                const d = document.getElementById('nameAoDisplay');
                const t = document.getElementById('teamAoDisplay');
                if (d) d.innerText = name.toUpperCase();
                if (t) t.innerText = (team === '-' || !team) ? '---' : team.toUpperCase();
            }

            window.broadcastData();

            // Close modal only if it's currently open
            const modal = document.getElementById('participantModal');
            if (modal && !modal.classList.contains('hidden')) {
                window.toggleParticipantModal();
            }
        };

        // Close modal when clicking outside
        document.addEventListener('click', function (e) {
            const modal = document.getElementById('participantModal');
            if (e.target === modal) {
                toggleParticipantModal();
            }
        });

        // ============================================
        // QUEUE SYSTEM
        // ============================================
        window.queueData = [];
        window.queueUnsubscribe = null;

        // Toggle Queue Sidebar
        window.toggleQueueSidebar = function () {
            const sidebar = document.getElementById('queueSidebar');
            if (!sidebar) return;

            if (sidebar.classList.contains('translate-x-full')) {
                sidebar.classList.remove('translate-x-full');
            } else {
                sidebar.classList.add('translate-x-full');
            }
        };

        // Load Queue Data from Firebase
        // DISABLED: Queue functionality removed
        window.loadQueueData = function () {
            console.log('[Queue] DISABLED - Queue functionality has been removed');
            return; // Early exit
            /* DISABLED CODE BELOW
            if (!window.currentTatami) {
                console.warn('[Queue] No tatami selected');
                return;
            }

            // Unsubscribe from previous listener if exists
            if (window.queueUnsubscribe) {
                window.queueUnsubscribe();
            }

            const queueRef = ref(rtdb, `tatami_queues/${window.currentTatami}/queue`);

            window.queueUnsubscribe = onValue(queueRef, (snapshot) => {
                const data = snapshot.val();
                if (data && Array.isArray(data)) {
                    window.queueData = data;
                    window.renderQueueList();
                    console.log('[Queue] Loaded queue:', data.length, 'matches');
                } else {
                    window.queueData = [];
                    window.renderQueueList();
                }
            }, (error) => {
                console.error('[Queue] Error loading queue:', error);
            });
            */ // END DISABLED CODE
        };

        // Render Queue List in Sidebar
        window.renderQueueList = function () {
            const container = document.getElementById('queueMatchList');
            if (!container) return;

            if (!window.queueData || window.queueData.length === 0) {
                container.innerHTML = `
                    <div class="py-20 text-center opacity-20 italic text-[10px] font-black uppercase tracking-widest">
                        Antrean Kosong
                    </div>
                `;
                return;
            }

            let html = '';
            window.queueData.forEach((match, index) => {
                html += `
                    <div class="p-4 rounded-2xl bg-white/5 border border-white/10 hover:bg-white/10 hover:border-cyan-500/30 transition-all cursor-pointer"
                         onclick="loadMatchFromQueueAt(${index})">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="px-2 py-1 rounded-lg bg-cyan-500/20 border border-cyan-500/30">
                                <span class="text-[8px] font-black text-cyan-400">#${match.partaiNum || (index + 1)}</span>
                            </div>
                            <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest flex-1 truncate">
                                ${match.className || 'Unknown Class'}
                            </p>
                        </div>
                        <div class="space-y-2">
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-2 rounded-full bg-red-500"></div>
                                <p class="text-[10px] font-bold text-white truncate flex-1">${match.aka?.name || '-'}</p>
                                <span class="text-[8px] font-bold text-slate-500 uppercase">${match.aka?.team || ''}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                                <p class="text-[10px] font-bold text-white truncate flex-1">${match.ao?.name || '-'}</p>
                                <span class="text-[8px] font-bold text-slate-500 uppercase">${match.ao?.team || ''}</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        };

        // Load Next Match from Queue
        window.loadNextMatchFromQueue = async function () {
            if (!window.queueData || window.queueData.length === 0) {
                console.warn('[Queue] No matches in queue');
                alert('Tidak ada pertandingan di antrean.');
                return;
            }

            const nextMatch = window.queueData[0];
            await loadMatchFromQueueAt(0);
        };

        // Load Specific Match from Queue by Index
        window.loadMatchFromQueueAt = async function (index) {
            if (!window.queueData || index >= window.queueData.length) {
                console.warn('[Queue] Invalid queue index:', index);
                return;
            }

            const match = window.queueData[index];

            const confirmed = await showCustomConfirm(
                'MUAT DARI ANTREAN?',
                `Partai #${match.partaiNum || (index + 1)}\\n${match.aka?.name || '-'} VS ${match.ao?.name || '-'}\\nKelas: ${match.className || '-'}`
            );

            if (!confirmed) return;

            // Reset and load match
            resetMatch();
            window.nameAka = match.aka?.name || '-';
            window.nameAo = match.ao?.name || '-';
            window.teamAka = match.aka?.team || match.aka?.kontingen || '-';
            window.teamAo = match.ao?.team || match.ao?.kontingen || '-';
            window.matchCategory = match.className || '-';
            window.matchRound = match.round || 'Penyisihan';

            // Update UI
            document.getElementById('nameAkaDisplay').innerText = window.nameAka.toUpperCase();
            document.getElementById('nameAoDisplay').innerText = window.nameAo.toUpperCase();
            document.getElementById('teamAkaDisplay').innerText = (window.teamAka === '-' || !window.teamAka) ? '---' : window.teamAka.toUpperCase();
            document.getElementById('teamAoDisplay').innerText = (window.teamAo === '-' || !window.teamAo) ? '---' : window.teamAo.toUpperCase();
            document.getElementById('categoryDisplay').innerText = window.matchCategory.split(' ')[0].toUpperCase();
            document.getElementById('roundDisplay').innerText = window.matchRound.toUpperCase();

            // Remove match from queue in Firebase
            const newQueue = window.queueData.filter((__, i) => i !== index);
            const queueRef = ref(rtdb, `tatami_queues/${window.currentTatami}/queue`);
            await set(queueRef, newQueue);

            window.broadcastData();

            // Play notification sound
            // DISABLED: new Audio('assets/sounds/notification.mp3').play().catch(() => { });

            console.log('[Queue] Loaded match from queue:', match);
        };

        // Initialize Queue on Page Load
        // DISABLED: Queue functionality removed
        /*
        setTimeout(() => {
            window.loadQueueData();
        }, 1000);
        */

        // ============================================
        // FIREBASE LISTENER CLEANUP (Quota Optimization)
        // ============================================

        window.addEventListener('beforeunload', () => {
            console.log('[Cleanup] Cleaning up Firebase listeners on page unload');

            // Cleanup queue listener
            if (window.queueUnsubscribe) {
                try {
                    window.queueUnsubscribe();
                } catch (e) {
                    console.warn('[Cleanup] Error unsubscribing queue:', e);
                }
            }

            // Clear broadcast timeout
            if (window._broadcastTimeout) {
                clearTimeout(window._broadcastTimeout);
            }
        });

        console.log('[Scoring] üî• Firebase quota optimization active');

    </script>
</body>

</html>