<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Scoring | Kensho Tech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/scoring.css">
</head>

<body class="h-screen overflow-hidden text-slate-100 bg-[#020617]">
    <!-- Aurora Background -->
    <div id="aurora-container">
        <div class="aurora aurora-1"></div>
        <div class="aurora aurora-2"></div>
        <div class="aurora aurora-3"></div>
    </div>

    <!-- SIDEBAR REMOVED FOR SCORING CONSOLE FOCUS -->

    <!-- CONTENT -->
    <!-- CONTENT -->
    <main class="w-full h-screen p-4 md:p-8 flex flex-col overflow-hidden relative">
        <!-- BACK BUTTON REMOVED AS PER REQUEST -->

        <header class="flex justify-between items-center mb-6">
            <!-- LEFT: BREADCRUMB -->
            <div class="flex-1 flex items-center justify-start">
                <a href="scoring-home.html"
                    class="flex items-center gap-3 px-4 py-2 rounded-2xl bg-white/5 border border-white/5 hover:bg-white/10 hover:border-white/10 transition-all group">
                    <svg class="w-4 h-4 text-slate-400 group-hover:text-red-500 group-hover:-translate-x-1 transition-all"
                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
                    </svg>
                    <span
                        class="text-[10px] font-black uppercase tracking-widest text-slate-500 group-hover:text-slate-200 transition-colors">Pusat
                        Scoring</span>
                </a>
            </div>

            <!-- CENTER: CONTROL REGISTRY -->
            <div
                class="flex items-center gap-2 px-3 py-2 rounded-[2rem] bg-slate-900/50 backdrop-blur-xl border border-white/5 shadow-2xl mx-4">
                <!-- MODE SWITCH -->
                <div class="flex p-1 rounded-xl bg-black/40 border border-white/5 min-w-[180px]">
                    <button id="modeKumiteBtn" onclick="setScoringMode('kumite')"
                        class="flex-1 py-2 rounded-lg text-[8px] font-black uppercase tracking-widest transition-all mode-active">KUMITE</button>
                    <button id="modeKataBtn" onclick="setScoringMode('kata')"
                        class="flex-1 py-2 rounded-lg text-[8px] font-black uppercase tracking-widest transition-all text-slate-500">KATA</button>
                </div>

                <div class="w-[1px] h-6 bg-white/10 mx-1"></div>

                <!-- LIST PESERTA BUTTON -->
                <button id="btnParticipantList" onclick="toggleParticipantModal()"
                    class="px-4 py-2 rounded-xl bg-slate-800/30 border border-white/5 text-[9px] font-black uppercase tracking-widest text-slate-400 hover:bg-slate-700 hover:text-white transition-all flex items-center gap-2 whitespace-nowrap">
                    <svg class="w-3.5 h-3.5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    Peserta
                </button>

                <!-- KATA LIST BUTTON -->
                <a id="btnKataList" href="kata-list.html" target="_blank"
                    class="px-4 py-2 rounded-xl bg-slate-800/30 border border-white/5 text-[9px] font-black uppercase tracking-widest text-slate-400 hover:bg-slate-700 hover:text-white transition-all flex items-center gap-2 whitespace-nowrap">
                    <svg class="w-3.5 h-3.5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                    Kata List
                </a>
            </div>

            <!-- RIGHT: TATAMI BADGE -->
            <div class="flex-1 flex items-center justify-end gap-3">
                <!-- Sync Indicator -->
                <div id="syncBadge" onclick="window.syncAll()" title="Klik untuk sinkronisasi manual"
                    style="cursor: pointer"
                    class="flex items-center gap-2 px-3 py-2 rounded-xl bg-white/5 border border-white/5 text-[7px] font-black uppercase tracking-[0.2em] text-slate-500 transition-all hover:bg-white/10 active:scale-95">
                    <div id="syncDot" class="w-1.5 h-1.5 rounded-full bg-slate-500"></div>
                    <span id="syncText">Offline Mode</span>
                </div>

                <div
                    class="flex items-center gap-4 pl-6 pr-2 py-2 rounded-2xl bg-red-600/5 border border-red-500/10 shadow-[0_0_30px_rgba(220,38,38,0.05)] relative group overflow-hidden">
                    <div
                        class="absolute inset-0 bg-gradient-to-r from-transparent via-red-500/5 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-1000">
                    </div>
                    <div class="text-right relative z-10">
                        <p
                            class="text-[7px] font-black uppercase opacity-40 tracking-[0.3em] leading-none mb-1 text-red-500">
                            Arena Aktif</p>
                        <p
                            class="text-xs font-black uppercase tracking-widest text-red-500 group-hover:scale-105 transition-transform">
                            TATAMI <span id="activeTatamiLabel" class="ml-1">-</span>
                        </p>
                    </div>
                    <div
                        class="w-8 h-8 rounded-xl bg-red-600/10 border border-red-500/20 flex items-center justify-center relative z-10">
                        <div class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></div>
                    </div>
                </div>
            </div>
        </header>

        <div id="mainScoringGrid" class="flex-1 flex flex-col gap-2 overflow-hidden">
            <!-- TOP: MATCH STATUS & SCOREBOARD -->
            <div id="scoringMainArea"
                class="flex-1 flex flex-col space-y-2 overflow-y-auto custom-scrollbar transition-all duration-500 pr-2">
                <!-- SCOREBOARD SPLIT-PANEL -->
                <div class="flex-1 grid grid-cols-12 gap-0 rounded-[3rem] overflow-hidden shadow-2xl border border-white/5 relative bg-slate-900/40 backdrop-blur-xl mb-2"
                    style="display: flex;">
                    <!-- AKA PANEL (Default: RIGHT side to match monitor) -->
                    <div id="panelContainerAka" style="order: 3; flex: 1;"
                        class="col-span-12 md:col-span-5 flex flex-col items-center justify-between py-4 px-6 bg-red-950/10 relative group border-r border-white/5">
                        <!-- HANTEI BUTTON (Minimalist) -->
                        <button id="btnHanteiAka" onclick="setHanteiWinner('aka')"
                            class="absolute top-0 right-0 px-4 py-2 bg-red-600 shadow-[0_4px_10px_rgba(220,38,38,0.3)] text-white rounded-bl-3xl border-l border-b border-white/20 hidden transition-all hover:scale-110 active:scale-95 z-50">
                            <span class="text-[10px] font-black italic tracking-widest uppercase">Kachi</span>
                        </button>

                        <div
                            class="absolute top-0 left-0 w-full h-1 bg-red-600 shadow-[0_5px_15px_rgba(220,38,38,0.4)]">
                        </div>

                        <!-- TOP: Name & Label -->
                        <div id="panelAka" class="text-center w-full relative z-10 pt-2">
                            <div id="badgeWinnerAka"
                                class="absolute -top-6 left-1/2 -translate-x-1/2 px-4 py-1 bg-red-500 text-white text-[8px] font-black uppercase tracking-[0.3em] rounded-full hidden">
                                WINNER</div>
                            <p class="text-[10px] font-black uppercase tracking-[0.4em] text-red-500/60 mb-1 italic">
                                AKA</p>
                            <h2 id="nameAkaDisplay"
                                class="text-2xl font-black uppercase italic tracking-tighter text-slate-200 truncate px-4">
                                ---</h2>
                            <input type="text" id="inputKataAka" placeholder="Input Nama Kata"
                                oninput="checkKataShortcut(this); broadcastData()"
                                class="w-auto min-w-[160px] bg-red-500/5 border border-red-500/10 rounded-xl px-4 py-2 text-xs font-black uppercase tracking-widest text-red-500 mt-2 focus:bg-red-500/10 focus:border-red-500/40 focus:scale-105 focus:outline-none placeholder:text-red-500/20 transition-all text-center hidden">
                        </div>

                        <!-- CENTER: Score (Anchor) -->
                        <div id="scoreAka"
                            class="text-[180px] font-black italic tracking-tighter text-red-500 leading-none drop-shadow-[0_20px_40px_rgba(248,113,113,0.3)] select-none my-auto">
                            00</div>

                        <!-- BOTTOM: Controls -->
                        <div id="kumiteControlsAka" class="w-full relative z-10 space-y-3 px-4">
                            <!-- Score Buttons -->
                            <div class="grid grid-cols-4 gap-2">
                                <button onclick="addScore('aka', 1)" class="neu-button py-3 rounded-xl group">
                                    <span
                                        class="text-xl font-black group-hover:scale-110 transition-transform text-red-400">+1</span>
                                </button>
                                <button onclick="addScore('aka', 2)"
                                    class="neu-button py-3 rounded-xl group border-red-500/30">
                                    <span
                                        class="text-xl font-black text-red-500 group-hover:scale-110 transition-transform">+2</span>
                                </button>
                                <button onclick="addScore('aka', 3)"
                                    class="neu-button py-3 rounded-xl group border-red-500/50">
                                    <span
                                        class="text-xl font-black text-red-600 group-hover:scale-110 transition-transform">+3</span>
                                </button>
                                <button onclick="addScore('aka', -1)"
                                    class="neu-button py-3 rounded-xl group bg-white/5 opacity-40">
                                    <span
                                        class="text-xl font-black text-slate-500 group-hover:scale-110 transition-transform">-1</span>
                                </button>
                            </div>

                            <!-- Penalty & Status Buttons -->
                            <div id="penAka" class="grid grid-cols-7 gap-1.5">
                                <button id="senshuAka" onclick="setSenshu('aka')"
                                    class="py-3 rounded-lg neu-button text-[10px] font-black opacity-70 hover:opacity-100 transition-opacity">S</button>
                                <button id="aka_c1" onclick="togglePenalty('aka', 'c1')"
                                    class="py-3 rounded-lg neu-button text-[10px] font-black opacity-60 bg-black/40 border-white/5 transition-all hover:opacity-100">C1</button>
                                <button id="aka_c2" onclick="togglePenalty('aka', 'c2')"
                                    class="py-3 rounded-lg neu-button text-[10px] font-black opacity-60 bg-black/40 border-white/5 transition-all hover:opacity-100">C2</button>
                                <button id="aka_c3" onclick="togglePenalty('aka', 'c3')"
                                    class="py-3 rounded-lg neu-button text-[10px] font-black opacity-60 bg-black/40 border-white/5 transition-all hover:opacity-100">C3</button>
                                <button id="aka_hc" onclick="togglePenalty('aka', 'hc')"
                                    class="py-3 rounded-lg neu-button text-[10px] font-black opacity-60 bg-black/40 border-white/5 transition-all hover:opacity-100">HC</button>
                                <button id="aka_h" onclick="togglePenalty('aka', 'h')"
                                    class="py-3 rounded-lg neu-button text-[10px] font-black opacity-60 bg-black/40 border-white/5 transition-all hover:opacity-100">H</button>
                                <button id="vrAka" onclick="toggleVR('aka')"
                                    class="py-3 rounded-lg neu-button text-[10px] font-black opacity-50 text-yellow-500 transition-all hover:opacity-100">VR</button>
                            </div>
                        </div>

                        <!-- KATA CONTROLS AKA (Integrated) -->
                        <div id="kataControlsAka" class="hidden w-full relative z-10 space-y-3 px-4">
                            <div class="grid grid-cols-5 gap-2">
                                <button onclick="openJudgeKeypad('aka', 0)" id="judgeBtnAka0"
                                    class="bg-slate-800/80 border border-white/10 rounded-xl py-3 text-center text-sm font-black text-red-400 hover:bg-red-500/20 transition-all">0.0</button>
                                <button onclick="openJudgeKeypad('aka', 1)" id="judgeBtnAka1"
                                    class="bg-slate-800/80 border border-white/10 rounded-xl py-3 text-center text-sm font-black text-red-400 hover:bg-red-500/20 transition-all">0.0</button>
                                <button onclick="openJudgeKeypad('aka', 2)" id="judgeBtnAka2"
                                    class="bg-slate-800/80 border border-white/10 rounded-xl py-3 text-center text-sm font-black text-red-400 hover:bg-red-500/20 transition-all">0.0</button>
                                <button onclick="openJudgeKeypad('aka', 3)" id="judgeBtnAka3"
                                    class="bg-slate-800/80 border border-white/10 rounded-xl py-3 text-center text-sm font-black text-red-400 hover:bg-red-500/20 transition-all">0.0</button>
                                <button onclick="openJudgeKeypad('aka', 4)" id="judgeBtnAka4"
                                    class="bg-slate-800/80 border border-white/10 rounded-xl py-3 text-center text-sm font-black text-red-400 hover:bg-red-500/20 transition-all">0.0</button>
                            </div>
                            <div
                                class="p-2.5 rounded-xl bg-red-500/10 border border-red-500/20 flex justify-between items-center">
                                <span class="text-[9px] font-black uppercase text-red-500/50">RESULT</span>
                                <span id="kataTotalAka" class="text-lg font-black text-red-500 italic">0.0</span>
                            </div>
                        </div>

                        <!-- KATA FLAG CONTROLS AKA -->
                        <div id="kataFlagControlsAka" class="hidden w-full relative z-10 space-y-3 px-4">
                            <p class="text-[8px] font-black uppercase tracking-widest text-red-500/50 text-center">
                                VOTING BENDERA AKA</p>
                            <div class="grid grid-cols-6 gap-2">
                                <button onclick="setKataFlagsAka(0)"
                                    class="flag-btn-aka py-3 rounded-xl bg-white/5 text-red-500 text-lg font-black border border-white/10 hover:border-red-500 hover:bg-red-500/20 transition-all"
                                    data-val="0">0</button>
                                <button onclick="setKataFlagsAka(1)"
                                    class="flag-btn-aka py-3 rounded-xl bg-white/5 text-red-500 text-lg font-black border border-white/10 hover:border-red-500 hover:bg-red-500/20 transition-all"
                                    data-val="1">1</button>
                                <button onclick="setKataFlagsAka(2)"
                                    class="flag-btn-aka py-3 rounded-xl bg-white/5 text-red-500 text-lg font-black border border-white/10 hover:border-red-500 hover:bg-red-500/20 transition-all"
                                    data-val="2">2</button>
                                <button onclick="setKataFlagsAka(3)"
                                    class="flag-btn-aka py-3 rounded-xl bg-white/5 text-red-500 text-lg font-black border border-white/10 hover:border-red-500 hover:bg-red-500/20 transition-all"
                                    data-val="3">3</button>
                                <button onclick="setKataFlagsAka(4)"
                                    class="flag-btn-aka py-3 rounded-xl bg-white/5 text-red-500 text-lg font-black border border-white/10 hover:border-red-500 hover:bg-red-500/20 transition-all"
                                    data-val="4">4</button>
                                <button onclick="setKataFlagsAka(5)"
                                    class="flag-btn-aka py-3 rounded-xl bg-white/5 text-red-500 text-lg font-black border border-white/10 hover:border-red-500 hover:bg-red-500/20 transition-all"
                                    data-val="5">5</button>
                            </div>
                        </div>
                    </div>

                    <!-- CENTER STRIP: TIMER & ROUND -->
                    <div id="panelContainerCenter" style="order: 2; flex: 0 0 auto; min-width: 250px;"
                        class="col-span-12 md:col-span-2 flex flex-col items-center justify-center py-2 px-2 bg-slate-950/80 border-x border-white/5 relative overflow-hidden gap-3">
                        <div
                            class="absolute inset-0 bg-gradient-to-b from-blue-500/10 via-transparent to-red-500/10 pointer-events-none">
                        </div>

                        <div class="text-center relative z-10 w-full px-2">
                            <div
                                class="bg-white/5 px-6 py-2 rounded-2xl border border-white/10 text-center mb-4 backdrop-blur-md">
                                <p id="categoryDisplay"
                                    class="text-xs font-black italic tracking-widest leading-none text-slate-200">
                                    KUMITE</p>
                            </div>
                        </div>

                        <div class="text-center relative z-10 w-full flex flex-col items-center">
                            <!-- MINI UTILITY BAR -->
                            <div class="flex items-center gap-2 mb-2">
                                <button onclick="flipPanels()" id="btnFlipPanels"
                                    class="w-8 h-8 rounded-lg bg-purple-600/20 text-purple-400 border border-purple-500/30 flex items-center justify-center hover:bg-purple-600 hover:text-white transition-all"
                                    title="Tukar Posisi AKA/AO">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                                    </svg>
                                </button>
                                <button onclick="handleMonitor()" id="btnMonitor"
                                    class="w-8 h-8 rounded-lg bg-blue-600/20 text-blue-400 border border-blue-500/30 flex items-center justify-center hover:bg-blue-600 hover:text-white transition-all"
                                    title="Open Monitor">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                    </svg>
                                </button>
                                <button onclick="toggleSettingsModal()" id="btnOpenSettings"
                                    class="w-8 h-8 rounded-lg bg-orange-600/20 text-orange-400 border border-orange-500/30 flex items-center justify-center hover:bg-orange-600 hover:text-white transition-all"
                                    title="Pengaturan Pertandingan">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                </button>
                                <button onclick="toggleMonitorFullscreen()" id="btnFullscreen"
                                    class="w-8 h-8 rounded-lg bg-slate-800 text-slate-400 border border-white/5 flex items-center justify-center hover:text-white transition-all hidden"
                                    title="Fullscreen Monitor">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                                    </svg>
                                </button>
                            </div>

                            <p class="text-[8px] font-black uppercase tracking-[0.8em] text-white/30 mb-0.5">TIME</p>
                            <div class="flex flex-col items-center group mb-1">
                                <input id="timerDisplay" type="text" value="01:00" onblur="handleTimerBlur(this)"
                                    onkeydown="handleTimerKey(event, this)"
                                    class="text-5xl font-black italic shimmer-text leading-none w-full text-center bg-transparent focus:outline-none cursor-text select-all">

                                <!-- QUICK ADJUST -->
                                <div class="flex gap-2 mt-2 opacity-40 group-hover:opacity-100 transition-opacity">
                                    <button onclick="adjustTimer(-1)"
                                        class="w-10 h-8 rounded-lg bg-white/5 flex items-center justify-center text-[8px] font-black hover:bg-white/10 hover:text-red-400 transition-all border border-white/5">-1S</button>
                                    <button onclick="adjustTimer(1)"
                                        class="w-10 h-8 rounded-lg bg-white/5 flex items-center justify-center text-[8px] font-black hover:bg-white/10 hover:text-green-400 transition-all border border-white/5">+1S</button>
                                </div>
                            </div>

                            <!-- CENTRAL TIMER CONTROLS -->
                            <div class="flex flex-col items-center space-y-2 w-full px-4">
                                <div
                                    class="flex items-center space-x-2 bg-black/60 px-4 py-1.5 rounded-full border border-white/10 shadow-inner mb-1">
                                    <span id="timerStatusDot"
                                        class="w-2 h-2 rounded-full bg-slate-400 animate-pulse"></span>
                                    <p id="timerLabel"
                                        class="text-[8px] font-black uppercase tracking-widest text-slate-200 whitespace-nowrap">
                                        SIAP BERTANDING</p>
                                </div>

                                <div class="grid grid-cols-2 gap-2 w-full">
                                    <button onclick="toggleTimer()" id="btnTimerControl"
                                        class="py-2.5 rounded-2xl bg-red-600 text-white text-[9px] font-black uppercase tracking-widest shadow-[0_8px_16px_rgba(220,38,38,0.3)] hover:scale-105 active:scale-95 transition-all">START
                                        MATCH</button>
                                    <button onclick="resetMatch()"
                                        class="py-2.5 rounded-2xl bg-slate-800 text-white text-[9px] font-black uppercase tracking-widest border border-white/10 hover:bg-slate-700 transition-all shadow-lg">RESET</button>
                                </div>

                                <!-- TIMER QUICK TOGGLE (KATA ONLY) -->
                                <div id="timerToggleContainer"
                                    class="hidden flex items-center justify-between w-full px-4 py-2 bg-white/5 rounded-2xl border border-white/5 mb-0.5 transition-all">
                                    <div class="flex items-center gap-2">
                                        <div id="timerToggleStatus"
                                            class="w-1 h-1 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.5)]">
                                        </div>
                                        <p class="text-[7.5px] font-black uppercase tracking-widest text-slate-400">
                                            Gunakan Timer</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer scale-75">
                                        <input type="checkbox" id="timerEnableSwitch" class="sr-only peer" checked
                                            onchange="toggleTimerSetting(this.checked)">
                                        <div
                                            class="w-8 h-4 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-red-600">
                                        </div>
                                    </label>
                                </div>

                                <!-- KATA MODE SELECTOR (Integrated) -->
                                <div id="kataTypeSwitch" class="hidden w-full flex justify-center mt-1">
                                    <div class="bg-black/60 p-1 rounded-xl flex gap-1 border border-white/5 w-full">
                                        <button id="kataTypeScoreBtn" onclick="setKataType('score')"
                                            class="flex-1 py-1 rounded-lg text-[7.5px] font-black uppercase tracking-widest transition-all mode-active italic">SCORE</button>
                                        <button id="kataTypeFlagBtn" onclick="setKataType('flag')"
                                            class="flex-1 py-1 rounded-lg text-[7.5px] font-black uppercase tracking-widest transition-all text-slate-500 italic">FLAG</button>
                                    </div>
                                </div>

                                <button onclick="announceWinner()" id="btnAnnounceWinner"
                                    class="w-full py-3 rounded-xl bg-yellow-500 text-black text-[9px] font-black uppercase tracking-widest shadow-lg hidden">ANNOUNCE
                                    WINNER</button>

                                <!-- KATA PERFORMER SELECTOR (AKA/AO) -->
                                <div id="performerSelector"
                                    class="hidden w-full flex flex-col items-center gap-1 mt-1 pt-1 border-t border-white/5">
                                    <p class="text-[6.5px] font-black uppercase tracking-[0.3em] text-slate-500">PILIH
                                        PERFORMER</p>
                                    <div class="bg-black/60 p-1 rounded-xl flex gap-1 border border-white/5 w-full">
                                        <button id="performerAkaBtn" onclick="setKataPerformer('aka')"
                                            class="flex-1 py-1.5 px-2 rounded-lg text-[8.5px] font-black uppercase tracking-widest transition-all text-slate-500 hover:text-slate-300 truncate">AKA</button>
                                        <button id="performerAoBtn" onclick="setKataPerformer('ao')"
                                            class="flex-1 py-1.5 px-2 rounded-lg text-[8.5px] font-black uppercase tracking-widest transition-all text-slate-500 hover:text-slate-300 truncate">AO</button>
                                    </div>
                                </div>

                                <!-- KATA WINNER SELECTOR -->
                                <div id="kataWinnerSelector"
                                    class="hidden w-full flex flex-col items-center gap-1 mt-1 pt-1 border-t border-white/10">
                                    <p class="text-[6.5px] font-black uppercase tracking-[0.3em] text-yellow-500">
                                        TENTUKAN
                                        PEMENANG</p>
                                    <div class="flex gap-1.5 w-full">
                                        <button id="winAkaBtn" onclick="declareKataWinner('aka')"
                                            class="flex-1 py-1.5 px-2 rounded-xl bg-red-600/20 text-red-500 border border-red-500/30 text-[8.5px] font-black uppercase tracking-widest hover:bg-red-600 hover:text-white transition-all truncate">WIN
                                            AKA</button>
                                        <button id="winAoBtn" onclick="declareKataWinner('ao')"
                                            class="flex-1 py-1.5 px-2 rounded-xl bg-blue-600/20 text-blue-500 border border-blue-500/30 text-[8.5px] font-black uppercase tracking-widest hover:bg-blue-600 hover:text-white transition-all truncate">WIN
                                            AO</button>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                    <!-- AO PANEL (Default: LEFT side to match monitor) -->
                    <div id="panelContainerAo" style="order: 1; flex: 1;"
                        class="col-span-12 md:col-span-5 flex flex-col items-center justify-between py-4 px-6 bg-blue-950/10 relative group border-l border-white/5">
                        <!-- HANTEI BUTTON (Minimalist) -->
                        <button id="btnHanteiAo" onclick="setHanteiWinner('ao')"
                            class="absolute top-0 left-0 px-4 py-2 bg-blue-600 shadow-[0_4px_10px_rgba(37,99,235,0.3)] text-white rounded-br-3xl border-r border-b border-white/20 hidden transition-all hover:scale-110 active:scale-95 z-50">
                            <span class="text-[10px] font-black italic tracking-widest uppercase">Kachi</span>
                        </button>

                        <div
                            class="absolute top-0 right-0 w-full h-1 bg-blue-600 shadow-[0_5px_15px_rgba(37,99,235,0.4)]">
                        </div>

                        <!-- TOP: Name & Label -->
                        <div id="panelAo" class="text-center w-full relative z-10 pt-2">
                            <div id="badgeWinnerAo"
                                class="absolute -top-6 left-1/2 -translate-x-1/2 px-4 py-1 bg-blue-500 text-white text-[8px] font-black uppercase tracking-[0.3em] rounded-full hidden">
                                WINNER</div>
                            <p class="text-[10px] font-black uppercase tracking-[0.4em] text-blue-500/60 mb-1 italic">
                                AO</p>
                            <h2 id="nameAoDisplay"
                                class="text-2xl font-black uppercase italic tracking-tighter text-slate-200 truncate px-4">
                                ---</h2>
                            <input type="text" id="inputKataAo" placeholder="Input Nama Kata"
                                oninput="checkKataShortcut(this); broadcastData()"
                                class="w-auto min-w-[160px] bg-blue-500/5 border border-blue-500/10 rounded-xl px-4 py-2 text-xs font-black uppercase tracking-widest text-blue-500 mt-2 focus:bg-blue-500/10 focus:border-blue-500/40 focus:scale-105 focus:outline-none placeholder:text-blue-500/20 transition-all text-center hidden">
                        </div>

                        <!-- CENTER: Score (Anchor) -->
                        <div id="scoreAo"
                            class="text-[180px] font-black italic tracking-tighter text-blue-500 leading-none drop-shadow-[0_20px_40px_rgba(59,130,246,0.3)] select-none my-auto">
                            00</div>

                        <!-- BOTTOM: Controls -->
                        <div id="kumiteControlsAo" class="w-full relative z-10 space-y-3 px-4">
                            <!-- Score Buttons -->
                            <div class="grid grid-cols-4 gap-2">
                                <button onclick="addScore('ao', 1)" class="neu-button py-3 rounded-xl group">
                                    <span
                                        class="text-xl font-black group-hover:scale-110 transition-transform text-blue-400">+1</span>
                                </button>
                                <button onclick="addScore('ao', 2)"
                                    class="neu-button py-3 rounded-xl group border-blue-500/30">
                                    <span
                                        class="text-xl font-black text-blue-500 group-hover:scale-110 transition-transform">+2</span>
                                </button>
                                <button onclick="addScore('ao', 3)"
                                    class="neu-button py-3 rounded-xl group border-blue-500/50">
                                    <span
                                        class="text-xl font-black text-blue-600 group-hover:scale-110 transition-transform">+3</span>
                                </button>
                                <button onclick="addScore('ao', -1)"
                                    class="neu-button py-3 rounded-xl group bg-white/5 opacity-40">
                                    <span
                                        class="text-xl font-black text-slate-500 group-hover:scale-110 transition-transform">-1</span>
                                </button>
                            </div>

                            <!-- Penalty & Status Buttons -->
                            <div id="penAo" class="grid grid-cols-7 gap-1.5">
                                <button id="senshuAo" onclick="setSenshu('ao')"
                                    class="py-3 rounded-lg neu-button text-[10px] font-black opacity-70 hover:opacity-100 transition-opacity">S</button>
                                <button id="ao_c1" onclick="togglePenalty('ao', 'c1')"
                                    class="py-3 rounded-lg neu-button text-[10px] font-black opacity-60 bg-black/40 border-white/5 transition-all hover:opacity-100">C1</button>
                                <button id="ao_c2" onclick="togglePenalty('ao', 'c2')"
                                    class="py-3 rounded-lg neu-button text-[10px] font-black opacity-60 bg-black/40 border-white/5 transition-all hover:opacity-100">C2</button>
                                <button id="ao_c3" onclick="togglePenalty('ao', 'c3')"
                                    class="py-3 rounded-lg neu-button text-[10px] font-black opacity-60 bg-black/40 border-white/5 transition-all hover:opacity-100">C3</button>
                                <button id="ao_hc" onclick="togglePenalty('ao', 'hc')"
                                    class="py-3 rounded-lg neu-button text-[10px] font-black opacity-60 bg-black/40 border-white/5 transition-all hover:opacity-100">HC</button>
                                <button id="ao_h" onclick="togglePenalty('ao', 'h')"
                                    class="py-3 rounded-lg neu-button text-[10px] font-black opacity-60 bg-black/40 border-white/5 transition-all hover:opacity-100">H</button>
                                <button id="vrAo" onclick="toggleVR('ao')"
                                    class="py-3 rounded-lg neu-button text-[10px] font-black opacity-50 text-yellow-500 transition-all hover:opacity-100">VR</button>
                            </div>
                        </div>

                        <!-- KATA CONTROLS AO (Integrated) -->
                        <div id="kataControlsAo" class="hidden w-full relative z-10 space-y-3 px-4">
                            <div class="grid grid-cols-5 gap-2">
                                <button onclick="openJudgeKeypad('ao', 0)" id="judgeBtnAo0"
                                    class="bg-slate-800/80 border border-white/10 rounded-xl py-3 text-center text-sm font-black text-blue-400 hover:bg-blue-500/20 transition-all">0.0</button>
                                <button onclick="openJudgeKeypad('ao', 1)" id="judgeBtnAo1"
                                    class="bg-slate-800/80 border border-white/10 rounded-xl py-3 text-center text-sm font-black text-blue-400 hover:bg-blue-500/20 transition-all">0.0</button>
                                <button onclick="openJudgeKeypad('ao', 2)" id="judgeBtnAo2"
                                    class="bg-slate-800/80 border border-white/10 rounded-xl py-3 text-center text-sm font-black text-blue-400 hover:bg-blue-500/20 transition-all">0.0</button>
                                <button onclick="openJudgeKeypad('ao', 3)" id="judgeBtnAo3"
                                    class="bg-slate-800/80 border border-white/10 rounded-xl py-3 text-center text-sm font-black text-blue-400 hover:bg-blue-500/20 transition-all">0.0</button>
                                <button onclick="openJudgeKeypad('ao', 4)" id="judgeBtnAo4"
                                    class="bg-slate-800/80 border border-white/10 rounded-xl py-3 text-center text-sm font-black text-blue-400 hover:bg-blue-500/20 transition-all">0.0</button>
                            </div>
                            <div
                                class="p-2.5 rounded-xl bg-blue-500/10 border border-blue-500/20 flex justify-between items-center">
                                <span class="text-[9px] font-black uppercase text-blue-500/50">RESULT</span>
                                <span id="kataTotalAo" class="text-lg font-black text-blue-500 italic">0.0</span>
                            </div>
                        </div>

                        <!-- KATA FLAG CONTROLS AO -->
                        <div id="kataFlagControlsAo" class="hidden w-full relative z-10 space-y-3 px-4">
                            <p class="text-[8px] font-black uppercase tracking-widest text-blue-500/50 text-center">
                                VOTING BENDERA AO</p>
                            <div class="grid grid-cols-6 gap-2">
                                <button onclick="setKataFlagsAo(0)"
                                    class="flag-btn-ao py-3 rounded-xl bg-white/5 text-blue-500 text-lg font-black border border-white/10 hover:border-blue-500 hover:bg-blue-500/20 transition-all"
                                    data-val="0">0</button>
                                <button onclick="setKataFlagsAo(1)"
                                    class="flag-btn-ao py-3 rounded-xl bg-white/5 text-blue-500 text-lg font-black border border-white/10 hover:border-blue-500 hover:bg-blue-500/20 transition-all"
                                    data-val="1">1</button>
                                <button onclick="setKataFlagsAo(2)"
                                    class="flag-btn-ao py-3 rounded-xl bg-white/5 text-blue-500 text-lg font-black border border-white/10 hover:border-blue-500 hover:bg-blue-500/20 transition-all"
                                    data-val="2">2</button>
                                <button onclick="setKataFlagsAo(3)"
                                    class="flag-btn-ao py-3 rounded-xl bg-white/5 text-blue-500 text-lg font-black border border-white/10 hover:border-blue-500 hover:bg-blue-500/20 transition-all"
                                    data-val="3">3</button>
                                <button onclick="setKataFlagsAo(4)"
                                    class="flag-btn-ao py-3 rounded-xl bg-white/5 text-blue-500 text-lg font-black border border-white/10 hover:border-blue-500 hover:bg-blue-500/20 transition-all"
                                    data-val="4">4</button>
                                <button onclick="setKataFlagsAo(5)"
                                    class="flag-btn-ao py-3 rounded-xl bg-white/5 text-blue-500 text-lg font-black border border-white/10 hover:border-blue-500 hover:bg-blue-500/20 transition-all"
                                    data-val="5">5</button>
                            </div>
                        </div>
                    </div>
                </div>



            </div> <!-- End of scoringMainArea -->


        </div> <!-- End of mainScoringGrid -->

        <!-- PARTICIPANT LIST MODAL -->
        <div id="participantModal"
            class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden">
            <div
                class="glass-card rounded-[3rem] w-[90vw] max-w-5xl max-h-[85vh] flex flex-col overflow-hidden shadow-2xl border border-white/10">
                <!-- Modal Header -->
                <div class="flex justify-between items-center p-6 border-b border-white/10">
                    <div>
                        <h2 class="text-2xl font-black italic tracking-tight uppercase text-white mb-1">List Peserta
                        </h2>
                        <p class="text-[9px] font-bold uppercase tracking-widest text-slate-500">Kelas Tanding Aktif</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <span id="participantCountModal"
                            class="text-xs font-bold text-slate-400 bg-white/5 px-4 py-2 rounded-full border border-white/5">
                            0 Peserta
                        </span>
                        <button onclick="toggleParticipantModal()"
                            class="w-10 h-10 rounded-xl bg-red-500/10 border border-red-500/20 flex items-center justify-center text-red-500 hover:bg-red-500/20 transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Modal Body -->
                <div class="flex-1 overflow-y-auto p-6">
                    <table class="w-full">
                        <thead class="sticky top-0 bg-slate-900/80 backdrop-blur-md">
                            <tr class="border-b border-white/10">
                                <th
                                    class="text-left py-3 px-4 text-[9px] font-black uppercase tracking-[0.2em] text-slate-500">
                                    Partai</th>
                                <th
                                    class="text-left py-3 px-4 text-[9px] font-black uppercase tracking-[0.2em] text-slate-500">
                                    Peserta AKA</th>
                                <th
                                    class="text-center py-3 px-2 text-[9px] font-black uppercase tracking-[0.2em] text-slate-500">
                                    VS</th>
                                <th
                                    class="text-left py-3 px-4 text-[9px] font-black uppercase tracking-[0.2em] text-slate-500">
                                    Peserta AO</th>
                                <th
                                    class="text-center py-3 px-4 text-[9px] font-black uppercase tracking-[0.2em] text-slate-500">
                                    Action</th>
                            </tr>
                        </thead>
                        <tbody id="participantTableModal">
                            <tr>
                                <td colspan="6"
                                    class="py-12 text-center text-[10px] font-bold uppercase tracking-widest text-slate-600">
                                    Pilih kelas dari Pengaturan Pertandingan
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- CUSTOM MODAL HTML -->
    <div id="customModal">
        <div class="modal-content">
            <div class="w-16 h-16 bg-red-500/10 rounded-2xl flex items-center justify-center mx-auto mb-6">
                <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h3 id="modalTitle" class="text-xl font-black uppercase tracking-widest text-white mb-2">Konfirmasi</h3>
            <p id="modalMessage" class="text-sm font-medium text-slate-400 leading-relaxed mb-8">Apakah Anda yakin ingin
                mengganti pertandingan?</p>
            <div class="flex gap-4">
                <button id="modalCancel"
                    class="flex-1 py-3 rounded-xl neu-button text-[10px] font-black uppercase tracking-widest text-slate-500">Batal</button>
                <button id="modalConfirm"
                    class="flex-1 py-3 rounded-xl bg-red-500 text-white text-[10px] font-black uppercase tracking-widest shadow-[0_8px_15px_rgba(248,113,113,0.3)]">Lanjutkan</button>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal"
        class="fixed inset-0 z-[100] hidden items-center justify-center p-4 bg-slate-950/80 backdrop-blur-md transition-all duration-300">
        <div class="bg-slate-900/90 border border-white/10 rounded-[2.5rem] w-full max-w-lg p-8 neu-flat animate-pop">
            <h3 class="text-xl font-black uppercase tracking-widest text-white mb-6 italic shimmer-text">Pengaturan
                Pertandingan</h3>

            <div class="space-y-6">
                <div class="autocomplete-container">
                    <label class="block text-[8px] font-black uppercase tracking-[0.4em] text-white/30 mb-2 ml-1">Nama
                        Kelas / Kategori</label>
                    <input type="text" id="inputCategory" placeholder="Cari Kelas... (Contoh: Male Kumite)"
                        autocomplete="off" onfocus="showCategoryDropdown()" oninput="filterCategories(this.value)"
                        class="w-full bg-black/40 border border-white/10 rounded-2xl px-6 py-4 text-sm font-bold text-white focus:border-red-500/50 focus:bg-black/60 outline-none transition-all">

                    <div id="categoryDropdown" class="custom-scrollbar">
                        <!-- Items dynamically populated -->
                    </div>
                </div>

            </div>

            <div class="flex gap-4 mt-10">
                <button onclick="toggleSettingsModal()"
                    class="flex-1 py-4 rounded-xl neu-button text-[10px] font-black uppercase tracking-widest text-slate-500">Tutup</button>
                <button onclick="saveMatchSettings()"
                    class="flex-1 py-4 rounded-xl bg-red-600 text-white text-[10px] font-black uppercase tracking-widest shadow-[0_10px_20px_rgba(220,38,38,0.3)]">Simpan
                    Pengaturan</button>
            </div>
        </div>
    </div>

    <!-- JUDGE KEYPAD MODAL -->
    <div id="judgeKeypadModal"
        class="fixed inset-0 z-[110] hidden items-center justify-center p-4 bg-slate-950/90 backdrop-blur-xl transition-all duration-300">
        <div
            class="bg-slate-900/95 border border-white/10 rounded-[3rem] w-full max-w-4xl p-10 neu-flat overflow-hidden max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-start mb-8">
                <div>
                    <h3 class="text-2xl font-black uppercase tracking-widest text-white italic shimmer-text">Input Nilai
                        Kata</h3>
                    <p id="keypadSubtitle"
                        class="text-[10px] font-black uppercase tracking-[0.4em] text-slate-500 mt-2 italic">
                        AKA - JUDGE 1</p>
                </div>
                <button onclick="closeJudgeKeypad()"
                    class="w-12 h-12 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center text-slate-400 hover:text-white hover:bg-red-500/20 transition-all">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div id="keypadGrid" class="flex-1 overflow-y-auto pr-4 custom-scrollbar space-y-8">
                <!-- Keypad buttons will be generated here -->
            </div>
        </div>
    </div>

    <script type="module">
        import { rtdb, auth, db } from './js/firebase-init.js';
        import { handleLogout } from './js/auth-helpers.js';
        import { ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { collection, query, where, getDocs, orderBy, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { logActivity } from './js/activity-logger.js';
        import { broadcastScoreData } from './js/scoring-firebase.js';
        import { playBuzzer, playBeep, formatTime, resumeAudio } from './js/scoring-utils.js';
        import { GOLDEN_PRESETS, getNextSlot, ROUND_MATCH_IDS } from './js/bracket-utils.js';
        import { syncEngine } from './js/sync-engine.js';

        window.handleLogout = handleLogout;
        window.resumeAudio = resumeAudio;

        // Expose Firestore functions for participant list
        window.db = db;
        window.query = query;
        window.collection = collection;
        window.where = where;
        window.getDocs = getDocs;
        window.orderBy = orderBy;
        window.getDoc = getDoc;
        window.doc = doc;
        window.GOLDEN_PRESETS = GOLDEN_PRESETS;
        window.getNextSlot = getNextSlot;
        window.ROUND_MATCH_IDS = ROUND_MATCH_IDS;
        window.syncAll = () => syncEngine.syncAll();

        // Protect Route
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'login.html';
            }
        });

        // Initial theme logic was removed since we are now permanent dark mode.

        // --- LOGIKA KONSOL SCORING ---
        window.akaScore = 0;
        window.aoScore = 0;
        window.timeLeft = 60; // 1 menit (Default User)
        window.timerId = null;
        window.isTimerRunning = false;
        window.isTimerEnabled = true;
        window.penaltiesAka = { c1: false, c2: false, c3: false, hc: false, h: false };
        window.penaltiesAo = { c1: false, c2: false, c3: false, hc: false, h: false };
        window.currentTatami = 1;
        window.monitorWindow = null;
        window.nameAka = "";
        window.nameAo = "";
        window.teamAka = "";
        window.teamAo = "";
        window.slotAka = null;
        window.slotAo = null;
        window.matchCategory = "";
        window.activeKataPerformer = null;
        window.scoringMode = 'kumite'; // 'kumite' or 'kata'
        window.kataType = 'score'; // 'score' or 'flag'
        window.kataScoreAka = 0.0;
        window.kataScoreAo = 0.0;
        window.judgeScoresAka = [0.0, 0.0, 0.0, 0.0, 0.0];
        window.judgeScoresAo = [0.0, 0.0, 0.0, 0.0, 0.0];
        window.akaFlags = 0;
        window.aoFlags = 0;
        window.senshu = null; // 'aka', 'ao', or null
        window.isWinnerDeclared = false;
        window.winnerSide = null;
        window.showWinnerBanner = false;
        window.vrAka = false;
        window.vrAo = false;
        window.isHantei = false;
        window.isQueueVisible = true;

        // --- SOUND EFFECTS (using modular functions) ---
        window.playBuzzer = playBuzzer;
        window.playBeep = playBeep;

        // --- SEARCHABLE DROPDOWN LOGIC ---
        window.matchCategories = [];
        window.eventId = new URLSearchParams(window.location.search).get('id');

        window.loadMatchCategories = async function () {
            if (!window.eventId) {
                console.warn('[Scoring] No eventId found in URL. Autocomplete disabled.');
                return;
            }
            try {
                const q = query(collection(db, `events/${window.eventId}/classes`), orderBy("name", "asc"));
                const snap = await getDocs(q);
                window.matchCategories = snap.docs.map(doc => doc.data().name);
                console.log('[Scoring] Loaded categories:', window.matchCategories.length);
            } catch (err) {
                console.error('[Scoring] Error loading categories:', err);
            }
        };

        window.showCategoryDropdown = function () {
            const dropdown = document.getElementById('categoryDropdown');
            if (dropdown) dropdown.classList.add('active');
            window.filterCategories(document.getElementById('inputCategory').value);
        };

        window.filterCategories = function (queryText) {
            const dropdown = document.getElementById('categoryDropdown');
            if (!dropdown) return;

            const filtered = window.matchCategories.filter(cat =>
                cat.toLowerCase().includes(queryText.toLowerCase())
            );

            if (filtered.length === 0 && queryText === "") {
                dropdown.innerHTML = window.matchCategories.map(cat =>
                    `<div class="dropdown-item" onclick="selectCategory('${cat.replace(/'/g, "\\'")}')">${cat}</div>`
                ).join('');
            } else {
                dropdown.innerHTML = filtered.map(cat =>
                    `<div class="dropdown-item" onclick="selectCategory('${cat.replace(/'/g, "\\'")}')">${cat}</div>`
                ).join('');
            }

            dropdown.classList.toggle('active', filtered.length > 0 || (queryText === "" && window.matchCategories.length > 0));
        };

        window.selectCategory = function (name) {
            const input = document.getElementById('inputCategory');
            if (input) input.value = name;
            const dropdown = document.getElementById('categoryDropdown');
            if (dropdown) dropdown.classList.remove('active');
        };

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.autocomplete-container')) {
                const dropdown = document.getElementById('categoryDropdown');
                if (dropdown) dropdown.classList.remove('active');
            }
        });

        // Load data on init
        window.loadMatchCategories();
        if (window.updateKataListLink) window.updateKataListLink();

        window.broadcastData = function () {
            const scoreData = {
                akaScore: window.akaScore,
                aoScore: window.aoScore,
                timeLeft: window.timeLeft,
                timerText: document.getElementById('timerDisplay')?.value || '00:00',
                isTimerRunning: window.isTimerRunning,
                isTimerEnabled: window.isTimerEnabled,
                penaltiesAka: window.penaltiesAka,
                penaltiesAo: window.penaltiesAo,
                tatami: window.currentTatami,
                nameAka: window.nameAka,
                nameAo: window.nameAo,
                teamAka: window.teamAka,
                teamAo: window.teamAo,
                activeKataPerformer: window.activeKataPerformer,
                category: window.matchCategory,
                kataAka: document.getElementById('inputKataAka')?.value || '',
                kataAo: document.getElementById('inputKataAo')?.value || '',
                senshu: window.senshu,
                isAtoshiBaraku: window.timeLeft <= 15 && window.timeLeft > 0,
                isWinnerDeclared: window.isWinnerDeclared,
                winnerSide: window.winnerSide,
                vrAka: window.vrAka,
                vrAo: window.vrAo,
                isHantei: window.isHantei,
                scoringMode: window.scoringMode,
                kataType: window.kataType,
                kataScoreAka: window.kataScoreAka,
                kataScoreAo: window.kataScoreAo,
                judgeScoresAka: window.judgeScoresAka,
                judgeScoresAo: window.judgeScoresAo,
                akaFlags: window.akaFlags,
                aoFlags: window.aoFlags,
                showWinnerBanner: window.showWinnerBanner
            };

            // Trigger internal UI updates IMMEDIATELY (Optimistic UI)
            if (window.updateBroadcastUI) window.updateBroadcastUI();

            // Use modular Firebase function with a small throttle
            if (window._broadcastTimeout) {
                // If it's the SAME data recently, we might skip, but better just throttle
            }
            clearTimeout(window._broadcastTimeout);
            window._broadcastTimeout = setTimeout(() => {
                broadcastScoreData(scoreData)
                    .catch(err => console.error('[Scoring] Broadcast failed:', err));
            }, 50); // Slightly increased throttle for better batching
        };

        window.updateBroadcastUI = function () {
            window.updateConsoleWinnerUI();

            // Hantei Buttons visibility
            const btnHaka = document.getElementById('btnHanteiAka');
            const btnHao = document.getElementById('btnHanteiAo');
            if (btnHaka) btnHaka.classList.toggle('hidden', !window.isHantei);
            if (btnHao) btnHao.classList.toggle('hidden', !window.isHantei);

            // Update Performer Buttons with Names
            const akaBtn = document.getElementById('performerAkaBtn');
            const aoBtn = document.getElementById('performerAoBtn');
            if (akaBtn) akaBtn.innerText = window.nameAka ? window.nameAka.toUpperCase() : 'AKA';
            if (aoBtn) aoBtn.innerText = window.nameAo ? window.nameAo.toUpperCase() : 'AO';
        }

        window.updateConsoleWinnerUI = function () {
            const panelAka = document.getElementById('panelAka');
            const panelAo = document.getElementById('panelAo');
            const badgeAka = document.getElementById('badgeWinnerAka');
            const badgeAo = document.getElementById('badgeWinnerAo');

            if (panelAka) panelAka.classList.remove('winner-glow-aka');
            if (panelAo) panelAo.classList.remove('winner-glow-ao');
            if (badgeAka) badgeAka.classList.add('hidden');
            if (badgeAo) badgeAo.classList.add('hidden');

            if (window.isWinnerDeclared) {
                if (window.winnerSide === 'aka') {
                    if (panelAka) panelAka.classList.add('winner-glow-aka');
                    if (badgeAka) badgeAka.classList.remove('hidden');
                } else if (window.winnerSide === 'ao') {
                    if (panelAo) panelAo.classList.add('winner-glow-ao');
                    if (badgeAo) badgeAo.classList.remove('hidden');
                }
            }

            // Update Winner Selector Buttons with Names
            const winAkaBtn = document.getElementById('winAkaBtn');
            const winAoBtn = document.getElementById('winAoBtn');
            if (winAkaBtn) winAkaBtn.innerText = window.nameAka ? `WIN ${window.nameAka.toUpperCase()}` : 'WIN AKA';
            if (winAoBtn) winAoBtn.innerText = window.nameAo ? `WIN ${window.nameAo.toUpperCase()}` : 'WIN AO';

            const announceBtn = document.getElementById('btnAnnounceWinner');
            if (announceBtn) {
                announceBtn.classList.toggle('hidden', !window.isWinnerDeclared || window.showWinnerBanner);
            }
        }


        const initDashboard = () => {
            const urlParams = new URLSearchParams(window.location.search);
            window.currentTatami = urlParams.get('tatami') || 1;
            window.eventId = urlParams.get('id');
            const classParam = urlParams.get('class');

            if (document.getElementById('activeTatamiLabel')) {
                document.getElementById('activeTatamiLabel').innerText = `${window.currentTatami}`;
            }

            // Update Kata List links
            if (window.updateKataListLink) window.updateKataListLink();

            window.resetMatch();

            // Sync mode from URL
            const modeParam = urlParams.get('mode');
            if (modeParam === 'kata_score') {
                window.setScoringMode('kata');
                window.setKataType('score');
            } else if (modeParam === 'kata_flag') {
                window.setScoringMode('kata');
                window.setKataType('flag');
            } else {
                window.setScoringMode('kumite'); // Default
            }

            // Check loadMode parameter (declare once at function scope)
            const loadMode = urlParams.get('loadMode');

            // Sync Class from URL
            if (classParam) {
                const decodedClass = decodeURIComponent(classParam);
                window.matchCategory = decodedClass;
                const catDisplay = document.getElementById('categoryDisplay');
                if (catDisplay) catDisplay.innerText = decodedClass;
                const inputCat = document.getElementById('inputCategory');
                if (inputCat) inputCat.value = decodedClass;

                // NEW: Auto-load participants only if loadMode is 'auto' or not specified
                if (loadMode !== 'blank') {
                    setTimeout(() => {
                        window.autoLoadParticipants(decodedClass);
                    }, 1000);
                } else {
                    console.log('[Scoring] Blank mode selected - skipping auto-load');
                }
            }

            // Hide buttons if in blank mode
            if (loadMode === 'blank') {
                // Hide top bar buttons
                const btnParticipant = document.getElementById('btnParticipantList');
                const btnKataList = document.getElementById('btnKataList');
                if (btnParticipant) btnParticipant.style.display = 'none';
                if (btnKataList) btnKataList.style.display = 'none';

                // Hide athlete name displays (since no data loaded)
                const nameAkaDisplay = document.getElementById('nameAkaDisplay');
                const nameAoDisplay = document.getElementById('nameAoDisplay');
                if (nameAkaDisplay) nameAkaDisplay.style.display = 'none';
                if (nameAoDisplay) nameAoDisplay.style.display = 'none';

                // Hide kata input fields (not needed in blank mode)
                const inputKataAka = document.getElementById('inputKataAka');
                const inputKataAo = document.getElementById('inputKataAo');
                if (inputKataAka) inputKataAka.style.display = 'none';
                if (inputKataAo) inputKataAo.style.display = 'none';

                console.log('[Blank Mode] UI elements hidden: buttons, names, kata inputs');
            }

            // Restore panel layout preference
            const savedLayout = localStorage.getItem('panelLayout');
            if (savedLayout === 'flipped') {
                setTimeout(() => {
                    flipPanels(); // Apply flipped layout if previously saved
                    console.log('[Panel Layout] Restored flipped layout from localStorage');
                }, 100);
            }
        };

        window.autoLoadParticipants = async function (className) {
            console.log('[Scoring] Attempting to auto-load participants for:', className);
            await loadParticipants();

            if (participantListData.length > 0) {
                const firstMatch = participantListData[0];
                const aka = firstMatch.aka;
                const ao = firstMatch.ao;

                console.log('[Scoring] Auto-loading Match #1:', (aka?.name || 'BYE'), 'vs', (ao?.name || 'BYE'));

                if (aka && aka.name && aka.name !== '-') {
                    window.nameAka = aka.name;
                    window.teamAka = aka.team || '';
                    window.slotAka = aka.slotId;
                    const display = document.getElementById('nameAkaDisplay');
                    if (display) display.innerText = aka.name.toUpperCase();
                }

                if (ao && ao.name && ao.name !== '-') {
                    window.nameAo = ao.name;
                    window.teamAo = ao.team || '';
                    window.slotAo = ao.slotId;
                    const display = document.getElementById('nameAoDisplay');
                    if (display) display.innerText = ao.name.toUpperCase();
                }

                window.matchCategory = className;
                if (window.broadcastData) window.broadcastData();
            } else {
                console.log('[Scoring] No match data available for auto-load');
            }
        };

        window.setScoringMode = function (mode) {
            window.scoringMode = mode;
            const isKata = mode === 'kata';

            // UI Toggle Buttons with Safety
            const kumiteBtn = document.getElementById('modeKumiteBtn');
            const kataBtn = document.getElementById('modeKataBtn');
            const catDisplay = document.getElementById('categoryDisplay');
            const typeSwitch = document.getElementById('kataTypeSwitch');

            if (kumiteBtn) {
                kumiteBtn.classList.toggle('mode-active', !isKata);
                kumiteBtn.classList.toggle('text-slate-500', isKata);
            }
            if (kataBtn) {
                kataBtn.classList.toggle('mode-active', isKata);
                kataBtn.classList.toggle('text-slate-500', !isKata);
            }

            // Label Category
            if (catDisplay) catDisplay.innerText = isKata ? 'KATA' : 'KUMITE';

            // Sub-mode switch visibility
            if (typeSwitch) typeSwitch.classList.toggle('hidden', !isKata);

            // Control visibility logic
            window.updateControlPanels();

            // Timer toggle visibility
            const timerToggle = document.getElementById('timerToggleContainer');
            if (timerToggle) {
                timerToggle.classList.toggle('hidden', !isKata);
                if (!isKata) {
                    // Kumite always has timer enabled
                    window.toggleTimerSetting(true);
                    const switchInput = document.getElementById('timerEnableSwitch');
                    if (switchInput) switchInput.checked = true;
                }
            }

            // Penalty section hide in Kata
            const penAka = document.getElementById('penAka');
            const penAo = document.getElementById('penAo');
            if (penAka) penAka.classList.toggle('hidden', isKata);
            if (penAo) penAo.classList.toggle('hidden', isKata);

            // Update scores display based on mode
            const sAka = document.getElementById('scoreAka');
            const sAo = document.getElementById('scoreAo');

            if (isKata) {
                const iAka = document.getElementById('inputKataAka');
                const iAo = document.getElementById('inputKataAo');
                if (iAka) iAka.classList.remove('hidden');
                if (iAo) iAo.classList.remove('hidden');

                if (sAka && sAo) {
                    if (window.kataType === 'score') {
                        sAka.innerText = window.kataScoreAka.toFixed(1);
                        sAo.innerText = window.kataScoreAo.toFixed(1);
                    } else {
                        sAka.innerText = '--';
                        sAo.innerText = '--';
                    }
                    sAka.classList.add('text-6xl', 'md:text-[120px]');
                    sAo.classList.add('text-6xl', 'md:text-[120px]');
                    sAka.classList.remove('text-8xl', 'md:text-[180px]');
                    sAo.classList.remove('text-8xl', 'md:text-[180px]');
                }
            } else {
                const iAka = document.getElementById('inputKataAka');
                const iAo = document.getElementById('inputKataAo');
                if (iAka) iAka.classList.add('hidden');
                if (iAo) iAo.classList.add('hidden');

                if (sAka && sAo) {
                    sAka.innerText = window.akaScore.toString().padStart(2, '0');
                    sAo.innerText = window.aoScore.toString().padStart(2, '0');
                    sAka.classList.remove('text-6xl', 'md:text-8xl');
                    sAo.classList.remove('text-6xl', 'md:text-8xl');
                    sAka.classList.add('text-8xl', 'md:text-[180px]');
                    sAo.classList.add('text-8xl', 'md:text-[180px]');
                }
            }

            window.broadcastData();
        }

        window.setKataType = function (type) {
            window.kataType = type;
            const isFlag = type === 'flag';

            document.getElementById('kataTypeScoreBtn').classList.toggle('mode-active', !isFlag);
            document.getElementById('kataTypeScoreBtn').classList.toggle('text-slate-500', isFlag);
            document.getElementById('kataTypeFlagBtn').classList.toggle('mode-active', isFlag);
            document.getElementById('kataTypeFlagBtn').classList.toggle('text-slate-500', !isFlag);

            window.updateControlPanels();

            // Refresh display
            if (window.scoringMode === 'kata') {
                if (isFlag) {
                    document.getElementById('scoreAka').innerText = window.isWinnerDeclared ? window.akaFlags : '--';
                    document.getElementById('scoreAo').innerText = window.isWinnerDeclared ? window.aoFlags : '--';
                } else {
                    document.getElementById('scoreAka').innerText = window.kataScoreAka.toFixed(1);
                    document.getElementById('scoreAo').innerText = window.kataScoreAo.toFixed(1);
                }
            }

            window.broadcastData();
        }

        window.updateControlPanels = function () {
            const isKata = window.scoringMode === 'kata';
            const isFlag = window.kataType === 'flag';

            // Performer & Winner Selector Visibility
            const perfSelector = document.getElementById('performerSelector');
            const winSelector = document.getElementById('kataWinnerSelector');
            if (perfSelector) {
                perfSelector.classList.toggle('hidden', !isKata || !window.isTimerEnabled);
            }
            if (winSelector) {
                winSelector.classList.toggle('hidden', !isKata || isFlag);
            }

            // Aka Panels
            document.getElementById('kumiteControlsAka').classList.toggle('hidden', isKata);
            document.getElementById('kataControlsAka').classList.toggle('hidden', !isKata || isFlag);
            const flagControlsAka = document.getElementById('kataFlagControlsAka');
            if (flagControlsAka) flagControlsAka.classList.toggle('hidden', !isKata || !isFlag);

            // Ao Panels
            document.getElementById('kumiteControlsAo').classList.toggle('hidden', isKata);
            document.getElementById('kataControlsAo').classList.toggle('hidden', !isKata || isFlag);
            const flagControlsAo = document.getElementById('kataFlagControlsAo');
            if (flagControlsAo) flagControlsAo.classList.toggle('hidden', !isKata || !isFlag);
        }

        // Kata Shortcut List (WKF Standard Alphabetical)
        const WKF_KATA_LIST = {
            "1": "ANAN", "2": "ANAN DAI", "3": "ANANKO", "4": "ANNUN", "5": "AOYAGI",
            "6": "BASSAI DAI", "7": "BASSAI SHO", "8": "CHATANYARA KUSHANKU", "9": "CHINTO", "10": "CHINTE",
            "11": "EMPI", "12": "GANKAKU", "13": "GARYU", "14": "GEKISAI DAI ICHI", "15": "GEKISAI DAI NI",
            "16": "GOJUSHIHO DAI", "17": "GOJUSHIHO SHO", "18": "HAFFA", "19": "HAKKAKU", "20": "HANGETSU",
            "21": "HEIAN SHODAN", "22": "HEIAN NIDAN", "23": "HEIAN SANDAN", "24": "HEIAN YONDAN", "25": "HEIAN GODAN",
            "26": "HEIKU", "27": "ISHINE", "28": "ITOSU ROHAI SHODAN", "29": "ITOSU ROHAI NIDAN", "30": "ITOSU ROHAI SANDAN",
            "31": "JIIN", "32": "JION", "33": "JITTE", "34": "JUROKU", "35": "KANKU DAI",
            "36": "KANKU SHO", "37": "KANSHU", "38": "KOPPO", "39": "KOSOKUN DAI", "40": "KOSOKUN SHO",
            "41": "KOSOKUN SHIHO", "42": "KURURUNFA", "43": "KUSHANKU", "44": "MATSUKAZE", "45": "MATSUMURA BASSAI",
            "46": "MATSUMURA ROHAI", "47": "MEIKYO", "48": "MYOJO", "49": "NAIHANCHI SHODAN", "50": "NAIHANCHI NIDAN",
            "51": "NAIHANCHI SANDAN", "52": "NIPAIPO", "53": "NISEISHI", "54": "NIJUSHIHO", "55": "PAIKU",
            "56": "PAPUREN", "57": "PASSAI", "58": "PINAN SHODAN", "59": "PINAN NIDAN", "60": "PINAN SANDAN",
            "61": "PINAN YONDAN", "62": "PINAN GODAN", "63": "ROHAI", "64": "SAIFA", "65": "SANCHIN",
            "66": "SANSEIRU", "67": "SEICHIN", "68": "SEIENCHIN", "69": "SEIPAI", "70": "SEISAN",
            "71": "SEISHAN", "72": "SEIYUNCHIN", "73": "SHIHO KOSOKUN", "74": "SHISOCHIN", "75": "SOCHIN",
            "76": "SUPARINPEI", "77": "TENSHO", "78": "TOMARI BASSAI", "79": "UNSU", "80": "UNSHU",
            "81": "WANKAN", "82": "WANSHU"
        };

        window.checkKataShortcut = function (input) {
            const val = input.value.trim();
            if (WKF_KATA_LIST[val]) {
                input.value = WKF_KATA_LIST[val];
                if (input.id === 'inputKataAka') window.kataAka = input.value;
                if (input.id === 'inputKataAo') window.kataAo = input.value;
                if (window.broadcastData) window.broadcastData();
            }
        };

        // Kata Flag voting functions
        window.setKataFlagsAka = function (count) {
            window.akaFlags = count;
            window.aoFlags = 5 - count;

            // Update button styles
            document.querySelectorAll('.flag-btn-aka').forEach(btn => {
                const val = parseInt(btn.dataset.val);
                btn.classList.toggle('bg-red-500', val === count);
                btn.classList.toggle('text-white', val === count);
                btn.classList.toggle('bg-white/5', val !== count);
                btn.classList.toggle('text-red-500', val !== count);
            });
            document.querySelectorAll('.flag-btn-ao').forEach(btn => {
                const val = parseInt(btn.dataset.val);
                const aoVal = 5 - count;
                btn.classList.toggle('bg-blue-500', val === aoVal);
                btn.classList.toggle('text-white', val === aoVal);
                btn.classList.toggle('bg-white/5', val !== aoVal);
                btn.classList.toggle('text-blue-500', val !== aoVal);
            });

            // Determine winner
            window.isWinnerDeclared = true;
            if (count > 2.5) window.winnerSide = 'aka';
            else if (count < 2.5) window.winnerSide = 'ao';
            else window.winnerSide = 'draw';

            // Update score display
            document.getElementById('scoreAka').innerText = count;
            document.getElementById('scoreAo').innerText = 5 - count;

            window.broadcastData();
        }

        window.setKataFlagsAo = function (count) {
            window.aoFlags = count;
            window.akaFlags = 5 - count;

            // Update button styles
            document.querySelectorAll('.flag-btn-ao').forEach(btn => {
                const val = parseInt(btn.dataset.val);
                btn.classList.toggle('bg-blue-500', val === count);
                btn.classList.toggle('text-white', val === count);
                btn.classList.toggle('bg-white/5', val !== count);
                btn.classList.toggle('text-blue-500', val !== count);
            });
            document.querySelectorAll('.flag-btn-aka').forEach(btn => {
                const val = parseInt(btn.dataset.val);
                const akaVal = 5 - count;
                btn.classList.toggle('bg-red-500', val === akaVal);
                btn.classList.toggle('text-white', val === akaVal);
                btn.classList.toggle('bg-white/5', val !== akaVal);
                btn.classList.toggle('text-red-500', val !== akaVal);
            });

            // Determine winner
            window.isWinnerDeclared = true;
            if (count > 2.5) window.winnerSide = 'ao';
            else if (count < 2.5) window.winnerSide = 'aka';
            else window.winnerSide = 'draw';

            // Update score display
            document.getElementById('scoreAka').innerText = 5 - count;
            document.getElementById('scoreAo').innerText = count;

            window.broadcastData();
        }

        window.updateKataJudgeScore = function (side, index, value) {
            const val = parseFloat(value) || 0.0;
            if (side === 'aka') {
                window.judgeScoresAka[index] = val;
                window.kataScoreAka = window.calculateKataTotal('aka', window.judgeScoresAka);
                document.getElementById('judgeBtnAka' + index).innerText = val.toFixed(1);
                document.getElementById('kataTotalAka').innerText = window.kataScoreAka.toFixed(1);
                document.getElementById('scoreAka').innerText = window.kataScoreAka.toFixed(1);
            } else {
                window.judgeScoresAo[index] = val;
                window.kataScoreAo = window.calculateKataTotal('ao', window.judgeScoresAo);
                document.getElementById('judgeBtnAo' + index).innerText = val.toFixed(1);
                document.getElementById('kataTotalAo').innerText = window.kataScoreAo.toFixed(1);
                document.getElementById('scoreAo').innerText = window.kataScoreAo.toFixed(1);
            }
            window.broadcastData();
        }

        window.calculateKataTotal = function (side, scores) {
            // Find all indices that have a non-zero value
            const validIndices = scores.map((s, i) => ({ val: s, idx: i }));

            // Sort by value
            const sorted = [...validIndices].sort((a, b) => a.val - b.val);

            // Per WKF: Drop 1 highest and 1 lowest for 5 judges
            // For 7 judges, it would be 2 highest and 2 lowest.
            // Our current UI has 5 judge slots.

            const discardedIndices = [];
            if (sorted.length >= 3) {
                discardedIndices.push(sorted[0].idx); // Lowest
                discardedIndices.push(sorted[sorted.length - 1].idx); // Highest
            }

            // Calculate total from those not discarded
            let total = 0;
            const remaining = sorted.filter(item => !discardedIndices.includes(item.idx));
            total = remaining.reduce((sum, item) => sum + item.val, 0);

            // Update UI with marks
            for (let i = 0; i < scores.length; i++) {
                const btnId = `judgeBtn${side.charAt(0).toUpperCase() + side.slice(1)}${i}`;
                const btn = document.getElementById(btnId);
                if (btn) {
                    if (discardedIndices.includes(i) && scores[i] > 0) {
                        btn.classList.add('kata-discarded');
                    } else {
                        btn.classList.remove('kata-discarded');
                    }
                }
            }

            return parseFloat(total.toFixed(1));
        }


        window.toggleQueueVisibility = function () {
            window.isQueueVisible = !window.isQueueVisible;
            const mainArea = document.getElementById('scoringMainArea');
            const sidebar = document.getElementById('queueSidebarArea');
            const iconShow = document.getElementById('queueIconShow');
            const iconHide = document.getElementById('queueIconHide');

            if (window.isQueueVisible) {
                if (mainArea.classList.contains('col-span-12')) mainArea.classList.replace('col-span-12', 'col-span-9');
                if (sidebar) sidebar.classList.remove('hidden');
                if (iconShow) iconShow.classList.remove('hidden');
                if (iconHide) iconHide.classList.add('hidden');
            } else {
                if (mainArea.classList.contains('col-span-9')) mainArea.classList.replace('col-span-9', 'col-span-12');
                if (sidebar) sidebar.classList.add('hidden');
                if (iconShow) iconShow.classList.add('hidden');
                if (iconHide) iconHide.classList.remove('hidden');
            }
        };

        window.addScore = function (side, amount) {
            if (window.scoringMode === 'kata') return;

            if (side === 'aka') {
                window.akaScore = Math.max(0, window.akaScore + amount);
                document.getElementById('scoreAka').innerText = window.akaScore.toString().padStart(2, '0');
                window.animateScore(document.getElementById('scoreAka'));

                // Track Score Activity
                const detail = amount > 0 ? `AKA +${amount}` : `AKA -${Math.abs(amount)}`;
                logActivity("Update Skor", detail, window.currentTatami);
            } else {
                window.aoScore = Math.max(0, window.aoScore + amount);
                document.getElementById('scoreAo').innerText = window.aoScore.toString().padStart(2, '0');
                window.animateScore(document.getElementById('scoreAo'));

                // Track Score Activity
                const detail = amount > 0 ? `AO +${amount}` : `AO -${Math.abs(amount)}`;
                logActivity("Update Skor", detail, window.currentTatami);
            }

            // WKF RULE: 8 Point Gap (Kachi)
            if (Math.abs(window.akaScore - window.aoScore) >= 8) {
                window.isWinnerDeclared = true;
                window.winnerSide = window.akaScore > window.aoScore ? 'aka' : 'ao';

                // Track Winner Activity
                const winnerName = window.winnerSide === 'aka' ? window.nameAka : window.nameAo;
                logActivity("Pemenang Dinyatakan", `${window.winnerSide.toUpperCase()} (${winnerName}) menang selisih poin.`, window.currentTatami);

                window.isTimerRunning = false;
                if (window.timerId) clearInterval(window.timerId);
                window.playBuzzer();
            }

            window.broadcastData();
        }

        window.toggleVR = function (side) {
            if (side === 'aka') window.vrAka = !window.vrAka;
            else window.vrAo = !window.vrAo;

            const btnId = `vr${side.charAt(0).toUpperCase() + side.slice(1)}`;
            const isActive = side === 'aka' ? window.vrAka : window.vrAo;

            document.getElementById(btnId).className = isActive ?
                "py-3 rounded-lg neu-button text-[10px] font-black text-yellow-400 bg-yellow-400/20 border-yellow-400/50" :
                "py-3 rounded-lg neu-button text-[10px] font-black opacity-50 text-yellow-500 transition-all hover:opacity-100";

            window.broadcastData();
        }

        window.animateScore = function (el) {
            el.classList.add('scale-125', 'brightness-150');
            setTimeout(() => el.classList.remove('scale-125', 'brightness-150'), 200);
        }

        window.setSenshu = function (side) {
            if (window.senshu === side) window.senshu = null;
            else window.senshu = side;

            // Update UI
            document.getElementById('senshuAka').className = window.senshu === 'aka' ?
                "py-3 rounded-lg bg-red-600 text-white text-[10px] font-black shadow-[0_0_20px_rgba(220,38,38,0.5)] border-white/20" :
                "py-3 rounded-lg neu-button text-[10px] font-black opacity-70 hover:opacity-100 transition-opacity";

            document.getElementById('senshuAo').className = window.senshu === 'ao' ?
                "py-3 rounded-lg bg-blue-600 text-white text-[10px] font-black shadow-[0_0_20px_rgba(37,99,235,0.5)] border-white/20" :
                "py-3 rounded-lg neu-button text-[10px] font-black opacity-70 hover:opacity-100 transition-opacity";

            window.broadcastData();
        }

        window.setKataPerformer = function (side) {
            if (window.activeKataPerformer === side) {
                window.activeKataPerformer = null;
            } else {
                window.activeKataPerformer = side;
            }

            const akaBtn = document.getElementById('performerAkaBtn');
            const aoBtn = document.getElementById('performerAoBtn');

            if (window.activeKataPerformer === 'aka') {
                akaBtn.classList.add('mode-active', 'bg-red-600/20', 'text-red-500', 'border-red-500/30');
                akaBtn.classList.remove('text-slate-500');
                aoBtn.classList.remove('mode-active', 'bg-blue-600/20', 'text-blue-500', 'border-blue-500/30');
                aoBtn.classList.add('text-slate-500');
            } else if (window.activeKataPerformer === 'ao') {
                aoBtn.classList.add('mode-active', 'bg-blue-600/20', 'text-blue-500', 'border-blue-500/30');
                aoBtn.classList.remove('text-slate-500');
                akaBtn.classList.remove('mode-active', 'bg-red-600/20', 'text-red-500', 'border-red-500/30');
                akaBtn.classList.add('text-slate-500');
            } else {
                akaBtn.classList.remove('mode-active', 'bg-red-600/20', 'text-red-500', 'border-red-500/30');
                akaBtn.classList.add('text-slate-500');
                aoBtn.classList.remove('mode-active', 'bg-blue-600/20', 'text-blue-500', 'border-blue-500/30');
                aoBtn.classList.add('text-slate-500');
            }

            window.broadcastData();
        };

        window.declareKataWinner = async function (side) {
            window.isWinnerDeclared = true;
            window.winnerSide = side;
            window.showWinnerBanner = true;
            window.broadcastData();
            window.updateConsoleWinnerUI();

            // Auto-save to database
            console.log(`[Winner] ${side.toUpperCase()} declared as winner, saving to database...`);

            const winnerName = side === 'aka' ? window.nameAka : window.nameAo;
            const winnerTeam = side === 'aka' ? window.teamAka : window.teamAo;
            const winnerSlot = side === 'aka' ? window.slotAka : window.slotAo;
            const winnerKata = side === 'aka' ? window.kataNameAka : window.kataNameAo;
            const winnerScore = side === 'aka' ? window.scoreAka : window.scoreAo;

            const loserName = side === 'aka' ? window.nameAo : window.nameAka;
            const loserTeam = side === 'aka' ? window.teamAo : window.teamAka;
            const loserSlot = side === 'aka' ? window.slotAo : window.slotAka;
            const loserKata = side === 'aka' ? window.kataNameAo : window.kataNameAka;
            const loserScore = side === 'aka' ? window.scoreAo : window.scoreAka;

            // Calculate next slot for auto-progression
            let nextSlot = null;
            if (winnerSlot && typeof getNextSlot === 'function') {
                nextSlot = getNextSlot(winnerSlot);
                console.log(`[Auto-Progression] Winner ${winnerName}  Next Slot: ${nextSlot}`);
            }

            const matchData = {
                eventId: eventId,
                category: window.matchCategory || selectedClass,
                tatami: tatamiNumber,
                winner: winnerName,
                winnerTeam: winnerTeam,
                nextSlot: nextSlot,
                aka: {
                    name: window.nameAka,
                    team: window.teamAka,
                    kata: window.kataNameAka,
                    score: window.scoreAka,
                    slotId: window.slotAka
                },
                ao: {
                    name: window.nameAo,
                    team: window.teamAo,
                    kata: window.kataNameAo,
                    score: window.scoreAo,
                    slotId: window.slotAo
                },
                timestamp: Date.now()
            };

            // Save to IndexedDB via syncEngine
            if (syncEngine) {
                await syncEngine.save(matchData);
                console.log('[Winner] Match data saved to local database, will sync to Cloud soon.');
            } else {
                console.error('[Winner] SyncEngine not available!');
            }
        };

        // FLIP PANELS FUNCTION - Swap AKA and AO positions
        window.flipPanels = function () {
            const panelAka = document.getElementById('panelContainerAka');
            const panelAo = document.getElementById('panelContainerAo');

            if (!panelAka || !panelAo) return;

            // Get current orders
            const currentAkaOrder = parseInt(getComputedStyle(panelAka).order) || 3;
            const currentAoOrder = parseInt(getComputedStyle(panelAo).order) || 1;

            // Swap orders
            panelAka.style.order = currentAoOrder;
            panelAo.style.order = currentAkaOrder;

            console.log(`[Panel Flip] AKA now at order ${currentAoOrder}, AO now at order ${currentAkaOrder}`);

            // Optional: Store preference in localStorage
            localStorage.setItem('panelLayout', currentAkaOrder === 3 ? 'flipped' : 'default');
        };

        window.toggleTimerSetting = function (enabled) {
            window.isTimerEnabled = enabled;
            const display = document.getElementById('timerDisplay');
            const toggleStatus = document.getElementById('timerToggleStatus');
            const timerControls = document.getElementById('btnTimerControl').parentElement;

            if (display) {
                display.style.opacity = enabled ? '1' : '0.15';
                display.style.filter = enabled ? 'none' : 'grayscale(1)';
            }
            if (toggleStatus) {
                toggleStatus.classList.toggle('bg-red-500', enabled);
                toggleStatus.classList.toggle('bg-slate-600', !enabled);
                toggleStatus.classList.toggle('shadow-[0_0_8px_rgba(239,68,68,0.5)]', enabled);
            }
            if (timerControls) {
                timerControls.style.opacity = enabled ? '1' : '0.3';
                timerControls.style.pointerEvents = enabled ? 'auto' : 'none';
            }

            window.broadcastData();
        };

        window.toggleTimer = function () {
            if (typeof resumeAudio === 'function') resumeAudio();

            if (!window.isTimerEnabled) {
                alert("Timer saat ini dinonaktifkan dalam pengaturan.");
                return;
            }

            const btn = document.getElementById('btnTimerControl');
            const dot = document.getElementById('timerStatusDot');
            const label = document.getElementById('timerLabel');

            if (window.isTimerRunning) {
                if (window.timerId) clearInterval(window.timerId);
                window.isTimerRunning = false;
                btn.innerText = 'RESUME MATCH';
                btn.classList.replace('bg-red-500', 'bg-slate-700');
                dot.classList.replace('bg-green-500', 'bg-yellow-500');
                label.innerText = 'MATCH DIHENTIKAN';
                label.classList.replace('text-green-500', 'text-yellow-500');
            } else {
                // Enforce performer selection in Kata mode when starting
                if (window.scoringMode === 'kata' && !window.activeKataPerformer) {
                    alert("HARAP PILIH PENAMPIL (AKA / AO) TERLEBIH DAHULU!");
                    return;
                }

                window.timerId = setInterval(window.updateTimer, 1000);
                window.isTimerRunning = true;
                btn.innerText = 'PAUSE MATCH';
                btn.classList.add('bg-slate-700');
                dot.classList.replace('bg-slate-600', 'bg-green-500');
                dot.classList.replace('bg-yellow-500', 'bg-green-500');
                label.innerText = 'PERTANDINGAN BERJALAN';
                label.classList.replace('text-slate-500', 'text-green-500');
                label.classList.replace('text-yellow-500', 'text-green-500');
                dot.classList.add('pulse-red');
            }
            window.broadcastData();
        }

        window.updateTimer = async function () {
            if (window.timeLeft <= 0) {
                if (window.timerId) clearInterval(window.timerId);
                window.isTimerRunning = false;
                window.playBuzzer();

                // Declare winner automatically based on score
                window.isWinnerDeclared = true;
                if (window.akaScore > window.aoScore) window.winnerSide = 'aka';
                else if (window.aoScore > window.akaScore) window.winnerSide = 'ao';
                else if (window.senshu) window.winnerSide = window.senshu;
                else {
                    window.winnerSide = 'draw';
                    window.isHantei = true;
                }

                await window.broadcastData();
                return;
            }
            window.timeLeft--;
            if (window.timeLeft === 15) window.playBeep();

            const mins = Math.floor(window.timeLeft / 60);
            const secs = window.timeLeft % 60;
            const display = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            document.getElementById('timerDisplay').value = display;

            await window.broadcastData();
        }

        window.adjustTimer = function (secs) {
            if (window.isTimerRunning) return;
            window.timeLeft = Math.max(0, window.timeLeft + secs);
            const minsDisplay = Math.floor(window.timeLeft / 60);
            const secsDisplay = window.timeLeft % 60;
            document.getElementById('timerDisplay').value = `${minsDisplay.toString().padStart(2, '0')}:${secsDisplay.toString().padStart(2, '0')}`;
            window.broadcastData();
        }

        window.showCustomConfirm = function (title, message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                const titleEl = document.getElementById('modalTitle');
                const msgEl = document.getElementById('modalMessage');
                const btnConfirm = document.getElementById('modalConfirm');
                const btnCancel = document.getElementById('modalCancel');

                titleEl.innerText = title;
                msgEl.innerText = message;
                modal.style.display = 'flex';

                const close = (result) => {
                    modal.style.display = 'none';
                    resolve(result);
                };

                btnConfirm.onclick = () => close(true);
                btnCancel.onclick = () => close(false);
                modal.onclick = (e) => { if (e.target === modal) close(false); };
            });
        }

        window.loadMatch = async function (aka, ao, category, round, teamAka = "", teamAo = "") {
            const confirmed = await showCustomConfirm(
                'GANTI PERTANDINGAN?',
                `Tandandingkan: ${aka.toUpperCase()} VS ${ao.toUpperCase()}\nKategori: ${category.toUpperCase()}`
            );

            if (!confirmed) return;

            resetMatch();
            window.nameAka = aka;
            window.nameAo = ao;
            window.teamAka = teamAka;
            window.teamAo = teamAo;
            window.matchCategory = category;
            window.matchRound = round;

            document.getElementById('nameAkaDisplay').innerText = aka.toUpperCase();
            document.getElementById('nameAoDisplay').innerText = ao.toUpperCase();
            document.getElementById('categoryDisplay').innerText = category.split(' ')[0].toUpperCase();
            document.getElementById('roundDisplay').innerText = round.toUpperCase();

            broadcastData();
        }

        window.setHanteiWinner = async function (side) {
            window.isWinnerDeclared = true;
            window.winnerSide = side;
            window.isHantei = false; // Reset Hantei state so winner banner can show

            // Track Hantei Activity
            const winnerName = side === 'aka' ? window.nameAka : window.nameAo;
            logActivity("Pemenang Hantei", `${side.toUpperCase()} (${winnerName}) menang keputusan wasit.`, window.currentTatami);

            window.broadcastData();
        }

        window.togglePenalty = async function (side, level) {
            const penalties = side === 'aka' ? window.penaltiesAka : window.penaltiesAo;
            penalties[level] = !penalties[level];

            // Track Penalty Activity
            const status = penalties[level] ? "DIBERIKAN" : "DICABUT";
            logActivity("Pelanggaran", `${side.toUpperCase()} ${level.toUpperCase()} ${status}`, window.currentTatami);

            // WKF RULE: Senshu is withdrawn if the athlete receives a C2 penalty
            if (level === 'c2' && penalties[level] && window.senshu === side) {
                window.senshu = null;
                const panel = side === 'aka' ? 'senshuAka' : 'senshuAo';
                document.getElementById(panel).className = "py-2 rounded-lg neu-button text-[9px] font-black opacity-40";
            }

            // Update Label/Button di UI Terpadu
            const btn = document.getElementById(`${side}_${level}`);

            if (penalties[level]) {
                btn.classList.remove('opacity-30', 'bg-black/40', 'border-white/5');
                btn.classList.add('opacity-100', 'text-white', 'shadow-lg');

                // Color mapping
                if (level.startsWith('c')) {
                    btn.classList.add('bg-yellow-500', 'border-yellow-400');
                } else if (level === 'hc') {
                    btn.classList.add('bg-orange-600', 'border-orange-500');
                } else if (level === 'h') {
                    btn.classList.add('bg-red-600', 'border-red-500');
                }
            } else {
                btn.classList.add('opacity-60', 'bg-black/40', 'border-white/5');
                btn.classList.remove('opacity-100', 'text-white', 'shadow-lg', 'bg-yellow-500', 'border-yellow-400', 'bg-orange-600', 'border-orange-500', 'bg-red-600', 'border-red-500');
            }
            window.broadcastData();
        }

        window.resetMatch = async function () {
            // Track Reset Activity
            if (window.akaScore > 0 || window.aoScore > 0) {
                logActivity("Reset Pertandingan", "Membersihkan skor dan timer untuk pertandingan baru.", window.currentTatami);
            }

            if (window.timerId) clearInterval(window.timerId);
            window.isTimerRunning = false;
            window.akaScore = 0;
            window.aoScore = 0;
            window.timeLeft = 60; // 01:00 corresponds to 60 seconds
            window.kataScoreAka = 0.0;
            window.kataScoreAo = 0.0;
            window.judgeScoresAka = [0.0, 0.0, 0.0, 0.0, 0.0];
            window.judgeScoresAo = [0.0, 0.0, 0.0, 0.0, 0.0];
            window.akaFlags = 0;
            window.aoFlags = 0;
            window.senshu = null;
            window.isWinnerDeclared = false;
            window.winnerSide = null;
            window.showWinnerBanner = false;
            window.vrAka = false;
            window.vrAo = false;
            window.isHantei = false;
            window.setKataPerformer(null);
            window.penaltiesAka = { c1: false, c2: false, c3: false, hc: false, h: false };
            window.penaltiesAo = { c1: false, c2: false, c3: false, hc: false, h: false };

            document.getElementById('timerDisplay').value = '01:00';
            document.getElementById('inputKataAka').value = '';
            document.getElementById('inputKataAo').value = '';

            // Mode-specific Score Reset
            if (window.scoringMode === 'kumite') {
                document.getElementById('scoreAka').innerText = '00';
                document.getElementById('scoreAo').innerText = '00';
            } else if (window.kataType === 'score') {
                document.getElementById('scoreAka').innerText = '0.0';
                document.getElementById('scoreAo').innerText = '0.0';
            } else {
                document.getElementById('scoreAka').innerText = '--';
                document.getElementById('scoreAo').innerText = '--';
            }

            // Reset Kata Judge Buttons & Totals
            for (let i = 0; i < 5; i++) {
                const bAka = document.getElementById('judgeBtnAka' + i);
                const bAo = document.getElementById('judgeBtnAo' + i);
                if (bAka) bAka.innerText = '0.0';
                if (bAo) bAo.innerText = '0.0';
            }
            if (document.getElementById('kataTotalAka')) document.getElementById('kataTotalAka').innerText = '0.0';
            if (document.getElementById('kataTotalAo')) document.getElementById('kataTotalAo').innerText = '0.0';

            // Clear Flag Button Highlights
            document.querySelectorAll('.flag-btn').forEach(btn => {
                btn.classList.remove('bg-red-600', 'text-white');
                btn.classList.add('bg-white/5', 'text-red-500');
            });

            // Reset UI Terpadu AKA/AO
            ['aka', 'ao'].forEach(side => {
                document.getElementById(`senshu${side.charAt(0).toUpperCase() + side.slice(1)}`).className = "py-3 rounded-lg neu-button text-[10px] font-black opacity-70 hover:opacity-100 transition-opacity";
                document.getElementById(`vr${side.charAt(0).toUpperCase() + side.slice(1)}`).className = "py-3 rounded-lg neu-button text-[10px] font-black opacity-50 text-yellow-500 transition-all hover:opacity-100";

                ['c1', 'c2', 'c3', 'hc', 'h'].forEach(level => {
                    const btn = document.getElementById(`${side}_${level}`);
                    if (btn) {
                        btn.classList.add('opacity-60', 'bg-black/40', 'border-white/5');
                        btn.classList.remove('opacity-100', 'text-white', 'shadow-lg', 'bg-yellow-500', 'border-yellow-400', 'bg-orange-600', 'border-orange-500', 'bg-red-600', 'border-red-500');
                    }
                });
            });

            document.getElementById('btnTimerControl').innerText = 'START MATCH';
            document.getElementById('btnTimerControl').classList.remove('bg-slate-700');
            document.getElementById('btnTimerControl').classList.add('bg-red-500');

            const dot = document.getElementById('timerStatusDot');
            const label = document.getElementById('timerLabel');
            dot.className = "w-2.5 h-2.5 rounded-full bg-slate-600";
            label.className = "text-[9px] font-black uppercase tracking-widest text-slate-500 whitespace-nowrap";
            label.innerText = 'SIAP BERTANDING';
            window.broadcastData(); // Call broadcastData to update monitor and UI
            window.updateConsoleWinnerUI(); // Ensure winner badges are hidden
        }

        window.announceWinner = function () {
            window.showWinnerBanner = true;
            window.broadcastData();
        }

        window.handleMonitor = function () {
            if (window.monitorWindow && !window.monitorWindow.closed) {
                window.monitorWindow.close();
                window.monitorWindow = null;
                window.updateMonitorUI();
            } else {
                window.monitorWindow = window.open(`scoring-monitor.html?tatami=${window.currentTatami}`, 'ScoringMonitor', 'width=1200,height=800');
                window.updateMonitorUI();
            }
        }

        window.toggleSettingsModal = function () {
            const modal = document.getElementById('settingsModal');
            if (modal.classList.contains('hidden')) {
                // Populate inputs with current values
                document.getElementById('inputCategory').value = window.matchCategory || '';

                modal.classList.replace('hidden', 'flex');
                setTimeout(() => modal.classList.add('opacity-100'), 10);
            } else {
                modal.classList.remove('opacity-100');
                setTimeout(() => modal.classList.replace('flex', 'hidden'), 300);
            }
        }

        window.saveMatchSettings = function () {
            const newCategory = document.getElementById('inputCategory').value.trim();
            window.matchCategory = newCategory;

            // Update UI Labels
            if (document.getElementById('categoryDisplay')) {
                document.getElementById('categoryDisplay').innerText = newCategory || '---';
            }

            window.broadcastData();
            if (window.updateKataListLink) window.updateKataListLink();
            window.toggleSettingsModal();
        }

        window.updateKataListLink = function () {
            const link = document.getElementById('kataListLink');
            if (link && window.eventId) {
                let href = `kata-list.html?id=${window.eventId}`;
                if (window.matchCategory) {
                    href += `&class=${encodeURIComponent(window.matchCategory)}`;
                }
                link.href = href;
            }
        };

        window.toggleMonitorFullscreen = function () {
            localStorage.setItem('karate_display_command', JSON.stringify({
                type: 'toggleFullscreen',
                timestamp: Date.now()
            }));
        }


        window.updateMonitorUI = function () {
            const btn = document.getElementById('btnMonitor');
            const fsBtn = document.getElementById('btnFullscreen');
            if (window.monitorWindow && !window.monitorWindow.closed) {
                if (btn) {
                    btn.classList.replace('bg-blue-600/20', 'bg-red-600/20');
                    btn.classList.replace('text-blue-400', 'text-red-400');
                    btn.classList.replace('border-blue-500/30', 'border-red-500/30');
                    btn.title = "Close Monitor";
                }
                if (fsBtn) fsBtn.classList.remove('hidden');
            } else {
                if (btn) {
                    btn.classList.replace('bg-red-600/20', 'bg-blue-600/20');
                    btn.classList.replace('text-red-400', 'text-blue-400');
                    btn.classList.replace('border-red-500/30', 'border-blue-500/30');
                    btn.title = "Open Monitor";
                }
                if (fsBtn) fsBtn.classList.add('hidden');
            }
        }

        // Check monitor window state periodically
        setInterval(() => {
            if (monitorWindow && monitorWindow.closed) {
                monitorWindow = null;
                updateMonitorUI();
            }
        }, 1000);

        window.finishMatch = async function () {
            // Jika pemenang sudah ditentukan (oleh skor, Kachi, atau Hantei),
            // tombol ini berfungsi untuk membersihkan papan skor dan lanjut ke match berikutnya.
            if (window.isWinnerDeclared) {
                const confirmed = await window.showCustomConfirm(
                    'PERTANDINGAN BERIKUTNYA?',
                    'Bersihkan papan skor dan siapkan pertandingan selanjutnya?'
                );
                if (confirmed) window.resetMatch();
                return;
            }

            const confirmed = await window.showCustomConfirm(
                'SELESAIKAN MATCH?',
                'Apakah Anda yakin ingin menyelesaikan pertandingan ini dan menentukan pemenang?'
            );

            if (confirmed) {
                window.isWinnerDeclared = true;
                const scoreA = window.scoringMode === 'kata' ? window.kataScoreAka : window.akaScore;
                const scoreB = window.scoringMode === 'kata' ? window.kataScoreAo : window.aoScore;

                if (scoreA > scoreB) window.winnerSide = 'aka';
                else if (scoreB > scoreA) window.winnerSide = 'ao';
                else if (window.scoringMode === 'kumite' && window.senshu) window.winnerSide = window.senshu;
                else {
                    window.winnerSide = 'draw';
                    if (window.scoringMode === 'kumite') window.isHantei = true;
                }

                window.broadcastData();

                // --- Sync Engine Integration ---
                const winnerName = window.winnerSide === 'aka' ? window.nameAka : window.nameAo;
                const winnerTeam = window.winnerSide === 'aka' ? window.teamAka : window.teamAo;
                const winnerSlot = window.winnerSide === 'aka' ? window.slotAka : window.slotAo;
                const nextSlot = getNextSlot(winnerSlot);

                syncEngine.saveMatchResult({
                    eventId: window.eventId,
                    category: window.matchCategory,
                    winner: {
                        name: winnerName,
                        team: winnerTeam,
                        side: window.winnerSide
                    },
                    aka: { name: window.nameAka, team: window.teamAka, score: scoreA },
                    ao: { name: window.nameAo, team: window.teamAo, score: scoreB },
                    nextSlot: nextSlot,
                    mode: window.scoringMode
                }).then(() => {
                    console.log('[Sync] Match result saved to local DB');
                }).catch(err => {
                    console.error('[Sync] Error saving to local DB:', err);
                });
            }
        }

        window.handleTimerBlur = function (el) {
            const text = el.value.trim();
            const parts = text.split(':');
            let mins = 0, secs = 0;
            if (parts.length >= 2) {
                mins = parseInt(parts[0]) || 0;
                secs = parseInt(parts[1]) || 0;
            } else {
                secs = parseInt(parts[0]) || 0;
            }
            window.timeLeft = (mins * 60) + secs;
            const displayMins = Math.floor(window.timeLeft / 60);
            const displaySecs = window.timeLeft % 60;
            el.value = `${displayMins.toString().padStart(2, '0')}:${displaySecs.toString().padStart(2, '0')}`;
            broadcastData();
        }

        window.handleTimerKey = function (e, el) {
            if (e.key === 'Enter') {
                e.preventDefault();
                el.blur();
            }
        }

        window.applyTimerSettings = function () {
            // Deprecated - using inline edit
        }

        // --- START INITIALIZATION ---
        initDashboard();
        // -----------------------------

        // --- JUDGE KEYPAD LOGIC (Integrated) ---
        let currentJudgeSide = 'aka';
        let currentJudgeIndex = 0;

        window.openJudgeKeypad = function (side, index) {
            currentJudgeSide = side;
            currentJudgeIndex = index;

            const modal = document.getElementById('judgeKeypadModal');
            const subtitle = document.getElementById('keypadSubtitle');
            if (subtitle) {
                subtitle.innerText = `${side.toUpperCase()} - JUDGE ${index + 1}`;
                subtitle.className = `text-[10px] font-bold uppercase tracking-[.4em] mt-2 italic ${side === 'aka' ? 'text-red-400' : 'text-blue-400'}`;
            }

            const grid = document.getElementById('keypadGrid');
            if (grid) {
                grid.innerHTML = '';
                // Render 5.0 to 10.0
                for (let base = 5; base <= 10; base++) {
                    const row = document.createElement('div');
                    row.className = "flex flex-col space-y-2";

                    const label = document.createElement('p');
                    label.className = "text-[9px] font-black opacity-30 tracking-widest uppercase ml-2";
                    label.innerText = `BASE ${base}`;
                    row.appendChild(label);

                    const buttons = document.createElement('div');
                    buttons.className = "grid grid-cols-5 md:grid-cols-10 gap-2";

                    const maxDecimal = (base === 10) ? 0 : 9;
                    for (let dec = 0; dec <= maxDecimal; dec++) {
                        const val = base + (dec / 10);
                        const btn = document.createElement('button');
                        btn.className = `py-3 rounded-xl border border-white/5 text-xs font-black transition-all hover:scale-105 shadow-lg active:scale-95 ${side === 'aka' ? 'bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white' : 'bg-blue-500/10 text-blue-400 hover:bg-blue-500 hover:text-white'}`;
                        btn.innerText = val.toFixed(1);
                        btn.onclick = () => window.selectJudgeScore(val);
                        buttons.appendChild(btn);
                    }
                    row.appendChild(buttons);
                    grid.appendChild(row);

                    if (base < 10) {
                        const divider = document.createElement('div');
                        divider.className = "h-[1px] bg-white/5";
                        grid.appendChild(divider);
                    }
                }
            }

            if (modal) {
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.add('opacity-100'), 10);
            }
        }

        window.closeJudgeKeypad = function () {
            const modal = document.getElementById('judgeKeypadModal');
            if (modal) {
                modal.classList.add('opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modal.classList.remove('opacity-0');
                }, 300);
            }
        }

        window.selectJudgeScore = function (val) {
            if (currentJudgeSide === 'aka') {
                window.judgeScoresAka[currentJudgeIndex] = val;
                window.kataScoreAka = window.calculateKataTotal('aka', window.judgeScoresAka);
                if (document.getElementById('judgeBtnAka' + currentJudgeIndex)) document.getElementById('judgeBtnAka' + currentJudgeIndex).innerText = val.toFixed(1);
                if (document.getElementById('kataTotalAka')) document.getElementById('kataTotalAka').innerText = window.kataScoreAka.toFixed(1);
                if (document.getElementById('scoreAka')) document.getElementById('scoreAka').innerText = window.kataScoreAka.toFixed(1);
            } else {
                window.judgeScoresAo[currentJudgeIndex] = val;
                window.kataScoreAo = window.calculateKataTotal('ao', window.judgeScoresAo);
                if (document.getElementById('judgeBtnAo' + currentJudgeIndex)) document.getElementById('judgeBtnAo' + currentJudgeIndex).innerText = val.toFixed(1);
                if (document.getElementById('kataTotalAo')) document.getElementById('kataTotalAo').innerText = window.kataScoreAo.toFixed(1);
                if (document.getElementById('scoreAo')) document.getElementById('scoreAo').innerText = window.kataScoreAo.toFixed(1);
            }
            window.broadcastData();
            window.closeJudgeKeypad();
        }

        window.setKataFlags = function (akaCount) {
            window.akaFlags = akaCount;
            window.aoFlags = Math.max(0, 5 - akaCount);

            if (window.akaFlags > window.aoFlags) {
                window.setHanteiWinner('aka');
            } else {
                window.setHanteiWinner('ao');
            }

            if (document.getElementById('scoreAka')) document.getElementById('scoreAka').innerText = window.akaFlags;
            if (document.getElementById('scoreAo')) document.getElementById('scoreAo').innerText = window.aoFlags;

            document.querySelectorAll('.flag-btn').forEach(btn => {
                const valAttr = btn.getAttribute('data-val');
                if (valAttr) {
                    const isSelected = parseInt(valAttr) === akaCount;
                    btn.classList.toggle('bg-red-600', isSelected);
                    btn.classList.toggle('text-white', isSelected);
                    btn.classList.toggle('bg-white/5', !isSelected);
                    btn.classList.toggle('text-red-500', !isSelected);
                }
            });

            window.broadcastData();
        }
    </script>

    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        .tab-active {
            box-shadow: inset 4px 4px 8px var(--dark), inset -4px -4px 8px var(--light) !important;
        }

        .punish-dot.opacity-100 {
            transform: scale(1.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Active Penalty Button Style (Simulated) */
        .neu-button:active,
        .neu-button.penalty-active {
            box-shadow: inset 2px 2px 5px var(--dark), inset -2px -2px 5px var(--light) !important;
            color: white !important;
        }

        /* MODAL STYLES */
        #timerModal {
            display: none;
            backdrop-filter: blur(8px);
            background: rgba(0, 0, 0, 0.4);
        }

        .modal-show {
            display: flex !important;
            animation: fadeIn 0.3s ease-out;
        }

        /* Kata Discarded Score Style */
        .kata-discarded {
            text-decoration: line-through;
            opacity: 0.3;
            filter: grayscale(1);
            position: relative;
        }

        .kata-discarded::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 10%;
            right: 10%;
            height: 2px;
            background: currentColor;
            transform: rotate(-15deg);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* TOGGLE SWITCH */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--light);
            transition: .4s;
            border-radius: 24px;
            box-shadow: inset 2px 2px 5px var(--dark);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: var(--text);
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--accent);
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        /* SEARCHABLE DROPDOWN STYLES */
        .autocomplete-container {
            position: relative;
            width: 100%;
        }

        #categoryDropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            margin-top: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.2s ease-out;
        }

        #categoryDropdown.active {
            display: block;
        }

        .dropdown-item {
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #ef4444;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>

    <script>
        // Participant List Modal Management
        let participantListData = [];

        window.toggleParticipantModal = async function () {
            const modal = document.getElementById('participantModal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                await loadParticipants();
                updateParticipantModal();
            } else {
                modal.classList.add('hidden');
            }
        };

        window.loadParticipants = async function () {
            // Get selected class from scoring console
            const categoryDisplay = document.getElementById('categoryDisplay');
            const selectedClass = categoryDisplay ? categoryDisplay.innerText.trim() : '';

            // Get event ID from URL
            const eventId = window.eventId || new URLSearchParams(window.location.search).get('id');

            if (!eventId) {
                console.warn('[Participant List] No event ID found');
                participantListData = [];
                return;
            }

            if (!selectedClass || selectedClass === 'KUMITE' || selectedClass === 'KATA') {
                console.log('[Participant List] No specific class selected');
                participantListData = [];
                return;
            }

            try {
                // 1. Try to fetch bracket data first (to get the exact bracket order)
                const bracketSnap = await getDoc(doc(db, `events/${eventId}/brackets`, selectedClass));

                if (bracketSnap.exists()) {
                    const bracketSnapData = bracketSnap.data();
                    const participants = bracketSnapData.participants || [];
                    const progression = bracketSnapData.data || {};

                    console.log(`[Participant List] Overhauling with full bracket progression for ${selectedClass}`);

                    const pattern = GOLDEN_PRESETS[participants.length] || [];
                    participantListData = [];

                    // Fetch Match Results for Kata/Scores
                    const matchResults = {};
                    try {
                        const resultsQuery = query(
                            collection(db, `events/${eventId}/match_results`),
                            where('category', '==', selectedClass)
                        );
                        const resultsSnap = await getDocs(resultsQuery);
                        resultsSnap.forEach(doc => {
                            const data = doc.data();
                            const key = `${data.aka?.name}_${data.ao?.name}`.toLowerCase();
                            matchResults[key] = data;
                        });
                    } catch (err) {
                        console.error('[Participant List] Error fetching match results:', err);
                    }

                    // Helper to get name from slot or pattern
                    const getAthleteAtSlot = (slotId, originalIdx) => {
                        if (progression[slotId]) return { name: progression[slotId], team: '', slotId: slotId };
                        if (originalIdx !== undefined && participants[originalIdx]) {
                            return { ...participants[originalIdx], slotId: slotId };
                        }
                        return { name: '-', team: '-', slotId: slotId };
                    };

                    // Helper to get match result data
                    const getMatchResult = (akaName, aoName) => {
                        const key1 = `${akaName}_${aoName}`.toLowerCase();
                        const key2 = `${aoName}_${akaName}`.toLowerCase();
                        return matchResults[key1] || matchResults[key2] || null;
                    };

                    // Determine initial round label based on first slot type
                    let initialRoundLabel = 'PENYISIHAN';
                    if (pattern.length > 0) {
                        const firstSlot = pattern[0];
                        if (firstSlot.startsWith('sn')) initialRoundLabel = 'SEMI FINAL';
                        else if (firstSlot.startsWith('qn')) initialRoundLabel = 'PEREMPAT FINAL';
                        else if (firstSlot.startsWith('fn')) initialRoundLabel = 'FINAL';
                    }

                    // 1. ROUND 1 (Initial Round)
                    for (let i = 0; i < participants.length; i += 2) {
                        const aka = getAthleteAtSlot(pattern[i], i);
                        const ao = getAthleteAtSlot(pattern[i + 1], i + 1);
                        const result = getMatchResult(aka.name, ao.name);

                        participantListData.push({
                            aka: aka,
                            ao: ao,
                            roundLabel: initialRoundLabel,
                            matchNum: Math.floor(i / 2) + 1,
                            result: result
                        });
                    }

                    // 2. HIGHER ROUNDS
                    const rounds = [
                        { key: 'quarter', label: 'PEREMPAT FINAL' },
                        { key: 'semi', label: 'SEMI FINAL' },
                        { key: 'final', label: 'FINAL' }
                    ].filter(r => r.label !== initialRoundLabel); // Prevent duplicates

                    rounds.forEach(r => {
                        const matches = ROUND_MATCH_IDS[r.key];
                        const availableMatches = matches.filter(m => pattern.includes(m.aka) || pattern.includes(m.ao) || (r.key === 'final' && participants.length >= 2) || (r.key === 'semi' && participants.length >= 4) || (r.key === 'quarter' && participants.length >= 8));

                        // Only show matches that actually exist in this bracket size
                        // Simplification: if pattern includes p_n_something, it builds up.
                        // Let's use a better filter:
                        let showRound = false;
                        if (r.key === 'quarter' && participants.length >= 5) showRound = true;
                        if (r.key === 'semi' && participants.length >= 3) showRound = true;
                        if (r.key === 'final' && participants.length >= 2) showRound = true;

                        if (showRound) {
                            matches.forEach((m, idx) => {
                                // Check if this specific match is relevant for this bracket size
                                // For now, let's just show all if the round is active
                                // (The UI will show BYE vs BYE if nothing is there)
                                const aka = getAthleteAtSlot(m.aka);
                                const ao = getAthleteAtSlot(m.ao);

                                if (aka.name !== '-' || ao.name !== '-' || idx < (participants.length / (r.key === 'final' ? 2 : (r.key === 'semi' ? 4 : 8)))) {
                                    const result = getMatchResult(aka.name, ao.name);
                                    participantListData.push({
                                        aka: aka,
                                        ao: ao,
                                        roundLabel: r.label,
                                        matchNum: idx + 1,
                                        result: result
                                    });
                                }
                            });
                        }
                    });

                    return;
                }

                // 2. Fallback: Fetch athletes from Firestore filtered by className (no bracket found)
                console.log(`[Participant List] No bracket found for ${selectedClass}. Falling back to athlete list.`);
                const q = query(
                    collection(db, `events/${eventId}/athletes`),
                    where('className', '==', selectedClass)
                );

                const snapshot = await getDocs(q);
                participantListData = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        name: data.name || '-',
                        team: data.team || data.kontingen || '-',
                        className: data.className || '-',
                        round: data.currentRound || 'penyisihan',
                        roundLabel: getRoundLabel(data.currentRound || 'penyisihan'),
                        status: data.tournamentStatus || 'active'
                    };
                });

                // Sort by name in JavaScript if no bracket order
                participantListData.sort((a, b) => a.name.localeCompare(b.name));

                console.log(`[Participant List] Loaded ${participantListData.length} participants for class: ${selectedClass}`);
            } catch (err) {
                console.error('[Participant List] Error loading participants:', err);
                participantListData = [];
            }
        };

        function getRoundLabel(round) {
            const labels = {
                'penyisihan': 'Penyisihan 1',
                'penyisihan_2': 'Penyisihan 2',
                'semifinal': 'Semi-Final',
                'final': 'Final'
            };
            return labels[round] || 'P1';
        }

        window.updateParticipantModal = function () {
            const tableBody = document.getElementById('participantTableModal');
            const countBadge = document.getElementById('participantCountModal');

            if (participantListData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="py-12 text-center text-[10px] font-bold uppercase tracking-widest text-slate-600">
                            Pilih kelas yang sudah memiliki BAGAN (Bracket)
                        </td>
                    </tr>
                `;
                countBadge.innerText = '0 Partai';
                return;
            }

            countBadge.innerText = `${participantListData.length} Partai`;

            let html = '';
            let currentRoundId = '';

            participantListData.forEach((m, idx) => {
                // Show Round Header
                if (m.roundLabel !== currentRoundId) {
                    currentRoundId = m.roundLabel;
                    html += `
                        <tr class="bg-white/5">
                            <td colspan="5" class="py-2 px-4 text-[9px] font-black uppercase tracking-[0.2em] text-yellow-500/80 border-y border-white/5">
                                ${currentRoundId}
                            </td>
                        </tr>
                    `;
                }

                const aka = m.aka;
                const ao = m.ao;

                const renderAthlete = (p, side, result) => {
                    if (!p || p.name === '-' || p.name === '') {
                        return `
                            <div class="flex flex-col opacity-30">
                                <span class="text-[9px] font-black uppercase italic">BYE / KOSONG</span>
                            </div>
                        `;
                    }

                    let kataName = '';
                    let score = '';
                    if (result) {
                        const athleteData = side === 'aka' ? result.aka : result.ao;
                        if (athleteData) {
                            kataName = athleteData.kata || '';
                            score = athleteData.score !== undefined ? athleteData.score : '';
                        }
                    }

                    return `
                        <div class="flex flex-col">
                            <span class="text-[11px] font-black uppercase text-white leading-tight">${p.name}</span>
                            <span class="text-[8px] font-bold text-slate-400 uppercase tracking-widest">${p.team || '-'}</span>
                            ${kataName ? `<span class="text-[7px] font-bold text-blue-400 italic mt-0.5">Kata: ${kataName}</span>` : ''}
                            ${score !== '' ? `<span class="text-[7px] font-black text-yellow-400 mt-0.5">Score: ${score}</span>` : ''}
                        </div>
                    `;
                };

                const renderButtons = (pAka, pAo) => {
                    const matchData = encodeURIComponent(JSON.stringify({ aka: pAka, ao: pAo }));

                    const btnSelect = (pAka && pAka.name !== '-') || (pAo && pAo.name !== '-') ? `
                         <button onclick="selectMatch('${matchData}')" 
                            class="px-2.5 py-1 bg-yellow-500 hover:bg-yellow-400 text-[8px] font-black rounded text-slate-900 uppercase transition-all shadow-lg shadow-yellow-500/20">SELECT</button>
                    ` : '';

                    const btnAka = pAka && pAka.name !== '-' ? `
                        <button onclick="loadToSide('aka', '${pAka.name.replace(/'/g, "\\'")}', '${pAka.team ? pAka.team.replace(/'/g, "\\'") : ''}', '${pAka.slotId || ''}')" 
                            class="px-2 py-1 bg-red-600/20 hover:bg-red-600 text-[7px] font-bold rounded text-red-500 hover:text-white uppercase transition-all">A</button>
                    ` : '';

                    const btnAo = pAo && pAo.name !== '-' ? `
                        <button onclick="loadToSide('ao', '${pAo.name.replace(/'/g, "\\'")}', '${pAo.team ? pAo.team.replace(/'/g, "\\'") : ''}', '${pAo.slotId || ''}')" 
                            class="px-2 py-1 bg-blue-600/20 hover:bg-blue-600 text-[7px] font-bold rounded text-blue-500 hover:text-white uppercase transition-all">O</button>
                    ` : '';

                    return `<div class="flex items-center justify-center gap-1">${btnSelect}<div class="w-[1px] h-3 bg-white/10 mx-1"></div>${btnAka}${btnAo}</div>`;
                };

                html += `
                    <tr class="border-b border-white/5 hover:bg-white/10 transition-colors">
                        <td class="py-4 px-4 text-[10px] font-black text-slate-500 italic">#${m.matchNum.toString().padStart(2, '0')}</td>
                        <td class="py-4 px-4">${renderAthlete(aka, 'aka', m.result)}</td>
                        <td class="py-4 px-2 text-center">
                            <span class="text-[10px] font-black text-slate-600 italic">VS</span>
                        </td>
                        <td class="py-4 px-4">${renderAthlete(ao, 'ao', m.result)}</td>
                        <td class="py-4 px-4 text-center">
                            ${renderButtons(aka, ao)}
                        </td>
                    </tr>
                `;
            });
            tableBody.innerHTML = html;
        };

        window.selectMatch = function (matchDataJson) {
            const match = JSON.parse(decodeURIComponent(matchDataJson));
            if (match.aka && match.aka.name !== '-') {
                window.loadToSide('aka', match.aka.name, match.aka.team, match.aka.slotId);
            }
            if (match.ao && match.ao.name !== '-') {
                window.loadToSide('ao', match.ao.name, match.ao.team, match.ao.slotId);
            }
            // Close modal for convenience
            document.getElementById('participantModal').classList.add('hidden');
        };

        window.loadToSide = function (side, name, team, slotId) {
            if (side === 'aka') {
                window.nameAka = name;
                window.teamAka = team;
                window.slotAka = slotId || null;
                const display = document.getElementById('nameAkaDisplay');
                if (display) display.innerText = name.toUpperCase();
            } else {
                window.nameAo = name;
                window.teamAo = team;
                window.slotAo = slotId || null;
                const display = document.getElementById('nameAoDisplay');
                if (display) display.innerText = name.toUpperCase();
            }

            // Sync match info if not set
            const categoryDisplay = document.getElementById('categoryDisplay');
            if (categoryDisplay && (!window.matchCategory || window.matchCategory === 'KUMITE' || window.matchCategory === 'KATA')) {
                window.matchCategory = categoryDisplay.innerText.trim();
            }
            if (!window.matchRound) {
                const roundDisplay = document.getElementById('roundDisplay');
                window.matchRound = roundDisplay ? roundDisplay.innerText.trim() : 'ROUND 1';
            }

            window.broadcastData();

            // Close modal only if it's currently open
            const modal = document.getElementById('participantModal');
            if (modal && !modal.classList.contains('hidden')) {
                window.toggleParticipantModal();
            }
        };

        // Close modal when clicking outside
        document.addEventListener('click', function (e) {
            const modal = document.getElementById('participantModal');
            if (e.target === modal) {
                toggleParticipantModal();
            }
        });
    </script>
</body>


</html>